{
    "sourceFile": "src/hooks/useAuth.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 158,
            "patches": [
                {
                    "date": 1738870357092,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1738870386960,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -98,65 +98,27 @@\n   const changeRole = async (newRole: UserRole): Promise<void> => {\r\n     if (!context.user || isTransitioning) return;\r\n \r\n     try {\r\n-      // First try to get current session\r\n-      const { data: { session: currentSession }, error: sessionError } = \r\n-        await supabaseClient.auth.getSession();\r\n+      await roleTransitionManager.transitionRole(newRole);\r\n       \r\n-      if (sessionError) {\r\n-        logger.error('Failed to get current session', {\r\n-          context: { error: sessionError },\r\n-          source: 'useAuth'\r\n-        });\r\n-      }\r\n-\r\n-      // If no current session or error, try refresh\r\n-      if (!currentSession || sessionError) {\r\n-        const { data: { session: refreshedSession }, error: refreshError } = \r\n-          await supabaseClient.auth.refreshSession();\r\n-        \r\n-        if (refreshError || !refreshedSession) {\r\n-          logger.error('Session refresh failed', {\r\n-            context: { error: refreshError },\r\n-            source: 'useAuth'\r\n-          });\r\n-          // Redirect to login if session cannot be refreshed\r\n-          await supabaseClient.auth.signOut();\r\n-          navigate('/login');\r\n-          return;\r\n-        }\r\n-\r\n-        // Use refreshed session\r\n-        await roleTransitionManager.transitionRole(newRole, refreshedSession);\r\n-      } else {\r\n-        // Use current session\r\n-        await roleTransitionManager.transitionRole(newRole, currentSession);\r\n-      }\r\n+      // Clear cache and refetch with new role\r\n+      queryClient.clear();\r\n+      await queryClient.resetQueries();\r\n       \r\n-      // Update context user with new role\r\n+      // Update context user\r\n       context.setUser({\r\n         ...context.user,\r\n         role: newRole\r\n       });\r\n \r\n-      // Clear cache and refetch with new role\r\n-      queryClient.clear();\r\n-      await queryClient.resetQueries();\r\n-      \r\n+      // Navigate to home with fresh data\r\n       navigate('/', { replace: true });\r\n     } catch (err) {\r\n       logger.error('Failed to change role', {\r\n         context: { error: err },\r\n         source: 'useAuth'\r\n       });\r\n-      \r\n-      // Handle session errors specifically\r\n-      if (err instanceof Error && err.message.includes('session')) {\r\n-        await supabaseClient.auth.signOut();\r\n-        navigate('/login');\r\n-      }\r\n-      \r\n       throw err;\r\n     }\r\n   };\r\n \r\n@@ -345,9 +307,9 @@\n         context: { \r\n           error: errorDetails,\r\n           credentials: { email: credentials.email }\r\n         },\r\n-        source: '\r\n+        source: 'useAuth'\r\n       });\r\n \r\n       if (error instanceof Error) {\r\n         throw error;\r\n"
                },
                {
                    "date": 1738870529975,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -22,13 +22,10 @@\n }\r\n \r\n interface ResetPasswordCredentials {\r\n   email: string;\r\n-  newPassword: string;\r\n-  accessToken: string;\r\n }\r\n \r\n-\r\n export const useAuth = () => {\r\n   const context = useContext(AuthContext);\r\n   \r\n   if (!context) {\r\n"
                },
                {
                    "date": 1739277198560,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,7 +1,7 @@\n \"use client\";\r\n \r\n-import { useContext, useEffect } from 'react';\r\n+import { useContext, useEffect, useState, useCallback, useRef } from 'react';\r\n import { AuthContext } from '../contexts/AuthContext';\r\n import { useNavigate, useLocation } from 'react-router-dom';\r\n import { QueryClient } from '@tanstack/query-core';\r\n import { roleTransitionManager } from '../lib/auth/RoleTransitionManager';\r\n@@ -10,8 +10,10 @@\n import { ROLE_PERMISSIONS } from '../types/roles';\r\n import { sessionManager } from '../lib/auth/sessionManager';\r\n import type { UserRole } from '../types/roles';\r\n import { supabaseClient } from '../lib/supabaseClient';\r\n+import { supabase } from '../lib/supabase';\r\n+import { AuthLoader } from '../lib/auth/AuthLoader';\r\n \r\n interface LoginCredentials {\r\n   email: string;\r\n   password: string;\r\n@@ -374,8 +376,84 @@\n       }\r\n     }\r\n   };\r\n \r\n+  const [isAuthenticated, setIsAuthenticated] = useState<boolean>(false);\r\n+  const [isLoading, setIsLoading] = useState<boolean>(true);\r\n+  const authLoader = useRef<AuthLoader>(AuthLoader.getInstance());\r\n+  const stateChangeTimeout = useRef<NodeJS.Timeout | null>(null);\r\n+  const lastAuthState = useRef<string | null>(null);\r\n+\r\n+  const handleAuthChange = useCallback(async (event: 'SIGNED_IN' | 'SIGNED_OUT', session: any) => {\r\n+    const currentState = event;\r\n+    \r\n+    // Prevent unnecessary state updates\r\n+    if (lastAuthState.current === currentState) {\r\n+      return;\r\n+    }\r\n+\r\n+    // Clear any pending state changes\r\n+    if (stateChangeTimeout.current) {\r\n+      clearTimeout(stateChangeTimeout.current);\r\n+    }\r\n+\r\n+    // Delay state change to prevent rapid toggles\r\n+    stateChangeTimeout.current = setTimeout(() => {\r\n+      const isChildWindow = authLoader.current.isChildWindowSession();\r\n+      \r\n+      // Don't allow child windows to become unauthenticated\r\n+      if (isChildWindow && currentState === 'SIGNED_OUT') {\r\n+        logger.debug('Child window maintaining authenticated state', 'useAuth');\r\n+        return;\r\n+      }\r\n+\r\n+      setIsAuthenticated(currentState === 'SIGNED_IN');\r\n+      lastAuthState.current = currentState;\r\n+      \r\n+      logger.info(`Auth state changed: ${currentState}`, 'useAuth');\r\n+    }, 500);\r\n+  }, []);\r\n+\r\n+  useEffect(() => {\r\n+    let mounted = true;\r\n+    \r\n+    const initialize = async () => {\r\n+      try {\r\n+        await authLoader.current.initialize();\r\n+        \r\n+        if (!mounted) return;\r\n+        \r\n+        const currentState = authLoader.current.getLastAuthState();\r\n+        if (currentState) {\r\n+          handleAuthChange(currentState as 'SIGNED_IN' | 'SIGNED_OUT', null);\r\n+        }\r\n+        \r\n+        setIsLoading(false);\r\n+      } catch (err) {\r\n+        logger.error(`Auth initialization failed: ${err instanceof Error ? err.message : String(err)}`, 'useAuth');\r\n+        if (mounted) {\r\n+          setIsLoading(false);\r\n+        }\r\n+      }\r\n+    };\r\n+\r\n+    const { data: { subscription } } = supabase.auth.onAuthStateChange((event: any, session: any) => {\r\n+      if (mounted) {\r\n+        handleAuthChange(event, session);\r\n+      }\r\n+    });\r\n+\r\n+    initialize();\r\n+\r\n+    return () => {\r\n+      mounted = false;\r\n+      subscription?.unsubscribe();\r\n+      if (stateChangeTimeout.current) {\r\n+        clearTimeout(stateChangeTimeout.current);\r\n+      }\r\n+    };\r\n+  }, [handleAuthChange]);\r\n+\r\n   return {\r\n     user: user ? {\r\n       ...user,\r\n       role: user.role || 'unknown'\r\n@@ -385,7 +463,12 @@\n     isTransitioning,\r\n     login,\r\n     logout,\r\n     signUp,\r\n-    resetPassword\r\n+    resetPassword,\r\n+    isAuthenticated,\r\n\\ No newline at end of file\n+    isLoading,\r\n+    sessionManager\r\n   };\r\n-};\n+};\r\n+\r\n+export default useAuth;\n\\ No newline at end of file\n"
                },
                {
                    "date": 1739277219873,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -12,8 +12,9 @@\n import type { UserRole } from '../types/roles';\r\n import { supabaseClient } from '../lib/supabaseClient';\r\n import { supabase } from '../lib/supabase';\r\n import { AuthLoader } from '../lib/auth/AuthLoader';\r\n+import type { AuthError } from '@supabase/supabase-js';\r\n \r\n interface LoginCredentials {\r\n   email: string;\r\n   password: string;\r\n@@ -401,16 +402,16 @@\n       const isChildWindow = authLoader.current.isChildWindowSession();\r\n       \r\n       // Don't allow child windows to become unauthenticated\r\n       if (isChildWindow && currentState === 'SIGNED_OUT') {\r\n-        logger.debug('Child window maintaining authenticated state', 'useAuth');\r\n+        logger.debug('Child window maintaining authenticated state', { source: 'useAuth' });\r\n         return;\r\n       }\r\n \r\n       setIsAuthenticated(currentState === 'SIGNED_IN');\r\n       lastAuthState.current = currentState;\r\n       \r\n-      logger.info(`Auth state changed: ${currentState}`, 'useAuth');\r\n+      logger.info(`Auth state changed: ${currentState}`, { source: 'useAuth' });\r\n     }, 500);\r\n   }, []);\r\n \r\n   useEffect(() => {\r\n@@ -428,9 +429,12 @@\n         }\r\n         \r\n         setIsLoading(false);\r\n       } catch (err) {\r\n-        logger.error(`Auth initialization failed: ${err instanceof Error ? err.message : String(err)}`, 'useAuth');\r\n+        logger.error('Auth initialization failed', { \r\n+          error: err instanceof Error ? err.message : String(err),\r\n+          source: 'useAuth'\r\n+        });\r\n         if (mounted) {\r\n           setIsLoading(false);\r\n         }\r\n       }\r\n"
                },
                {
                    "date": 1739278677816,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -27,8 +27,11 @@\n interface ResetPasswordCredentials {\r\n   email: string;\r\n }\r\n \r\n+const AUTH_STATE_CHANGE_DELAY = 1000; // 1 second delay for state changes\r\n+const AUTH_STATE_DEBOUNCE = 2000; // 2 seconds debounce for rapid changes\r\n+\r\n export const useAuth = () => {\r\n   const context = useContext(AuthContext);\r\n   \r\n   if (!context) {\r\n@@ -382,37 +385,54 @@\n   const [isLoading, setIsLoading] = useState<boolean>(true);\r\n   const authLoader = useRef<AuthLoader>(AuthLoader.getInstance());\r\n   const stateChangeTimeout = useRef<NodeJS.Timeout | null>(null);\r\n   const lastAuthState = useRef<string | null>(null);\r\n+  const lastStateChangeTime = useRef<number>(0);\r\n+  const pendingStateChange = useRef<'SIGNED_IN' | 'SIGNED_OUT' | null>(null);\r\n \r\n   const handleAuthChange = useCallback(async (event: 'SIGNED_IN' | 'SIGNED_OUT', session: any) => {\r\n-    const currentState = event;\r\n+    const now = Date.now();\r\n+    const timeSinceLastChange = now - lastStateChangeTime.current;\r\n     \r\n-    // Prevent unnecessary state updates\r\n-    if (lastAuthState.current === currentState) {\r\n-      return;\r\n-    }\r\n+    // Store the pending state change\r\n+    pendingStateChange.current = event;\r\n \r\n     // Clear any pending state changes\r\n     if (stateChangeTimeout.current) {\r\n       clearTimeout(stateChangeTimeout.current);\r\n     }\r\n \r\n-    // Delay state change to prevent rapid toggles\r\n+    // If we're changing too quickly, delay the change\r\n+    if (timeSinceLastChange < AUTH_STATE_DEBOUNCE) {\r\n+      logger.debug(`Debouncing auth state change to ${event}`, { component: 'useAuth' });\r\n+      stateChangeTimeout.current = setTimeout(() => {\r\n+        handleAuthChange(event, session);\r\n+      }, AUTH_STATE_DEBOUNCE);\r\n+      return;\r\n+    }\r\n+\r\n+    // Don't allow rapid toggles between states\r\n+    if (lastAuthState.current && lastAuthState.current !== event && timeSinceLastChange < AUTH_STATE_CHANGE_DELAY) {\r\n+      logger.debug(`Preventing rapid auth state toggle to ${event}`, { component: 'useAuth' });\r\n+      return;\r\n+    }\r\n+\r\n+    // Process the state change\r\n     stateChangeTimeout.current = setTimeout(() => {\r\n       const isChildWindow = authLoader.current.isChildWindowSession();\r\n       \r\n       // Don't allow child windows to become unauthenticated\r\n-      if (isChildWindow && currentState === 'SIGNED_OUT') {\r\n-        logger.debug('Child window maintaining authenticated state', { source: 'useAuth' });\r\n+      if (isChildWindow && event === 'SIGNED_OUT') {\r\n+        logger.debug('Child window maintaining authenticated state', { component: 'useAuth' });\r\n         return;\r\n       }\r\n \r\n-      setIsAuthenticated(currentState === 'SIGNED_IN');\r\n-      lastAuthState.current = currentState;\r\n+      setIsAuthenticated(event === 'SIGNED_IN');\r\n+      lastAuthState.current = event;\r\n+      lastStateChangeTime.current = Date.now();\r\n       \r\n-      logger.info(`Auth state changed: ${currentState}`, { source: 'useAuth' });\r\n-    }, 500);\r\n+      logger.info(`Auth state changed: ${event}`, { component: 'useAuth' });\r\n+    }, AUTH_STATE_CHANGE_DELAY);\r\n   }, []);\r\n \r\n   useEffect(() => {\r\n     let mounted = true;\r\n@@ -431,9 +451,9 @@\n         setIsLoading(false);\r\n       } catch (err) {\r\n         logger.error('Auth initialization failed', { \r\n           error: err instanceof Error ? err.message : String(err),\r\n-          source: 'useAuth'\r\n+          component: 'useAuth'\r\n         });\r\n         if (mounted) {\r\n           setIsLoading(false);\r\n         }\r\n@@ -457,21 +477,20 @@\n     };\r\n   }, [handleAuthChange]);\r\n \r\n   return {\r\n-    user: user ? {\r\n-      ...user,\r\n-      role: user.role || 'unknown'\r\n+    user: context?.user ? {\r\n+      ...context.user,\r\n+      role: context.user.role || 'unknown'\r\n     } : null,\r\n-    loading,\r\n+    loading: isLoading,\r\n     changeRole,\r\n     isTransitioning,\r\n     login,\r\n     logout,\r\n     signUp,\r\n     resetPassword,\r\n     isAuthenticated,\r\n-    isLoading,\r\n     sessionManager\r\n   };\r\n };\r\n \r\n"
                },
                {
                    "date": 1739278699416,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -392,46 +392,40 @@\n   const handleAuthChange = useCallback(async (event: 'SIGNED_IN' | 'SIGNED_OUT', session: any) => {\r\n     const now = Date.now();\r\n     const timeSinceLastChange = now - lastStateChangeTime.current;\r\n     \r\n-    // Store the pending state change\r\n     pendingStateChange.current = event;\r\n \r\n-    // Clear any pending state changes\r\n     if (stateChangeTimeout.current) {\r\n       clearTimeout(stateChangeTimeout.current);\r\n     }\r\n \r\n-    // If we're changing too quickly, delay the change\r\n     if (timeSinceLastChange < AUTH_STATE_DEBOUNCE) {\r\n-      logger.debug(`Debouncing auth state change to ${event}`, { component: 'useAuth' });\r\n+      logger.debug(`[useAuth] Debouncing auth state change to ${event}`);\r\n       stateChangeTimeout.current = setTimeout(() => {\r\n         handleAuthChange(event, session);\r\n       }, AUTH_STATE_DEBOUNCE);\r\n       return;\r\n     }\r\n \r\n-    // Don't allow rapid toggles between states\r\n     if (lastAuthState.current && lastAuthState.current !== event && timeSinceLastChange < AUTH_STATE_CHANGE_DELAY) {\r\n-      logger.debug(`Preventing rapid auth state toggle to ${event}`, { component: 'useAuth' });\r\n+      logger.debug(`[useAuth] Preventing rapid auth state toggle to ${event}`);\r\n       return;\r\n     }\r\n \r\n-    // Process the state change\r\n     stateChangeTimeout.current = setTimeout(() => {\r\n       const isChildWindow = authLoader.current.isChildWindowSession();\r\n       \r\n-      // Don't allow child windows to become unauthenticated\r\n       if (isChildWindow && event === 'SIGNED_OUT') {\r\n-        logger.debug('Child window maintaining authenticated state', { component: 'useAuth' });\r\n+        logger.debug('[useAuth] Child window maintaining authenticated state');\r\n         return;\r\n       }\r\n \r\n       setIsAuthenticated(event === 'SIGNED_IN');\r\n       lastAuthState.current = event;\r\n       lastStateChangeTime.current = Date.now();\r\n       \r\n-      logger.info(`Auth state changed: ${event}`, { component: 'useAuth' });\r\n+      logger.info(`[useAuth] Auth state changed: ${event}`);\r\n     }, AUTH_STATE_CHANGE_DELAY);\r\n   }, []);\r\n \r\n   useEffect(() => {\r\n@@ -449,12 +443,9 @@\n         }\r\n         \r\n         setIsLoading(false);\r\n       } catch (err) {\r\n-        logger.error('Auth initialization failed', { \r\n-          error: err instanceof Error ? err.message : String(err),\r\n-          component: 'useAuth'\r\n-        });\r\n+        logger.error(`[useAuth] Auth initialization failed: ${err instanceof Error ? err.message : String(err)}`);\r\n         if (mounted) {\r\n           setIsLoading(false);\r\n         }\r\n       }\r\n"
                },
                {
                    "date": 1739278797230,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,488 +1,508 @@\n-\"use client\";\r\n-\r\n-import { useContext, useEffect, useState, useCallback, useRef } from 'react';\r\n-import { AuthContext } from '../contexts/AuthContext';\r\n-import { useNavigate, useLocation } from 'react-router-dom';\r\n-import { QueryClient } from '@tanstack/query-core';\r\n-import { roleTransitionManager } from '../lib/auth/RoleTransitionManager';\r\n-import { useRoleStore } from '../lib/auth/store';\r\n-import { logger } from '../lib/logger';\r\n-import { ROLE_PERMISSIONS } from '../types/roles';\r\n-import { sessionManager } from '../lib/auth/sessionManager';\r\n-import type { UserRole } from '../types/roles';\r\n-import { supabaseClient } from '../lib/supabaseClient';\r\n-import { supabase } from '../lib/supabase';\r\n-import { AuthLoader } from '../lib/auth/AuthLoader';\r\n-import type { AuthError } from '@supabase/supabase-js';\r\n-\r\n-interface LoginCredentials {\r\n-  email: string;\r\n-  password: string;\r\n-}\r\n-\r\n-interface SignUpCredentials extends LoginCredentials {\r\n-  name?: string;\r\n-}\r\n-\r\n-interface ResetPasswordCredentials {\r\n-  email: string;\r\n-}\r\n-\r\n-const AUTH_STATE_CHANGE_DELAY = 1000; // 1 second delay for state changes\r\n-const AUTH_STATE_DEBOUNCE = 2000; // 2 seconds debounce for rapid changes\r\n-\r\n-export const useAuth = () => {\r\n-  const context = useContext(AuthContext);\r\n-  \r\n-  if (!context) {\r\n-    console.warn('useAuth must be used within an AuthProvider');\r\n-    return { user: null, loading: false };\r\n-  }\r\n-\r\n-  const { user, loading } = context;\r\n-\r\n-  // Add debug logging\r\n-  console.log('Auth Context:', {\r\n-    hasUser: !!user,\r\n-    userRole: user?.role,\r\n-    userId: user?.id,\r\n-    isLoading: loading,\r\n-    fullUser: user // Log the full user object for debugging\r\n-  });\r\n-\r\n-  const { isTransitioning } = useRoleStore();\r\n-  const navigate = useNavigate();\r\n-  const queryClient = new QueryClient();\r\n-  const location = useLocation();\r\n-  \r\n-  // Add loading state check\r\n-  useEffect(() => {\r\n-    if (loading) {\r\n-      logger.info('Auth loading state active', {\r\n-        source: 'useAuth'\r\n-      });\r\n-    }\r\n-  }, [loading]);\r\n-\r\n-  // Auto-refresh session when it's about to expire\r\n-  useEffect(() => {\r\n-    if (!user) return;\r\n-    const refreshInterval = setInterval(async () => {\r\n-      try {\r\n-        await sessionManager.refreshSession();\r\n-      } catch (err) {\r\n-        logger.error('Failed to refresh session', {\r\n-          context: { error: err },\r\n-          source: 'useAuth'\r\n-        });\r\n-      }\r\n-    }, 4 * 60 * 1000); // Check every 4 minutes\r\n-    \r\n-    return () => {\r\n-      if (refreshInterval) {\r\n-        clearInterval(refreshInterval);\r\n-      }\r\n-    };\r\n-  }, [user]);\r\n-\r\n-  useEffect(() => {\r\n-    if (user) {\r\n-      logger.debug('Auth state check on route change', {\r\n-        context: {\r\n-          role: user.role,\r\n-          path: location.pathname,\r\n-          permissions: ROLE_PERMISSIONS[user.role]?.permissions\r\n-        },\r\n-        source: 'useAuth'\r\n-      });\r\n-    }\r\n-  }, [user, location.pathname]);\r\n-\r\n-  const changeRole = async (newRole: UserRole): Promise<void> => {\r\n-    if (!context.user || isTransitioning) return;\r\n-\r\n-    try {\r\n-      await roleTransitionManager.transitionRole(newRole);\r\n-      \r\n-      // Clear cache and refetch with new role\r\n-      queryClient.clear();\r\n-      await queryClient.resetQueries();\r\n-      \r\n-      // Update context user\r\n-      context.setUser({\r\n-        ...context.user,\r\n-        role: newRole\r\n-      });\r\n-\r\n-      // Navigate to home with fresh data\r\n-      navigate('/', { replace: true });\r\n-    } catch (err) {\r\n-      logger.error('Failed to change role', {\r\n-        context: { error: err },\r\n-        source: 'useAuth'\r\n-      });\r\n-      throw err;\r\n-    }\r\n-  };\r\n-\r\n-  const login = async (credentials: LoginCredentials) => {\r\n-    try {\r\n-      console.log('[Auth] Attempting login:', {\r\n-        email: credentials.email,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-      \r\n-      const { data, error } = await supabaseClient.auth.signInWithPassword({\r\n-        email: credentials.email,\r\n-        password: credentials.password,\r\n-      });\r\n-\r\n-      if (error) {\r\n-        console.error('[Auth] Supabase login error:', {\r\n-          message: error.message,\r\n-          status: error.status,\r\n-          name: error.name,\r\n-          timestamp: new Date().toISOString()\r\n-        });\r\n-        \r\n-        // Provide more specific error messages\r\n-        if (error.message.includes('Invalid login credentials')) {\r\n-          throw new Error('Invalid email or password. Please check your credentials and try again.');\r\n-        }\r\n-        \r\n-        logger.error('Login failed', {\r\n-          context: { \r\n-            error,\r\n-            credentials: { email: credentials.email }\r\n-          },\r\n-          source: 'useAuth'\r\n-        });\r\n-        throw new Error(error.message);\r\n-      }\r\n-\r\n-      console.log('[Auth] Login response:', {\r\n-        hasUser: !!data.user,\r\n-        userId: data.user?.id,\r\n-        userEmail: data.user?.email,\r\n-        metadata: data.user?.user_metadata,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-\r\n-      if (!data.user) {\r\n-        throw new Error('Login successful but user data is missing');\r\n-      }\r\n-\r\n-      // Map Supabase user to our user format\r\n-      const mappedUser = {\r\n-        id: data.user.id,\r\n-        email: data.user.email!,\r\n-        name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\r\n-        role: data.user.user_metadata?.role || 'student',\r\n-        photoUrl: data.user.user_metadata?.avatar_url,\r\n-      };\r\n-\r\n-      console.log('[Auth] Mapped user:', mappedUser);\r\n-\r\n-      context.setUser(mappedUser);\r\n-      return { user: mappedUser };\r\n-    } catch (error) {\r\n-      const errorDetails = error instanceof Error ? {\r\n-        message: error.message,\r\n-        name: error.name,\r\n-        stack: error.stack\r\n-      } : error;\r\n-\r\n-      console.error('[Auth] Login error details:', {\r\n-        error: errorDetails,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-\r\n-      logger.error('Login failed', {\r\n-        context: { \r\n-          error: errorDetails,\r\n-          credentials: { email: credentials.email }\r\n-        },\r\n-        source: 'useAuth'\r\n-      });\r\n-\r\n-      if (error instanceof Error) {\r\n-        throw error;\r\n-      } else {\r\n-        throw new Error('An unexpected error occurred. Please try again.');\r\n-      }\r\n-    }\r\n-  };\r\n-\r\n-  const logout = async () => {\r\n-    try {\r\n-      const { error } = await supabaseClient.auth.signOut();\r\n-      \r\n-      if (error) {\r\n-        throw error;\r\n-      }\r\n-\r\n-      context.setUser(null);\r\n-      queryClient.clear();\r\n-      navigate('/login');\r\n-    } catch (error) {\r\n-      logger.error('Logout failed', {\r\n-        context: { error },\r\n-        source: 'useAuth'\r\n-      });\r\n-      throw error;\r\n-    }\r\n-  };\r\n-\r\n-  const signUp = async (credentials: SignUpCredentials) => {\r\n-    try {\r\n-      console.log('[Auth] Attempting signup:', {\r\n-        email: credentials.email,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-      \r\n-      const { data, error } = await supabaseClient.auth.signUp({\r\n-        email: credentials.email,\r\n-        password: credentials.password,\r\n-        options: {\r\n-          data: {\r\n-            name: credentials.name || credentials.email.split('@')[0],\r\n-            role: 'student'\r\n-          }\r\n-        }\r\n-      });\r\n-\r\n-      if (error) {\r\n-        console.error('[Auth] Supabase signup error:', {\r\n-          message: error.message,\r\n-          status: error.status,\r\n-          name: error.name,\r\n-          timestamp: new Date().toISOString()\r\n-        });\r\n-        \r\n-        logger.error('Signup failed', {\r\n-          context: { \r\n-            error,\r\n-            credentials: { email: credentials.email }\r\n-          },\r\n-          source: 'useAuth'\r\n-        });\r\n-        throw new Error(error.message);\r\n-      }\r\n-\r\n-      console.log('[Auth] Signup response:', {\r\n-        hasUser: !!data.user,\r\n-        userId: data.user?.id,\r\n-        userEmail: data.user?.email,\r\n-        metadata: data.user?.user_metadata,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-\r\n-      if (!data.user) {\r\n-        throw new Error('Signup successful but user data is missing');\r\n-      }\r\n-\r\n-      // Map Supabase user to our user format\r\n-      const mappedUser = {\r\n-        id: data.user.id,\r\n-        email: data.user.email!,\r\n-        name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\r\n-        role: data.user.user_metadata?.role || 'student',\r\n-        photoUrl: data.user.user_metadata?.avatar_url,\r\n-      };\r\n-\r\n-      console.log('[Auth] Mapped user:', mappedUser);\r\n-\r\n-      context.setUser(mappedUser);\r\n-      return { user: mappedUser };\r\n-    } catch (error) {\r\n-      const errorDetails = error instanceof Error ? {\r\n-        message: error.message,\r\n-        name: error.name,\r\n-        stack: error.stack\r\n-      } : error;\r\n-\r\n-      console.error('[Auth] Signup error details:', {\r\n-        error: errorDetails,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-\r\n-      logger.error('Signup failed', {\r\n-        context: { \r\n-          error: errorDetails,\r\n-          credentials: { email: credentials.email }\r\n-        },\r\n-        source: 'useAuth'\r\n-      });\r\n-\r\n-      if (error instanceof Error) {\r\n-        throw error;\r\n-      } else {\r\n-        throw new Error('An unexpected error occurred during signup. Please try again.');\r\n-      }\r\n-    }\r\n-  };\r\n-\r\n-  const resetPassword = async (credentials: ResetPasswordCredentials) => {\r\n-    try {\r\n-      console.log('[Auth] Attempting password reset:', {\r\n-        email: credentials.email,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-      \r\n-      const { data, error } = await supabaseClient.auth.resetPasswordForEmail(\r\n-        credentials.email,\r\n-        { redirectTo: `${window.location.origin}/reset-password` }\r\n-      );\r\n-\r\n-      if (error) {\r\n-        console.error('[Auth] Supabase password reset error:', {\r\n-          message: error.message,\r\n-          status: error.status,\r\n-          name: error.name,\r\n-          timestamp: new Date().toISOString()\r\n-        });\r\n-        \r\n-        logger.error('Password reset failed', {\r\n-          context: { \r\n-            error,\r\n-            credentials: { email: credentials.email }\r\n-          },\r\n-          source: 'useAuth'\r\n-        });\r\n-        throw new Error(error.message);\r\n-      }\r\n-\r\n-      return data;\r\n-    } catch (error) {\r\n-      const errorDetails = error instanceof Error ? {\r\n-        message: error.message,\r\n-        name: error.name,\r\n-        stack: error.stack\r\n-      } : error;\r\n-\r\n-      console.error('[Auth] Password reset error details:', {\r\n-        error: errorDetails,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-\r\n-      logger.error('Password reset failed', {\r\n-        context: { \r\n-          error: errorDetails,\r\n-          credentials: { email: credentials.email }\r\n-        },\r\n-        source: 'useAuth'\r\n-      });\r\n-\r\n-      if (error instanceof Error) {\r\n-        throw error;\r\n-      } else {\r\n-        throw new Error('An unexpected error occurred during password reset. Please try again.');\r\n-      }\r\n-    }\r\n-  };\r\n-\r\n-  const [isAuthenticated, setIsAuthenticated] = useState<boolean>(false);\r\n-  const [isLoading, setIsLoading] = useState<boolean>(true);\r\n-  const authLoader = useRef<AuthLoader>(AuthLoader.getInstance());\r\n-  const stateChangeTimeout = useRef<NodeJS.Timeout | null>(null);\r\n-  const lastAuthState = useRef<string | null>(null);\r\n-  const lastStateChangeTime = useRef<number>(0);\r\n-  const pendingStateChange = useRef<'SIGNED_IN' | 'SIGNED_OUT' | null>(null);\r\n-\r\n-  const handleAuthChange = useCallback(async (event: 'SIGNED_IN' | 'SIGNED_OUT', session: any) => {\r\n-    const now = Date.now();\r\n-    const timeSinceLastChange = now - lastStateChangeTime.current;\r\n-    \r\n-    pendingStateChange.current = event;\r\n-\r\n-    if (stateChangeTimeout.current) {\r\n-      clearTimeout(stateChangeTimeout.current);\r\n-    }\r\n-\r\n-    if (timeSinceLastChange < AUTH_STATE_DEBOUNCE) {\r\n-      logger.debug(`[useAuth] Debouncing auth state change to ${event}`);\r\n-      stateChangeTimeout.current = setTimeout(() => {\r\n-        handleAuthChange(event, session);\r\n-      }, AUTH_STATE_DEBOUNCE);\r\n-      return;\r\n-    }\r\n-\r\n-    if (lastAuthState.current && lastAuthState.current !== event && timeSinceLastChange < AUTH_STATE_CHANGE_DELAY) {\r\n-      logger.debug(`[useAuth] Preventing rapid auth state toggle to ${event}`);\r\n-      return;\r\n-    }\r\n-\r\n-    stateChangeTimeout.current = setTimeout(() => {\r\n-      const isChildWindow = authLoader.current.isChildWindowSession();\r\n-      \r\n-      if (isChildWindow && event === 'SIGNED_OUT') {\r\n-        logger.debug('[useAuth] Child window maintaining authenticated state');\r\n-        return;\r\n-      }\r\n-\r\n-      setIsAuthenticated(event === 'SIGNED_IN');\r\n-      lastAuthState.current = event;\r\n-      lastStateChangeTime.current = Date.now();\r\n-      \r\n-      logger.info(`[useAuth] Auth state changed: ${event}`);\r\n-    }, AUTH_STATE_CHANGE_DELAY);\r\n-  }, []);\r\n-\r\n-  useEffect(() => {\r\n-    let mounted = true;\r\n-    \r\n-    const initialize = async () => {\r\n-      try {\r\n-        await authLoader.current.initialize();\r\n-        \r\n-        if (!mounted) return;\r\n-        \r\n-        const currentState = authLoader.current.getLastAuthState();\r\n-        if (currentState) {\r\n-          handleAuthChange(currentState as 'SIGNED_IN' | 'SIGNED_OUT', null);\r\n-        }\r\n-        \r\n-        setIsLoading(false);\r\n-      } catch (err) {\r\n-        logger.error(`[useAuth] Auth initialization failed: ${err instanceof Error ? err.message : String(err)}`);\r\n-        if (mounted) {\r\n-          setIsLoading(false);\r\n-        }\r\n-      }\r\n-    };\r\n-\r\n-    const { data: { subscription } } = supabase.auth.onAuthStateChange((event: any, session: any) => {\r\n-      if (mounted) {\r\n-        handleAuthChange(event, session);\r\n-      }\r\n-    });\r\n-\r\n-    initialize();\r\n-\r\n-    return () => {\r\n-      mounted = false;\r\n-      subscription?.unsubscribe();\r\n-      if (stateChangeTimeout.current) {\r\n-        clearTimeout(stateChangeTimeout.current);\r\n-      }\r\n-    };\r\n-  }, [handleAuthChange]);\r\n-\r\n-  return {\r\n-    user: context?.user ? {\r\n-      ...context.user,\r\n-      role: context.user.role || 'unknown'\r\n-    } : null,\r\n-    loading: isLoading,\r\n-    changeRole,\r\n-    isTransitioning,\r\n-    login,\r\n-    logout,\r\n-    signUp,\r\n-    resetPassword,\r\n-    isAuthenticated,\r\n-    sessionManager\r\n-  };\r\n-};\r\n-\r\n+\"use client\";\n+\n+import { useContext, useEffect, useState, useCallback, useRef } from 'react';\n+import { AuthContext } from '../contexts/AuthContext';\n+import { useNavigate, useLocation } from 'react-router-dom';\n+import { QueryClient } from '@tanstack/query-core';\n+import { roleTransitionManager } from '../lib/auth/RoleTransitionManager';\n+import { useRoleStore } from '../lib/auth/store';\n+import { logger } from '../lib/logger';\n+import { ROLE_PERMISSIONS } from '../types/roles';\n+import { sessionManager } from '../lib/auth/sessionManager';\n+import type { UserRole } from '../types/roles';\n+import { supabaseClient } from '../lib/supabaseClient';\n+import { supabase } from '../lib/supabase';\n+import { AuthLoader } from '../lib/auth/AuthLoader';\n+import type { AuthError } from '@supabase/supabase-js';\n+\n+interface LoginCredentials {\n+  email: string;\n+  password: string;\n+}\n+\n+interface SignUpCredentials extends LoginCredentials {\n+  name?: string;\n+}\n+\n+interface ResetPasswordCredentials {\n+  email: string;\n+}\n+\n+export const useAuth = () => {\n+  const context = useContext(AuthContext);\n+  \n+  if (!context) {\n+    console.warn('useAuth must be used within an AuthProvider');\n+    return { user: null, loading: false };\n+  }\n+\n+  const { user, loading } = context;\n+\n+  // Add debug logging\n+  console.log('Auth Context:', {\n+    hasUser: !!user,\n+    userRole: user?.role,\n+    userId: user?.id,\n+    isLoading: loading,\n+    fullUser: user // Log the full user object for debugging\n+  });\n+\n+  const { isTransitioning } = useRoleStore();\n+  const navigate = useNavigate();\n+  const queryClient = new QueryClient();\n+  const location = useLocation();\n+  \n+  // Add loading state check\n+  useEffect(() => {\n+    if (loading) {\n+      logger.info('Auth loading state active', {\n+        source: 'useAuth',\n+        context: { loading }\n+      });\n+    }\n+  }, [loading]);\n+\n+  // Auto-refresh session when it's about to expire\n+  useEffect(() => {\n+    if (!user) return;\n+    const refreshInterval = setInterval(async () => {\n+      try {\n+        await sessionManager.refreshSession();\n+      } catch (err) {\n+        logger.error('Failed to refresh session', {\n+          source: 'useAuth',\n+          context: { error: err }\n+        });\n+      }\n+    }, 4 * 60 * 1000); // Check every 4 minutes\n+    \n+    return () => {\n+      if (refreshInterval) {\n+        clearInterval(refreshInterval);\n+      }\n+    };\n+  }, [user]);\n+\n+  useEffect(() => {\n+    if (user) {\n+      logger.debug('Auth state check on route change', {\n+        source: 'useAuth',\n+        context: {\n+          role: user.role,\n+          path: location.pathname,\n+          permissions: ROLE_PERMISSIONS[user.role]?.permissions\n+        }\n+      });\n+    }\n+  }, [user, location.pathname]);\n+\n+  const changeRole = async (newRole: UserRole): Promise<void> => {\n+    if (!context.user || isTransitioning) return;\n+\n+    try {\n+      await roleTransitionManager.transitionRole(newRole);\n+      \n+      // Clear cache and refetch with new role\n+      queryClient.clear();\n+      await queryClient.resetQueries();\n+      \n+      // Update context user\n+      context.setUser({\n+        ...context.user,\n+        role: newRole\n+      });\n+\n+      // Navigate to home with fresh data\n+      navigate('/', { replace: true });\n+    } catch (err) {\n+      logger.error('Failed to change role', {\n+        source: 'useAuth',\n+        context: { error: err }\n+      });\n+      throw err;\n+    }\n+  };\n+\n+  const login = async (credentials: LoginCredentials) => {\n+    try {\n+      console.log('[Auth] Attempting login:', {\n+        email: credentials.email,\n+        timestamp: new Date().toISOString()\n+      });\n+      \n+      const { data, error } = await supabaseClient.auth.signInWithPassword({\n+        email: credentials.email,\n+        password: credentials.password,\n+      });\n+\n+      if (error) {\n+        console.error('[Auth] Supabase login error:', {\n+          message: error.message,\n+          status: error.status,\n+          name: error.name,\n+          timestamp: new Date().toISOString()\n+        });\n+        \n+        // Provide more specific error messages\n+        if (error.message.includes('Invalid login credentials')) {\n+          throw new Error('Invalid email or password. Please check your credentials and try again.');\n+        }\n+        \n+        logger.error('Login failed', {\n+          context: { \n+            error,\n+            credentials: { email: credentials.email }\n+          },\n+          source: 'useAuth'\n+        });\n+        throw new Error(error.message);\n+      }\n+\n+      console.log('[Auth] Login response:', {\n+        hasUser: !!data.user,\n+        userId: data.user?.id,\n+        userEmail: data.user?.email,\n+        metadata: data.user?.user_metadata,\n+        timestamp: new Date().toISOString()\n+      });\n+\n+      if (!data.user) {\n+        throw new Error('Login successful but user data is missing');\n+      }\n+\n+      // Map Supabase user to our user format\n+      const mappedUser = {\n+        id: data.user.id,\n+        email: data.user.email!,\n+        name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\n+        role: data.user.user_metadata?.role || 'student',\n+        photoUrl: data.user.user_metadata?.avatar_url,\n+      };\n+\n+      console.log('[Auth] Mapped user:', mappedUser);\n+\n+      context.setUser(mappedUser);\n+      return { user: mappedUser };\n+    } catch (error) {\n+      const errorDetails = error instanceof Error ? {\n+        message: error.message,\n+        name: error.name,\n+        stack: error.stack\n+      } : error;\n+\n+      console.error('[Auth] Login error details:', {\n+        error: errorDetails,\n+        timestamp: new Date().toISOString()\n+      });\n+\n+      logger.error('Login failed', {\n+        context: { \n+          error: errorDetails,\n+          credentials: { email: credentials.email }\n+        },\n+        source: 'useAuth'\n+      });\n+\n+      if (error instanceof Error) {\n+        throw error;\n+      } else {\n+        throw new Error('An unexpected error occurred. Please try again.');\n+      }\n+    }\n+  };\n+\n+  const logout = async () => {\n+    try {\n+      const { error } = await supabaseClient.auth.signOut();\n+      \n+      if (error) {\n+        throw error;\n+      }\n+\n+      context.setUser(null);\n+      queryClient.clear();\n+      navigate('/login');\n+    } catch (error) {\n+      logger.error('Logout failed', {\n+        context: { error },\n+        source: 'useAuth'\n+      });\n+      throw error;\n+    }\n+  };\n+\n+  const signUp = async (credentials: SignUpCredentials) => {\n+    try {\n+      console.log('[Auth] Attempting signup:', {\n+        email: credentials.email,\n+        timestamp: new Date().toISOString()\n+      });\n+      \n+      const { data, error } = await supabaseClient.auth.signUp({\n+        email: credentials.email,\n+        password: credentials.password,\n+        options: {\n+          data: {\n+            name: credentials.name || credentials.email.split('@')[0],\n+            role: 'student'\n+          }\n+        }\n+      });\n+\n+      if (error) {\n+        console.error('[Auth] Supabase signup error:', {\n+          message: error.message,\n+          status: error.status,\n+          name: error.name,\n+          timestamp: new Date().toISOString()\n+        });\n+        \n+        logger.error('Signup failed', {\n+          context: { \n+            error,\n+            credentials: { email: credentials.email }\n+          },\n+          source: 'useAuth'\n+        });\n+        throw new Error(error.message);\n+      }\n+\n+      console.log('[Auth] Signup response:', {\n+        hasUser: !!data.user,\n+        userId: data.user?.id,\n+        userEmail: data.user?.email,\n+        metadata: data.user?.user_metadata,\n+        timestamp: new Date().toISOString()\n+      });\n+\n+      if (!data.user) {\n+        throw new Error('Signup successful but user data is missing');\n+      }\n+\n+      // Map Supabase user to our user format\n+      const mappedUser = {\n+        id: data.user.id,\n+        email: data.user.email!,\n+        name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\n+        role: data.user.user_metadata?.role || 'student',\n+        photoUrl: data.user.user_metadata?.avatar_url,\n+      };\n+\n+      console.log('[Auth] Mapped user:', mappedUser);\n+\n+      context.setUser(mappedUser);\n+      return { user: mappedUser };\n+    } catch (error) {\n+      const errorDetails = error instanceof Error ? {\n+        message: error.message,\n+        name: error.name,\n+        stack: error.stack\n+      } : error;\n+\n+      console.error('[Auth] Signup error details:', {\n+        error: errorDetails,\n+        timestamp: new Date().toISOString()\n+      });\n+\n+      logger.error('Signup failed', {\n+        context: { \n+          error: errorDetails,\n+          credentials: { email: credentials.email }\n+        },\n+        source: 'useAuth'\n+      });\n+\n+      if (error instanceof Error) {\n+        throw error;\n+      } else {\n+        throw new Error('An unexpected error occurred during signup. Please try again.');\n+      }\n+    }\n+  };\n+\n+  const resetPassword = async (credentials: ResetPasswordCredentials) => {\n+    try {\n+      console.log('[Auth] Attempting password reset:', {\n+        email: credentials.email,\n+        timestamp: new Date().toISOString()\n+      });\n+      \n+      const { data, error } = await supabaseClient.auth.resetPasswordForEmail(\n+        credentials.email,\n+        { redirectTo: `${window.location.origin}/reset-password` }\n+      );\n+\n+      if (error) {\n+        console.error('[Auth] Supabase password reset error:', {\n+          message: error.message,\n+          status: error.status,\n+          name: error.name,\n+          timestamp: new Date().toISOString()\n+        });\n+        \n+        logger.error('Password reset failed', {\n+          context: { \n+            error,\n+            credentials: { email: credentials.email }\n+          },\n+          source: 'useAuth'\n+        });\n+        throw new Error(error.message);\n+      }\n+\n+      return data;\n+    } catch (error) {\n+      const errorDetails = error instanceof Error ? {\n+        message: error.message,\n+        name: error.name,\n+        stack: error.stack\n+      } : error;\n+\n+      console.error('[Auth] Password reset error details:', {\n+        error: errorDetails,\n+        timestamp: new Date().toISOString()\n+      });\n+\n+      logger.error('Password reset failed', {\n+        context: { \n+          error: errorDetails,\n+          credentials: { email: credentials.email }\n+        },\n+        source: 'useAuth'\n+      });\n+\n+      if (error instanceof Error) {\n+        throw error;\n+      } else {\n+        throw new Error('An unexpected error occurred during password reset. Please try again.');\n+      }\n+    }\n+  };\n+\n+  const [isAuthenticated, setIsAuthenticated] = useState<boolean>(false);\n+  const [isLoading, setIsLoading] = useState<boolean>(true);\n+  const authLoader = useRef<AuthLoader>(AuthLoader.getInstance());\n+  const stateChangeTimeout = useRef<NodeJS.Timeout | null>(null);\n+  const lastAuthState = useRef<string | null>(null);\n+\n+  const handleAuthChange = useCallback(async (event: 'SIGNED_IN' | 'SIGNED_OUT', session: any) => {\n+    const currentState = event;\n+    \n+    // Prevent unnecessary state updates\n+    if (lastAuthState.current === currentState) {\n+      return;\n+    }\n+\n+    // Clear any pending state changes\n+    if (stateChangeTimeout.current) {\n+      clearTimeout(stateChangeTimeout.current);\n+    }\n+\n+    // Delay state change to prevent rapid toggles\n+    stateChangeTimeout.current = setTimeout(() => {\n+      const isChildWindow = authLoader.current.isChildWindowSession();\n+      \n+      // Don't allow child windows to become unauthenticated\n+      if (isChildWindow && currentState === 'SIGNED_OUT') {\n+        logger.debug('Child window maintaining authenticated state', {\n+          source: 'useAuth',\n+          context: { currentState, isChildWindow }\n+        });\n+        return;\n+      }\n+\n+      // For child windows, check parent window's auth state\n+      if (isChildWindow && window.opener) {\n+        try {\n+          const parentAuthState = window.opener.localStorage.getItem('auth_state');\n+          if (parentAuthState) {\n+            const parsedState = JSON.parse(parentAuthState);\n+            if (parsedState.lastAuthState === 'SIGNED_IN') {\n+              logger.debug('Child window syncing with parent auth state', {\n+                source: 'useAuth',\n+                context: { parentState: parsedState.lastAuthState }\n+              });\n+              setIsAuthenticated(true);\n+              return;\n+            }\n+          }\n+        } catch (err) {\n+          logger.warn('Failed to check parent window auth state', {\n+            source: 'useAuth',\n+            context: { error: err }\n+          });\n+        }\n+      }\n+\n+      setIsAuthenticated(currentState === 'SIGNED_IN');\n+      lastAuthState.current = currentState;\n+      \n+      logger.info(`Auth state changed: ${currentState}`, {\n+        source: 'useAuth',\n+        context: { newState: currentState }\n+      });\n+    }, 500);\n+  }, []);\n+\n+  useEffect(() => {\n+    let mounted = true;\n+    \n+    const initialize = async () => {\n+      try {\n+        await authLoader.current.initialize();\n+        \n+        if (!mounted) return;\n+        \n+        const currentState = authLoader.current.getLastAuthState();\n+        if (currentState) {\n+          handleAuthChange(currentState as 'SIGNED_IN' | 'SIGNED_OUT', null);\n+        }\n+        \n+        setIsLoading(false);\n+      } catch (err) {\n+        logger.error('Auth initialization failed', {\n+          source: 'useAuth',\n+          context: { error: err }\n+        });\n+        if (mounted) {\n+          setIsLoading(false);\n+        }\n+      }\n+    };\n+\n+    const { data: { subscription } } = supabase.auth.onAuthStateChange((event: any, session: any) => {\n+      if (mounted) {\n+        handleAuthChange(event, session);\n+      }\n+    });\n+\n+    initialize();\n+\n+    return () => {\n+      mounted = false;\n+      subscription?.unsubscribe();\n+      if (stateChangeTimeout.current) {\n+        clearTimeout(stateChangeTimeout.current);\n+      }\n+    };\n+  }, [handleAuthChange]);\n+\n+  return {\n+    user: user ? {\n+      ...user,\n+      role: user.role || 'unknown'\n+    } : null,\n+    loading,\n+    changeRole,\n+    isTransitioning,\n+    login,\n+    logout,\n+    signUp,\n+    resetPassword,\n+    isAuthenticated,\n+    isLoading,\n+    sessionManager\n+  };\n+};\n+\n export default useAuth;\n\\ No newline at end of file\n"
                },
                {
                    "date": 1739388126394,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -13,8 +13,9 @@\n import { supabaseClient } from '../lib/supabaseClient';\n import { supabase } from '../lib/supabase';\n import { AuthLoader } from '../lib/auth/AuthLoader';\n import type { AuthError } from '@supabase/supabase-js';\n+import { sessionMonitor } from '@/lib/auth/SessionMonitor';\n \n interface LoginCredentials {\n   email: string;\n   password: string;\n@@ -378,116 +379,15 @@\n       }\n     }\n   };\n \n-  const [isAuthenticated, setIsAuthenticated] = useState<boolean>(false);\n-  const [isLoading, setIsLoading] = useState<boolean>(true);\n-  const authLoader = useRef<AuthLoader>(AuthLoader.getInstance());\n-  const stateChangeTimeout = useRef<NodeJS.Timeout | null>(null);\n-  const lastAuthState = useRef<string | null>(null);\n+  const [authState, setAuthState] = useState(sessionMonitor.getState());\n \n-  const handleAuthChange = useCallback(async (event: 'SIGNED_IN' | 'SIGNED_OUT', session: any) => {\n-    const currentState = event;\n-    \n-    // Prevent unnecessary state updates\n-    if (lastAuthState.current === currentState) {\n-      return;\n-    }\n-\n-    // Clear any pending state changes\n-    if (stateChangeTimeout.current) {\n-      clearTimeout(stateChangeTimeout.current);\n-    }\n-\n-    // Delay state change to prevent rapid toggles\n-    stateChangeTimeout.current = setTimeout(() => {\n-      const isChildWindow = authLoader.current.isChildWindowSession();\n-      \n-      // Don't allow child windows to become unauthenticated\n-      if (isChildWindow && currentState === 'SIGNED_OUT') {\n-        logger.debug('Child window maintaining authenticated state', {\n-          source: 'useAuth',\n-          context: { currentState, isChildWindow }\n-        });\n-        return;\n-      }\n-\n-      // For child windows, check parent window's auth state\n-      if (isChildWindow && window.opener) {\n-        try {\n-          const parentAuthState = window.opener.localStorage.getItem('auth_state');\n-          if (parentAuthState) {\n-            const parsedState = JSON.parse(parentAuthState);\n-            if (parsedState.lastAuthState === 'SIGNED_IN') {\n-              logger.debug('Child window syncing with parent auth state', {\n-                source: 'useAuth',\n-                context: { parentState: parsedState.lastAuthState }\n-              });\n-              setIsAuthenticated(true);\n-              return;\n-            }\n-          }\n-        } catch (err) {\n-          logger.warn('Failed to check parent window auth state', {\n-            source: 'useAuth',\n-            context: { error: err }\n-          });\n-        }\n-      }\n-\n-      setIsAuthenticated(currentState === 'SIGNED_IN');\n-      lastAuthState.current = currentState;\n-      \n-      logger.info(`Auth state changed: ${currentState}`, {\n-        source: 'useAuth',\n-        context: { newState: currentState }\n-      });\n-    }, 500);\n+  useEffect(() => {\n+    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\n+    return () => unsubscribe();\n   }, []);\n \n-  useEffect(() => {\n-    let mounted = true;\n-    \n-    const initialize = async () => {\n-      try {\n-        await authLoader.current.initialize();\n-        \n-        if (!mounted) return;\n-        \n-        const currentState = authLoader.current.getLastAuthState();\n-        if (currentState) {\n-          handleAuthChange(currentState as 'SIGNED_IN' | 'SIGNED_OUT', null);\n-        }\n-        \n-        setIsLoading(false);\n-      } catch (err) {\n-        logger.error('Auth initialization failed', {\n-          source: 'useAuth',\n-          context: { error: err }\n-        });\n-        if (mounted) {\n-          setIsLoading(false);\n-        }\n-      }\n-    };\n-\n-    const { data: { subscription } } = supabase.auth.onAuthStateChange((event: any, session: any) => {\n-      if (mounted) {\n-        handleAuthChange(event, session);\n-      }\n-    });\n-\n-    initialize();\n-\n-    return () => {\n-      mounted = false;\n-      subscription?.unsubscribe();\n-      if (stateChangeTimeout.current) {\n-        clearTimeout(stateChangeTimeout.current);\n-      }\n-    };\n-  }, [handleAuthChange]);\n-\n   return {\n     user: user ? {\n       ...user,\n       role: user.role || 'unknown'\n@@ -498,10 +398,8 @@\n     login,\n     logout,\n     signUp,\n     resetPassword,\n-    isAuthenticated,\n-    isLoading,\n     sessionManager\n   };\n };\n \n"
                },
                {
                    "date": 1739388247916,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -14,8 +14,9 @@\n import { supabase } from '../lib/supabase';\n import { AuthLoader } from '../lib/auth/AuthLoader';\n import type { AuthError } from '@supabase/supabase-js';\n import { sessionMonitor } from '@/lib/auth/SessionMonitor';\n+import type { SessionState } from '@/lib/auth/sessionManager';\n \n interface LoginCredentials {\n   email: string;\n   password: string;\n"
                },
                {
                    "date": 1739388372769,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -29,379 +29,381 @@\n interface ResetPasswordCredentials {\n   email: string;\n }\n \n-export const useAuth = () => {\n-  const context = useContext(AuthContext);\n-  \n-  if (!context) {\n-    console.warn('useAuth must be used within an AuthProvider');\n-    return { user: null, loading: false };\n-  }\n+export namespace Auth {\n+  export const useAuth = () => {\n+    const context = useContext(AuthContext);\n+    \n+    if (!context) {\n+      console.warn('useAuth must be used within an AuthProvider');\n+      return { user: null, loading: false };\n+    }\n \n-  const { user, loading } = context;\n+    const { user, loading } = context;\n \n-  // Add debug logging\n-  console.log('Auth Context:', {\n-    hasUser: !!user,\n-    userRole: user?.role,\n-    userId: user?.id,\n-    isLoading: loading,\n-    fullUser: user // Log the full user object for debugging\n-  });\n+    // Add debug logging\n+    console.log('Auth Context:', {\n+      hasUser: !!user,\n+      userRole: user?.role,\n+      userId: user?.id,\n+      isLoading: loading,\n+      fullUser: user // Log the full user object for debugging\n+    });\n \n-  const { isTransitioning } = useRoleStore();\n-  const navigate = useNavigate();\n-  const queryClient = new QueryClient();\n-  const location = useLocation();\n-  \n-  // Add loading state check\n-  useEffect(() => {\n-    if (loading) {\n-      logger.info('Auth loading state active', {\n-        source: 'useAuth',\n-        context: { loading }\n-      });\n-    }\n-  }, [loading]);\n+    const { isTransitioning } = useRoleStore();\n+    const navigate = useNavigate();\n+    const queryClient = new QueryClient();\n+    const location = useLocation();\n+    \n+    // Add loading state check\n+    useEffect(() => {\n+      if (loading) {\n+        logger.info('Auth loading state active', {\n+          source: 'useAuth',\n+          context: { loading }\n+        });\n+      }\n+    }, [loading]);\n \n-  // Auto-refresh session when it's about to expire\n-  useEffect(() => {\n-    if (!user) return;\n-    const refreshInterval = setInterval(async () => {\n+    // Auto-refresh session when it's about to expire\n+    useEffect(() => {\n+      if (!user) return;\n+      const refreshInterval = setInterval(async () => {\n+        try {\n+          await sessionManager.refreshSession();\n+        } catch (err) {\n+          logger.error('Failed to refresh session', {\n+            source: 'useAuth',\n+            context: { error: err }\n+          });\n+        }\n+      }, 4 * 60 * 1000); // Check every 4 minutes\n+      \n+      return () => {\n+        if (refreshInterval) {\n+          clearInterval(refreshInterval);\n+        }\n+      };\n+    }, [user]);\n+\n+    useEffect(() => {\n+      if (user) {\n+        logger.debug('Auth state check on route change', {\n+          source: 'useAuth',\n+          context: {\n+            role: user.role,\n+            path: location.pathname,\n+            permissions: ROLE_PERMISSIONS[user.role]?.permissions\n+          }\n+        });\n+      }\n+    }, [user, location.pathname]);\n+\n+    const changeRole = async (newRole: UserRole): Promise<void> => {\n+      if (!context.user || isTransitioning) return;\n+\n       try {\n-        await sessionManager.refreshSession();\n+        await roleTransitionManager.transitionRole(newRole);\n+        \n+        // Clear cache and refetch with new role\n+        queryClient.clear();\n+        await queryClient.resetQueries();\n+        \n+        // Update context user\n+        context.setUser({\n+          ...context.user,\n+          role: newRole\n+        });\n+\n+        // Navigate to home with fresh data\n+        navigate('/', { replace: true });\n       } catch (err) {\n-        logger.error('Failed to refresh session', {\n+        logger.error('Failed to change role', {\n           source: 'useAuth',\n           context: { error: err }\n         });\n+        throw err;\n       }\n-    }, 4 * 60 * 1000); // Check every 4 minutes\n-    \n-    return () => {\n-      if (refreshInterval) {\n-        clearInterval(refreshInterval);\n-      }\n     };\n-  }, [user]);\n \n-  useEffect(() => {\n-    if (user) {\n-      logger.debug('Auth state check on route change', {\n-        source: 'useAuth',\n-        context: {\n-          role: user.role,\n-          path: location.pathname,\n-          permissions: ROLE_PERMISSIONS[user.role]?.permissions\n+    const login = async (credentials: LoginCredentials) => {\n+      try {\n+        console.log('[Auth] Attempting login:', {\n+          email: credentials.email,\n+          timestamp: new Date().toISOString()\n+        });\n+        \n+        const { data, error } = await supabaseClient.auth.signInWithPassword({\n+          email: credentials.email,\n+          password: credentials.password,\n+        });\n+\n+        if (error) {\n+          console.error('[Auth] Supabase login error:', {\n+            message: error.message,\n+            status: error.status,\n+            name: error.name,\n+            timestamp: new Date().toISOString()\n+          });\n+          \n+          // Provide more specific error messages\n+          if (error.message.includes('Invalid login credentials')) {\n+            throw new Error('Invalid email or password. Please check your credentials and try again.');\n+          }\n+          \n+          logger.error('Login failed', {\n+            context: { \n+              error,\n+              credentials: { email: credentials.email }\n+            },\n+            source: 'useAuth'\n+          });\n+          throw new Error(error.message);\n         }\n-      });\n-    }\n-  }, [user, location.pathname]);\n \n-  const changeRole = async (newRole: UserRole): Promise<void> => {\n-    if (!context.user || isTransitioning) return;\n+        console.log('[Auth] Login response:', {\n+          hasUser: !!data.user,\n+          userId: data.user?.id,\n+          userEmail: data.user?.email,\n+          metadata: data.user?.user_metadata,\n+          timestamp: new Date().toISOString()\n+        });\n \n-    try {\n-      await roleTransitionManager.transitionRole(newRole);\n-      \n-      // Clear cache and refetch with new role\n-      queryClient.clear();\n-      await queryClient.resetQueries();\n-      \n-      // Update context user\n-      context.setUser({\n-        ...context.user,\n-        role: newRole\n-      });\n+        if (!data.user) {\n+          throw new Error('Login successful but user data is missing');\n+        }\n \n-      // Navigate to home with fresh data\n-      navigate('/', { replace: true });\n-    } catch (err) {\n-      logger.error('Failed to change role', {\n-        source: 'useAuth',\n-        context: { error: err }\n-      });\n-      throw err;\n-    }\n-  };\n+        // Map Supabase user to our user format\n+        const mappedUser = {\n+          id: data.user.id,\n+          email: data.user.email!,\n+          name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\n+          role: data.user.user_metadata?.role || 'student',\n+          photoUrl: data.user.user_metadata?.avatar_url,\n+        };\n \n-  const login = async (credentials: LoginCredentials) => {\n-    try {\n-      console.log('[Auth] Attempting login:', {\n-        email: credentials.email,\n-        timestamp: new Date().toISOString()\n-      });\n-      \n-      const { data, error } = await supabaseClient.auth.signInWithPassword({\n-        email: credentials.email,\n-        password: credentials.password,\n-      });\n+        console.log('[Auth] Mapped user:', mappedUser);\n \n-      if (error) {\n-        console.error('[Auth] Supabase login error:', {\n+        context.setUser(mappedUser);\n+        return { user: mappedUser };\n+      } catch (error) {\n+        const errorDetails = error instanceof Error ? {\n           message: error.message,\n-          status: error.status,\n           name: error.name,\n+          stack: error.stack\n+        } : error;\n+\n+        console.error('[Auth] Login error details:', {\n+          error: errorDetails,\n           timestamp: new Date().toISOString()\n         });\n-        \n-        // Provide more specific error messages\n-        if (error.message.includes('Invalid login credentials')) {\n-          throw new Error('Invalid email or password. Please check your credentials and try again.');\n-        }\n-        \n+\n         logger.error('Login failed', {\n           context: { \n-            error,\n+            error: errorDetails,\n             credentials: { email: credentials.email }\n           },\n           source: 'useAuth'\n         });\n-        throw new Error(error.message);\n+\n+        if (error instanceof Error) {\n+          throw error;\n+        } else {\n+          throw new Error('An unexpected error occurred. Please try again.');\n+        }\n       }\n+    };\n \n-      console.log('[Auth] Login response:', {\n-        hasUser: !!data.user,\n-        userId: data.user?.id,\n-        userEmail: data.user?.email,\n-        metadata: data.user?.user_metadata,\n-        timestamp: new Date().toISOString()\n-      });\n+    const logout = async () => {\n+      try {\n+        const { error } = await supabaseClient.auth.signOut();\n+        \n+        if (error) {\n+          throw error;\n+        }\n \n-      if (!data.user) {\n-        throw new Error('Login successful but user data is missing');\n+        context.setUser(null);\n+        queryClient.clear();\n+        navigate('/login');\n+      } catch (error) {\n+        logger.error('Logout failed', {\n+          context: { error },\n+          source: 'useAuth'\n+        });\n+        throw error;\n       }\n+    };\n \n-      // Map Supabase user to our user format\n-      const mappedUser = {\n-        id: data.user.id,\n-        email: data.user.email!,\n-        name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\n-        role: data.user.user_metadata?.role || 'student',\n-        photoUrl: data.user.user_metadata?.avatar_url,\n-      };\n+    const signUp = async (credentials: SignUpCredentials) => {\n+      try {\n+        console.log('[Auth] Attempting signup:', {\n+          email: credentials.email,\n+          timestamp: new Date().toISOString()\n+        });\n+        \n+        const { data, error } = await supabaseClient.auth.signUp({\n+          email: credentials.email,\n+          password: credentials.password,\n+          options: {\n+            data: {\n+              name: credentials.name || credentials.email.split('@')[0],\n+              role: 'student'\n+            }\n+          }\n+        });\n \n-      console.log('[Auth] Mapped user:', mappedUser);\n+        if (error) {\n+          console.error('[Auth] Supabase signup error:', {\n+            message: error.message,\n+            status: error.status,\n+            name: error.name,\n+            timestamp: new Date().toISOString()\n+          });\n+          \n+          logger.error('Signup failed', {\n+            context: { \n+              error,\n+              credentials: { email: credentials.email }\n+            },\n+            source: 'useAuth'\n+          });\n+          throw new Error(error.message);\n+        }\n \n-      context.setUser(mappedUser);\n-      return { user: mappedUser };\n-    } catch (error) {\n-      const errorDetails = error instanceof Error ? {\n-        message: error.message,\n-        name: error.name,\n-        stack: error.stack\n-      } : error;\n+        console.log('[Auth] Signup response:', {\n+          hasUser: !!data.user,\n+          userId: data.user?.id,\n+          userEmail: data.user?.email,\n+          metadata: data.user?.user_metadata,\n+          timestamp: new Date().toISOString()\n+        });\n \n-      console.error('[Auth] Login error details:', {\n\\ No newline at end of file\n-        error: errorDetails,\n-        timestamp: new Date().toISOString()\n-      });\n+        if (!data.user) {\n+          throw new Error('Signup successful but user data is missing');\n+        }\n \n-      logger.error('Login failed', {\n-        context: { \n-          error: errorDetails,\n-          credentials: { email: credentials.email }\n-        },\n-        source: 'useAuth'\n-      });\n+        // Map Supabase user to our user format\n+        const mappedUser = {\n+          id: data.user.id,\n+          email: data.user.email!,\n+          name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\n+          role: data.user.user_metadata?.role || 'student',\n+          photoUrl: data.user.user_metadata?.avatar_url,\n+        };\n \n-      if (error instanceof Error) {\n-        throw error;\n-      } else {\n-        throw new Error('An unexpected error occurred. Please try again.');\n-      }\n-    }\n-  };\n+        console.log('[Auth] Mapped user:', mappedUser);\n \n-  const logout = async () => {\n-    try {\n-      const { error } = await supabaseClient.auth.signOut();\n-      \n-      if (error) {\n-        throw error;\n-      }\n-\n-      context.setUser(null);\n-      queryClient.clear();\n-      navigate('/login');\n-    } catch (error) {\n-      logger.error('Logout failed', {\n-        context: { error },\n-        source: 'useAuth'\n-      });\n-      throw error;\n-    }\n-  };\n-\n-  const signUp = async (credentials: SignUpCredentials) => {\n-    try {\n-      console.log('[Auth] Attempting signup:', {\n-        email: credentials.email,\n-        timestamp: new Date().toISOString()\n-      });\n-      \n-      const { data, error } = await supabaseClient.auth.signUp({\n-        email: credentials.email,\n-        password: credentials.password,\n-        options: {\n-          data: {\n-            name: credentials.name || credentials.email.split('@')[0],\n-            role: 'student'\n-          }\n-        }\n-      });\n-\n-      if (error) {\n-        console.error('[Auth] Supabase signup error:', {\n+        context.setUser(mappedUser);\n+        return { user: mappedUser };\n+      } catch (error) {\n+        const errorDetails = error instanceof Error ? {\n           message: error.message,\n-          status: error.status,\n           name: error.name,\n+          stack: error.stack\n+        } : error;\n+\n+        console.error('[Auth] Signup error details:', {\n+          error: errorDetails,\n           timestamp: new Date().toISOString()\n         });\n-        \n+\n         logger.error('Signup failed', {\n           context: { \n-            error,\n+            error: errorDetails,\n             credentials: { email: credentials.email }\n           },\n           source: 'useAuth'\n         });\n-        throw new Error(error.message);\n-      }\n \n-      console.log('[Auth] Signup response:', {\n-        hasUser: !!data.user,\n-        userId: data.user?.id,\n-        userEmail: data.user?.email,\n-        metadata: data.user?.user_metadata,\n-        timestamp: new Date().toISOString()\n-      });\n-\n-      if (!data.user) {\n-        throw new Error('Signup successful but user data is missing');\n+        if (error instanceof Error) {\n+          throw error;\n+        } else {\n+          throw new Error('An unexpected error occurred during signup. Please try again.');\n+        }\n       }\n+    };\n \n-      // Map Supabase user to our user format\n-      const mappedUser = {\n-        id: data.user.id,\n-        email: data.user.email!,\n-        name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\n-        role: data.user.user_metadata?.role || 'student',\n-        photoUrl: data.user.user_metadata?.avatar_url,\n-      };\n+    const resetPassword = async (credentials: ResetPasswordCredentials) => {\n+      try {\n+        console.log('[Auth] Attempting password reset:', {\n+          email: credentials.email,\n+          timestamp: new Date().toISOString()\n+        });\n+        \n+        const { data, error } = await supabaseClient.auth.resetPasswordForEmail(\n+          credentials.email,\n+          { redirectTo: `${window.location.origin}/reset-password` }\n+        );\n \n-      console.log('[Auth] Mapped user:', mappedUser);\n+        if (error) {\n+          console.error('[Auth] Supabase password reset error:', {\n+            message: error.message,\n+            status: error.status,\n+            name: error.name,\n+            timestamp: new Date().toISOString()\n+          });\n+          \n+          logger.error('Password reset failed', {\n+            context: { \n+              error,\n+              credentials: { email: credentials.email }\n+            },\n+            source: 'useAuth'\n+          });\n+          throw new Error(error.message);\n+        }\n \n-      context.setUser(mappedUser);\n-      return { user: mappedUser };\n-    } catch (error) {\n-      const errorDetails = error instanceof Error ? {\n-        message: error.message,\n-        name: error.name,\n-        stack: error.stack\n-      } : error;\n+        return data;\n+      } catch (error) {\n+        const errorDetails = error instanceof Error ? {\n+          message: error.message,\n+          name: error.name,\n+          stack: error.stack\n+        } : error;\n \n-      console.error('[Auth] Signup error details:', {\n-        error: errorDetails,\n-        timestamp: new Date().toISOString()\n-      });\n-\n-      logger.error('Signup failed', {\n-        context: { \n+        console.error('[Auth] Password reset error details:', {\n           error: errorDetails,\n-          credentials: { email: credentials.email }\n-        },\n-        source: 'useAuth'\n-      });\n-\n-      if (error instanceof Error) {\n-        throw error;\n-      } else {\n-        throw new Error('An unexpected error occurred during signup. Please try again.');\n-      }\n-    }\n-  };\n-\n-  const resetPassword = async (credentials: ResetPasswordCredentials) => {\n-    try {\n-      console.log('[Auth] Attempting password reset:', {\n-        email: credentials.email,\n-        timestamp: new Date().toISOString()\n-      });\n-      \n-      const { data, error } = await supabaseClient.auth.resetPasswordForEmail(\n-        credentials.email,\n-        { redirectTo: `${window.location.origin}/reset-password` }\n-      );\n-\n-      if (error) {\n-        console.error('[Auth] Supabase password reset error:', {\n-          message: error.message,\n-          status: error.status,\n-          name: error.name,\n           timestamp: new Date().toISOString()\n         });\n-        \n+\n         logger.error('Password reset failed', {\n           context: { \n-            error,\n+            error: errorDetails,\n             credentials: { email: credentials.email }\n           },\n           source: 'useAuth'\n         });\n-        throw new Error(error.message);\n-      }\n \n-      return data;\n-    } catch (error) {\n-      const errorDetails = error instanceof Error ? {\n-        message: error.message,\n-        name: error.name,\n-        stack: error.stack\n-      } : error;\n-\n-      console.error('[Auth] Password reset error details:', {\n-        error: errorDetails,\n-        timestamp: new Date().toISOString()\n-      });\n-\n-      logger.error('Password reset failed', {\n-        context: { \n-          error: errorDetails,\n-          credentials: { email: credentials.email }\n-        },\n-        source: 'useAuth'\n-      });\n-\n-      if (error instanceof Error) {\n-        throw error;\n-      } else {\n-        throw new Error('An unexpected error occurred during password reset. Please try again.');\n+        if (error instanceof Error) {\n+          throw error;\n+        } else {\n+          throw new Error('An unexpected error occurred during password reset. Please try again.');\n+        }\n       }\n-    }\n-  };\n+    };\n \n-  const [authState, setAuthState] = useState(sessionMonitor.getState());\n+    const [authState, setAuthState] = useState(sessionMonitor.getState());\n \n-  useEffect(() => {\n-    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\n-    return () => unsubscribe();\n-  }, []);\n+    useEffect(() => {\n+      const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\n+      return () => unsubscribe();\n+    }, []);\n \n-  return {\n-    user: user ? {\n-      ...user,\n-      role: user.role || 'unknown'\n-    } : null,\n-    loading,\n-    changeRole,\n-    isTransitioning,\n-    login,\n-    logout,\n-    signUp,\n-    resetPassword,\n-    sessionManager\n-  };\n-};\n+    return {\n+      user: user ? {\n+        ...user,\n+        role: user.role || 'unknown'\n+      } : null,\n+      loading,\n+      changeRole,\n+      isTransitioning,\n+      login,\n+      logout,\n+      signUp,\n+      resetPassword,\n+      sessionManager\n+    };\n+  }\n+}\n \n-export default useAuth;\n+export default Auth.useAuth;\n\\ No newline at end of file\n"
                },
                {
                    "date": 1739388412834,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -403,7 +403,11 @@\n       resetPassword,\n       sessionManager\n     };\n   }\n+\n+  public async checkAndRefreshSession() {\n+    // ... method implementation ...\n+  }\n }\n \n export default Auth.useAuth;\n\\ No newline at end of file\n"
                },
                {
                    "date": 1739388429570,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -403,11 +403,7 @@\n       resetPassword,\n       sessionManager\n     };\n   }\n-\n-  public async checkAndRefreshSession() {\n-    // ... method implementation ...\n-  }\n }\n \n export default Auth.useAuth;\n\\ No newline at end of file\n"
                },
                {
                    "date": 1739388448402,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -388,8 +388,12 @@\n       const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\n       return () => unsubscribe();\n     }, []);\n \n+    public async checkAndRefreshSession() {\n+      // ... existing implementation\n+    }\n+\n     return {\n       user: user ? {\n         ...user,\n         role: user.role || 'unknown'\n"
                },
                {
                    "date": 1739388459373,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -388,12 +388,8 @@\n       const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\n       return () => unsubscribe();\n     }, []);\n \n-    public async checkAndRefreshSession() {\n-      // ... existing implementation\n-    }\n-\n     return {\n       user: user ? {\n         ...user,\n         role: user.role || 'unknown'\n"
                },
                {
                    "date": 1739388481384,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -388,8 +388,12 @@\n       const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\n       return () => unsubscribe();\n     }, []);\n \n+    public async checkAndRefreshSession(): Promise<void> {\n+      // ... existing code\n+    }\n+\n     return {\n       user: user ? {\n         ...user,\n         role: user.role || 'unknown'\n"
                },
                {
                    "date": 1739388502104,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -389,10 +389,11 @@\n       return () => unsubscribe();\n     }, []);\n \n     public async checkAndRefreshSession(): Promise<void> {\n+      \n       // ... existing code\n-    }\n+    };\n \n     return {\n       user: user ? {\n         ...user,\n"
                },
                {
                    "date": 1739388511071,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -388,11 +388,17 @@\n       const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\n       return () => unsubscribe();\n     }, []);\n \n-    public async checkAndRefreshSession(): Promise<void> {\n-      \n-      // ... existing code\n+    const checkAndRefreshSession = async (): Promise<void> => {\n+      try {\n+        await sessionManager.checkAndRefreshSession();\n+      } catch (error) {\n+        logger.error('Failed to check and refresh session', {\n+          context: { error },\n+          source: 'useAuth'\n+        });\n+      }\n     };\n \n     return {\n       user: user ? {\n"
                },
                {
                    "date": 1739389295862,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -29,392 +29,388 @@\n interface ResetPasswordCredentials {\n   email: string;\n }\n \n-export namespace Auth {\n-  export const useAuth = () => {\n-    const context = useContext(AuthContext);\n-    \n-    if (!context) {\n-      console.warn('useAuth must be used within an AuthProvider');\n-      return { user: null, loading: false };\n-    }\n+export function useAuth() {\n+  const context = useContext(AuthContext);\n+  \n+  if (!context) {\n+    console.warn('useAuth must be used within an AuthProvider');\n+    return { user: null, loading: false };\n+  }\n \n-    const { user, loading } = context;\n+  const { user, loading } = context;\n \n-    // Add debug logging\n-    console.log('Auth Context:', {\n-      hasUser: !!user,\n-      userRole: user?.role,\n-      userId: user?.id,\n-      isLoading: loading,\n-      fullUser: user // Log the full user object for debugging\n-    });\n+  // Add debug logging\n+  console.log('Auth Context:', {\n+    hasUser: !!user,\n+    userRole: user?.role,\n+    userId: user?.id,\n+    isLoading: loading,\n+    fullUser: user // Log the full user object for debugging\n+  });\n \n-    const { isTransitioning } = useRoleStore();\n-    const navigate = useNavigate();\n-    const queryClient = new QueryClient();\n-    const location = useLocation();\n-    \n-    // Add loading state check\n-    useEffect(() => {\n-      if (loading) {\n-        logger.info('Auth loading state active', {\n-          source: 'useAuth',\n-          context: { loading }\n-        });\n-      }\n-    }, [loading]);\n+  const { isTransitioning } = useRoleStore();\n+  const navigate = useNavigate();\n+  const queryClient = new QueryClient();\n+  const location = useLocation();\n+  \n+  // Add loading state check\n+  useEffect(() => {\n+    if (loading) {\n+      logger.info('Auth loading state active', {\n+        source: 'useAuth',\n+        context: { loading }\n+      });\n+    }\n+  }, [loading]);\n \n-    // Auto-refresh session when it's about to expire\n-    useEffect(() => {\n-      if (!user) return;\n-      const refreshInterval = setInterval(async () => {\n-        try {\n-          await sessionManager.refreshSession();\n-        } catch (err) {\n-          logger.error('Failed to refresh session', {\n-            source: 'useAuth',\n-            context: { error: err }\n-          });\n-        }\n-      }, 4 * 60 * 1000); // Check every 4 minutes\n-      \n-      return () => {\n-        if (refreshInterval) {\n-          clearInterval(refreshInterval);\n-        }\n-      };\n-    }, [user]);\n-\n-    useEffect(() => {\n-      if (user) {\n-        logger.debug('Auth state check on route change', {\n-          source: 'useAuth',\n-          context: {\n-            role: user.role,\n-            path: location.pathname,\n-            permissions: ROLE_PERMISSIONS[user.role]?.permissions\n-          }\n-        });\n-      }\n-    }, [user, location.pathname]);\n-\n-    const changeRole = async (newRole: UserRole): Promise<void> => {\n-      if (!context.user || isTransitioning) return;\n-\n+  // Auto-refresh session when it's about to expire\n+  useEffect(() => {\n+    if (!user) return;\n+    const refreshInterval = setInterval(async () => {\n       try {\n-        await roleTransitionManager.transitionRole(newRole);\n-        \n-        // Clear cache and refetch with new role\n-        queryClient.clear();\n-        await queryClient.resetQueries();\n-        \n-        // Update context user\n-        context.setUser({\n-          ...context.user,\n-          role: newRole\n-        });\n-\n-        // Navigate to home with fresh data\n-        navigate('/', { replace: true });\n+        await sessionManager.refreshSession();\n       } catch (err) {\n-        logger.error('Failed to change role', {\n+        logger.error('Failed to refresh session', {\n           source: 'useAuth',\n           context: { error: err }\n         });\n-        throw err;\n       }\n+    }, 4 * 60 * 1000); // Check every 4 minutes\n+    \n+    return () => {\n+      if (refreshInterval) {\n+        clearInterval(refreshInterval);\n+      }\n     };\n+  }, [user]);\n \n-    const login = async (credentials: LoginCredentials) => {\n-      try {\n-        console.log('[Auth] Attempting login:', {\n-          email: credentials.email,\n-          timestamp: new Date().toISOString()\n-        });\n-        \n-        const { data, error } = await supabaseClient.auth.signInWithPassword({\n-          email: credentials.email,\n-          password: credentials.password,\n-        });\n-\n-        if (error) {\n-          console.error('[Auth] Supabase login error:', {\n-            message: error.message,\n-            status: error.status,\n-            name: error.name,\n-            timestamp: new Date().toISOString()\n-          });\n-          \n-          // Provide more specific error messages\n-          if (error.message.includes('Invalid login credentials')) {\n-            throw new Error('Invalid email or password. Please check your credentials and try again.');\n-          }\n-          \n-          logger.error('Login failed', {\n-            context: { \n-              error,\n-              credentials: { email: credentials.email }\n-            },\n-            source: 'useAuth'\n-          });\n-          throw new Error(error.message);\n+  useEffect(() => {\n+    if (user) {\n+      logger.debug('Auth state check on route change', {\n+        source: 'useAuth',\n+        context: {\n+          role: user.role,\n+          path: location.pathname,\n+          permissions: ROLE_PERMISSIONS[user.role]?.permissions\n         }\n+      });\n+    }\n+  }, [user, location.pathname]);\n \n-        console.log('[Auth] Login response:', {\n-          hasUser: !!data.user,\n-          userId: data.user?.id,\n-          userEmail: data.user?.email,\n-          metadata: data.user?.user_metadata,\n-          timestamp: new Date().toISOString()\n-        });\n+  const changeRole = async (newRole: UserRole): Promise<void> => {\n+    if (!context.user || isTransitioning) return;\n \n-        if (!data.user) {\n-          throw new Error('Login successful but user data is missing');\n-        }\n+    try {\n+      await roleTransitionManager.transitionRole(newRole);\n+      \n+      // Clear cache and refetch with new role\n+      queryClient.clear();\n+      await queryClient.resetQueries();\n+      \n+      // Update context user\n+      context.setUser({\n+        ...context.user,\n+        role: newRole\n+      });\n \n-        // Map Supabase user to our user format\n-        const mappedUser = {\n-          id: data.user.id,\n-          email: data.user.email!,\n-          name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\n-          role: data.user.user_metadata?.role || 'student',\n-          photoUrl: data.user.user_metadata?.avatar_url,\n-        };\n+      // Navigate to home with fresh data\n+      navigate('/', { replace: true });\n+    } catch (err) {\n+      logger.error('Failed to change role', {\n+        source: 'useAuth',\n+        context: { error: err }\n+      });\n+      throw err;\n+    }\n+  };\n \n-        console.log('[Auth] Mapped user:', mappedUser);\n+  const login = async (credentials: LoginCredentials) => {\n+    try {\n+      console.log('[Auth] Attempting login:', {\n+        email: credentials.email,\n+        timestamp: new Date().toISOString()\n+      });\n+      \n+      const { data, error } = await supabaseClient.auth.signInWithPassword({\n+        email: credentials.email,\n+        password: credentials.password,\n+      });\n \n-        context.setUser(mappedUser);\n-        return { user: mappedUser };\n-      } catch (error) {\n-        const errorDetails = error instanceof Error ? {\n+      if (error) {\n+        console.error('[Auth] Supabase login error:', {\n           message: error.message,\n+          status: error.status,\n           name: error.name,\n-          stack: error.stack\n-        } : error;\n-\n-        console.error('[Auth] Login error details:', {\n-          error: errorDetails,\n           timestamp: new Date().toISOString()\n         });\n-\n+        \n+        // Provide more specific error messages\n+        if (error.message.includes('Invalid login credentials')) {\n+          throw new Error('Invalid email or password. Please check your credentials and try again.');\n+        }\n+        \n         logger.error('Login failed', {\n           context: { \n-            error: errorDetails,\n+            error,\n             credentials: { email: credentials.email }\n           },\n           source: 'useAuth'\n         });\n+        throw new Error(error.message);\n+      }\n \n-        if (error instanceof Error) {\n-          throw error;\n-        } else {\n-          throw new Error('An unexpected error occurred. Please try again.');\n-        }\n+      console.log('[Auth] Login response:', {\n+        hasUser: !!data.user,\n+        userId: data.user?.id,\n+        userEmail: data.user?.email,\n+        metadata: data.user?.user_metadata,\n+        timestamp: new Date().toISOString()\n+      });\n+\n+      if (!data.user) {\n+        throw new Error('Login successful but user data is missing');\n       }\n-    };\n \n-    const logout = async () => {\n-      try {\n-        const { error } = await supabaseClient.auth.signOut();\n-        \n-        if (error) {\n-          throw error;\n-        }\n+      // Map Supabase user to our user format\n+      const mappedUser = {\n+        id: data.user.id,\n+        email: data.user.email!,\n+        name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\n+        role: data.user.user_metadata?.role || 'student',\n+        photoUrl: data.user.user_metadata?.avatar_url,\n+      };\n \n-        context.setUser(null);\n-        queryClient.clear();\n-        navigate('/login');\n-      } catch (error) {\n-        logger.error('Logout failed', {\n-          context: { error },\n-          source: 'useAuth'\n-        });\n+      console.log('[Auth] Mapped user:', mappedUser);\n+\n+      context.setUser(mappedUser);\n+      return { user: mappedUser };\n+    } catch (error) {\n+      const errorDetails = error instanceof Error ? {\n+        message: error.message,\n+        name: error.name,\n+        stack: error.stack\n+      } : error;\n+\n+      console.error('[Auth] Login error details:', {\n+        error: errorDetails,\n+        timestamp: new Date().toISOString()\n+      });\n+\n+      logger.error('Login failed', {\n+        context: { \n+          error: errorDetails,\n+          credentials: { email: credentials.email }\n+        },\n+        source: 'useAuth'\n+      });\n+\n+      if (error instanceof Error) {\n         throw error;\n+      } else {\n+        throw new Error('An unexpected error occurred. Please try again.');\n       }\n-    };\n+    }\n+  };\n \n-    const signUp = async (credentials: SignUpCredentials) => {\n-      try {\n-        console.log('[Auth] Attempting signup:', {\n-          email: credentials.email,\n-          timestamp: new Date().toISOString()\n-        });\n-        \n-        const { data, error } = await supabaseClient.auth.signUp({\n-          email: credentials.email,\n-          password: credentials.password,\n-          options: {\n-            data: {\n-              name: credentials.name || credentials.email.split('@')[0],\n-              role: 'student'\n-            }\n-          }\n-        });\n+  const logout = async () => {\n+    try {\n+      const { error } = await supabaseClient.auth.signOut();\n+      \n+      if (error) {\n+        throw error;\n+      }\n \n-        if (error) {\n-          console.error('[Auth] Supabase signup error:', {\n-            message: error.message,\n-            status: error.status,\n-            name: error.name,\n-            timestamp: new Date().toISOString()\n-          });\n-          \n-          logger.error('Signup failed', {\n-            context: { \n-              error,\n\\ No newline at end of file\n-              credentials: { email: credentials.email }\n-            },\n-            source: 'useAuth'\n-          });\n-          throw new Error(error.message);\n-        }\n+      context.setUser(null);\n+      queryClient.clear();\n+      navigate('/login');\n+    } catch (error) {\n+      logger.error('Logout failed', {\n+        context: { error },\n+        source: 'useAuth'\n+      });\n+      throw error;\n+    }\n+  };\n \n-        console.log('[Auth] Signup response:', {\n-          hasUser: !!data.user,\n-          userId: data.user?.id,\n-          userEmail: data.user?.email,\n-          metadata: data.user?.user_metadata,\n-          timestamp: new Date().toISOString()\n-        });\n-\n-        if (!data.user) {\n-          throw new Error('Signup successful but user data is missing');\n+  const signUp = async (credentials: SignUpCredentials) => {\n+    try {\n+      console.log('[Auth] Attempting signup:', {\n+        email: credentials.email,\n+        timestamp: new Date().toISOString()\n+      });\n+      \n+      const { data, error } = await supabaseClient.auth.signUp({\n+        email: credentials.email,\n+        password: credentials.password,\n+        options: {\n+          data: {\n+            name: credentials.name || credentials.email.split('@')[0],\n+            role: 'student'\n+          }\n         }\n+      });\n \n-        // Map Supabase user to our user format\n-        const mappedUser = {\n-          id: data.user.id,\n-          email: data.user.email!,\n-          name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\n-          role: data.user.user_metadata?.role || 'student',\n-          photoUrl: data.user.user_metadata?.avatar_url,\n-        };\n-\n-        console.log('[Auth] Mapped user:', mappedUser);\n-\n-        context.setUser(mappedUser);\n-        return { user: mappedUser };\n-      } catch (error) {\n-        const errorDetails = error instanceof Error ? {\n+      if (error) {\n+        console.error('[Auth] Supabase signup error:', {\n           message: error.message,\n+          status: error.status,\n           name: error.name,\n-          stack: error.stack\n-        } : error;\n-\n-        console.error('[Auth] Signup error details:', {\n-          error: errorDetails,\n           timestamp: new Date().toISOString()\n         });\n-\n+        \n         logger.error('Signup failed', {\n           context: { \n-            error: errorDetails,\n+            error,\n             credentials: { email: credentials.email }\n           },\n           source: 'useAuth'\n         });\n+        throw new Error(error.message);\n+      }\n \n-        if (error instanceof Error) {\n-          throw error;\n-        } else {\n-          throw new Error('An unexpected error occurred during signup. Please try again.');\n-        }\n+      console.log('[Auth] Signup response:', {\n+        hasUser: !!data.user,\n+        userId: data.user?.id,\n+        userEmail: data.user?.email,\n+        metadata: data.user?.user_metadata,\n+        timestamp: new Date().toISOString()\n+      });\n+\n+      if (!data.user) {\n+        throw new Error('Signup successful but user data is missing');\n       }\n-    };\n \n-    const resetPassword = async (credentials: ResetPasswordCredentials) => {\n-      try {\n-        console.log('[Auth] Attempting password reset:', {\n-          email: credentials.email,\n-          timestamp: new Date().toISOString()\n-        });\n-        \n-        const { data, error } = await supabaseClient.auth.resetPasswordForEmail(\n-          credentials.email,\n-          { redirectTo: `${window.location.origin}/reset-password` }\n-        );\n+      // Map Supabase user to our user format\n+      const mappedUser = {\n+        id: data.user.id,\n+        email: data.user.email!,\n+        name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\n+        role: data.user.user_metadata?.role || 'student',\n+        photoUrl: data.user.user_metadata?.avatar_url,\n+      };\n \n-        if (error) {\n-          console.error('[Auth] Supabase password reset error:', {\n-            message: error.message,\n-            status: error.status,\n-            name: error.name,\n-            timestamp: new Date().toISOString()\n-          });\n-          \n-          logger.error('Password reset failed', {\n-            context: { \n-              error,\n-              credentials: { email: credentials.email }\n-            },\n-            source: 'useAuth'\n-          });\n-          throw new Error(error.message);\n-        }\n+      console.log('[Auth] Mapped user:', mappedUser);\n \n-        return data;\n-      } catch (error) {\n-        const errorDetails = error instanceof Error ? {\n+      context.setUser(mappedUser);\n+      return { user: mappedUser };\n+    } catch (error) {\n+      const errorDetails = error instanceof Error ? {\n+        message: error.message,\n+        name: error.name,\n+        stack: error.stack\n+      } : error;\n+\n+      console.error('[Auth] Signup error details:', {\n+        error: errorDetails,\n+        timestamp: new Date().toISOString()\n+      });\n+\n+      logger.error('Signup failed', {\n+        context: { \n+          error: errorDetails,\n+          credentials: { email: credentials.email }\n+        },\n+        source: 'useAuth'\n+      });\n+\n+      if (error instanceof Error) {\n+        throw error;\n+      } else {\n+        throw new Error('An unexpected error occurred during signup. Please try again.');\n+      }\n+    }\n+  };\n+\n+  const resetPassword = async (credentials: ResetPasswordCredentials) => {\n+    try {\n+      console.log('[Auth] Attempting password reset:', {\n+        email: credentials.email,\n+        timestamp: new Date().toISOString()\n+      });\n+      \n+      const { data, error } = await supabaseClient.auth.resetPasswordForEmail(\n+        credentials.email,\n+        { redirectTo: `${window.location.origin}/reset-password` }\n+      );\n+\n+      if (error) {\n+        console.error('[Auth] Supabase password reset error:', {\n           message: error.message,\n+          status: error.status,\n           name: error.name,\n-          stack: error.stack\n-        } : error;\n-\n-        console.error('[Auth] Password reset error details:', {\n-          error: errorDetails,\n           timestamp: new Date().toISOString()\n         });\n-\n+        \n         logger.error('Password reset failed', {\n           context: { \n-            error: errorDetails,\n+            error,\n             credentials: { email: credentials.email }\n           },\n           source: 'useAuth'\n         });\n-\n-        if (error instanceof Error) {\n-          throw error;\n-        } else {\n-          throw new Error('An unexpected error occurred during password reset. Please try again.');\n-        }\n+        throw new Error(error.message);\n       }\n-    };\n \n-    const [authState, setAuthState] = useState(sessionMonitor.getState());\n+      return data;\n+    } catch (error) {\n+      const errorDetails = error instanceof Error ? {\n+        message: error.message,\n+        name: error.name,\n+        stack: error.stack\n+      } : error;\n \n-    useEffect(() => {\n-      const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\n-      return () => unsubscribe();\n-    }, []);\n+      console.error('[Auth] Password reset error details:', {\n+        error: errorDetails,\n+        timestamp: new Date().toISOString()\n+      });\n \n-    const checkAndRefreshSession = async (): Promise<void> => {\n-      try {\n-        await sessionManager.checkAndRefreshSession();\n-      } catch (error) {\n-        logger.error('Failed to check and refresh session', {\n-          context: { error },\n-          source: 'useAuth'\n-        });\n+      logger.error('Password reset failed', {\n+        context: { \n+          error: errorDetails,\n+          credentials: { email: credentials.email }\n+        },\n+        source: 'useAuth'\n+      });\n+\n+      if (error instanceof Error) {\n+        throw error;\n+      } else {\n+        throw new Error('An unexpected error occurred during password reset. Please try again.');\n       }\n-    };\n+    }\n+  };\n \n-    return {\n-      user: user ? {\n-        ...user,\n-        role: user.role || 'unknown'\n-      } : null,\n-      loading,\n-      changeRole,\n-      isTransitioning,\n-      login,\n-      logout,\n-      signUp,\n-      resetPassword,\n-      sessionManager\n-    };\n-  }\n-}\n+  const [authState, setAuthState] = useState(sessionMonitor.getState());\n \n-export default Auth.useAuth;\n+  useEffect(() => {\n+    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\n+    return () => unsubscribe();\n+  }, []);\n+\n+  const checkAndRefreshSession = async (): Promise<void> => {\n+    try {\n+      await sessionManager.checkAndRefreshSession();\n+    } catch (error) {\n+      logger.error('Failed to check and refresh session', {\n+        context: { error },\n+        source: 'useAuth'\n+      });\n+    }\n+  };\n+\n+  return {\n+    user: user ? {\n+      ...user,\n+      role: user.role || 'unknown'\n+    } : null,\n+    loading,\n+    changeRole,\n+    isTransitioning,\n+    login,\n+    logout,\n+    signUp,\n+    resetPassword,\n+    sessionManager\n+  };\n+}\n\\ No newline at end of file\n"
                },
                {
                    "date": 1739391578757,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -39,16 +39,19 @@\n   }\n \n   const { user, loading } = context;\n \n-  // Add debug logging\n-  console.log('Auth Context:', {\n-    hasUser: !!user,\n-    userRole: user?.role,\n-    userId: user?.id,\n-    isLoading: loading,\n-    fullUser: user // Log the full user object for debugging\n-  });\n+  // Only log in development and reduce frequency\n+  if (process.env.NODE_ENV === 'development') {\n+    useEffect(() => {\n+      logger.debug('Auth Context:', {\n+        hasUser: !!user,\n+        userRole: user?.role,\n+        userId: user?.id,\n+        isLoading: loading\n+      });\n+    }, [user?.id, user?.role, loading]); // Only log on important changes\n+  }\n \n   const { isTransitioning } = useRoleStore();\n   const navigate = useNavigate();\n   const queryClient = new QueryClient();\n"
                },
                {
                    "date": 1739391614649,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -42,13 +42,15 @@\n \n   // Only log in development and reduce frequency\n   if (process.env.NODE_ENV === 'development') {\n     useEffect(() => {\n-      logger.debug('Auth Context:', {\n-        hasUser: !!user,\n-        userRole: user?.role,\n-        userId: user?.id,\n-        isLoading: loading\n+      logger.debug('Auth Context', {\n+        context: {\n+          hasUser: !!user,\n+          userRole: user?.role,\n+          userId: user?.id,\n+          isLoading: loading\n+        }\n       });\n     }, [user?.id, user?.role, loading]); // Only log on important changes\n   }\n \n"
                },
                {
                    "date": 1739391696037,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -43,8 +43,9 @@\n   // Only log in development and reduce frequency\n   if (process.env.NODE_ENV === 'development') {\n     useEffect(() => {\n       logger.debug('Auth Context', {\n+        source: 'useAuth',\n         context: {\n           hasUser: !!user,\n           userRole: user?.role,\n           userId: user?.id,\n"
                },
                {
                    "date": 1739391758740,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -15,8 +15,9 @@\n import { AuthLoader } from '../lib/auth/AuthLoader';\n import type { AuthError } from '@supabase/supabase-js';\n import { sessionMonitor } from '@/lib/auth/SessionMonitor';\n import type { SessionState } from '@/lib/auth/sessionManager';\n+import { debounce } from 'lodash';\n \n interface LoginCredentials {\n   email: string;\n   password: string;\n@@ -39,11 +40,11 @@\n   }\n \n   const { user, loading } = context;\n \n-  // Only log in development and reduce frequency\n+  // Only log in development and reduce frequency with debounce\n   if (process.env.NODE_ENV === 'development') {\n-    useEffect(() => {\n+    const debouncedLog = debounce(() => {\n       logger.debug('Auth Context', {\n         source: 'useAuth',\n         context: {\n           hasUser: !!user,\n@@ -51,9 +52,14 @@\n           userId: user?.id,\n           isLoading: loading\n         }\n       });\n-    }, [user?.id, user?.role, loading]); // Only log on important changes\n+    }, 1000); // Log at most once per second\n+\n+    useEffect(() => {\n+      debouncedLog();\n+      return () => debouncedLog.cancel();\n+    }, [user?.id, user?.role, loading]);\n   }\n \n   const { isTransitioning } = useRoleStore();\n   const navigate = useNavigate();\n"
                },
                {
                    "date": 1739391885353,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,7 +1,7 @@\n \"use client\";\n \n-import { useContext, useEffect, useState, useCallback, useRef } from 'react';\n+import { useContext, useEffect, useState, useCallback, useRef, useMemo } from 'react';\n import { AuthContext } from '../contexts/AuthContext';\n import { useNavigate, useLocation } from 'react-router-dom';\n import { QueryClient } from '@tanstack/query-core';\n import { roleTransitionManager } from '../lib/auth/RoleTransitionManager';\n@@ -42,24 +42,32 @@\n   const { user, loading } = context;\n \n   // Only log in development and reduce frequency with debounce\n   if (process.env.NODE_ENV === 'development') {\n-    const debouncedLog = debounce(() => {\n-      logger.debug('Auth Context', {\n-        source: 'useAuth',\n-        context: {\n-          hasUser: !!user,\n-          userRole: user?.role,\n-          userId: user?.id,\n-          isLoading: loading\n-        }\n-      });\n-    }, 1000); // Log at most once per second\n+    const debouncedLog = useMemo(() => {\n+      let timeoutId: number;\n+      \n+      const debounced = () => {\n+        clearTimeout(timeoutId);\n+        timeoutId = setTimeout(() => {\n+          logger.debug('Auth Context', {\n+            source: 'useAuth',\n+            context: {\n+              hasUser: !!user,\n+              userRole: user?.role,\n+              userId: user?.id,\n+              isLoading: loading\n+            }\n+          });\n+        }, 1000);\n+      };\n \n+      return debounced;\n+    }, []); // Empty deps since we want this to be stable\n+\n     useEffect(() => {\n       debouncedLog();\n-      return () => debouncedLog.cancel();\n-    }, [user?.id, user?.role, loading]);\n+    }, [user?.id, user?.role, loading, debouncedLog]);\n   }\n \n   const { isTransitioning } = useRoleStore();\n   const navigate = useNavigate();\n"
                },
                {
                    "date": 1739391925865,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -43,9 +43,9 @@\n \n   // Only log in development and reduce frequency with debounce\n   if (process.env.NODE_ENV === 'development') {\n     const debouncedLog = useMemo(() => {\n-      let timeoutId: number;\n+      let timeoutId: ReturnType<typeof setTimeout>;\n       \n       const debounced = () => {\n         clearTimeout(timeoutId);\n         timeoutId = setTimeout(() => {\n@@ -61,9 +61,9 @@\n         }, 1000);\n       };\n \n       return debounced;\n-    }, []); // Empty deps since we want this to be stable\n+    }, []);\n \n     useEffect(() => {\n       debouncedLog();\n     }, [user?.id, user?.role, loading, debouncedLog]);\n"
                },
                {
                    "date": 1739392036052,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -16,8 +16,9 @@\n import type { AuthError } from '@supabase/supabase-js';\n import { sessionMonitor } from '@/lib/auth/SessionMonitor';\n import type { SessionState } from '@/lib/auth/sessionManager';\n import { debounce } from 'lodash';\n+import { useDebounce } from '@/hooks/useDebounce';\n \n interface LoginCredentials {\n   email: string;\n   password: string;\n@@ -42,32 +43,25 @@\n   const { user, loading } = context;\n \n   // Only log in development and reduce frequency with debounce\n   if (process.env.NODE_ENV === 'development') {\n-    const debouncedLog = useMemo(() => {\n-      let timeoutId: ReturnType<typeof setTimeout>;\n-      \n-      const debounced = () => {\n-        clearTimeout(timeoutId);\n-        timeoutId = setTimeout(() => {\n-          logger.debug('Auth Context', {\n-            source: 'useAuth',\n-            context: {\n-              hasUser: !!user,\n-              userRole: user?.role,\n-              userId: user?.id,\n-              isLoading: loading\n-            }\n-          });\n-        }, 1000);\n-      };\n+    const debouncedLog = useCallback(() => {\n+      logger.debug('Auth Context', {\n+        source: 'useAuth',\n+        context: {\n+          hasUser: !!user,\n+          userRole: user?.role,\n+          userId: user?.id,\n+          isLoading: loading\n+        }\n+      });\n+    }, [user?.id, user?.role, loading]);\n \n-      return debounced;\n-    }, []);\n+    const debouncedValue = useDebounce(debouncedLog, 1000);\n \n     useEffect(() => {\n-      debouncedLog();\n-    }, [user?.id, user?.role, loading, debouncedLog]);\n+      debouncedValue();\n+    }, [debouncedValue]);\n   }\n \n   const { isTransitioning } = useRoleStore();\n   const navigate = useNavigate();\n"
                },
                {
                    "date": 1739392096379,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -43,9 +43,9 @@\n   const { user, loading } = context;\n \n   // Only log in development and reduce frequency with debounce\n   if (process.env.NODE_ENV === 'development') {\n-    const debouncedLog = useCallback(() => {\n+    const logAuthContext = useCallback(() => {\n       logger.debug('Auth Context', {\n         source: 'useAuth',\n         context: {\n           hasUser: !!user,\n@@ -55,13 +55,12 @@\n         }\n       });\n     }, [user?.id, user?.role, loading]);\n \n-    const debouncedValue = useDebounce(debouncedLog, 1000);\n-\n     useEffect(() => {\n-      debouncedValue();\n-    }, [debouncedValue]);\n+      const timer = setTimeout(logAuthContext, 1000);\n+      return () => clearTimeout(timer);\n+    }, [logAuthContext]);\n   }\n \n   const { isTransitioning } = useRoleStore();\n   const navigate = useNavigate();\n"
                },
                {
                    "date": 1739392271361,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -43,24 +43,29 @@\n   const { user, loading } = context;\n \n   // Only log in development and reduce frequency with debounce\n   if (process.env.NODE_ENV === 'development') {\n-    const logAuthContext = useCallback(() => {\n-      logger.debug('Auth Context', {\n-        source: 'useAuth',\n-        context: {\n-          hasUser: !!user,\n-          userRole: user?.role,\n-          userId: user?.id,\n-          isLoading: loading\n-        }\n-      });\n+    const prevValuesRef = useRef({ id: user?.id, role: user?.role, loading });\n+    \n+    useEffect(() => {\n+      const prevValues = prevValuesRef.current;\n+      if (\n+        prevValues.id !== user?.id || \n+        prevValues.role !== user?.role || \n+        prevValues.loading !== loading\n+      ) {\n+        logger.debug('Auth Context', {\n+          source: 'useAuth',\n+          context: {\n+            hasUser: !!user,\n+            userRole: user?.role,\n+            userId: user?.id,\n+            isLoading: loading\n+          }\n+        });\n+        prevValuesRef.current = { id: user?.id, role: user?.role, loading };\n+      }\n     }, [user?.id, user?.role, loading]);\n-\n-    useEffect(() => {\n-      const timer = setTimeout(logAuthContext, 1000);\n-      return () => clearTimeout(timer);\n-    }, [logAuthContext]);\n   }\n \n   const { isTransitioning } = useRoleStore();\n   const navigate = useNavigate();\n"
                },
                {
                    "date": 1739392323823,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -43,29 +43,39 @@\n   const { user, loading } = context;\n \n   // Only log in development and reduce frequency with debounce\n   if (process.env.NODE_ENV === 'development') {\n-    const prevValuesRef = useRef({ id: user?.id, role: user?.role, loading });\n+    const prevValuesRef = useRef({\n+      id: null as string | null,\n+      role: null as string | null,\n+      loading: false\n+    });\n     \n     useEffect(() => {\n       const prevValues = prevValuesRef.current;\n+      const currentValues = {\n+        id: user?.id || null,\n+        role: user?.role || null,\n+        loading\n+      };\n+\n       if (\n-        prevValues.id !== user?.id || \n-        prevValues.role !== user?.role || \n-        prevValues.loading !== loading\n+        prevValues.id !== currentValues.id || \n+        prevValues.role !== currentValues.role || \n+        prevValues.loading !== currentValues.loading\n       ) {\n         logger.debug('Auth Context', {\n           source: 'useAuth',\n           context: {\n             hasUser: !!user,\n-            userRole: user?.role,\n-            userId: user?.id,\n+            userRole: user?.role || null,\n+            userId: user?.id || null,\n             isLoading: loading\n           }\n         });\n-        prevValuesRef.current = { id: user?.id, role: user?.role, loading };\n+        prevValuesRef.current = currentValues;\n       }\n-    }, [user?.id, user?.role, loading]);\n+    }, [user, loading]);\n   }\n \n   const { isTransitioning } = useRoleStore();\n   const navigate = useNavigate();\n"
                },
                {
                    "date": 1739392920615,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,420 @@\n+\"use client\";\n+\n+import { useContext, useEffect, useState, useCallback, useRef } from 'react';\n+import { AuthContext } from '../contexts/AuthContext';\n+import { useNavigate, useLocation } from 'react-router-dom';\n+import { QueryClient } from '@tanstack/query-core';\n+import { roleTransitionManager } from '../lib/auth/RoleTransitionManager';\n+import { useRoleStore } from '../lib/auth/store';\n+import { logger } from '../lib/logger';\n+import { ROLE_PERMISSIONS } from '../types/roles';\n+import { sessionManager } from '../lib/auth/sessionManager';\n+import type { UserRole } from '../types/roles';\n+import { supabaseClient } from '../lib/supabaseClient';\n+import { supabase } from '../lib/supabase';\n+import { AuthLoader } from '../lib/auth/AuthLoader';\n+import type { AuthError } from '@supabase/supabase-js';\n+import { sessionMonitor } from '@/lib/auth/SessionMonitor';\n+import type { SessionState } from '@/lib/auth/sessionManager';\n+\n+interface LoginCredentials {\n+  email: string;\n+  password: string;\n+}\n+\n+interface SignUpCredentials extends LoginCredentials {\n+  name?: string;\n+}\n+\n+interface ResetPasswordCredentials {\n+  email: string;\n+}\n+\n+export namespace Auth {\n+  export const useAuth = () => {\n+    const context = useContext(AuthContext);\n+    \n+    if (!context) {\n+      console.warn('useAuth must be used within an AuthProvider');\n+      return { user: null, loading: false };\n+    }\n+\n+    const { user, loading } = context;\n+\n+    // Add debug logging\n+    console.log('Auth Context:', {\n+      hasUser: !!user,\n+      userRole: user?.role,\n+      userId: user?.id,\n+      isLoading: loading,\n+      fullUser: user // Log the full user object for debugging\n+    });\n+\n+    const { isTransitioning } = useRoleStore();\n+    const navigate = useNavigate();\n+    const queryClient = new QueryClient();\n+    const location = useLocation();\n+    \n+    // Add loading state check\n+    useEffect(() => {\n+      if (loading) {\n+        logger.info('Auth loading state active', {\n+          source: 'useAuth',\n+          context: { loading }\n+        });\n+      }\n+    }, [loading]);\n+\n+    // Auto-refresh session when it's about to expire\n+    useEffect(() => {\n+      if (!user) return;\n+      const refreshInterval = setInterval(async () => {\n+        try {\n+          await sessionManager.refreshSession();\n+        } catch (err) {\n+          logger.error('Failed to refresh session', {\n+            source: 'useAuth',\n+            context: { error: err }\n+          });\n+        }\n+      }, 4 * 60 * 1000); // Check every 4 minutes\n+      \n+      return () => {\n+        if (refreshInterval) {\n+          clearInterval(refreshInterval);\n+        }\n+      };\n+    }, [user]);\n+\n+    useEffect(() => {\n+      if (user) {\n+        logger.debug('Auth state check on route change', {\n+          source: 'useAuth',\n+          context: {\n+            role: user.role,\n+            path: location.pathname,\n+            permissions: ROLE_PERMISSIONS[user.role]?.permissions\n+          }\n+        });\n+      }\n+    }, [user, location.pathname]);\n+\n+    const changeRole = async (newRole: UserRole): Promise<void> => {\n+      if (!context.user || isTransitioning) return;\n+\n+      try {\n+        await roleTransitionManager.transitionRole(newRole);\n+        \n+        // Clear cache and refetch with new role\n+        queryClient.clear();\n+        await queryClient.resetQueries();\n+        \n+        // Update context user\n+        context.setUser({\n+          ...context.user,\n+          role: newRole\n+        });\n+\n+        // Navigate to home with fresh data\n+        navigate('/', { replace: true });\n+      } catch (err) {\n+        logger.error('Failed to change role', {\n+          source: 'useAuth',\n+          context: { error: err }\n+        });\n+        throw err;\n+      }\n+    };\n+\n+    const login = async (credentials: LoginCredentials) => {\n+      try {\n+        console.log('[Auth] Attempting login:', {\n+          email: credentials.email,\n+          timestamp: new Date().toISOString()\n+        });\n+        \n+        const { data, error } = await supabaseClient.auth.signInWithPassword({\n+          email: credentials.email,\n+          password: credentials.password,\n+        });\n+\n+        if (error) {\n+          console.error('[Auth] Supabase login error:', {\n+            message: error.message,\n+            status: error.status,\n+            name: error.name,\n+            timestamp: new Date().toISOString()\n+          });\n+          \n+          // Provide more specific error messages\n+          if (error.message.includes('Invalid login credentials')) {\n+            throw new Error('Invalid email or password. Please check your credentials and try again.');\n+          }\n+          \n+          logger.error('Login failed', {\n+            context: { \n+              error,\n+              credentials: { email: credentials.email }\n+            },\n+            source: 'useAuth'\n+          });\n+          throw new Error(error.message);\n+        }\n+\n+        console.log('[Auth] Login response:', {\n+          hasUser: !!data.user,\n+          userId: data.user?.id,\n+          userEmail: data.user?.email,\n+          metadata: data.user?.user_metadata,\n+          timestamp: new Date().toISOString()\n+        });\n+\n+        if (!data.user) {\n+          throw new Error('Login successful but user data is missing');\n+        }\n+\n+        // Map Supabase user to our user format\n+        const mappedUser = {\n+          id: data.user.id,\n+          email: data.user.email!,\n+          name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\n+          role: data.user.user_metadata?.role || 'student',\n+          photoUrl: data.user.user_metadata?.avatar_url,\n+        };\n+\n+        console.log('[Auth] Mapped user:', mappedUser);\n+\n+        context.setUser(mappedUser);\n+        return { user: mappedUser };\n+      } catch (error) {\n+        const errorDetails = error instanceof Error ? {\n+          message: error.message,\n+          name: error.name,\n+          stack: error.stack\n+        } : error;\n+\n+        console.error('[Auth] Login error details:', {\n+          error: errorDetails,\n+          timestamp: new Date().toISOString()\n+        });\n+\n+        logger.error('Login failed', {\n+          context: { \n+            error: errorDetails,\n+            credentials: { email: credentials.email }\n+          },\n+          source: 'useAuth'\n+        });\n+\n+        if (error instanceof Error) {\n+          throw error;\n+        } else {\n+          throw new Error('An unexpected error occurred. Please try again.');\n+        }\n+      }\n+    };\n+\n+    const logout = async () => {\n+      try {\n+        const { error } = await supabaseClient.auth.signOut();\n+        \n+        if (error) {\n+          throw error;\n+        }\n+\n+        context.setUser(null);\n+        queryClient.clear();\n+        navigate('/login');\n+      } catch (error) {\n+        logger.error('Logout failed', {\n+          context: { error },\n+          source: 'useAuth'\n+        });\n+        throw error;\n+      }\n+    };\n+\n+    const signUp = async (credentials: SignUpCredentials) => {\n+      try {\n+        console.log('[Auth] Attempting signup:', {\n+          email: credentials.email,\n+          timestamp: new Date().toISOString()\n+        });\n+        \n+        const { data, error } = await supabaseClient.auth.signUp({\n+          email: credentials.email,\n+          password: credentials.password,\n+          options: {\n+            data: {\n+              name: credentials.name || credentials.email.split('@')[0],\n+              role: 'student'\n+            }\n+          }\n+        });\n+\n+        if (error) {\n+          console.error('[Auth] Supabase signup error:', {\n+            message: error.message,\n+            status: error.status,\n+            name: error.name,\n+            timestamp: new Date().toISOString()\n+          });\n+          \n+          logger.error('Signup failed', {\n+            context: { \n+              error,\n+              credentials: { email: credentials.email }\n+            },\n+            source: 'useAuth'\n+          });\n+          throw new Error(error.message);\n+        }\n+\n+        console.log('[Auth] Signup response:', {\n+          hasUser: !!data.user,\n+          userId: data.user?.id,\n+          userEmail: data.user?.email,\n+          metadata: data.user?.user_metadata,\n+          timestamp: new Date().toISOString()\n+        });\n+\n+        if (!data.user) {\n+          throw new Error('Signup successful but user data is missing');\n+        }\n+\n+        // Map Supabase user to our user format\n+        const mappedUser = {\n+          id: data.user.id,\n+          email: data.user.email!,\n+          name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\n+          role: data.user.user_metadata?.role || 'student',\n+          photoUrl: data.user.user_metadata?.avatar_url,\n+        };\n+\n+        console.log('[Auth] Mapped user:', mappedUser);\n+\n+        context.setUser(mappedUser);\n+        return { user: mappedUser };\n+      } catch (error) {\n+        const errorDetails = error instanceof Error ? {\n+          message: error.message,\n+          name: error.name,\n+          stack: error.stack\n+        } : error;\n+\n+        console.error('[Auth] Signup error details:', {\n+          error: errorDetails,\n+          timestamp: new Date().toISOString()\n+        });\n+\n+        logger.error('Signup failed', {\n+          context: { \n+            error: errorDetails,\n+            credentials: { email: credentials.email }\n+          },\n+          source: 'useAuth'\n+        });\n+\n+        if (error instanceof Error) {\n+          throw error;\n+        } else {\n+          throw new Error('An unexpected error occurred during signup. Please try again.');\n+        }\n+      }\n+    };\n+\n+    const resetPassword = async (credentials: ResetPasswordCredentials) => {\n+      try {\n+        console.log('[Auth] Attempting password reset:', {\n+          email: credentials.email,\n+          timestamp: new Date().toISOString()\n+        });\n+        \n+        const { data, error } = await supabaseClient.auth.resetPasswordForEmail(\n+          credentials.email,\n+          { redirectTo: `${window.location.origin}/reset-password` }\n+        );\n+\n+        if (error) {\n+          console.error('[Auth] Supabase password reset error:', {\n+            message: error.message,\n+            status: error.status,\n+            name: error.name,\n+            timestamp: new Date().toISOString()\n+          });\n+          \n+          logger.error('Password reset failed', {\n+            context: { \n+              error,\n+              credentials: { email: credentials.email }\n+            },\n+            source: 'useAuth'\n+          });\n+          throw new Error(error.message);\n+        }\n+\n+        return data;\n+      } catch (error) {\n+        const errorDetails = error instanceof Error ? {\n+          message: error.message,\n+          name: error.name,\n+          stack: error.stack\n+        } : error;\n+\n+        console.error('[Auth] Password reset error details:', {\n+          error: errorDetails,\n+          timestamp: new Date().toISOString()\n+        });\n+\n+        logger.error('Password reset failed', {\n+          context: { \n+            error: errorDetails,\n+            credentials: { email: credentials.email }\n+          },\n+          source: 'useAuth'\n+        });\n+\n+        if (error instanceof Error) {\n+          throw error;\n+        } else {\n+          throw new Error('An unexpected error occurred during password reset. Please try again.');\n+        }\n+      }\n+    };\n+\n+    const [authState, setAuthState] = useState(sessionMonitor.getState());\n+\n+    useEffect(() => {\n+      const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\n+      return () => unsubscribe();\n+    }, []);\n+\n+    const checkAndRefreshSession = async (): Promise<void> => {\n+      try {\n+        await sessionManager.checkAndRefreshSession();\n+      } catch (error) {\n+        logger.error('Failed to check and refresh session', {\n+          context: { error },\n+          source: 'useAuth'\n+        });\n+      }\n+    };\n+\n+    return {\n+      user: user ? {\n+        ...user,\n+        role: user.role || 'unknown'\n+      } : null,\n+      loading,\n+      changeRole,\n+      isTransitioning,\n+      login,\n+      logout,\n+      signUp,\n+      resetPassword,\n+      sessionManager\n+    };\n+  }\n+}\n+\n+export default Auth.useAuth;\n\\ No newline at end of file\n"
                },
                {
                    "date": 1739393007588,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -29,430 +29,8 @@\n interface ResetPasswordCredentials {\n   email: string;\n }\n \n-export namespace Auth {\n-  export const useAuth = () => {\n-    const context = useContext(AuthContext);\n-    \n-    if (!context) {\n-      console.warn('useAuth must be used within an AuthProvider');\n-      return { user: null, loading: false };\n-    }\n-\n-    const { user, loading } = context;\n-\n-    // Add debug logging\n-    console.log('Auth Context:', {\n-      hasUser: !!user,\n-      userRole: user?.role,\n-      userId: user?.id,\n-      isLoading: loading,\n-      fullUser: user // Log the full user object for debugging\n-    });\n-\n-    const { isTransitioning } = useRoleStore();\n-    const navigate = useNavigate();\n-    const queryClient = new QueryClient();\n-    const location = useLocation();\n-    \n-    // Add loading state check\n-    useEffect(() => {\n-      if (loading) {\n-        logger.info('Auth loading state active', {\n-          source: 'useAuth',\n-          context: { loading }\n-        });\n-      }\n-    }, [loading]);\n-\n-    // Auto-refresh session when it's about to expire\n-    useEffect(() => {\n-      if (!user) return;\n-      const refreshInterval = setInterval(async () => {\n-        try {\n-          await sessionManager.refreshSession();\n-        } catch (err) {\n-          logger.error('Failed to refresh session', {\n-            source: 'useAuth',\n-            context: { error: err }\n-          });\n-        }\n-      }, 4 * 60 * 1000); // Check every 4 minutes\n-      \n-      return () => {\n-        if (refreshInterval) {\n-          clearInterval(refreshInterval);\n-        }\n-      };\n-    }, [user]);\n-\n-    useEffect(() => {\n-      if (user) {\n-        logger.debug('Auth state check on route change', {\n-          source: 'useAuth',\n-          context: {\n-            role: user.role,\n-            path: location.pathname,\n-            permissions: ROLE_PERMISSIONS[user.role]?.permissions\n-          }\n-        });\n-      }\n-    }, [user, location.pathname]);\n-\n-    const changeRole = async (newRole: UserRole): Promise<void> => {\n-      if (!context.user || isTransitioning) return;\n-\n-      try {\n-        await roleTransitionManager.transitionRole(newRole);\n-        \n-        // Clear cache and refetch with new role\n-        queryClient.clear();\n-        await queryClient.resetQueries();\n-        \n-        // Update context user\n-        context.setUser({\n-          ...context.user,\n-          role: newRole\n-        });\n-\n-        // Navigate to home with fresh data\n-        navigate('/', { replace: true });\n-      } catch (err) {\n-        logger.error('Failed to change role', {\n-          source: 'useAuth',\n-          context: { error: err }\n-        });\n-        throw err;\n-      }\n-    };\n-\n-    const login = async (credentials: LoginCredentials) => {\n-      try {\n-        console.log('[Auth] Attempting login:', {\n-          email: credentials.email,\n-          timestamp: new Date().toISOString()\n-        });\n-        \n-        const { data, error } = await supabaseClient.auth.signInWithPassword({\n-          email: credentials.email,\n-          password: credentials.password,\n-        });\n-\n-        if (error) {\n-          console.error('[Auth] Supabase login error:', {\n-            message: error.message,\n-            status: error.status,\n-            name: error.name,\n-            timestamp: new Date().toISOString()\n-          });\n-          \n-          // Provide more specific error messages\n-          if (error.message.includes('Invalid login credentials')) {\n-            throw new Error('Invalid email or password. Please check your credentials and try again.');\n-          }\n-          \n-          logger.error('Login failed', {\n-            context: { \n-              error,\n-              credentials: { email: credentials.email }\n-            },\n-            source: 'useAuth'\n-          });\n-          throw new Error(error.message);\n-        }\n-\n-        console.log('[Auth] Login response:', {\n-          hasUser: !!data.user,\n-          userId: data.user?.id,\n-          userEmail: data.user?.email,\n-          metadata: data.user?.user_metadata,\n-          timestamp: new Date().toISOString()\n-        });\n-\n-        if (!data.user) {\n-          throw new Error('Login successful but user data is missing');\n-        }\n-\n-        // Map Supabase user to our user format\n-        const mappedUser = {\n-          id: data.user.id,\n-          email: data.user.email!,\n-          name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\n-          role: data.user.user_metadata?.role || 'student',\n-          photoUrl: data.user.user_metadata?.avatar_url,\n-        };\n-\n-        console.log('[Auth] Mapped user:', mappedUser);\n-\n-        context.setUser(mappedUser);\n-        return { user: mappedUser };\n-      } catch (error) {\n-        const errorDetails = error instanceof Error ? {\n-          message: error.message,\n-          name: error.name,\n-          stack: error.stack\n-        } : error;\n-\n-        console.error('[Auth] Login error details:', {\n-          error: errorDetails,\n-          timestamp: new Date().toISOString()\n-        });\n-\n-        logger.error('Login failed', {\n-          context: { \n-            error: errorDetails,\n-            credentials: { email: credentials.email }\n-          },\n-          source: 'useAuth'\n-        });\n-\n-        if (error instanceof Error) {\n-          throw error;\n-        } else {\n-          throw new Error('An unexpected error occurred. Please try again.');\n-        }\n-      }\n-    };\n-\n-    const logout = async () => {\n-      try {\n-        const { error } = await supabaseClient.auth.signOut();\n-        \n-        if (error) {\n-          throw error;\n-        }\n-\n-        context.setUser(null);\n-        queryClient.clear();\n-        navigate('/login');\n-      } catch (error) {\n-        logger.error('Logout failed', {\n-          context: { error },\n-          source: 'useAuth'\n-        });\n-        throw error;\n-      }\n-    };\n-\n-    const signUp = async (credentials: SignUpCredentials) => {\n-      try {\n-        console.log('[Auth] Attempting signup:', {\n-          email: credentials.email,\n-          timestamp: new Date().toISOString()\n-        });\n-        \n-        const { data, error } = await supabaseClient.auth.signUp({\n-          email: credentials.email,\n-          password: credentials.password,\n-          options: {\n-            data: {\n-              name: credentials.name || credentials.email.split('@')[0],\n-              role: 'student'\n-            }\n-          }\n-        });\n-\n-        if (error) {\n-          console.error('[Auth] Supabase signup error:', {\n-            message: error.message,\n-            status: error.status,\n-            name: error.name,\n-            timestamp: new Date().toISOString()\n-          });\n-          \n-          logger.error('Signup failed', {\n-            context: { \n-              error,\n-              credentials: { email: credentials.email }\n-            },\n-            source: 'useAuth'\n-          });\n-          throw new Error(error.message);\n-        }\n-\n-        console.log('[Auth] Signup response:', {\n-          hasUser: !!data.user,\n-          userId: data.user?.id,\n-          userEmail: data.user?.email,\n-          metadata: data.user?.user_metadata,\n-          timestamp: new Date().toISOString()\n-        });\n-\n-        if (!data.user) {\n-          throw new Error('Signup successful but user data is missing');\n-        }\n-\n-        // Map Supabase user to our user format\n-        const mappedUser = {\n-          id: data.user.id,\n-          email: data.user.email!,\n-          name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\n-          role: data.user.user_metadata?.role || 'student',\n-          photoUrl: data.user.user_metadata?.avatar_url,\n-        };\n-\n-        console.log('[Auth] Mapped user:', mappedUser);\n-\n-        context.setUser(mappedUser);\n-        return { user: mappedUser };\n-      } catch (error) {\n-        const errorDetails = error instanceof Error ? {\n-          message: error.message,\n-          name: error.name,\n-          stack: error.stack\n-        } : error;\n-\n-        console.error('[Auth] Signup error details:', {\n-          error: errorDetails,\n-          timestamp: new Date().toISOString()\n-        });\n-\n-        logger.error('Signup failed', {\n-          context: { \n-            error: errorDetails,\n-            credentials: { email: credentials.email }\n-          },\n-          source: 'useAuth'\n-        });\n-\n-        if (error instanceof Error) {\n-          throw error;\n-        } else {\n-          throw new Error('An unexpected error occurred during signup. Please try again.');\n-        }\n-      }\n-    };\n-\n-    const resetPassword = async (credentials: ResetPasswordCredentials) => {\n-      try {\n-        console.log('[Auth] Attempting password reset:', {\n-          email: credentials.email,\n-          timestamp: new Date().toISOString()\n-        });\n-        \n-        const { data, error } = await supabaseClient.auth.resetPasswordForEmail(\n-          credentials.email,\n-          { redirectTo: `${window.location.origin}/reset-password` }\n-        );\n-\n-        if (error) {\n-          console.error('[Auth] Supabase password reset error:', {\n-            message: error.message,\n-            status: error.status,\n-            name: error.name,\n-            timestamp: new Date().toISOString()\n-          });\n-          \n-          logger.error('Password reset failed', {\n-            context: { \n-              error,\n-              credentials: { email: credentials.email }\n-            },\n-            source: 'useAuth'\n-          });\n-          throw new Error(error.message);\n-        }\n-\n-        return data;\n-      } catch (error) {\n-        const errorDetails = error instanceof Error ? {\n-          message: error.message,\n-          name: error.name,\n-          stack: error.stack\n-        } : error;\n-\n-        console.error('[Auth] Password reset error details:', {\n-          error: errorDetails,\n-          timestamp: new Date().toISOString()\n-        });\n-\n-        logger.error('Password reset failed', {\n-          context: { \n-            error: errorDetails,\n-            credentials: { email: credentials.email }\n-          },\n-          source: 'useAuth'\n-        });\n-\n-        if (error instanceof Error) {\n-          throw error;\n-        } else {\n-          throw new Error('An unexpected error occurred during password reset. Please try again.');\n-        }\n-      }\n-    };\n-\n-    const [authState, setAuthState] = useState(sessionMonitor.getState());\n-\n-    useEffect(() => {\n-      const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\n-      return () => unsubscribe();\n-    }, []);\n-\n-    const checkAndRefreshSession = async (): Promise<void> => {\n-      try {\n-        await sessionManager.checkAndRefreshSession();\n-      } catch (error) {\n-        logger.error('Failed to check and refresh session', {\n-          context: { error },\n-          source: 'useAuth'\n-        });\n-      }\n-    };\n-\n-    return {\n-      user: user ? {\n-        ...user,\n-        role: user.role || 'unknown'\n-      } : null,\n-      loading,\n-      changeRole,\n-      isTransitioning,\n-      login,\n-      logout,\n-      signUp,\n-      resetPassword,\n-      sessionManager\n-    };\n-  }\n-}\n-\n-export default Auth.useAuth;\n-\"use client\";\n-\n-import { useContext, useEffect, useState, useCallback, useRef, useMemo } from 'react';\n-import { AuthContext } from '../contexts/AuthContext';\n-import { useNavigate, useLocation } from 'react-router-dom';\n-import { QueryClient } from '@tanstack/query-core';\n-import { roleTransitionManager } from '../lib/auth/RoleTransitionManager';\n-import { useRoleStore } from '../lib/auth/store';\n-import { logger } from '../lib/logger';\n-import { ROLE_PERMISSIONS } from '../types/roles';\n-import { sessionManager } from '../lib/auth/sessionManager';\n-import type { UserRole } from '../types/roles';\n-import { supabaseClient } from '../lib/supabaseClient';\n-import { supabase } from '../lib/supabase';\n-import { AuthLoader } from '../lib/auth/AuthLoader';\n-import type { AuthError } from '@supabase/supabase-js';\n-import { sessionMonitor } from '@/lib/auth/SessionMonitor';\n-import type { SessionState } from '@/lib/auth/sessionManager';\n-import { debounce } from 'lodash';\n-import { useDebounce } from '@/hooks/useDebounce';\n-\n-interface LoginCredentials {\n-  email: string;\n-  password: string;\n-}\n-\n-interface SignUpCredentials extends LoginCredentials {\n-  name?: string;\n-}\n-\n-interface ResetPasswordCredentials {\n-  email: string;\n-}\n-\n export function useAuth() {\n   const context = useContext(AuthContext);\n   \n   if (!context) {\n@@ -461,43 +39,17 @@\n   }\n \n   const { user, loading } = context;\n \n-  // Only log in development and reduce frequency with debounce\n-  if (process.env.NODE_ENV === 'development') {\n-    const prevValuesRef = useRef({\n-      id: null as string | null,\n-      role: null as string | null,\n-      loading: false\n-    });\n-    \n-    useEffect(() => {\n-      const prevValues = prevValuesRef.current;\n-      const currentValues = {\n-        id: user?.id || null,\n-        role: user?.role || null,\n-        loading\n-      };\n+  // Add debug logging\n+  console.log('Auth Context:', {\n+    hasUser: !!user,\n+    userRole: user?.role,\n+    userId: user?.id,\n+    isLoading: loading,\n+    fullUser: user // Log the full user object for debugging\n+  });\n \n-      if (\n-        prevValues.id !== currentValues.id || \n-        prevValues.role !== currentValues.role || \n-        prevValues.loading !== currentValues.loading\n-      ) {\n-        logger.debug('Auth Context', {\n-          source: 'useAuth',\n-          context: {\n-            hasUser: !!user,\n-            userRole: user?.role || null,\n-            userId: user?.id || null,\n-            isLoading: loading\n-          }\n-        });\n-        prevValuesRef.current = currentValues;\n-      }\n-    }, [user, loading]);\n-  }\n-\n   const { isTransitioning } = useRoleStore();\n   const navigate = useNavigate();\n   const queryClient = new QueryClient();\n   const location = useLocation();\n"
                },
                {
                    "date": 1740683568148,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,416 +1,416 @@\n-\"use client\";\n-\n-import { useContext, useEffect, useState, useCallback, useRef } from 'react';\n-import { AuthContext } from '../contexts/AuthContext';\n-import { useNavigate, useLocation } from 'react-router-dom';\n-import { QueryClient } from '@tanstack/query-core';\n-import { roleTransitionManager } from '../lib/auth/RoleTransitionManager';\n-import { useRoleStore } from '../lib/auth/store';\n-import { logger } from '../lib/logger';\n-import { ROLE_PERMISSIONS } from '../types/roles';\n-import { sessionManager } from '../lib/auth/sessionManager';\n-import type { UserRole } from '../types/roles';\n-import { supabaseClient } from '../lib/supabaseClient';\n-import { supabase } from '../lib/supabase';\n-import { AuthLoader } from '../lib/auth/AuthLoader';\n-import type { AuthError } from '@supabase/supabase-js';\n-import { sessionMonitor } from '@/lib/auth/SessionMonitor';\n-import type { SessionState } from '@/lib/auth/sessionManager';\n-\n-interface LoginCredentials {\n-  email: string;\n-  password: string;\n-}\n-\n-interface SignUpCredentials extends LoginCredentials {\n-  name?: string;\n-}\n-\n-interface ResetPasswordCredentials {\n-  email: string;\n-}\n-\n-export function useAuth() {\n-  const context = useContext(AuthContext);\n-  \n-  if (!context) {\n-    console.warn('useAuth must be used within an AuthProvider');\n-    return { user: null, loading: false };\n-  }\n-\n-  const { user, loading } = context;\n-\n-  // Add debug logging\n-  console.log('Auth Context:', {\n-    hasUser: !!user,\n-    userRole: user?.role,\n-    userId: user?.id,\n-    isLoading: loading,\n-    fullUser: user // Log the full user object for debugging\n-  });\n-\n-  const { isTransitioning } = useRoleStore();\n-  const navigate = useNavigate();\n-  const queryClient = new QueryClient();\n-  const location = useLocation();\n-  \n-  // Add loading state check\n-  useEffect(() => {\n-    if (loading) {\n-      logger.info('Auth loading state active', {\n-        source: 'useAuth',\n-        context: { loading }\n-      });\n-    }\n-  }, [loading]);\n-\n-  // Auto-refresh session when it's about to expire\n-  useEffect(() => {\n-    if (!user) return;\n-    const refreshInterval = setInterval(async () => {\n-      try {\n-        await sessionManager.refreshSession();\n-      } catch (err) {\n-        logger.error('Failed to refresh session', {\n-          source: 'useAuth',\n-          context: { error: err }\n-        });\n-      }\n-    }, 4 * 60 * 1000); // Check every 4 minutes\n-    \n-    return () => {\n-      if (refreshInterval) {\n-        clearInterval(refreshInterval);\n-      }\n-    };\n-  }, [user]);\n-\n-  useEffect(() => {\n-    if (user) {\n-      logger.debug('Auth state check on route change', {\n-        source: 'useAuth',\n-        context: {\n-          role: user.role,\n-          path: location.pathname,\n-          permissions: ROLE_PERMISSIONS[user.role]?.permissions\n-        }\n-      });\n-    }\n-  }, [user, location.pathname]);\n-\n-  const changeRole = async (newRole: UserRole): Promise<void> => {\n-    if (!context.user || isTransitioning) return;\n-\n-    try {\n-      await roleTransitionManager.transitionRole(newRole);\n-      \n-      // Clear cache and refetch with new role\n-      queryClient.clear();\n-      await queryClient.resetQueries();\n-      \n-      // Update context user\n-      context.setUser({\n-        ...context.user,\n-        role: newRole\n-      });\n-\n-      // Navigate to home with fresh data\n-      navigate('/', { replace: true });\n-    } catch (err) {\n-      logger.error('Failed to change role', {\n-        source: 'useAuth',\n-        context: { error: err }\n-      });\n-      throw err;\n-    }\n-  };\n-\n-  const login = async (credentials: LoginCredentials) => {\n-    try {\n-      console.log('[Auth] Attempting login:', {\n-        email: credentials.email,\n-        timestamp: new Date().toISOString()\n-      });\n-      \n-      const { data, error } = await supabaseClient.auth.signInWithPassword({\n-        email: credentials.email,\n-        password: credentials.password,\n-      });\n-\n-      if (error) {\n-        console.error('[Auth] Supabase login error:', {\n-          message: error.message,\n-          status: error.status,\n-          name: error.name,\n-          timestamp: new Date().toISOString()\n-        });\n-        \n-        // Provide more specific error messages\n-        if (error.message.includes('Invalid login credentials')) {\n-          throw new Error('Invalid email or password. Please check your credentials and try again.');\n-        }\n-        \n-        logger.error('Login failed', {\n-          context: { \n-            error,\n-            credentials: { email: credentials.email }\n-          },\n-          source: 'useAuth'\n-        });\n-        throw new Error(error.message);\n-      }\n-\n-      console.log('[Auth] Login response:', {\n-        hasUser: !!data.user,\n-        userId: data.user?.id,\n-        userEmail: data.user?.email,\n-        metadata: data.user?.user_metadata,\n-        timestamp: new Date().toISOString()\n-      });\n-\n-      if (!data.user) {\n-        throw new Error('Login successful but user data is missing');\n-      }\n-\n-      // Map Supabase user to our user format\n-      const mappedUser = {\n-        id: data.user.id,\n-        email: data.user.email!,\n-        name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\n-        role: data.user.user_metadata?.role || 'student',\n-        photoUrl: data.user.user_metadata?.avatar_url,\n-      };\n-\n-      console.log('[Auth] Mapped user:', mappedUser);\n-\n-      context.setUser(mappedUser);\n-      return { user: mappedUser };\n-    } catch (error) {\n-      const errorDetails = error instanceof Error ? {\n-        message: error.message,\n-        name: error.name,\n-        stack: error.stack\n-      } : error;\n-\n-      console.error('[Auth] Login error details:', {\n-        error: errorDetails,\n-        timestamp: new Date().toISOString()\n-      });\n-\n-      logger.error('Login failed', {\n-        context: { \n-          error: errorDetails,\n-          credentials: { email: credentials.email }\n-        },\n-        source: 'useAuth'\n-      });\n-\n-      if (error instanceof Error) {\n-        throw error;\n-      } else {\n-        throw new Error('An unexpected error occurred. Please try again.');\n-      }\n-    }\n-  };\n-\n-  const logout = async () => {\n-    try {\n-      const { error } = await supabaseClient.auth.signOut();\n-      \n-      if (error) {\n-        throw error;\n-      }\n-\n-      context.setUser(null);\n-      queryClient.clear();\n-      navigate('/login');\n-    } catch (error) {\n-      logger.error('Logout failed', {\n-        context: { error },\n-        source: 'useAuth'\n-      });\n-      throw error;\n-    }\n-  };\n-\n-  const signUp = async (credentials: SignUpCredentials) => {\n-    try {\n-      console.log('[Auth] Attempting signup:', {\n-        email: credentials.email,\n-        timestamp: new Date().toISOString()\n-      });\n-      \n-      const { data, error } = await supabaseClient.auth.signUp({\n-        email: credentials.email,\n-        password: credentials.password,\n-        options: {\n-          data: {\n-            name: credentials.name || credentials.email.split('@')[0],\n-            role: 'student'\n-          }\n-        }\n-      });\n-\n-      if (error) {\n-        console.error('[Auth] Supabase signup error:', {\n-          message: error.message,\n-          status: error.status,\n-          name: error.name,\n-          timestamp: new Date().toISOString()\n-        });\n-        \n-        logger.error('Signup failed', {\n-          context: { \n-            error,\n-            credentials: { email: credentials.email }\n-          },\n-          source: 'useAuth'\n-        });\n-        throw new Error(error.message);\n-      }\n-\n-      console.log('[Auth] Signup response:', {\n-        hasUser: !!data.user,\n-        userId: data.user?.id,\n-        userEmail: data.user?.email,\n-        metadata: data.user?.user_metadata,\n-        timestamp: new Date().toISOString()\n-      });\n-\n-      if (!data.user) {\n-        throw new Error('Signup successful but user data is missing');\n-      }\n-\n-      // Map Supabase user to our user format\n-      const mappedUser = {\n-        id: data.user.id,\n-        email: data.user.email!,\n-        name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\n-        role: data.user.user_metadata?.role || 'student',\n-        photoUrl: data.user.user_metadata?.avatar_url,\n-      };\n-\n-      console.log('[Auth] Mapped user:', mappedUser);\n-\n-      context.setUser(mappedUser);\n-      return { user: mappedUser };\n-    } catch (error) {\n-      const errorDetails = error instanceof Error ? {\n-        message: error.message,\n-        name: error.name,\n-        stack: error.stack\n-      } : error;\n-\n-      console.error('[Auth] Signup error details:', {\n-        error: errorDetails,\n-        timestamp: new Date().toISOString()\n-      });\n-\n-      logger.error('Signup failed', {\n-        context: { \n-          error: errorDetails,\n-          credentials: { email: credentials.email }\n-        },\n-        source: 'useAuth'\n-      });\n-\n-      if (error instanceof Error) {\n-        throw error;\n-      } else {\n-        throw new Error('An unexpected error occurred during signup. Please try again.');\n-      }\n-    }\n-  };\n-\n-  const resetPassword = async (credentials: ResetPasswordCredentials) => {\n-    try {\n-      console.log('[Auth] Attempting password reset:', {\n-        email: credentials.email,\n-        timestamp: new Date().toISOString()\n-      });\n-      \n-      const { data, error } = await supabaseClient.auth.resetPasswordForEmail(\n-        credentials.email,\n-        { redirectTo: `${window.location.origin}/reset-password` }\n-      );\n-\n-      if (error) {\n-        console.error('[Auth] Supabase password reset error:', {\n-          message: error.message,\n-          status: error.status,\n-          name: error.name,\n-          timestamp: new Date().toISOString()\n-        });\n-        \n-        logger.error('Password reset failed', {\n-          context: { \n-            error,\n-            credentials: { email: credentials.email }\n-          },\n-          source: 'useAuth'\n-        });\n-        throw new Error(error.message);\n-      }\n-\n-      return data;\n-    } catch (error) {\n-      const errorDetails = error instanceof Error ? {\n-        message: error.message,\n-        name: error.name,\n-        stack: error.stack\n-      } : error;\n-\n-      console.error('[Auth] Password reset error details:', {\n-        error: errorDetails,\n-        timestamp: new Date().toISOString()\n-      });\n-\n-      logger.error('Password reset failed', {\n-        context: { \n-          error: errorDetails,\n-          credentials: { email: credentials.email }\n-        },\n-        source: 'useAuth'\n-      });\n-\n-      if (error instanceof Error) {\n-        throw error;\n-      } else {\n-        throw new Error('An unexpected error occurred during password reset. Please try again.');\n-      }\n-    }\n-  };\n-\n-  const [authState, setAuthState] = useState(sessionMonitor.getState());\n-\n-  useEffect(() => {\n-    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\n-    return () => unsubscribe();\n-  }, []);\n-\n-  const checkAndRefreshSession = async (): Promise<void> => {\n-    try {\n-      await sessionManager.checkAndRefreshSession();\n-    } catch (error) {\n-      logger.error('Failed to check and refresh session', {\n-        context: { error },\n-        source: 'useAuth'\n-      });\n-    }\n-  };\n-\n-  return {\n-    user: user ? {\n-      ...user,\n-      role: user.role || 'unknown'\n-    } : null,\n-    loading,\n-    changeRole,\n-    isTransitioning,\n-    login,\n-    logout,\n-    signUp,\n-    resetPassword,\n-    sessionManager\n-  };\n+\"use client\";\r\n+\r\n+import { useContext, useEffect, useState, useCallback, useRef } from 'react';\r\n+import { AuthContext } from '../contexts/AuthContext';\r\n+import { useNavigate, useLocation } from 'react-router-dom';\r\n+import { QueryClient } from '@tanstack/query-core';\r\n+import { roleTransitionManager } from '../lib/auth/RoleTransitionManager';\r\n+import { useRoleStore } from '../lib/auth/store';\r\n+import { logger } from '../lib/logger';\r\n+import { ROLE_PERMISSIONS } from '../types/roles';\r\n+import { sessionManager } from '../lib/auth/sessionManager';\r\n+import type { UserRole } from '../types/roles';\r\n+import { supabaseClient } from '../lib/supabaseClient';\r\n+import { supabase } from '../lib/supabase';\r\n+import { AuthLoader } from '../lib/auth/AuthLoader';\r\n+import type { AuthError } from '@supabase/supabase-js';\r\n+import { sessionMonitor } from '@/lib/auth/SessionMonitor';\r\n+import type { SessionState } from '@/lib/auth/sessionManager';\r\n+\r\n+interface LoginCredentials {\r\n+  email: string;\r\n+  password: string;\r\n+}\r\n+\r\n+interface SignUpCredentials extends LoginCredentials {\r\n+  name?: string;\r\n+}\r\n+\r\n+interface ResetPasswordCredentials {\r\n+  email: string;\r\n+}\r\n+\r\n+export function useAuth() {\r\n+  const context = useContext(AuthContext);\r\n+  const { isTransitioning } = useRoleStore();\r\n+  const navigate = useNavigate();\r\n+  const location = useLocation();\r\n+  const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n+  const queryClient = new QueryClient();\r\n+  \r\n+  if (!context) {\r\n+    console.warn('useAuth must be used within an AuthProvider');\r\n+    return { user: null, loading: false };\r\n+  }\r\n+\r\n+  const { user, loading } = context;\r\n+\r\n+  // Add debug logging\r\n+  console.log('Auth Context:', {\r\n+    hasUser: !!user,\r\n+    userRole: user?.role,\r\n+    userId: user?.id,\r\n+    isLoading: loading,\r\n+    fullUser: user\r\n+  });\r\n+\r\n+  // Add loading state check\r\n+  useEffect(() => {\r\n+    if (loading) {\r\n+      logger.info('Auth loading state active', {\r\n+        source: 'useAuth',\r\n+        context: { loading }\r\n+      });\r\n+    }\r\n+  }, [loading]);\r\n+\r\n+  // Auto-refresh session when it's about to expire\r\n+  useEffect(() => {\r\n+    if (!user) return;\r\n+    const refreshInterval = setInterval(async () => {\r\n+      try {\r\n+        await sessionManager.refreshSession();\r\n+      } catch (err) {\r\n+        logger.error('Failed to refresh session', {\r\n+          source: 'useAuth',\r\n+          context: { error: err }\r\n+        });\r\n+      }\r\n+    }, 4 * 60 * 1000); // Check every 4 minutes\r\n+    \r\n+    return () => {\r\n+      if (refreshInterval) {\r\n+        clearInterval(refreshInterval);\r\n+      }\r\n+    };\r\n+  }, [user]);\r\n+\r\n+  useEffect(() => {\r\n+    if (user) {\r\n+      logger.debug('Auth state check on route change', {\r\n+        source: 'useAuth',\r\n+        context: {\r\n+          role: user.role,\r\n+          path: location.pathname,\r\n+          permissions: ROLE_PERMISSIONS[user.role]?.permissions\r\n+        }\r\n+      });\r\n+    }\r\n+  }, [user, location.pathname]);\r\n+\r\n+  const changeRole = async (newRole: UserRole): Promise<void> => {\r\n+    if (!context.user || isTransitioning) return;\r\n+\r\n+    try {\r\n+      await roleTransitionManager.transitionRole(newRole);\r\n+      \r\n+      // Clear cache and refetch with new role\r\n+      queryClient.clear();\r\n+      await queryClient.resetQueries();\r\n+      \r\n+      // Update context user\r\n+      context.setUser({\r\n+        ...context.user,\r\n+        role: newRole\r\n+      });\r\n+\r\n+      // Navigate to home with fresh data\r\n+      navigate('/', { replace: true });\r\n+    } catch (err) {\r\n+      logger.error('Failed to change role', {\r\n+        source: 'useAuth',\r\n+        context: { error: err }\r\n+      });\r\n+      throw err;\r\n+    }\r\n+  };\r\n+\r\n+  const login = async (credentials: LoginCredentials) => {\r\n+    try {\r\n+      console.log('[Auth] Attempting login:', {\r\n+        email: credentials.email,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+      \r\n+      const { data, error } = await supabaseClient.auth.signInWithPassword({\r\n+        email: credentials.email,\r\n+        password: credentials.password,\r\n+      });\r\n+\r\n+      if (error) {\r\n+        console.error('[Auth] Supabase login error:', {\r\n+          message: error.message,\r\n+          status: error.status,\r\n+          name: error.name,\r\n+          timestamp: new Date().toISOString()\r\n+        });\r\n+        \r\n+        // Provide more specific error messages\r\n+        if (error.message.includes('Invalid login credentials')) {\r\n+          throw new Error('Invalid email or password. Please check your credentials and try again.');\r\n+        }\r\n+        \r\n+        logger.error('Login failed', {\r\n+          context: { \r\n+            error,\r\n+            credentials: { email: credentials.email }\r\n+          },\r\n+          source: 'useAuth'\r\n+        });\r\n+        throw new Error(error.message);\r\n+      }\r\n+\r\n+      console.log('[Auth] Login response:', {\r\n+        hasUser: !!data.user,\r\n+        userId: data.user?.id,\r\n+        userEmail: data.user?.email,\r\n+        metadata: data.user?.user_metadata,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+\r\n+      if (!data.user) {\r\n+        throw new Error('Login successful but user data is missing');\r\n+      }\r\n+\r\n+      // Map Supabase user to our user format\r\n+      const mappedUser = {\r\n+        id: data.user.id,\r\n+        email: data.user.email!,\r\n+        name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\r\n+        role: data.user.user_metadata?.role || 'student',\r\n+        photoUrl: data.user.user_metadata?.avatar_url,\r\n+      };\r\n+\r\n+      console.log('[Auth] Mapped user:', mappedUser);\r\n+\r\n+      context.setUser(mappedUser);\r\n+      return { user: mappedUser };\r\n+    } catch (error) {\r\n+      const errorDetails = error instanceof Error ? {\r\n+        message: error.message,\r\n+        name: error.name,\r\n+        stack: error.stack\r\n+      } : error;\r\n+\r\n+      console.error('[Auth] Login error details:', {\r\n+        error: errorDetails,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+\r\n+      logger.error('Login failed', {\r\n+        context: { \r\n+          error: errorDetails,\r\n+          credentials: { email: credentials.email }\r\n+        },\r\n+        source: 'useAuth'\r\n+      });\r\n+\r\n+      if (error instanceof Error) {\r\n+        throw error;\r\n+      } else {\r\n+        throw new Error('An unexpected error occurred. Please try again.');\r\n+      }\r\n+    }\r\n+  };\r\n+\r\n+  const logout = async () => {\r\n+    try {\r\n+      const { error } = await supabaseClient.auth.signOut();\r\n+      \r\n+      if (error) {\r\n+        throw error;\r\n+      }\r\n+\r\n+      context.setUser(null);\r\n+      queryClient.clear();\r\n+      navigate('/login');\r\n+    } catch (error) {\r\n+      logger.error('Logout failed', {\r\n+        context: { error },\r\n+        source: 'useAuth'\r\n+      });\r\n+      throw error;\r\n+    }\r\n+  };\r\n+\r\n+  const signUp = async (credentials: SignUpCredentials) => {\r\n+    try {\r\n+      console.log('[Auth] Attempting signup:', {\r\n+        email: credentials.email,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+      \r\n+      const { data, error } = await supabaseClient.auth.signUp({\r\n+        email: credentials.email,\r\n+        password: credentials.password,\r\n+        options: {\r\n+          data: {\r\n+            name: credentials.name || credentials.email.split('@')[0],\r\n+            role: 'student'\r\n+          }\r\n+        }\r\n+      });\r\n+\r\n+      if (error) {\r\n+        console.error('[Auth] Supabase signup error:', {\r\n+          message: error.message,\r\n+          status: error.status,\r\n+          name: error.name,\r\n+          timestamp: new Date().toISOString()\r\n+        });\r\n+        \r\n+        logger.error('Signup failed', {\r\n+          context: { \r\n+            error,\r\n+            credentials: { email: credentials.email }\r\n+          },\r\n+          source: 'useAuth'\r\n+        });\r\n+        throw new Error(error.message);\r\n+      }\r\n+\r\n+      console.log('[Auth] Signup response:', {\r\n+        hasUser: !!data.user,\r\n+        userId: data.user?.id,\r\n+        userEmail: data.user?.email,\r\n+        metadata: data.user?.user_metadata,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+\r\n+      if (!data.user) {\r\n+        throw new Error('Signup successful but user data is missing');\r\n+      }\r\n+\r\n+      // Map Supabase user to our user format\r\n+      const mappedUser = {\r\n+        id: data.user.id,\r\n+        email: data.user.email!,\r\n+        name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\r\n+        role: data.user.user_metadata?.role || 'student',\r\n+        photoUrl: data.user.user_metadata?.avatar_url,\r\n+      };\r\n+\r\n+      console.log('[Auth] Mapped user:', mappedUser);\r\n+\r\n+      context.setUser(mappedUser);\r\n+      return { user: mappedUser };\r\n+    } catch (error) {\r\n+      const errorDetails = error instanceof Error ? {\r\n+        message: error.message,\r\n+        name: error.name,\r\n+        stack: error.stack\r\n+      } : error;\r\n+\r\n+      console.error('[Auth] Signup error details:', {\r\n+        error: errorDetails,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+\r\n+      logger.error('Signup failed', {\r\n+        context: { \r\n+          error: errorDetails,\r\n+          credentials: { email: credentials.email }\r\n+        },\r\n+        source: 'useAuth'\r\n+      });\r\n+\r\n+      if (error instanceof Error) {\r\n+        throw error;\r\n+      } else {\r\n+        throw new Error('An unexpected error occurred during signup. Please try again.');\r\n+      }\r\n+    }\r\n+  };\r\n+\r\n+  const resetPassword = async (credentials: ResetPasswordCredentials) => {\r\n+    try {\r\n+      console.log('[Auth] Attempting password reset:', {\r\n+        email: credentials.email,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+      \r\n+      const { data, error } = await supabaseClient.auth.resetPasswordForEmail(\r\n+        credentials.email,\r\n+        { redirectTo: `${window.location.origin}/reset-password` }\r\n+      );\r\n+\r\n+      if (error) {\r\n+        console.error('[Auth] Supabase password reset error:', {\r\n+          message: error.message,\r\n+          status: error.status,\r\n+          name: error.name,\r\n+          timestamp: new Date().toISOString()\r\n+        });\r\n+        \r\n+        logger.error('Password reset failed', {\r\n+          context: { \r\n+            error,\r\n+            credentials: { email: credentials.email }\r\n+          },\r\n+          source: 'useAuth'\r\n+        });\r\n+        throw new Error(error.message);\r\n+      }\r\n+\r\n+      return data;\r\n+    } catch (error) {\r\n+      const errorDetails = error instanceof Error ? {\r\n+        message: error.message,\r\n+        name: error.name,\r\n+        stack: error.stack\r\n+      } : error;\r\n+\r\n+      console.error('[Auth] Password reset error details:', {\r\n+        error: errorDetails,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+\r\n+      logger.error('Password reset failed', {\r\n+        context: { \r\n+          error: errorDetails,\r\n+          credentials: { email: credentials.email }\r\n+        },\r\n+        source: 'useAuth'\r\n+      });\r\n+\r\n+      if (error instanceof Error) {\r\n+        throw error;\r\n+      } else {\r\n+        throw new Error('An unexpected error occurred during password reset. Please try again.');\r\n+      }\r\n+    }\r\n+  };\r\n+\r\n+  const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n+\r\n+  useEffect(() => {\r\n+    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n+    return () => unsubscribe();\r\n+  }, []);\r\n+\r\n+  const checkAndRefreshSession = async (): Promise<void> => {\r\n+    try {\r\n+      await sessionManager.checkAndRefreshSession();\r\n+    } catch (error) {\r\n+      logger.error('Failed to check and refresh session', {\r\n+        context: { error },\r\n+        source: 'useAuth'\r\n+      });\r\n+    }\r\n+  };\r\n+\r\n+  return {\r\n+    user: user ? {\r\n+      ...user,\r\n+      role: user.role || 'unknown'\r\n+    } : null,\r\n+    loading,\r\n+    changeRole,\r\n+    isTransitioning,\r\n+    login,\r\n+    logout,\r\n+    signUp,\r\n+    resetPassword,\r\n+    sessionManager\r\n+  };\r\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1740683587826,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -380,10 +380,8 @@\n       }\r\n     }\r\n   };\r\n \r\n-  const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n-\r\n   useEffect(() => {\r\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n     return () => unsubscribe();\r\n   }, []);\r\n"
                },
                {
                    "date": 1740683810150,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -31,13 +31,8 @@\n }\r\n \r\n export function useAuth() {\r\n   const context = useContext(AuthContext);\r\n-  const { isTransitioning } = useRoleStore();\r\n-  const navigate = useNavigate();\r\n-  const location = useLocation();\r\n-  const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n-  const queryClient = new QueryClient();\r\n   \r\n   if (!context) {\r\n     console.warn('useAuth must be used within an AuthProvider');\r\n     return { user: null, loading: false };\r\n@@ -50,11 +45,16 @@\n     hasUser: !!user,\r\n     userRole: user?.role,\r\n     userId: user?.id,\r\n     isLoading: loading,\r\n-    fullUser: user\r\n+    fullUser: user // Log the full user object for debugging\r\n   });\r\n \r\n+  const { isTransitioning } = useRoleStore();\r\n+  const navigate = useNavigate();\r\n+  const queryClient = new QueryClient();\r\n+  const location = useLocation();\r\n+  \r\n   // Add loading state check\r\n   useEffect(() => {\r\n     if (loading) {\r\n       logger.info('Auth loading state active', {\r\n@@ -380,8 +380,10 @@\n       }\r\n     }\r\n   };\r\n \r\n+  const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n+\r\n   useEffect(() => {\r\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n     return () => unsubscribe();\r\n   }, []);\r\n"
                },
                {
                    "date": 1740683885670,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -31,16 +31,20 @@\n }\r\n \r\n export function useAuth() {\r\n   const context = useContext(AuthContext);\r\n+  const { isTransitioning } = useRoleStore();\r\n   \r\n   if (!context) {\r\n     console.warn('useAuth must be used within an AuthProvider');\r\n     return { user: null, loading: false };\r\n   }\r\n \r\n   const { user, loading } = context;\r\n-\r\n+  const navigate = useNavigate();\r\n+  const queryClient = new QueryClient();\r\n+  const location = useLocation();\r\n+  \r\n   // Add debug logging\r\n   console.log('Auth Context:', {\r\n     hasUser: !!user,\r\n     userRole: user?.role,\r\n@@ -48,13 +52,8 @@\n     isLoading: loading,\r\n     fullUser: user // Log the full user object for debugging\r\n   });\r\n \r\n-  const { isTransitioning } = useRoleStore();\r\n-  const navigate = useNavigate();\r\n-  const queryClient = new QueryClient();\r\n-  const location = useLocation();\r\n-  \r\n   // Add loading state check\r\n   useEffect(() => {\r\n     if (loading) {\r\n       logger.info('Auth loading state active', {\r\n"
                },
                {
                    "date": 1740683921662,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -32,18 +32,18 @@\n \r\n export function useAuth() {\r\n   const context = useContext(AuthContext);\r\n   const { isTransitioning } = useRoleStore();\r\n+  const navigate = useNavigate();\r\n+  const location = useLocation();\r\n   \r\n   if (!context) {\r\n     console.warn('useAuth must be used within an AuthProvider');\r\n     return { user: null, loading: false };\r\n   }\r\n \r\n   const { user, loading } = context;\r\n-  const navigate = useNavigate();\r\n   const queryClient = new QueryClient();\r\n-  const location = useLocation();\r\n   \r\n   // Add debug logging\r\n   console.log('Auth Context:', {\r\n     hasUser: !!user,\r\n"
                },
                {
                    "date": 1740683946924,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,415 @@\n+\"use client\";\r\n+\r\n+import { useContext, useEffect, useState, useCallback, useRef } from 'react';\r\n+import { AuthContext } from '../contexts/AuthContext';\r\n+import { useNavigate, useLocation } from 'react-router-dom';\r\n+import { QueryClient } from '@tanstack/query-core';\r\n+import { roleTransitionManager } from '../lib/auth/RoleTransitionManager';\r\n+import { useRoleStore } from '../lib/auth/store';\r\n+import { logger } from '../lib/logger';\r\n+import { ROLE_PERMISSIONS } from '../types/roles';\r\n+import { sessionManager } from '../lib/auth/sessionManager';\r\n+import type { UserRole } from '../types/roles';\r\n+import { supabaseClient } from '../lib/supabaseClient';\r\n+import { supabase } from '../lib/supabase';\r\n+import { AuthLoader } from '../lib/auth/AuthLoader';\r\n+import type { AuthError } from '@supabase/supabase-js';\r\n+import { sessionMonitor } from '@/lib/auth/SessionMonitor';\r\n+import type { SessionState } from '@/lib/auth/sessionManager';\r\n+\r\n+interface LoginCredentials {\r\n+  email: string;\r\n+  password: string;\r\n+}\r\n+\r\n+interface SignUpCredentials extends LoginCredentials {\r\n+  name?: string;\r\n+}\r\n+\r\n+interface ResetPasswordCredentials {\r\n+  email: string;\r\n+}\r\n+\r\n+export function useAuth() {\r\n+  const context = useContext(AuthContext);\r\n+  const { isTransitioning } = useRoleStore();\r\n+  const navigate = useNavigate();\r\n+  const location = useLocation();\r\n+  \r\n+  if (!context) {\r\n+    console.warn('useAuth must be used within an AuthProvider');\r\n+    return { user: null, loading: false };\r\n+  }\r\n+\r\n+  const { user, loading } = context;\r\n+  const queryClient = new QueryClient();\r\n+  \r\n+  // Add debug logging\r\n+  logger.debug('Auth Context:', {\r\n+    hasUser: !!user,\r\n+    userRole: user?.role,\r\n+    userId: user?.id,\r\n+    isLoading: loading,\r\n+    fullUser: user // Log the full user object for debugging\r\n+  });\r\n+\r\n+  // Add loading state check\r\n+  useEffect(() => {\r\n+    if (loading) {\r\n+      logger.info('Auth loading state active', {\r\n+        source: 'useAuth',\r\n+        context: { loading }\r\n+      });\r\n+    }\r\n+  }, [loading]);\r\n+\r\n+  // Auto-refresh session when it's about to expire\r\n+  useEffect(() => {\r\n+    if (!user) return;\r\n+    const refreshInterval = setInterval(async () => {\r\n+      try {\r\n+        await sessionManager.refreshSession();\r\n+      } catch (err) {\r\n+        logger.error('Failed to refresh session', {\r\n+          source: 'useAuth',\r\n+          context: { error: err }\r\n+        });\r\n+      }\r\n+    }, 4 * 60 * 1000); // Check every 4 minutes\r\n+    \r\n+    return () => {\r\n+      if (refreshInterval) {\r\n+        clearInterval(refreshInterval);\r\n+      }\r\n+    };\r\n+  }, [user]);\r\n+\r\n+  useEffect(() => {\r\n+    if (user) {\r\n+      logger.debug('Auth state check on route change', {\r\n+        source: 'useAuth',\r\n+        context: {\r\n+          role: user.role,\r\n+          path: location.pathname,\r\n+          permissions: ROLE_PERMISSIONS[user.role]?.permissions\r\n+        }\r\n+      });\r\n+    }\r\n+  }, [user, location.pathname]);\r\n+\r\n+  const changeRole = async (newRole: UserRole): Promise<void> => {\r\n+    if (!context.user || isTransitioning) return;\r\n+\r\n+    try {\r\n+      await roleTransitionManager.transitionRole(newRole);\r\n+      \r\n+      // Clear cache and refetch with new role\r\n+      queryClient.clear();\r\n+      await queryClient.resetQueries();\r\n+      \r\n+      // Update context user\r\n+      context.setUser({\r\n+        ...context.user,\r\n+        role: newRole\r\n+      });\r\n+\r\n+      // Navigate to home with fresh data\r\n+      navigate('/', { replace: true });\r\n+    } catch (err) {\r\n+      logger.error('Failed to change role', {\r\n+        source: 'useAuth',\r\n+        context: { error: err }\r\n+      });\r\n+      throw err;\r\n+    }\r\n+  };\r\n+\r\n+  const login = async (credentials: LoginCredentials) => {\r\n+    try {\r\n+      console.log('[Auth] Attempting login:', {\r\n+        email: credentials.email,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+      \r\n+      const { data, error } = await supabaseClient.auth.signInWithPassword({\r\n+        email: credentials.email,\r\n+        password: credentials.password,\r\n+      });\r\n+\r\n+      if (error) {\r\n+        console.error('[Auth] Supabase login error:', {\r\n+          message: error.message,\r\n+          status: error.status,\r\n+          name: error.name,\r\n+          timestamp: new Date().toISOString()\r\n+        });\r\n+        \r\n+        // Provide more specific error messages\r\n+        if (error.message.includes('Invalid login credentials')) {\r\n+          throw new Error('Invalid email or password. Please check your credentials and try again.');\r\n+        }\r\n+        \r\n+        logger.error('Login failed', {\r\n+          context: { \r\n+            error,\r\n+            credentials: { email: credentials.email }\r\n+          },\r\n+          source: 'useAuth'\r\n+        });\r\n+        throw new Error(error.message);\r\n+      }\r\n+\r\n+      console.log('[Auth] Login response:', {\r\n+        hasUser: !!data.user,\r\n+        userId: data.user?.id,\r\n+        userEmail: data.user?.email,\r\n+        metadata: data.user?.user_metadata,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+\r\n+      if (!data.user) {\r\n+        throw new Error('Login successful but user data is missing');\r\n+      }\r\n+\r\n+      // Map Supabase user to our user format\r\n+      const mappedUser = {\r\n+        id: data.user.id,\r\n+        email: data.user.email!,\r\n+        name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\r\n+        role: data.user.user_metadata?.role || 'student',\r\n+        photoUrl: data.user.user_metadata?.avatar_url,\r\n+      };\r\n+\r\n+      console.log('[Auth] Mapped user:', mappedUser);\r\n+\r\n+      context.setUser(mappedUser);\r\n+      return { user: mappedUser };\r\n+    } catch (error) {\r\n+      const errorDetails = error instanceof Error ? {\r\n+        message: error.message,\r\n+        name: error.name,\r\n+        stack: error.stack\r\n+      } : error;\r\n+\r\n+      console.error('[Auth] Login error details:', {\r\n+        error: errorDetails,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+\r\n+      logger.error('Login failed', {\r\n+        context: { \r\n+          error: errorDetails,\r\n+          credentials: { email: credentials.email }\r\n+        },\r\n+        source: 'useAuth'\r\n+      });\r\n+\r\n+      if (error instanceof Error) {\r\n+        throw error;\r\n+      } else {\r\n+        throw new Error('An unexpected error occurred. Please try again.');\r\n+      }\r\n+    }\r\n+  };\r\n+\r\n+  const logout = async () => {\r\n+    try {\r\n+      const { error } = await supabaseClient.auth.signOut();\r\n+      \r\n+      if (error) {\r\n+        throw error;\r\n+      }\r\n+\r\n+      context.setUser(null);\r\n+      queryClient.clear();\r\n+      navigate('/login');\r\n+    } catch (error) {\r\n+      logger.error('Logout failed', {\r\n+        context: { error },\r\n+        source: 'useAuth'\r\n+      });\r\n+      throw error;\r\n+    }\r\n+  };\r\n+\r\n+  const signUp = async (credentials: SignUpCredentials) => {\r\n+    try {\r\n+      console.log('[Auth] Attempting signup:', {\r\n+        email: credentials.email,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+      \r\n+      const { data, error } = await supabaseClient.auth.signUp({\r\n+        email: credentials.email,\r\n+        password: credentials.password,\r\n+        options: {\r\n+          data: {\r\n+            name: credentials.name || credentials.email.split('@')[0],\r\n+            role: 'student'\r\n+          }\r\n+        }\r\n+      });\r\n+\r\n+      if (error) {\r\n+        console.error('[Auth] Supabase signup error:', {\r\n+          message: error.message,\r\n+          status: error.status,\r\n+          name: error.name,\r\n+          timestamp: new Date().toISOString()\r\n+        });\r\n+        \r\n+        logger.error('Signup failed', {\r\n+          context: { \r\n+            error,\r\n+            credentials: { email: credentials.email }\r\n+          },\r\n+          source: 'useAuth'\r\n+        });\r\n+        throw new Error(error.message);\r\n+      }\r\n+\r\n+      console.log('[Auth] Signup response:', {\r\n+        hasUser: !!data.user,\r\n+        userId: data.user?.id,\r\n+        userEmail: data.user?.email,\r\n+        metadata: data.user?.user_metadata,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+\r\n+      if (!data.user) {\r\n+        throw new Error('Signup successful but user data is missing');\r\n+      }\r\n+\r\n+      // Map Supabase user to our user format\r\n+      const mappedUser = {\r\n+        id: data.user.id,\r\n+        email: data.user.email!,\r\n+        name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\r\n+        role: data.user.user_metadata?.role || 'student',\r\n+        photoUrl: data.user.user_metadata?.avatar_url,\r\n+      };\r\n+\r\n+      console.log('[Auth] Mapped user:', mappedUser);\r\n+\r\n+      context.setUser(mappedUser);\r\n+      return { user: mappedUser };\r\n+    } catch (error) {\r\n+      const errorDetails = error instanceof Error ? {\r\n+        message: error.message,\r\n+        name: error.name,\r\n+        stack: error.stack\r\n+      } : error;\r\n+\r\n+      console.error('[Auth] Signup error details:', {\r\n+        error: errorDetails,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+\r\n+      logger.error('Signup failed', {\r\n+        context: { \r\n+          error: errorDetails,\r\n+          credentials: { email: credentials.email }\r\n+        },\r\n+        source: 'useAuth'\r\n+      });\r\n+\r\n+      if (error instanceof Error) {\r\n+        throw error;\r\n+      } else {\r\n+        throw new Error('An unexpected error occurred during signup. Please try again.');\r\n+      }\r\n+    }\r\n+  };\r\n+\r\n+  const resetPassword = async (credentials: ResetPasswordCredentials) => {\r\n+    try {\r\n+      console.log('[Auth] Attempting password reset:', {\r\n+        email: credentials.email,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+      \r\n+      const { data, error } = await supabaseClient.auth.resetPasswordForEmail(\r\n+        credentials.email,\r\n+        { redirectTo: `${window.location.origin}/reset-password` }\r\n+      );\r\n+\r\n+      if (error) {\r\n+        console.error('[Auth] Supabase password reset error:', {\r\n+          message: error.message,\r\n+          status: error.status,\r\n+          name: error.name,\r\n+          timestamp: new Date().toISOString()\r\n+        });\r\n+        \r\n+        logger.error('Password reset failed', {\r\n+          context: { \r\n+            error,\r\n+            credentials: { email: credentials.email }\r\n+          },\r\n+          source: 'useAuth'\r\n+        });\r\n+        throw new Error(error.message);\r\n+      }\r\n+\r\n+      return data;\r\n+    } catch (error) {\r\n+      const errorDetails = error instanceof Error ? {\r\n+        message: error.message,\r\n+        name: error.name,\r\n+        stack: error.stack\r\n+      } : error;\r\n+\r\n+      console.error('[Auth] Password reset error details:', {\r\n+        error: errorDetails,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+\r\n+      logger.error('Password reset failed', {\r\n+        context: { \r\n+          error: errorDetails,\r\n+          credentials: { email: credentials.email }\r\n+        },\r\n+        source: 'useAuth'\r\n+      });\r\n+\r\n+      if (error instanceof Error) {\r\n+        throw error;\r\n+      } else {\r\n+        throw new Error('An unexpected error occurred during password reset. Please try again.');\r\n+      }\r\n+    }\r\n+  };\r\n+\r\n+  const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n+\r\n+  useEffect(() => {\r\n+    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n+    return () => unsubscribe();\r\n+  }, []);\r\n+\r\n+  const checkAndRefreshSession = async (): Promise<void> => {\r\n+    try {\r\n+      await sessionManager.checkAndRefreshSession();\r\n+    } catch (error) {\r\n+      logger.error('Failed to check and refresh session', {\r\n+        context: { error },\r\n+        source: 'useAuth'\r\n+      });\r\n+    }\r\n+  };\r\n+\r\n+  return {\r\n+    user: user ? {\r\n+      ...user,\r\n+      role: user.role || 'unknown'\r\n+    } : null,\r\n+    loading,\r\n+    changeRole,\r\n+    isTransitioning,\r\n+    login,\r\n+    logout,\r\n+    signUp,\r\n+    resetPassword,\r\n+    sessionManager\r\n+  };\r\n+}\n\\ No newline at end of file\n"
                },
                {
                    "date": 1740683970661,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -44,423 +44,8 @@\n   const { user, loading } = context;\r\n   const queryClient = new QueryClient();\r\n   \r\n   // Add debug logging\r\n-  logger.debug('Auth Context:', {\r\n-    hasUser: !!user,\r\n-    userRole: user?.role,\r\n-    userId: user?.id,\r\n-    isLoading: loading,\r\n-    fullUser: user // Log the full user object for debugging\r\n-  });\r\n-\r\n-  // Add loading state check\r\n-  useEffect(() => {\r\n-    if (loading) {\r\n-      logger.info('Auth loading state active', {\r\n-        source: 'useAuth',\r\n-        context: { loading }\r\n-      });\r\n-    }\r\n-  }, [loading]);\r\n-\r\n-  // Auto-refresh session when it's about to expire\r\n-  useEffect(() => {\r\n-    if (!user) return;\r\n-    const refreshInterval = setInterval(async () => {\r\n-      try {\r\n-        await sessionManager.refreshSession();\r\n-      } catch (err) {\r\n-        logger.error('Failed to refresh session', {\r\n-          source: 'useAuth',\r\n-          context: { error: err }\r\n-        });\r\n-      }\r\n-    }, 4 * 60 * 1000); // Check every 4 minutes\r\n-    \r\n-    return () => {\r\n-      if (refreshInterval) {\r\n-        clearInterval(refreshInterval);\r\n-      }\r\n-    };\r\n-  }, [user]);\r\n-\r\n-  useEffect(() => {\r\n-    if (user) {\r\n-      logger.debug('Auth state check on route change', {\r\n-        source: 'useAuth',\r\n-        context: {\r\n-          role: user.role,\r\n-          path: location.pathname,\r\n-          permissions: ROLE_PERMISSIONS[user.role]?.permissions\r\n-        }\r\n-      });\r\n-    }\r\n-  }, [user, location.pathname]);\r\n-\r\n-  const changeRole = async (newRole: UserRole): Promise<void> => {\r\n-    if (!context.user || isTransitioning) return;\r\n-\r\n-    try {\r\n-      await roleTransitionManager.transitionRole(newRole);\r\n-      \r\n-      // Clear cache and refetch with new role\r\n-      queryClient.clear();\r\n-      await queryClient.resetQueries();\r\n-      \r\n-      // Update context user\r\n-      context.setUser({\r\n-        ...context.user,\r\n-        role: newRole\r\n-      });\r\n-\r\n-      // Navigate to home with fresh data\r\n-      navigate('/', { replace: true });\r\n-    } catch (err) {\r\n-      logger.error('Failed to change role', {\r\n-        source: 'useAuth',\r\n-        context: { error: err }\r\n-      });\r\n-      throw err;\r\n-    }\r\n-  };\r\n-\r\n-  const login = async (credentials: LoginCredentials) => {\r\n-    try {\r\n-      console.log('[Auth] Attempting login:', {\r\n-        email: credentials.email,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-      \r\n-      const { data, error } = await supabaseClient.auth.signInWithPassword({\r\n-        email: credentials.email,\r\n-        password: credentials.password,\r\n-      });\r\n-\r\n-      if (error) {\r\n-        console.error('[Auth] Supabase login error:', {\r\n-          message: error.message,\r\n-          status: error.status,\r\n-          name: error.name,\r\n-          timestamp: new Date().toISOString()\r\n-        });\r\n-        \r\n-        // Provide more specific error messages\r\n-        if (error.message.includes('Invalid login credentials')) {\r\n-          throw new Error('Invalid email or password. Please check your credentials and try again.');\r\n-        }\r\n-        \r\n-        logger.error('Login failed', {\r\n-          context: { \r\n-            error,\r\n-            credentials: { email: credentials.email }\r\n-          },\r\n-          source: 'useAuth'\r\n-        });\r\n-        throw new Error(error.message);\r\n-      }\r\n-\r\n-      console.log('[Auth] Login response:', {\r\n-        hasUser: !!data.user,\r\n-        userId: data.user?.id,\r\n-        userEmail: data.user?.email,\r\n-        metadata: data.user?.user_metadata,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-\r\n-      if (!data.user) {\r\n-        throw new Error('Login successful but user data is missing');\r\n-      }\r\n-\r\n-      // Map Supabase user to our user format\r\n-      const mappedUser = {\r\n-        id: data.user.id,\r\n-        email: data.user.email!,\r\n-        name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\r\n-        role: data.user.user_metadata?.role || 'student',\r\n-        photoUrl: data.user.user_metadata?.avatar_url,\r\n-      };\r\n-\r\n-      console.log('[Auth] Mapped user:', mappedUser);\r\n-\r\n-      context.setUser(mappedUser);\r\n-      return { user: mappedUser };\r\n-    } catch (error) {\r\n-      const errorDetails = error instanceof Error ? {\r\n-        message: error.message,\r\n-        name: error.name,\r\n-        stack: error.stack\r\n-      } : error;\r\n-\r\n-      console.error('[Auth] Login error details:', {\r\n-        error: errorDetails,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-\r\n-      logger.error('Login failed', {\r\n-        context: { \r\n-          error: errorDetails,\r\n-          credentials: { email: credentials.email }\r\n-        },\r\n-        source: 'useAuth'\r\n-      });\r\n-\r\n-      if (error instanceof Error) {\r\n-        throw error;\r\n-      } else {\r\n-        throw new Error('An unexpected error occurred. Please try again.');\r\n-      }\r\n-    }\r\n-  };\r\n-\r\n-  const logout = async () => {\r\n-    try {\r\n-      const { error } = await supabaseClient.auth.signOut();\r\n-      \r\n-      if (error) {\r\n-        throw error;\r\n-      }\r\n-\r\n-      context.setUser(null);\r\n-      queryClient.clear();\r\n-      navigate('/login');\r\n-    } catch (error) {\r\n-      logger.error('Logout failed', {\r\n-        context: { error },\r\n-        source: 'useAuth'\r\n-      });\r\n-      throw error;\r\n-    }\r\n-  };\r\n-\r\n-  const signUp = async (credentials: SignUpCredentials) => {\r\n-    try {\r\n-      console.log('[Auth] Attempting signup:', {\r\n-        email: credentials.email,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-      \r\n-      const { data, error } = await supabaseClient.auth.signUp({\r\n-        email: credentials.email,\r\n-        password: credentials.password,\r\n-        options: {\r\n-          data: {\r\n-            name: credentials.name || credentials.email.split('@')[0],\r\n-            role: 'student'\r\n-          }\r\n-        }\r\n-      });\r\n-\r\n-      if (error) {\r\n-        console.error('[Auth] Supabase signup error:', {\r\n-          message: error.message,\r\n-          status: error.status,\r\n-          name: error.name,\r\n-          timestamp: new Date().toISOString()\r\n-        });\r\n-        \r\n-        logger.error('Signup failed', {\r\n-          context: { \r\n-            error,\r\n-            credentials: { email: credentials.email }\r\n-          },\r\n-          source: 'useAuth'\r\n-        });\r\n-        throw new Error(error.message);\r\n-      }\r\n-\r\n-      console.log('[Auth] Signup response:', {\r\n-        hasUser: !!data.user,\r\n-        userId: data.user?.id,\r\n-        userEmail: data.user?.email,\r\n-        metadata: data.user?.user_metadata,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-\r\n-      if (!data.user) {\r\n-        throw new Error('Signup successful but user data is missing');\r\n-      }\r\n-\r\n-      // Map Supabase user to our user format\r\n-      const mappedUser = {\r\n-        id: data.user.id,\r\n-        email: data.user.email!,\r\n-        name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\r\n-        role: data.user.user_metadata?.role || 'student',\r\n-        photoUrl: data.user.user_metadata?.avatar_url,\r\n-      };\r\n-\r\n-      console.log('[Auth] Mapped user:', mappedUser);\r\n-\r\n-      context.setUser(mappedUser);\r\n-      return { user: mappedUser };\r\n-    } catch (error) {\r\n-      const errorDetails = error instanceof Error ? {\r\n-        message: error.message,\r\n-        name: error.name,\r\n-        stack: error.stack\r\n-      } : error;\r\n-\r\n-      console.error('[Auth] Signup error details:', {\r\n-        error: errorDetails,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-\r\n-      logger.error('Signup failed', {\r\n-        context: { \r\n-          error: errorDetails,\r\n-          credentials: { email: credentials.email }\r\n-        },\r\n-        source: 'useAuth'\r\n-      });\r\n-\r\n-      if (error instanceof Error) {\r\n-        throw error;\r\n-      } else {\r\n-        throw new Error('An unexpected error occurred during signup. Please try again.');\r\n-      }\r\n-    }\r\n-  };\r\n-\r\n-  const resetPassword = async (credentials: ResetPasswordCredentials) => {\r\n-    try {\r\n-      console.log('[Auth] Attempting password reset:', {\r\n-        email: credentials.email,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-      \r\n-      const { data, error } = await supabaseClient.auth.resetPasswordForEmail(\r\n-        credentials.email,\r\n-        { redirectTo: `${window.location.origin}/reset-password` }\r\n-      );\r\n-\r\n-      if (error) {\r\n-        console.error('[Auth] Supabase password reset error:', {\r\n-          message: error.message,\r\n-          status: error.status,\r\n-          name: error.name,\r\n-          timestamp: new Date().toISOString()\r\n-        });\r\n-        \r\n-        logger.error('Password reset failed', {\r\n-          context: { \r\n-            error,\r\n-            credentials: { email: credentials.email }\r\n-          },\r\n-          source: 'useAuth'\r\n-        });\r\n-        throw new Error(error.message);\r\n-      }\r\n-\r\n-      return data;\r\n-    } catch (error) {\r\n-      const errorDetails = error instanceof Error ? {\r\n-        message: error.message,\r\n-        name: error.name,\r\n-        stack: error.stack\r\n-      } : error;\r\n-\r\n-      console.error('[Auth] Password reset error details:', {\r\n-        error: errorDetails,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-\r\n-      logger.error('Password reset failed', {\r\n-        context: { \r\n-          error: errorDetails,\r\n-          credentials: { email: credentials.email }\r\n-        },\r\n-        source: 'useAuth'\r\n-      });\r\n-\r\n-      if (error instanceof Error) {\r\n-        throw error;\r\n-      } else {\r\n-        throw new Error('An unexpected error occurred during password reset. Please try again.');\r\n-      }\r\n-    }\r\n-  };\r\n-\r\n-  const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n-\r\n-  useEffect(() => {\r\n-    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n-    return () => unsubscribe();\r\n-  }, []);\r\n-\r\n-  const checkAndRefreshSession = async (): Promise<void> => {\r\n-    try {\r\n-      await sessionManager.checkAndRefreshSession();\r\n-    } catch (error) {\r\n-      logger.error('Failed to check and refresh session', {\r\n-        context: { error },\r\n-        source: 'useAuth'\r\n-      });\r\n-    }\r\n-  };\r\n-\r\n-  return {\r\n-    user: user ? {\r\n-      ...user,\r\n-      role: user.role || 'unknown'\r\n-    } : null,\r\n-    loading,\r\n-    changeRole,\r\n-    isTransitioning,\r\n-    login,\r\n-    logout,\r\n-    signUp,\r\n-    resetPassword,\r\n-    sessionManager\r\n-  };\r\n-}\n-\"use client\";\r\n-\r\n-import { useContext, useEffect, useState, useCallback, useRef } from 'react';\r\n-import { AuthContext } from '../contexts/AuthContext';\r\n-import { useNavigate, useLocation } from 'react-router-dom';\r\n-import { QueryClient } from '@tanstack/query-core';\r\n-import { roleTransitionManager } from '../lib/auth/RoleTransitionManager';\r\n-import { useRoleStore } from '../lib/auth/store';\r\n-import { logger } from '../lib/logger';\r\n-import { ROLE_PERMISSIONS } from '../types/roles';\r\n-import { sessionManager } from '../lib/auth/sessionManager';\r\n-import type { UserRole } from '../types/roles';\r\n-import { supabaseClient } from '../lib/supabaseClient';\r\n-import { supabase } from '../lib/supabase';\r\n-import { AuthLoader } from '../lib/auth/AuthLoader';\r\n-import type { AuthError } from '@supabase/supabase-js';\r\n-import { sessionMonitor } from '@/lib/auth/SessionMonitor';\r\n-import type { SessionState } from '@/lib/auth/sessionManager';\r\n-\r\n-interface LoginCredentials {\r\n-  email: string;\r\n-  password: string;\r\n-}\r\n-\r\n-interface SignUpCredentials extends LoginCredentials {\r\n-  name?: string;\r\n-}\r\n-\r\n-interface ResetPasswordCredentials {\r\n-  email: string;\r\n-}\r\n-\r\n-export function useAuth() {\r\n-  const context = useContext(AuthContext);\r\n-  const { isTransitioning } = useRoleStore();\r\n-  const navigate = useNavigate();\r\n-  const location = useLocation();\r\n-  \r\n-  if (!context) {\r\n-    console.warn('useAuth must be used within an AuthProvider');\r\n-    return { user: null, loading: false };\r\n-  }\r\n-\r\n-  const { user, loading } = context;\r\n-  const queryClient = new QueryClient();\r\n-  \r\n-  // Add debug logging\r\n   console.log('Auth Context:', {\r\n     hasUser: !!user,\r\n     userRole: user?.role,\r\n     userId: user?.id,\r\n"
                },
                {
                    "date": 1740683992769,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -44,9 +44,20 @@\n   const { user, loading } = context;\r\n   const queryClient = new QueryClient();\r\n   \r\n   // Add debug logging\r\n-  console.log('Auth Context:', {\r\n+  console.log('Auth Context:', {```xml\r\n+user, loading, isTransitioning, location, navigate, queryClient, sessionMonitor);\r\n+  const logger = useLogger();\r\n+\r\n+  const login = async (credentials: LoginCredentials): Promise<AuthError | null> => {\r\n+    const { email, password } = credentials;\r\n+    const { error } = await supabase.auth.signInWithPassword({\r\n+      email,\r\n+      password,\r\n+    });\r\n+\r\n+    if (error) {\r\n     hasUser: !!user,\r\n     userRole: user?.role,\r\n     userId: user?.id,\r\n     isLoading: loading,\r\n"
                },
                {
                    "date": 1740684000006,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -44,20 +44,21 @@\n   const { user, loading } = context;\r\n   const queryClient = new QueryClient();\r\n   \r\n   // Add debug logging\r\n-  console.log('Auth Context:', {```xml\r\n-user, loading, isTransitioning, location, navigate, queryClient, sessionMonitor);\r\n-  const logger = useLogger();\r\n+  console.log('Auth Context:', {\r\n+    hasUser: !!user,\r\n+    userRole: user?.role,\r\n+    userId: user?.id,\r\n+    isLoading: loading,\r\n+    fullUser: user // Log the full user object for debugging\r\n+  });\r\n \r\n-  const login = async (credentials: LoginCredentials): Promise<AuthError | null> => {\r\n-    const { email, password } = credentials;\r\n-    const { error } = await supabase.auth.signInWithPassword({\r\n-      email,\r\n-      password,\r\n-    });\r\n-\r\n-    if (error) {\r\n+  // Add loading state check\r\n+  useEffect(() => {\r\n+    if (loading || isTransitioning) {\r\n+      return;\r\n+    }e.log('Auth Context:', {\r\n     hasUser: !!user,\r\n     userRole: user?.role,\r\n     userId: user?.id,\r\n     isLoading: loading,\r\n"
                },
                {
                    "date": 1740684009154,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -56,12 +56,14 @@\n   // Add loading state check\r\n   useEffect(() => {\r\n     if (loading || isTransitioning) {\r\n       return;\r\n-    }e.log('Auth Context:', {\r\n-    hasUser: !!user,\r\n-    userRole: user?.role,\r\n-    userId: user?.id,\r\n+    }\r\n+\r\n+    logger.info('Auth Context:', {\r\n+      hasUser: !!user,\r\n+      userRole: user?.role,\r\n+      userId: user?.id,\r\n     isLoading: loading,\r\n     fullUser: user // Log the full user object for debugging\r\n   });\r\n \r\n"
                },
                {
                    "date": 1740684021451,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -54,22 +54,8 @@\n   });\r\n \r\n   // Add loading state check\r\n   useEffect(() => {\r\n-    if (loading || isTransitioning) {\r\n-      return;\r\n-    }\r\n-\r\n-    logger.info('Auth Context:', {\r\n-      hasUser: !!user,\r\n-      userRole: user?.role,\r\n-      userId: user?.id,\r\n-    isLoading: loading,\r\n-    fullUser: user // Log the full user object for debugging\r\n-  });\r\n-\r\n-  // Add loading state check\r\n-  useEffect(() => {\r\n     if (loading) {\r\n       logger.info('Auth loading state active', {\r\n         source: 'useAuth',\r\n         context: { loading }\r\n"
                },
                {
                    "date": 1740684044019,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -53,8 +53,20 @@\n     fullUser: user // Log the full user object for debugging\r\n   });\r\n \r\n   // Add loading state check\r\n+  useEffect() => {\r\n+    if (loading || isTransitioning) {\r\n+      return;\r\n+    }e.log('Auth Context:', {\r\n+    hasUser: !!user,\r\n+    userRole: user?.role,\r\n+    userId: user?.id,\r\n+    isLoading: loading,\r\n+    fullUser: user // Log the full user object for debugging\r\n+  });\r\n+\r\n+  // Add loading state check\r\n   useEffect(() => {\r\n     if (loading) {\r\n       logger.info('Auth loading state active', {\r\n         source: 'useAuth',\r\n"
                },
                {
                    "date": 1740684052818,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -53,15 +53,17 @@\n     fullUser: user // Log the full user object for debugging\r\n   });\r\n \r\n   // Add loading state check\r\n-  useEffect() => {\r\n+  useEffect(() => {\r\n     if (loading || isTransitioning) {\r\n       return;\r\n-    }e.log('Auth Context:', {\r\n-    hasUser: !!user,\r\n-    userRole: user?.role,\r\n-    userId: user?.id,\r\n+    }\r\n+\r\n+    console.log('Auth Context:', {\r\n+      hasUser: !!user,\r\n+      userRole: user?.role,\r\n+      userId: user?.id,\r\n     isLoading: loading,\r\n     fullUser: user // Log the full user object for debugging\r\n   });\r\n \r\n"
                },
                {
                    "date": 1740684113419,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -425,5 +425,5 @@\n     signUp,\r\n     resetPassword,\r\n     sessionManager\r\n   };\r\n-}\n\\ No newline at end of file\n+}}\n\\ No newline at end of file\n"
                },
                {
                    "date": 1740684125772,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -425,5 +425,13 @@\n     signUp,\r\n     resetPassword,\r\n     sessionManager\r\n   };\r\n-}}\n\\ No newline at end of file\n+}const authContextValue = useMemo(() => ({\r\n+    user: authState.user,\r\n+    isAuthenticated: authState.isAuthenticated,\r\n+    isLoading: authState.isLoading,\r\n+    checkAndRefreshSession,\r\n+    ...authFunctions\r\n+  }), [authState, authFunctions, checkAndRefreshSession]);\r\n+\r\n+  return authContextValue;\n\\ No newline at end of file\n"
                },
                {
                    "date": 1740684132872,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -425,13 +425,5 @@\n     signUp,\r\n     resetPassword,\r\n     sessionManager\r\n   };\r\n-}const authContextValue = useMemo(() => ({\r\n-    user: authState.user,\r\n-    isAuthenticated: authState.isAuthenticated,\r\n-    isLoading: authState.isLoading,\r\n-    checkAndRefreshSession,\r\n-    ...authFunctions\r\n-  }), [authState, authFunctions, checkAndRefreshSession]);\r\n-\r\n-  return authContextValue;\n\\ No newline at end of file\n+}\n\\ No newline at end of file\n"
                },
                {
                    "date": 1740684164696,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -425,5 +425,5 @@\n     signUp,\r\n     resetPassword,\r\n     sessionManager\r\n   };\r\n-}\n\\ No newline at end of file\n+})\n\\ No newline at end of file\n"
                },
                {
                    "date": 1740684181746,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -425,5 +425,5 @@\n     signUp,\r\n     resetPassword,\r\n     sessionManager\r\n   };\r\n-})\n\\ No newline at end of file\n+}};\n\\ No newline at end of file\n"
                },
                {
                    "date": 1740684186963,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -425,5 +425,5 @@\n     signUp,\r\n     resetPassword,\r\n     sessionManager\r\n   };\r\n-}};\n\\ No newline at end of file\n+},}\n\\ No newline at end of file\n"
                },
                {
                    "date": 1740684213306,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -425,5 +425,5 @@\n     signUp,\r\n     resetPassword,\r\n     sessionManager\r\n   };\r\n-},}\n\\ No newline at end of file\n+}\n\\ No newline at end of file\n"
                },
                {
                    "date": 1740684287419,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -29,9 +29,9 @@\n interface ResetPasswordCredentials {\r\n   email: string;\r\n }\r\n \r\n-export function useAuth() {\r\n+export function useAuth() \r\n   const context = useContext(AuthContext);\r\n   const { isTransitioning } = useRoleStore();\r\n   const navigate = useNavigate();\r\n   const location = useLocation();\r\n"
                },
                {
                    "date": 1740684293388,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -29,9 +29,9 @@\n interface ResetPasswordCredentials {\r\n   email: string;\r\n }\r\n \r\n-export function useAuth() \r\n+export function useAuth() {\r\n   const context = useContext(AuthContext);\r\n   const { isTransitioning } = useRoleStore();\r\n   const navigate = useNavigate();\r\n   const location = useLocation();\r\n"
                },
                {
                    "date": 1740684299130,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -27,9 +27,9 @@\n }\r\n \r\n interface ResetPasswordCredentials {\r\n   email: string;\r\n-}\r\n+  }\r\n \r\n export function useAuth() {\r\n   const context = useContext(AuthContext);\r\n   const { isTransitioning } = useRoleStore();\r\n"
                },
                {
                    "date": 1740684309996,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -35,8 +35,9 @@\n   const { isTransitioning } = useRoleStore();\r\n   const navigate = useNavigate();\r\n   const location = useLocation();\r\n   \r\n+  \r\n   if (!context) {\r\n     console.warn('useAuth must be used within an AuthProvider');\r\n     return { user: null, loading: false };\r\n   }\r\n"
                },
                {
                    "date": 1740684319307,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -34,8 +34,9 @@\n   const context = useContext(AuthContext);\r\n   const { isTransitioning } = useRoleStore();\r\n   const navigate = useNavigate();\r\n   const location = useLocation();\r\n+  const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n   \r\n   \r\n   if (!context) {\r\n     console.warn('useAuth must be used within an AuthProvider');\r\n"
                },
                {
                    "date": 1740684360314,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -35,10 +35,10 @@\n   const { isTransitioning } = useRoleStore();\r\n   const navigate = useNavigate();\r\n   const location = useLocation();\r\n   const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n+\r\n   \r\n-  \r\n   if (!context) {\r\n     console.warn('useAuth must be used within an AuthProvider');\r\n     return { user: null, loading: false };\r\n   }\r\n@@ -427,5 +427,5 @@\n     signUp,\r\n     resetPassword,\r\n     sessionManager\r\n   };\r\n-}\n\\ No newline at end of file\n+},\n\\ No newline at end of file\n"
                },
                {
                    "date": 1740684369806,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -427,5 +427,6 @@\n     signUp,\r\n     resetPassword,\r\n     sessionManager\r\n   };\r\n-},\n\\ No newline at end of file\n+}\r\n+}\n\\ No newline at end of file\n"
                },
                {
                    "date": 1740684398435,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -393,10 +393,19 @@\n       } else {\r\n         throw new Error('An unexpected error occurred during password reset. Please try again.');\r\n       }\r\n     }\r\n-  };\r\n+  }async function resetPassword(credentials) {\r\n+    try {\r\n+      const { data, error } = await supabase.auth.resetPasswordForEmail(credentials.email, {\r\n+        redirectTo: `${window.location.origin}/reset-password-conf\r\n+      });\r\n \r\n+      if (error) {\r\n+        console.error('[Auth] Password reset error:', error);\r\n+        logger.error('Password reset failed', {\r\n+          context: {;\r\n+\r\n   const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n \r\n   useEffect(() => {\r\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n@@ -427,6 +436,6 @@\n     signUp,\r\n     resetPassword,\r\n     sessionManager\r\n   };\r\n-}\r\n+})\r\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1740684422439,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -393,19 +393,10 @@\n       } else {\r\n         throw new Error('An unexpected error occurred during password reset. Please try again.');\r\n       }\r\n     }\r\n-  }async function resetPassword(credentials) {\r\n-    try {\r\n-      const { data, error } = await supabase.auth.resetPasswordForEmail(credentials.email, {\r\n-        redirectTo: `${window.location.origin}/reset-password-conf\r\n-      });\r\n+  };\r\n \r\n-      if (error) {\r\n-        console.error('[Auth] Password reset error:', error);\r\n-        logger.error('Password reset failed', {\r\n-          context: {;\r\n-\r\n   const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n \r\n   useEffect(() => {\r\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n"
                },
                {
                    "date": 1740684441115,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -35,10 +35,15 @@\n   const { isTransitioning } = useRoleStore();\r\n   const navigate = useNavigate();\r\n   const location = useLocation();\r\n   const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n-\r\n   \r\n+  // Subscribe to session state updates\r\n+  useEffect(() => {\r\n+    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n+    return () => unsubscribe();\r\n+  }, []);\r\n+  \r\n   if (!context) {\r\n     console.warn('useAuth must be used within an AuthProvider');\r\n     return { user: null, loading: false };\r\n   }\r\n@@ -395,15 +400,8 @@\n       }\r\n     }\r\n   };\r\n \r\n-  const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n-\r\n-  useEffect(() => {\r\n-    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n-    return () => unsubscribe();\r\n-  }, []);\r\n-\r\n   const checkAndRefreshSession = async (): Promise<void> => {\r\n     try {\r\n       await sessionManager.checkAndRefreshSession();\r\n     } catch (error) {\r\n@@ -427,6 +425,5 @@\n     signUp,\r\n     resetPassword,\r\n     sessionManager\r\n   };\r\n-})\r\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1740684475575,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -29,9 +29,26 @@\n interface ResetPasswordCredentials {\r\n   email: string;\r\n   }\r\n \r\n-export function useAuth() {\r\n+export function useAuth() if (!context) {\r\n+    throw new Error('useAuth must be used within an AuthProvider');\r\n+  }\r\n+\r\n+  const {\r\n+    signIn,\r\n+    signUp,\r\n+    signOut,\r\n+    resetPassword,\r\n+    updateUser,\r\n+    transitionRole,\r\n+    user,\r\n+    session,\r\n+    loading,\r\n+    error,\r\n+    authLoader,\r\n+    setAuthLoader,\r\n+  } = context;{\r\n   const context = useContext(AuthContext);\r\n   const { isTransitioning } = useRoleStore();\r\n   const navigate = useNavigate();\r\n   const location = useLocation();\r\n"
                },
                {
                    "date": 1740684492401,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -29,26 +29,9 @@\n interface ResetPasswordCredentials {\r\n   email: string;\r\n   }\r\n \r\n-export function useAuth() if (!context) {\r\n-    throw new Error('useAuth must be used within an AuthProvider');\r\n-  }\r\n-\r\n-  const {\r\n-    signIn,\r\n-    signUp,\r\n-    signOut,\r\n-    resetPassword,\r\n-    updateUser,\r\n-    transitionRole,\r\n-    user,\r\n-    session,\r\n-    loading,\r\n-    error,\r\n-    authLoader,\r\n-    setAuthLoader,\r\n-  } = context;{\r\n+export function useAuth() {\r\n   const context = useContext(AuthContext);\r\n   const { isTransitioning } = useRoleStore();\r\n   const navigate = useNavigate();\r\n   const location = useLocation();\r\n"
                },
                {
                    "date": 1740684511123,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -400,8 +400,15 @@\n       }\r\n     }\r\n   };\r\n \r\n+  const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n+\r\n+  useEffect(() => {\r\n+    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n+    return () => unsubscribe();\r\n+  }, []);\r\n+\r\n   const checkAndRefreshSession = async (): Promise<void> => {\r\n     try {\r\n       await sessionManager.checkAndRefreshSession();\r\n     } catch (error) {\r\n@@ -425,5 +432,6 @@\n     signUp,\r\n     resetPassword,\r\n     sessionManager\r\n   };\r\n+})\r\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1740684534990,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -432,6 +432,5 @@\n     signUp,\r\n     resetPassword,\r\n     sessionManager\r\n   };\r\n-})\r\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1740684581468,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -71,9 +71,9 @@\n       userRole: user?.role,\r\n       userId: user?.id,\r\n     isLoading: loading,\r\n     fullUser: user // Log the full user object for debugging\r\n-  });\r\n+  }));\r\n \r\n   // Add loading state check\r\n   useEffect(() => {\r\n     if (loading) {\r\n"
                },
                {
                    "date": 1740684588578,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -71,9 +71,9 @@\n       userRole: user?.role,\r\n       userId: user?.id,\r\n     isLoading: loading,\r\n     fullUser: user // Log the full user object for debugging\r\n-  }));\r\n+  }),);\r\n \r\n   // Add loading state check\r\n   useEffect(() => {\r\n     if (loading) {\r\n"
                },
                {
                    "date": 1740684595791,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -71,9 +71,9 @@\n       userRole: user?.role,\r\n       userId: user?.id,\r\n     isLoading: loading,\r\n     fullUser: user // Log the full user object for debugging\r\n-  }),);\r\n+  }), false;);\r\n \r\n   // Add loading state check\r\n   useEffect(() => {\r\n     if (loading) {\r\n"
                },
                {
                    "date": 1740684617388,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -71,9 +71,9 @@\n       userRole: user?.role,\r\n       userId: user?.id,\r\n     isLoading: loading,\r\n     fullUser: user // Log the full user object for debugging\r\n-  }), false;);\r\n+  });\r\n \r\n   // Add loading state check\r\n   useEffect(() => {\r\n     if (loading) {\r\n"
                },
                {
                    "date": 1740684660755,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -72,8 +72,9 @@\n       userId: user?.id,\r\n     isLoading: loading,\r\n     fullUser: user // Log the full user object for debugging\r\n   });\r\n+  \r\n \r\n   // Add loading state check\r\n   useEffect(() => {\r\n     if (loading) {\r\n"
                },
                {
                    "date": 1740684669727,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -72,9 +72,9 @@\n       userId: user?.id,\r\n     isLoading: loading,\r\n     fullUser: user // Log the full user object for debugging\r\n   });\r\n-  \r\n+});\r\n \r\n   // Add loading state check\r\n   useEffect(() => {\r\n     if (loading) {\r\n"
                },
                {
                    "date": 1740684701164,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -42,8 +42,23 @@\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n     return () => unsubscribe();\r\n   }, []);\r\n   \r\n+  // Add loading state check\r\n+  useEffect(() => {\r\n+    if (loading || isTransitioning) {\r\n+      return;\r\n+    }\r\n+\r\n+    console.log('Auth Context:', {\r\n+      hasUser: !!user,\r\n+      userRole: user?.role,\r\n+      userId: user?.id,\r\n+      isLoading: loading,\r\n+      fullUser: user // Log the full user object for debugging\r\n+    });\r\n+  }, [loading, isTransitioning]);\r\n+\r\n   if (!context) {\r\n     console.warn('useAuth must be used within an AuthProvider');\r\n     return { user: null, loading: false };\r\n   }\r\n"
                },
                {
                    "date": 1740684730396,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -76,23 +76,8 @@\n   });\r\n \r\n   // Add loading state check\r\n   useEffect(() => {\r\n-    if (loading || isTransitioning) {\r\n-      return;\r\n-    }\r\n-\r\n-    console.log('Auth Context:', {\r\n-      hasUser: !!user,\r\n-      userRole: user?.role,\r\n-      userId: user?.id,\r\n-    isLoading: loading,\r\n-    fullUser: user // Log the full user object for debugging\r\n-  });\r\n-});\r\n-\r\n-  // Add loading state check\r\n-  useEffect(() => {\r\n     if (loading) {\r\n       logger.info('Auth loading state active', {\r\n         source: 'useAuth',\r\n         context: { loading }\r\n@@ -416,15 +401,8 @@\n       }\r\n     }\r\n   };\r\n \r\n-  const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n-\r\n-  useEffect(() => {\r\n-    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n-    return () => unsubscribe();\r\n-  }, []);\r\n-\r\n   const checkAndRefreshSession = async (): Promise<void> => {\r\n     try {\r\n       await sessionManager.checkAndRefreshSession();\r\n     } catch (error) {\r\n"
                },
                {
                    "date": 1740684766105,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -42,23 +42,8 @@\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n     return () => unsubscribe();\r\n   }, []);\r\n   \r\n-  // Add loading state check\r\n-  useEffect(() => {\r\n-    if (loading || isTransitioning) {\r\n-      return;\r\n-    }\r\n-\r\n-    console.log('Auth Context:', {\r\n-      hasUser: !!user,\r\n-      userRole: user?.role,\r\n-      userId: user?.id,\r\n-      isLoading: loading,\r\n-      fullUser: user // Log the full user object for debugging\r\n-    });\r\n-  }, [loading, isTransitioning]);\r\n-\r\n   if (!context) {\r\n     console.warn('useAuth must be used within an AuthProvider');\r\n     return { user: null, loading: false };\r\n   }\r\n@@ -76,8 +61,23 @@\n   });\r\n \r\n   // Add loading state check\r\n   useEffect(() => {\r\n+    if (loading || isTransitioning) {\r\n+      return;\r\n+    }\r\n+\r\n+    console.log('Auth Context:', {\r\n+      hasUser: !!user,\r\n+      userRole: user?.role,\r\n+      userId: user?.id,\r\n+    isLoading: loading,\r\n+    fullUser: user // Log the full user object for debugging\r\n+  });\r\n+});\r\n+\r\n+  // Add loading state check\r\n+  useEffect(() => {\r\n     if (loading) {\r\n       logger.info('Auth loading state active', {\r\n         source: 'useAuth',\r\n         context: { loading }\r\n@@ -401,8 +401,15 @@\n       }\r\n     }\r\n   };\r\n \r\n+  const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n+\r\n+  useEffect(() => {\r\n+    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n+    return () => unsubscribe();\r\n+  }, []);\r\n+\r\n   const checkAndRefreshSession = async (): Promise<void> => {\r\n     try {\r\n       await sessionManager.checkAndRefreshSession();\r\n     } catch (error) {\r\n"
                },
                {
                    "date": 1740684773287,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -42,8 +42,23 @@\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n     return () => unsubscribe();\r\n   }, []);\r\n   \r\n+  // Add loading state check\r\n+  useEffect(() => {\r\n+    if (loading || isTransitioning) {\r\n+      return;\r\n+    }\r\n+\r\n+    console.log('Auth Context:', {\r\n+      hasUser: !!user,\r\n+      userRole: user?.role,\r\n+      userId: user?.id,\r\n+      isLoading: loading,\r\n+      fullUser: user // Log the full user object for debugging\r\n+    });\r\n+  }, [loading, isTransitioning]);\r\n+\r\n   if (!context) {\r\n     console.warn('useAuth must be used within an AuthProvider');\r\n     return { user: null, loading: false };\r\n   }\r\n@@ -61,23 +76,8 @@\n   });\r\n \r\n   // Add loading state check\r\n   useEffect(() => {\r\n-    if (loading || isTransitioning) {\r\n-      return;\r\n-    }\r\n-\r\n-    console.log('Auth Context:', {\r\n-      hasUser: !!user,\r\n-      userRole: user?.role,\r\n-      userId: user?.id,\r\n-    isLoading: loading,\r\n-    fullUser: user // Log the full user object for debugging\r\n-  });\r\n-});\r\n-\r\n-  // Add loading state check\r\n-  useEffect(() => {\r\n     if (loading) {\r\n       logger.info('Auth loading state active', {\r\n         source: 'useAuth',\r\n         context: { loading }\r\n@@ -401,15 +401,8 @@\n       }\r\n     }\r\n   };\r\n \r\n-  const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n-\r\n-  useEffect(() => {\r\n-    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n-    return () => unsubscribe();\r\n-  }, []);\r\n-\r\n   const checkAndRefreshSession = async (): Promise<void> => {\r\n     try {\r\n       await sessionManager.checkAndRefreshSession();\r\n     } catch (error) {\r\n"
                },
                {
                    "date": 1740684789603,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -47,23 +47,16 @@\n   useEffect(() => {\r\n     if (loading || isTransitioning) {\r\n       return;\r\n     }\r\n-\r\n-    console.log('Auth Context:', {\r\n-      hasUser: !!user,\r\n-      userRole: user?.role,\r\n-      userId: user?.id,\r\n-      isLoading: loading,\r\n-      fullUser: user // Log the full user object for debugging\r\n-    });\r\n+    // Effect logic here\r\n   }, [loading, isTransitioning]);\r\n-\r\n+  \r\n   if (!context) {\r\n     console.warn('useAuth must be used within an AuthProvider');\r\n     return { user: null, loading: false };\r\n   }\r\n-\r\n+  \r\n   const { user, loading } = context;\r\n   const queryClient = new QueryClient();\r\n   \r\n   // Add debug logging\r\n@@ -76,8 +69,23 @@\n   });\r\n \r\n   // Add loading state check\r\n   useEffect(() => {\r\n+    if (loading || isTransitioning) {\r\n+      return;\r\n+    }\r\n+\r\n+    console.log('Auth Context:', {\r\n+      hasUser: !!user,\r\n+      userRole: user?.role,\r\n+      userId: user?.id,\r\n+    isLoading: loading,\r\n+    fullUser: user // Log the full user object for debugging\r\n+  });\r\n+});\r\n+\r\n+  // Add loading state check\r\n+  useEffect(() => {\r\n     if (loading) {\r\n       logger.info('Auth loading state active', {\r\n         source: 'useAuth',\r\n         context: { loading }\r\n@@ -401,8 +409,15 @@\n       }\r\n     }\r\n   };\r\n \r\n+  const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n+\r\n+  useEffect(() => {\r\n+    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n+    return () => unsubscribe();\r\n+  }, []);\r\n+\r\n   const checkAndRefreshSession = async (): Promise<void> => {\r\n     try {\r\n       await sessionManager.checkAndRefreshSession();\r\n     } catch (error) {\r\n"
                },
                {
                    "date": 1740685494398,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -34,9 +34,9 @@\n   const context = useContext(AuthContext);\r\n   const { isTransitioning } = useRoleStore();\r\n   const navigate = useNavigate();\r\n   const location = useLocation();\r\n-  const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n+  const [_authState, setAuthState] = useState(sessionMonitor.getState());\r\n   \r\n   // Subscribe to session state updates\r\n   useEffect(() => {\r\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n"
                },
                {
                    "date": 1740685509382,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -34,13 +34,13 @@\n   const context = useContext(AuthContext);\r\n   const { isTransitioning } = useRoleStore();\r\n   const navigate = useNavigate();\r\n   const location = useLocation();\r\n-  const [_authState, setAuthState] = useState(sessionMonitor.getState());\r\n+  const [_authState, setSessionAuthState] = useState(sessionMonitor.getState());\r\n   \r\n   // Subscribe to session state updates\r\n   useEffect(() => {\r\n-    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n+    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setSessionAuthState);\r\n     return () => unsubscribe();\r\n   }, []);\r\n   \r\n   // Add loading state check\r\n"
                },
                {
                    "date": 1740685528977,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -36,8 +36,16 @@\n   const navigate = useNavigate();\r\n   const location = useLocation();\r\n   const [_authState, setSessionAuthState] = useState(sessionMonitor.getState());\r\n   \r\n+  if (!context) {\r\n+    console.warn('useAuth must be used within an AuthProvider');\r\n+    return { user: null, loading: false };\r\n+  }\r\n+  \r\n+  const { user, loading } = context;\r\n+  const queryClient = new QueryClient();\r\n+  \r\n   // Subscribe to session state updates\r\n   useEffect(() => {\r\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setSessionAuthState);\r\n     return () => unsubscribe();\r\n@@ -50,16 +58,8 @@\n     }\r\n     // Effect logic here\r\n   }, [loading, isTransitioning]);\r\n   \r\n-  if (!context) {\r\n-    console.warn('useAuth must be used within an AuthProvider');\r\n-    return { user: null, loading: false };\r\n-  }\r\n-  \r\n-  const { user, loading } = context;\r\n-  const queryClient = new QueryClient();\r\n-  \r\n   // Add debug logging\r\n   console.log('Auth Context:', {\r\n     hasUser: !!user,\r\n     userRole: user?.role,\r\n"
                },
                {
                    "date": 1740685552217,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -36,22 +36,22 @@\n   const navigate = useNavigate();\r\n   const location = useLocation();\r\n   const [_authState, setSessionAuthState] = useState(sessionMonitor.getState());\r\n   \r\n+  // Subscribe to session state updates\r\n+  useEffect(() => {\r\n+    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setSessionAuthState);\r\n+    return () => unsubscribe();\r\n+  }, []);\r\n+  \r\n   if (!context) {\r\n     console.warn('useAuth must be used within an AuthProvider');\r\n     return { user: null, loading: false };\r\n   }\r\n   \r\n   const { user, loading } = context;\r\n   const queryClient = new QueryClient();\r\n   \r\n-  // Subscribe to session state updates\r\n-  useEffect(() => {\r\n-    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setSessionAuthState);\r\n-    return () => unsubscribe();\r\n-  }, []);\r\n-  \r\n   // Add loading state check\r\n   useEffect(() => {\r\n     if (loading || isTransitioning) {\r\n       return;\r\n"
                },
                {
                    "date": 1740685570751,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,456 @@\n+\"use client\";\r\n+\r\n+import { useContext, useEffect, useState, useCallback, useRef } from 'react';\r\n+import { AuthContext } from '../contexts/AuthContext';\r\n+import { useNavigate, useLocation } from 'react-router-dom';\r\n+import { QueryClient } from '@tanstack/query-core';\r\n+import { roleTransitionManager } from '../lib/auth/RoleTransitionManager';\r\n+import { useRoleStore } from '../lib/auth/store';\r\n+import { logger } from '../lib/logger';\r\n+import { ROLE_PERMISSIONS } from '../types/roles';\r\n+import { sessionManager } from '../lib/auth/sessionManager';\r\n+import type { UserRole } from '../types/roles';\r\n+import { supabaseClient } from '../lib/supabaseClient';\r\n+import { supabase } from '../lib/supabase';\r\n+import { AuthLoader } from '../lib/auth/AuthLoader';\r\n+import type { AuthError } from '@supabase/supabase-js';\r\n+import { sessionMonitor } from '@/lib/auth/SessionMonitor';\r\n+import type { SessionState } from '@/lib/auth/sessionManager';\r\n+\r\n+interface LoginCredentials {\r\n+  email: string;\r\n+  password: string;\r\n+}\r\n+\r\n+interface SignUpCredentials extends LoginCredentials {\r\n+  name?: string;\r\n+}\r\n+\r\n+interface ResetPasswordCredentials {\r\n+  email: string;\r\n+  }\r\n+\r\n+export function useAuth() {\r\n+  const context = useContext(AuthContext);\r\n+  const { isTransitioning } = useRoleStore();\r\n+  const navigate = useNavigate();\r\n+  const location = useLocation();\r\n+  const [_authState, setSessionAuthState] = useState(sessionMonitor.getState());\r\n+  \r\n+  // Subscribe to session state updates\r\n+  useEffect(() => {\r\n+    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setSessionAuthState);\r\n+    return () => unsubscribe();\r\n+  }, []);\r\n+  \r\n+  // Define a dummy loading value for the early return case\r\n+  const loading = context?.loading || false;\r\n+  \r\n+  // Add loading state check - this will run regardless of context\r\n+  useEffect(() => {\r\n+    if (!context || loading || isTransitioning) {\r\n+      return;\r\n+    }\r\n+    // Effect logic here\r\n+  }, [context, loading, isTransitioning]);\r\n+  \r\n+  if (!context) {\r\n+    console.warn('useAuth must be used within an AuthProvider');\r\n+    return { user: null, loading: false };\r\n+  }\r\n+  \r\n+  const { user } = context;\r\n+  const queryClient = new QueryClient();\r\n+  \r\n+  // Add loading state check\r\n+  useEffect(() => {\r\n+    if (loading || isTransitioning) {\r\n+      return;\r\n+    }\r\n+    // Effect logic here\r\n+  }, [loading, isTransitioning]);\r\n+  \r\n+  // Add debug logging\r\n+  console.log('Auth Context:', {\r\n+    hasUser: !!user,\r\n+    userRole: user?.role,\r\n+    userId: user?.id,\r\n+    isLoading: loading,\r\n+    fullUser: user // Log the full user object for debugging\r\n+  });\r\n+\r\n+  // Add loading state check\r\n+  useEffect(() => {\r\n+    if (loading || isTransitioning) {\r\n+      return;\r\n+    }\r\n+\r\n+    console.log('Auth Context:', {\r\n+      hasUser: !!user,\r\n+      userRole: user?.role,\r\n+      userId: user?.id,\r\n+    isLoading: loading,\r\n+    fullUser: user // Log the full user object for debugging\r\n+  });\r\n+});\r\n+\r\n+  // Add loading state check\r\n+  useEffect(() => {\r\n+    if (loading) {\r\n+      logger.info('Auth loading state active', {\r\n+        source: 'useAuth',\r\n+        context: { loading }\r\n+      });\r\n+    }\r\n+  }, [loading]);\r\n+\r\n+  // Auto-refresh session when it's about to expire\r\n+  useEffect(() => {\r\n+    if (!user) return;\r\n+    const refreshInterval = setInterval(async () => {\r\n+      try {\r\n+        await sessionManager.refreshSession();\r\n+      } catch (err) {\r\n+        logger.error('Failed to refresh session', {\r\n+          source: 'useAuth',\r\n+          context: { error: err }\r\n+        });\r\n+      }\r\n+    }, 4 * 60 * 1000); // Check every 4 minutes\r\n+    \r\n+    return () => {\r\n+      if (refreshInterval) {\r\n+        clearInterval(refreshInterval);\r\n+      }\r\n+    };\r\n+  }, [user]);\r\n+\r\n+  useEffect(() => {\r\n+    if (user) {\r\n+      logger.debug('Auth state check on route change', {\r\n+        source: 'useAuth',\r\n+        context: {\r\n+          role: user.role,\r\n+          path: location.pathname,\r\n+          permissions: ROLE_PERMISSIONS[user.role]?.permissions\r\n+        }\r\n+      });\r\n+    }\r\n+  }, [user, location.pathname]);\r\n+\r\n+  const changeRole = async (newRole: UserRole): Promise<void> => {\r\n+    if (!context.user || isTransitioning) return;\r\n+\r\n+    try {\r\n+      await roleTransitionManager.transitionRole(newRole);\r\n+      \r\n+      // Clear cache and refetch with new role\r\n+      queryClient.clear();\r\n+      await queryClient.resetQueries();\r\n+      \r\n+      // Update context user\r\n+      context.setUser({\r\n+        ...context.user,\r\n+        role: newRole\r\n+      });\r\n+\r\n+      // Navigate to home with fresh data\r\n+      navigate('/', { replace: true });\r\n+    } catch (err) {\r\n+      logger.error('Failed to change role', {\r\n+        source: 'useAuth',\r\n+        context: { error: err }\r\n+      });\r\n+      throw err;\r\n+    }\r\n+  };\r\n+\r\n+  const login = async (credentials: LoginCredentials) => {\r\n+    try {\r\n+      console.log('[Auth] Attempting login:', {\r\n+        email: credentials.email,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+      \r\n+      const { data, error } = await supabaseClient.auth.signInWithPassword({\r\n+        email: credentials.email,\r\n+        password: credentials.password,\r\n+      });\r\n+\r\n+      if (error) {\r\n+        console.error('[Auth] Supabase login error:', {\r\n+          message: error.message,\r\n+          status: error.status,\r\n+          name: error.name,\r\n+          timestamp: new Date().toISOString()\r\n+        });\r\n+        \r\n+        // Provide more specific error messages\r\n+        if (error.message.includes('Invalid login credentials')) {\r\n+          throw new Error('Invalid email or password. Please check your credentials and try again.');\r\n+        }\r\n+        \r\n+        logger.error('Login failed', {\r\n+          context: { \r\n+            error,\r\n+            credentials: { email: credentials.email }\r\n+          },\r\n+          source: 'useAuth'\r\n+        });\r\n+        throw new Error(error.message);\r\n+      }\r\n+\r\n+      console.log('[Auth] Login response:', {\r\n+        hasUser: !!data.user,\r\n+        userId: data.user?.id,\r\n+        userEmail: data.user?.email,\r\n+        metadata: data.user?.user_metadata,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+\r\n+      if (!data.user) {\r\n+        throw new Error('Login successful but user data is missing');\r\n+      }\r\n+\r\n+      // Map Supabase user to our user format\r\n+      const mappedUser = {\r\n+        id: data.user.id,\r\n+        email: data.user.email!,\r\n+        name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\r\n+        role: data.user.user_metadata?.role || 'student',\r\n+        photoUrl: data.user.user_metadata?.avatar_url,\r\n+      };\r\n+\r\n+      console.log('[Auth] Mapped user:', mappedUser);\r\n+\r\n+      context.setUser(mappedUser);\r\n+      return { user: mappedUser };\r\n+    } catch (error) {\r\n+      const errorDetails = error instanceof Error ? {\r\n+        message: error.message,\r\n+        name: error.name,\r\n+        stack: error.stack\r\n+      } : error;\r\n+\r\n+      console.error('[Auth] Login error details:', {\r\n+        error: errorDetails,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+\r\n+      logger.error('Login failed', {\r\n+        context: { \r\n+          error: errorDetails,\r\n+          credentials: { email: credentials.email }\r\n+        },\r\n+        source: 'useAuth'\r\n+      });\r\n+\r\n+      if (error instanceof Error) {\r\n+        throw error;\r\n+      } else {\r\n+        throw new Error('An unexpected error occurred. Please try again.');\r\n+      }\r\n+    }\r\n+  };\r\n+\r\n+  const logout = async () => {\r\n+    try {\r\n+      const { error } = await supabaseClient.auth.signOut();\r\n+      \r\n+      if (error) {\r\n+        throw error;\r\n+      }\r\n+\r\n+      context.setUser(null);\r\n+      queryClient.clear();\r\n+      navigate('/login');\r\n+    } catch (error) {\r\n+      logger.error('Logout failed', {\r\n+        context: { error },\r\n+        source: 'useAuth'\r\n+      });\r\n+      throw error;\r\n+    }\r\n+  };\r\n+\r\n+  const signUp = async (credentials: SignUpCredentials) => {\r\n+    try {\r\n+      console.log('[Auth] Attempting signup:', {\r\n+        email: credentials.email,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+      \r\n+      const { data, error } = await supabaseClient.auth.signUp({\r\n+        email: credentials.email,\r\n+        password: credentials.password,\r\n+        options: {\r\n+          data: {\r\n+            name: credentials.name || credentials.email.split('@')[0],\r\n+            role: 'student'\r\n+          }\r\n+        }\r\n+      });\r\n+\r\n+      if (error) {\r\n+        console.error('[Auth] Supabase signup error:', {\r\n+          message: error.message,\r\n+          status: error.status,\r\n+          name: error.name,\r\n+          timestamp: new Date().toISOString()\r\n+        });\r\n+        \r\n+        logger.error('Signup failed', {\r\n+          context: { \r\n+            error,\r\n+            credentials: { email: credentials.email }\r\n+          },\r\n+          source: 'useAuth'\r\n+        });\r\n+        throw new Error(error.message);\r\n+      }\r\n+\r\n+      console.log('[Auth] Signup response:', {\r\n+        hasUser: !!data.user,\r\n+        userId: data.user?.id,\r\n+        userEmail: data.user?.email,\r\n+        metadata: data.user?.user_metadata,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+\r\n+      if (!data.user) {\r\n+        throw new Error('Signup successful but user data is missing');\r\n+      }\r\n+\r\n+      // Map Supabase user to our user format\r\n+      const mappedUser = {\r\n+        id: data.user.id,\r\n+        email: data.user.email!,\r\n+        name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\r\n+        role: data.user.user_metadata?.role || 'student',\r\n+        photoUrl: data.user.user_metadata?.avatar_url,\r\n+      };\r\n+\r\n+      console.log('[Auth] Mapped user:', mappedUser);\r\n+\r\n+      context.setUser(mappedUser);\r\n+      return { user: mappedUser };\r\n+    } catch (error) {\r\n+      const errorDetails = error instanceof Error ? {\r\n+        message: error.message,\r\n+        name: error.name,\r\n+        stack: error.stack\r\n+      } : error;\r\n+\r\n+      console.error('[Auth] Signup error details:', {\r\n+        error: errorDetails,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+\r\n+      logger.error('Signup failed', {\r\n+        context: { \r\n+          error: errorDetails,\r\n+          credentials: { email: credentials.email }\r\n+        },\r\n+        source: 'useAuth'\r\n+      });\r\n+\r\n+      if (error instanceof Error) {\r\n+        throw error;\r\n+      } else {\r\n+        throw new Error('An unexpected error occurred during signup. Please try again.');\r\n+      }\r\n+    }\r\n+  };\r\n+\r\n+  const resetPassword = async (credentials: ResetPasswordCredentials) => {\r\n+    try {\r\n+      console.log('[Auth] Attempting password reset:', {\r\n+        email: credentials.email,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+      \r\n+      const { data, error } = await supabaseClient.auth.resetPasswordForEmail(\r\n+        credentials.email,\r\n+        { redirectTo: `${window.location.origin}/reset-password` }\r\n+      );\r\n+\r\n+      if (error) {\r\n+        console.error('[Auth] Supabase password reset error:', {\r\n+          message: error.message,\r\n+          status: error.status,\r\n+          name: error.name,\r\n+          timestamp: new Date().toISOString()\r\n+        });\r\n+        \r\n+        logger.error('Password reset failed', {\r\n+          context: { \r\n+            error,\r\n+            credentials: { email: credentials.email }\r\n+          },\r\n+          source: 'useAuth'\r\n+        });\r\n+        throw new Error(error.message);\r\n+      }\r\n+\r\n+      return data;\r\n+    } catch (error) {\r\n+      const errorDetails = error instanceof Error ? {\r\n+        message: error.message,\r\n+        name: error.name,\r\n+        stack: error.stack\r\n+      } : error;\r\n+\r\n+      console.error('[Auth] Password reset error details:', {\r\n+        error: errorDetails,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+\r\n+      logger.error('Password reset failed', {\r\n+        context: { \r\n+          error: errorDetails,\r\n+          credentials: { email: credentials.email }\r\n+        },\r\n+        source: 'useAuth'\r\n+      });\r\n+\r\n+      if (error instanceof Error) {\r\n+        throw error;\r\n+      } else {\r\n+        throw new Error('An unexpected error occurred during password reset. Please try again.');\r\n+      }\r\n+    }\r\n+  };\r\n+\r\n+  const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n+\r\n+  useEffect(() => {\r\n+    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n+    return () => unsubscribe();\r\n+  }, []);\r\n+\r\n+  const checkAndRefreshSession = async (): Promise<void> => {\r\n+    try {\r\n+      await sessionManager.checkAndRefreshSession();\r\n+    } catch (error) {\r\n+      logger.error('Failed to check and refresh session', {\r\n+        context: { error },\r\n+        source: 'useAuth'\r\n+      });\r\n+    }\r\n+  };\r\n+\r\n+  return {\r\n+    user: user ? {\r\n+      ...user,\r\n+      role: user.role || 'unknown'\r\n+    } : null,\r\n+    loading,\r\n+    changeRole,\r\n+    isTransitioning,\r\n+    login,\r\n+    logout,\r\n+    signUp,\r\n+    resetPassword,\r\n+    sessionManager\r\n+  };\r\n+}\n\\ No newline at end of file\n"
                },
                {
                    "date": 1740685919085,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -30,481 +30,34 @@\n   email: string;\r\n   }\r\n \r\n export function useAuth() {\r\n+  // All hooks must be called at the top level\r\n   const context = useContext(AuthContext);\r\n   const { isTransitioning } = useRoleStore();\r\n   const navigate = useNavigate();\r\n   const location = useLocation();\r\n   const [_authState, setSessionAuthState] = useState(sessionMonitor.getState());\r\n+  const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n   \r\n   // Subscribe to session state updates\r\n   useEffect(() => {\r\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setSessionAuthState);\r\n     return () => unsubscribe();\r\n   }, []);\r\n   \r\n-  // Define a dummy loading value for the early return case\r\n-  const loading = context?.loading || false;\r\n-  \r\n-  // Add loading state check - this will run regardless of context\r\n   useEffect(() => {\r\n-    if (!context || loading || isTransitioning) {\r\n-      return;\r\n-    }\r\n-    // Effect logic here\r\n-  }, [context, loading, isTransitioning]);\r\n-  \r\n-  if (!context) {\r\n-    console.warn('useAuth must be used within an AuthProvider');\r\n-    return { user: null, loading: false };\r\n-  }\r\n-  \r\n-  const { user } = context;\r\n-  const queryClient = new QueryClient();\r\n-  \r\n-  // Add loading state check\r\n-  useEffect(() => {\r\n-    if (loading || isTransitioning) {\r\n-      return;\r\n-    }\r\n-    // Effect logic here\r\n-  }, [loading, isTransitioning]);\r\n-  \r\n-  // Add debug logging\r\n-  console.log('Auth Context:', {\r\n-    hasUser: !!user,\r\n-    userRole: user?.role,\r\n-    userId: user?.id,\r\n-    isLoading: loading,\r\n-    fullUser: user // Log the full user object for debugging\r\n-  });\r\n-\r\n-  // Add loading state check\r\n-  useEffect(() => {\r\n-    if (loading || isTransitioning) {\r\n-      return;\r\n-    }\r\n-\r\n-    console.log('Auth Context:', {\r\n-      hasUser: !!user,\r\n-      userRole: user?.role,\r\n-      userId: user?.id,\r\n-    isLoading: loading,\r\n-    fullUser: user // Log the full user object for debugging\r\n-  });\r\n-});\r\n-\r\n-  // Add loading state check\r\n-  useEffect(() => {\r\n-    if (loading) {\r\n-      logger.info('Auth loading state active', {\r\n-        source: 'useAuth',\r\n-        context: { loading }\r\n-      });\r\n-    }\r\n-  }, [loading]);\r\n-\r\n-  // Auto-refresh session when it's about to expire\r\n-  useEffect(() => {\r\n-    if (!user) return;\r\n-    const refreshInterval = setInterval(async () => {\r\n-      try {\r\n-        await sessionManager.refreshSession();\r\n-      } catch (err) {\r\n-        logger.error('Failed to refresh session', {\r\n-          source: 'useAuth',\r\n-          context: { error: err }\r\n-        });\r\n-      }\r\n-    }, 4 * 60 * 1000); // Check every 4 minutes\r\n-    \r\n-    return () => {\r\n-      if (refreshInterval) {\r\n-        clearInterval(refreshInterval);\r\n-      }\r\n-    };\r\n-  }, [user]);\r\n-\r\n-  useEffect(() => {\r\n-    if (user) {\r\n-      logger.debug('Auth state check on route change', {\r\n-        source: 'useAuth',\r\n-        context: {\r\n-          role: user.role,\r\n-          path: location.pathname,\r\n-          permissions: ROLE_PERMISSIONS[user.role]?.permissions\r\n-        }\r\n-      });\r\n-    }\r\n-  }, [user, location.pathname]);\r\n-\r\n-  const changeRole = async (newRole: UserRole): Promise<void> => {\r\n-    if (!context.user || isTransitioning) return;\r\n-\r\n-    try {\r\n-      await roleTransitionManager.transitionRole(newRole);\r\n-      \r\n-      // Clear cache and refetch with new role\r\n-      queryClient.clear();\r\n-      await queryClient.resetQueries();\r\n-      \r\n-      // Update context user\r\n-      context.setUser({\r\n-        ...context.user,\r\n-        role: newRole\r\n-      });\r\n-\r\n-      // Navigate to home with fresh data\r\n-      navigate('/', { replace: true });\r\n-    } catch (err) {\r\n-      logger.error('Failed to change role', {\r\n-        source: 'useAuth',\r\n-        context: { error: err }\r\n-      });\r\n-      throw err;\r\n-    }\r\n-  };\r\n-\r\n-  const login = async (credentials: LoginCredentials) => {\r\n-    try {\r\n-      console.log('[Auth] Attempting login:', {\r\n-        email: credentials.email,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-      \r\n-      const { data, error } = await supabaseClient.auth.signInWithPassword({\r\n-        email: credentials.email,\r\n-        password: credentials.password,\r\n-      });\r\n-\r\n-      if (error) {\r\n-        console.error('[Auth] Supabase login error:', {\r\n-          message: error.message,\r\n-          status: error.status,\r\n-          name: error.name,\r\n-          timestamp: new Date().toISOString()\r\n-        });\r\n-        \r\n-        // Provide more specific error messages\r\n-        if (error.message.includes('Invalid login credentials')) {\r\n-          throw new Error('Invalid email or password. Please check your credentials and try again.');\r\n-        }\r\n-        \r\n-        logger.error('Login failed', {\r\n-          context: { \r\n-            error,\r\n-            credentials: { email: credentials.email }\r\n-          },\r\n-          source: 'useAuth'\r\n-        });\r\n-        throw new Error(error.message);\r\n-      }\r\n-\r\n-      console.log('[Auth] Login response:', {\r\n-        hasUser: !!data.user,\r\n-        userId: data.user?.id,\r\n-        userEmail: data.user?.email,\r\n-        metadata: data.user?.user_metadata,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-\r\n-      if (!data.user) {\r\n-        throw new Error('Login successful but user data is missing');\r\n-      }\r\n-\r\n-      // Map Supabase user to our user format\r\n-      const mappedUser = {\r\n-        id: data.user.id,\r\n-        email: data.user.email!,\r\n-        name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\r\n-        role: data.user.user_metadata?.role || 'student',\r\n-        photoUrl: data.user.user_metadata?.avatar_url,\r\n-      };\r\n-\r\n-      console.log('[Auth] Mapped user:', mappedUser);\r\n-\r\n-      context.setUser(mappedUser);\r\n-      return { user: mappedUser };\r\n-    } catch (error) {\r\n-      const errorDetails = error instanceof Error ? {\r\n-        message: error.message,\r\n-        name: error.name,\r\n-        stack: error.stack\r\n-      } : error;\r\n-\r\n-      console.error('[Auth] Login error details:', {\r\n-        error: errorDetails,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-\r\n-      logger.error('Login failed', {\r\n-        context: { \r\n-          error: errorDetails,\r\n-          credentials: { email: credentials.email }\r\n-        },\r\n-        source: 'useAuth'\r\n-      });\r\n-\r\n-      if (error instanceof Error) {\r\n-        throw error;\r\n-      } else {\r\n-        throw new Error('An unexpected error occurred. Please try again.');\r\n-      }\r\n-    }\r\n-  };\r\n-\r\n-  const logout = async () => {\r\n-    try {\r\n-      const { error } = await supabaseClient.auth.signOut();\r\n-      \r\n-      if (error) {\r\n-        throw error;\r\n-      }\r\n-\r\n-      context.setUser(null);\r\n-      queryClient.clear();\r\n-      navigate('/login');\r\n-    } catch (error) {\r\n-      logger.error('Logout failed', {\r\n-        context: { error },\r\n-        source: 'useAuth'\r\n-      });\r\n-      throw error;\r\n-    }\r\n-  };\r\n-\r\n-  const signUp = async (credentials: SignUpCredentials) => {\r\n-    try {\r\n-      console.log('[Auth] Attempting signup:', {\r\n-        email: credentials.email,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-      \r\n-      const { data, error } = await supabaseClient.auth.signUp({\r\n-        email: credentials.email,\r\n-        password: credentials.password,\r\n-        options: {\r\n-          data: {\r\n-            name: credentials.name || credentials.email.split('@')[0],\r\n-            role: 'student'\r\n-          }\r\n-        }\r\n-      });\r\n-\r\n-      if (error) {\r\n-        console.error('[Auth] Supabase signup error:', {\r\n-          message: error.message,\r\n-          status: error.status,\r\n-          name: error.name,\r\n-          timestamp: new Date().toISOString()\r\n-        });\r\n-        \r\n-        logger.error('Signup failed', {\r\n-          context: { \r\n-            error,\r\n-            credentials: { email: credentials.email }\r\n-          },\r\n-          source: 'useAuth'\r\n-        });\r\n-        throw new Error(error.message);\r\n-      }\r\n-\r\n-      console.log('[Auth] Signup response:', {\r\n-        hasUser: !!data.user,\r\n-        userId: data.user?.id,\r\n-        userEmail: data.user?.email,\r\n-        metadata: data.user?.user_metadata,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-\r\n-      if (!data.user) {\r\n-        throw new Error('Signup successful but user data is missing');\r\n-      }\r\n-\r\n-      // Map Supabase user to our user format\r\n-      const mappedUser = {\r\n-        id: data.user.id,\r\n-        email: data.user.email!,\r\n-        name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\r\n-        role: data.user.user_metadata?.role || 'student',\r\n-        photoUrl: data.user.user_metadata?.avatar_url,\r\n-      };\r\n-\r\n-      console.log('[Auth] Mapped user:', mappedUser);\r\n-\r\n-      context.setUser(mappedUser);\r\n-      return { user: mappedUser };\r\n-    } catch (error) {\r\n-      const errorDetails = error instanceof Error ? {\r\n-        message: error.message,\r\n-        name: error.name,\r\n-        stack: error.stack\r\n-      } : error;\r\n-\r\n-      console.error('[Auth] Signup error details:', {\r\n-        error: errorDetails,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-\r\n-      logger.error('Signup failed', {\r\n-        context: { \r\n-          error: errorDetails,\r\n-          credentials: { email: credentials.email }\r\n-        },\r\n-        source: 'useAuth'\r\n-      });\r\n-\r\n-      if (error instanceof Error) {\r\n-        throw error;\r\n-      } else {\r\n-        throw new Error('An unexpected error occurred during signup. Please try again.');\r\n-      }\r\n-    }\r\n-  };\r\n-\r\n-  const resetPassword = async (credentials: ResetPasswordCredentials) => {\r\n-    try {\r\n-      console.log('[Auth] Attempting password reset:', {\r\n-        email: credentials.email,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-      \r\n-      const { data, error } = await supabaseClient.auth.resetPasswordForEmail(\r\n-        credentials.email,\r\n-        { redirectTo: `${window.location.origin}/reset-password` }\r\n-      );\r\n-\r\n-      if (error) {\r\n-        console.error('[Auth] Supabase password reset error:', {\r\n-          message: error.message,\r\n-          status: error.status,\r\n-          name: error.name,\r\n-          timestamp: new Date().toISOString()\r\n-        });\r\n-        \r\n-        logger.error('Password reset failed', {\r\n-          context: { \r\n-            error,\r\n-            credentials: { email: credentials.email }\r\n-          },\r\n-          source: 'useAuth'\r\n-        });\r\n-        throw new Error(error.message);\r\n-      }\r\n-\r\n-      return data;\r\n-    } catch (error) {\r\n-      const errorDetails = error instanceof Error ? {\r\n-        message: error.message,\r\n-        name: error.name,\r\n-        stack: error.stack\r\n-      } : error;\r\n-\r\n-      console.error('[Auth] Password reset error details:', {\r\n-        error: errorDetails,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-\r\n-      logger.error('Password reset failed', {\r\n-        context: { \r\n-          error: errorDetails,\r\n-          credentials: { email: credentials.email }\r\n-        },\r\n-        source: 'useAuth'\r\n-      });\r\n-\r\n-      if (error instanceof Error) {\r\n-        throw error;\r\n-      } else {\r\n-        throw new Error('An unexpected error occurred during password reset. Please try again.');\r\n-      }\r\n-    }\r\n-  };\r\n-\r\n-  const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n-\r\n-  useEffect(() => {\r\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n     return () => unsubscribe();\r\n   }, []);\r\n-\r\n-  const checkAndRefreshSession = async (): Promise<void> => {\r\n-    try {\r\n-      await sessionManager.checkAndRefreshSession();\r\n-    } catch (error) {\r\n-      logger.error('Failed to check and refresh session', {\r\n-        context: { error },\r\n-        source: 'useAuth'\r\n-      });\r\n-    }\r\n-  };\r\n-\r\n-  return {\r\n-    user: user ? {\r\n-      ...user,\r\n-      role: user.role || 'unknown'\r\n-    } : null,\r\n-    loading,\r\n-    changeRole,\r\n-    isTransitioning,\r\n-    login,\r\n-    logout,\r\n-    signUp,\r\n-    resetPassword,\r\n-    sessionManager\r\n-  };\r\n-}\n-\"use client\";\r\n-\r\n-import { useContext, useEffect, useState, useCallback, useRef } from 'react';\r\n-import { AuthContext } from '../contexts/AuthContext';\r\n-import { useNavigate, useLocation } from 'react-router-dom';\r\n-import { QueryClient } from '@tanstack/query-core';\r\n-import { roleTransitionManager } from '../lib/auth/RoleTransitionManager';\r\n-import { useRoleStore } from '../lib/auth/store';\r\n-import { logger } from '../lib/logger';\r\n-import { ROLE_PERMISSIONS } from '../types/roles';\r\n-import { sessionManager } from '../lib/auth/sessionManager';\r\n-import type { UserRole } from '../types/roles';\r\n-import { supabaseClient } from '../lib/supabaseClient';\r\n-import { supabase } from '../lib/supabase';\r\n-import { AuthLoader } from '../lib/auth/AuthLoader';\r\n-import type { AuthError } from '@supabase/supabase-js';\r\n-import { sessionMonitor } from '@/lib/auth/SessionMonitor';\r\n-import type { SessionState } from '@/lib/auth/sessionManager';\r\n-\r\n-interface LoginCredentials {\r\n-  email: string;\r\n-  password: string;\r\n-}\r\n-\r\n-interface SignUpCredentials extends LoginCredentials {\r\n-  name?: string;\r\n-}\r\n-\r\n-interface ResetPasswordCredentials {\r\n-  email: string;\r\n-  }\r\n-\r\n-export function useAuth() {\r\n-  const context = useContext(AuthContext);\r\n-  const { isTransitioning } = useRoleStore();\r\n-  const navigate = useNavigate();\r\n-  const location = useLocation();\r\n-  const [_authState, setSessionAuthState] = useState(sessionMonitor.getState());\r\n   \r\n-  // Subscribe to session state updates\r\n-  useEffect(() => {\r\n-    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setSessionAuthState);\r\n-    return () => unsubscribe();\r\n-  }, []);\r\n-  \r\n+  // Early return for missing context\r\n   if (!context) {\r\n     console.warn('useAuth must be used within an AuthProvider');\r\n     return { user: null, loading: false };\r\n   }\r\n   \r\n+  // Now we can safely use context\r\n   const { user, loading } = context;\r\n   const queryClient = new QueryClient();\r\n   \r\n   // Add loading state check\r\n@@ -865,15 +418,8 @@\n       }\r\n     }\r\n   };\r\n \r\n-  const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n-\r\n-  useEffect(() => {\r\n-    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n-    return () => unsubscribe();\r\n-  }, []);\r\n-\r\n   const checkAndRefreshSession = async (): Promise<void> => {\r\n     try {\r\n       await sessionManager.checkAndRefreshSession();\r\n     } catch (error) {\r\n"
                },
                {
                    "date": 1740685942536,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -44,8 +44,12 @@\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setSessionAuthState);\r\n     return () => unsubscribe();\r\n   }, []);\r\n   \r\n+  // Define a dummy loading value for the early return case\r\n+  const loading = context?.loading || false;\r\n+  \r\n+  // Add loading state check - this will run regardless of context\r\n   useEffect(() => {\r\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n     return () => unsubscribe();\r\n   }, []);\r\n"
                },
                {
                    "date": 1740685971690,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -49,8 +49,13 @@\n   const loading = context?.loading || false;\r\n   \r\n   // Add loading state check - this will run regardless of context\r\n   useEffect(() => {\r\n+    if (!context || loading || isTransitioning) {\r\n+      return;\r\n+    }\r\n+    // Effect logic here\r\n+  }, [context, loading, isTransitioning]);\r\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n     return () => unsubscribe();\r\n   }, []);\r\n   \r\n"
                },
                {
                    "date": 1740685993113,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -56,10 +56,10 @@\n     // Effect logic here\r\n   }, [context, loading, isTransitioning]);\r\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n     return () => unsubscribe();\r\n-  }, []);\r\n   \r\n+  \r\n   // Early return for missing context\r\n   if (!context) {\r\n     console.warn('useAuth must be used within an AuthProvider');\r\n     return { user: null, loading: false };\r\n"
                },
                {
                    "date": 1740685998486,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -56,8 +56,9 @@\n     // Effect logic here\r\n   }, [context, loading, isTransitioning]);\r\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n     return () => unsubscribe();\r\n+  }, []);\r\n   \r\n   \r\n   // Early return for missing context\r\n   if (!context) {\r\n"
                },
                {
                    "date": 1740686022217,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -58,10 +58,8 @@\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n     return () => unsubscribe();\r\n   }, []);\r\n   \r\n-  \r\n-  // Early return for missing context\r\n   if (!context) {\r\n     console.warn('useAuth must be used within an AuthProvider');\r\n     return { user: null, loading: false };\r\n   }\r\n@@ -428,8 +426,15 @@\n       }\r\n     }\r\n   };\r\n \r\n+  const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n+\r\n+  useEffect(() => {\r\n+    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n+    return () => unsubscribe();\r\n+  }, []);\r\n+\r\n   const checkAndRefreshSession = async (): Promise<void> => {\r\n     try {\r\n       await sessionManager.checkAndRefreshSession();\r\n     } catch (error) {\r\n"
                },
                {
                    "date": 1740686070479,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -54,11 +54,8 @@\n       return;\r\n     }\r\n     // Effect logic here\r\n   }, [context, loading, isTransitioning]);\r\n-    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n-    return () => unsubscribe();\r\n-  }, []);\r\n   \r\n   if (!context) {\r\n     console.warn('useAuth must be used within an AuthProvider');\r\n     return { user: null, loading: false };\r\n"
                },
                {
                    "date": 1740686119352,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -61,9 +61,9 @@\n     return { user: null, loading: false };\r\n   }\r\n   \r\n   // Now we can safely use context\r\n-  const { user, loading } = context;\r\n+  const { user } = context;\r\n   const queryClient = new QueryClient();\r\n   \r\n   // Add loading state check\r\n   useEffect(() => {\r\n@@ -98,8 +98,23 @@\n });\r\n \r\n   // Add loading state check\r\n   useEffect(() => {\r\n+    if (loading || isTransitioning) {\r\n+      return;\r\n+    }\r\n+\r\n+    console.log('Auth Context:', {\r\n+      hasUser: !!user,\r\n+      userRole: user?.role,\r\n+      userId: user?.id,\r\n+    isLoading: loading,\r\n+    fullUser: user // Log the full user object for debugging\r\n+  });\r\n+});\r\n+\r\n+  // Add loading state check\r\n+  useEffect(() => {\r\n     if (loading) {\r\n       logger.info('Auth loading state active', {\r\n         source: 'useAuth',\r\n         context: { loading }\r\n"
                },
                {
                    "date": 1740686130940,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -36,9 +36,9 @@\n   const { isTransitioning } = useRoleStore();\r\n   const navigate = useNavigate();\r\n   const location = useLocation();\r\n   const [_authState, setSessionAuthState] = useState(sessionMonitor.getState());\r\n-  const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n+  //const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n   \r\n   // Subscribe to session state updates\r\n   useEffect(() => {\r\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setSessionAuthState);\r\n"
                },
                {
                    "date": 1740686341197,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -98,23 +98,8 @@\n });\r\n \r\n   // Add loading state check\r\n   useEffect(() => {\r\n-    if (loading || isTransitioning) {\r\n-      return;\r\n-    }\r\n-\r\n-    console.log('Auth Context:', {\r\n-      hasUser: !!user,\r\n-      userRole: user?.role,\r\n-      userId: user?.id,\r\n-    isLoading: loading,\r\n-    fullUser: user // Log the full user object for debugging\r\n-  });\r\n-});\r\n-\r\n-  // Add loading state check\r\n-  useEffect(() => {\r\n     if (loading) {\r\n       logger.info('Auth loading state active', {\r\n         source: 'useAuth',\r\n         context: { loading }\r\n"
                },
                {
                    "date": 1740686382503,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -36,9 +36,8 @@\n   const { isTransitioning } = useRoleStore();\r\n   const navigate = useNavigate();\r\n   const location = useLocation();\r\n   const [_authState, setSessionAuthState] = useState(sessionMonitor.getState());\r\n-  //const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n   \r\n   // Subscribe to session state updates\r\n   useEffect(() => {\r\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setSessionAuthState);\r\n@@ -55,8 +54,16 @@\n     }\r\n     // Effect logic here\r\n   }, [context, loading, isTransitioning]);\r\n   \r\n+  // Add loading state check\r\n+  useEffect(() => {\r\n+    if (loading || isTransitioning) {\r\n+      return;\r\n+    }\r\n+    // Effect logic here\r\n+  }, [loading, isTransitioning]);\r\n+  \r\n   if (!context) {\r\n     console.warn('useAuth must be used within an AuthProvider');\r\n     return { user: null, loading: false };\r\n   }\r\n@@ -69,26 +76,9 @@\n   useEffect(() => {\r\n     if (loading || isTransitioning) {\r\n       return;\r\n     }\r\n-    // Effect logic here\r\n-  }, [loading, isTransitioning]);\r\n-  \r\n-  // Add debug logging\r\n-  console.log('Auth Context:', {\r\n-    hasUser: !!user,\r\n-    userRole: user?.role,\r\n-    userId: user?.id,\r\n-    isLoading: loading,\r\n-    fullUser: user // Log the full user object for debugging\r\n-  });\r\n \r\n-  // Add loading state check\r\n-  useEffect(() => {\r\n-    if (loading || isTransitioning) {\r\n-      return;\r\n-    }\r\n-\r\n     console.log('Auth Context:', {\r\n       hasUser: !!user,\r\n       userRole: user?.role,\r\n       userId: user?.id,\r\n"
                },
                {
                    "date": 1740686562859,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -61,8 +61,22 @@\n       return;\r\n     }\r\n     // Effect logic here\r\n   }, [loading, isTransitioning]);\r\n+  // Add debug logging\r\n+  console.log('Auth Context:', {\r\n+    hasUser: !!user,\r\n+    userRole: user?.role,\r\n+    userId: user?.id,\r\n+    isLoading: loading,\r\n+    fullUser: user // Log the full user object for debugging\r\n+  });\r\n+\r\n+  // Add loading state check\r\n+  useEffect(() => {\r\n+    if (loading || isTransitioning) {\r\n+      return;\r\n+    }\r\n   \r\n   if (!context) {\r\n     console.warn('useAuth must be used within an AuthProvider');\r\n     return { user: null, loading: false };\r\n"
                },
                {
                    "date": 1740686574562,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -61,23 +61,10 @@\n       return;\r\n     }\r\n     // Effect logic here\r\n   }, [loading, isTransitioning]);\r\n-  // Add debug logging\r\n-  console.log('Auth Context:', {\r\n-    hasUser: !!user,\r\n-    userRole: user?.role,\r\n-    userId: user?.id,\r\n-    isLoading: loading,\r\n-    fullUser: user // Log the full user object for debugging\r\n-  });\r\n-\r\n-  // Add loading state check\r\n-  useEffect(() => {\r\n-    if (loading || isTransitioning) {\r\n-      return;\r\n-    }\r\n   \r\n+  \r\n   if (!context) {\r\n     console.warn('useAuth must be used within an AuthProvider');\r\n     return { user: null, loading: false };\r\n   }\r\n"
                },
                {
                    "date": 1740686604109,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -71,8 +71,23 @@\n   \r\n   // Now we can safely use context\r\n   const { user } = context;\r\n   const queryClient = new QueryClient();\r\n+\r\n+  // Add debug logging\r\n+  console.log('Auth Context:', {\r\n+    hasUser: !!user,\r\n+    userRole: user?.role,\r\n+    userId: user?.id,\r\n+    isLoading: loading,\r\n+    fullUser: user // Log the full user object for debugging\r\n+  });\r\n+\r\n+  // Add loading state check\r\n+  useEffect(() => {\r\n+    if (loading || isTransitioning) {\r\n+      return;\r\n+    }\r\n   \r\n   // Add loading state check\r\n   useEffect(() => {\r\n     if (loading || isTransitioning) {\r\n"
                },
                {
                    "date": 1740686739263,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -59,9 +59,9 @@\n   useEffect(() => {\r\n     if (loading || isTransitioning) {\r\n       return;\r\n     }\r\n-    // Effect logic here\r\n+    // Add your effect logic here\r\n   }, [loading, isTransitioning]);\r\n   \r\n   \r\n   if (!context) {\r\n"
                },
                {
                    "date": 1740686776674,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -461,5 +461,5 @@\n     signUp,\r\n     resetPassword,\r\n     sessionManager\r\n   };\r\n-}\n\\ No newline at end of file\n+}}\n\\ No newline at end of file\n"
                },
                {
                    "date": 1740686982633,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -85,9 +85,9 @@\n   // Add loading state check\r\n   useEffect(() => {\r\n     if (loading || isTransitioning) {\r\n       return;\r\n-    }\r\n+    })\r\n   \r\n   // Add loading state check\r\n   useEffect(() => {\r\n     if (loading || isTransitioning) {\r\n"
                },
                {
                    "date": 1740686995908,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -85,9 +85,10 @@\n   // Add loading state check\r\n   useEffect(() => {\r\n     if (loading || isTransitioning) {\r\n       return;\r\n-    })\r\n+    }\r\n+  }, [loading, isTransitioning]);\r\n   \r\n   // Add loading state check\r\n   useEffect(() => {\r\n     if (loading || isTransitioning) {\r\n@@ -461,5 +462,5 @@\n     signUp,\r\n     resetPassword,\r\n     sessionManager\r\n   };\r\n-}}\n\\ No newline at end of file\n+}\n\\ No newline at end of file\n"
                },
                {
                    "date": 1740687058021,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -36,8 +36,9 @@\n   const { isTransitioning } = useRoleStore();\r\n   const navigate = useNavigate();\r\n   const location = useLocation();\r\n   const [_authState, setSessionAuthState] = useState(sessionMonitor.getState());\r\n+  const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n   \r\n   // Subscribe to session state updates\r\n   useEffect(() => {\r\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setSessionAuthState);\r\n@@ -62,9 +63,8 @@\n     }\r\n     // Add your effect logic here\r\n   }, [loading, isTransitioning]);\r\n   \r\n-  \r\n   if (!context) {\r\n     console.warn('useAuth must be used within an AuthProvider');\r\n     return { user: null, loading: false };\r\n   }\r\n@@ -430,15 +430,8 @@\n       }\r\n     }\r\n   };\r\n \r\n-  const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n-\r\n-  useEffect(() => {\r\n-    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n-    return () => unsubscribe();\r\n-  }, []);\r\n-\r\n   const checkAndRefreshSession = async (): Promise<void> => {\r\n     try {\r\n       await sessionManager.checkAndRefreshSession();\r\n     } catch (error) {\r\n"
                },
                {
                    "date": 1740687114534,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -430,8 +430,15 @@\n       }\r\n     }\r\n   };\r\n \r\n+  const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n+\r\n+  useEffect(() => {\r\n+    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n+    return () => unsubscribe();\r\n+  }, []);\r\n+\r\n   const checkAndRefreshSession = async (): Promise<void> => {\r\n     try {\r\n       await sessionManager.checkAndRefreshSession();\r\n     } catch (error) {\r\n"
                },
                {
                    "date": 1740687197094,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -430,9 +430,9 @@\n       }\r\n     }\r\n   };\r\n \r\n-  const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n+  //const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n \r\n   useEffect(() => {\r\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n     return () => unsubscribe();\r\n"
                },
                {
                    "date": 1740687326225,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -44,8 +44,13 @@\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setSessionAuthState);\r\n     return () => unsubscribe();\r\n   }, []);\r\n   \r\n+  useEffect(() => {\r\n+    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n+    return () => unsubscribe();\r\n+  }, []);\r\n+  \r\n   // Define a dummy loading value for the early return case\r\n   const loading = context?.loading || false;\r\n   \r\n   // Add loading state check - this will run regardless of context\r\n@@ -430,15 +435,8 @@\n       }\r\n     }\r\n   };\r\n \r\n-  //const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n-\r\n-  useEffect(() => {\r\n-    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n-    return () => unsubscribe();\r\n-  }, []);\r\n-\r\n   const checkAndRefreshSession = async (): Promise<void> => {\r\n     try {\r\n       await sessionManager.checkAndRefreshSession();\r\n     } catch (error) {\r\n"
                },
                {
                    "date": 1740687348437,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -435,8 +435,15 @@\n       }\r\n     }\r\n   };\r\n \r\n+  //const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n+\r\n+  useEffect(() => {\r\n+    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n+    return () => unsubscribe();\r\n+  }, []);\r\n+\r\n   const checkAndRefreshSession = async (): Promise<void> => {\r\n     try {\r\n       await sessionManager.checkAndRefreshSession();\r\n     } catch (error) {\r\n"
                },
                {
                    "date": 1740687421106,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -68,8 +68,52 @@\n     }\r\n     // Add your effect logic here\r\n   }, [loading, isTransitioning]);\r\n   \r\n+  // Add loading state check\r\n+  useEffect(() => {\r\n+    if (loading) {\r\n+      logger.info('Auth loading state active', {\r\n+        source: 'useAuth',\r\n+        context: { loading }\r\n+      });\r\n+    }\r\n+  }, [loading]);\r\n+\r\n+  // Auto-refresh session when it's about to expire\r\n+  useEffect(() => {\r\n+    if (!context?.user) return;\r\n+    const refreshInterval = setInterval(async () => {\r\n+      try {\r\n+        await sessionManager.refreshSession();\r\n+      } catch (err) {\r\n+        logger.error('Failed to refresh session', {\r\n+          source: 'useAuth',\r\n+          context: { error: err }\r\n+        });\r\n+      }\r\n+    }, 4 * 60 * 1000); // Check every 4 minutes\r\n+    \r\n+    return () => {\r\n+      if (refreshInterval) {\r\n+        clearInterval(refreshInterval);\r\n+      }\r\n+    };\r\n+  }, [context?.user]);\r\n+\r\n+  useEffect(() => {\r\n+    if (context?.user) {\r\n+      logger.debug('Auth state check on route change', {\r\n+        source: 'useAuth',\r\n+        context: {\r\n+          role: context.user.role,\r\n+          path: location.pathname,\r\n+          permissions: ROLE_PERMISSIONS[context.user.role]?.permissions\r\n+        }\r\n+      });\r\n+    }\r\n+  }, [context?.user, location.pathname]);\r\n+  \r\n   if (!context) {\r\n     console.warn('useAuth must be used within an AuthProvider');\r\n     return { user: null, loading: false };\r\n   }\r\n@@ -106,20 +150,9 @@\n       userId: user?.id,\r\n     isLoading: loading,\r\n     fullUser: user // Log the full user object for debugging\r\n   });\r\n-});\r\n \r\n-  // Add loading state check\r\n-  useEffect(() => {\r\n-    if (loading) {\r\n-      logger.info('Auth loading state active', {\r\n-        source: 'useAuth',\r\n-        context: { loading }\r\n-      });\r\n-    }\r\n-  }, [loading]);\r\n-\r\n   // Auto-refresh session when it's about to expire\r\n   useEffect(() => {\r\n     if (!user) return;\r\n     const refreshInterval = setInterval(async () => {\r\n"
                },
                {
                    "date": 1740687659445,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -65,9 +65,16 @@\n   useEffect(() => {\r\n     if (loading || isTransitioning) {\r\n       return;\r\n     }\r\n+    \r\n     // Add your effect logic here\r\n+    // Don't return anything except a cleanup function\r\n+    \r\n+    // Optional cleanup function\r\n+    return () => {\r\n+      // Cleanup code here if needed\r\n+    };\r\n   }, [loading, isTransitioning]);\r\n   \r\n   // Add loading state check\r\n   useEffect(() => {\r\n"
                },
                {
                    "date": 1740687835371,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -154,11 +154,13 @@\n     console.log('Auth Context:', {\r\n       hasUser: !!user,\r\n       userRole: user?.role,\r\n       userId: user?.id,\r\n-    isLoading: loading,\r\n-    fullUser: user // Log the full user object for debugging\r\n-  });\r\n+      isLoading: loading,\r\n+      fullUser: user // Log the full user object for debugging\r\n+    });\r\n+    // Don't return anything here\r\n+  }, [loading, isTransitioning, user]);\r\n \r\n   // Auto-refresh session when it's about to expire\r\n   useEffect(() => {\r\n     if (!user) return;\r\n"
                },
                {
                    "date": 1740687988887,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -65,16 +65,9 @@\n   useEffect(() => {\r\n     if (loading || isTransitioning) {\r\n       return;\r\n     }\r\n-    \r\n     // Add your effect logic here\r\n-    // Don't return anything except a cleanup function\r\n-    \r\n-    // Optional cleanup function\r\n-    return () => {\r\n-      // Cleanup code here if needed\r\n-    };\r\n   }, [loading, isTransitioning]);\r\n   \r\n   // Add loading state check\r\n   useEffect(() => {\r\n@@ -127,387 +120,9 @@\n   \r\n   // Now we can safely use context\r\n   const { user } = context;\r\n   const queryClient = new QueryClient();\r\n-\r\n-  // Add debug logging\r\n-  console.log('Auth Context:', {\r\n-    hasUser: !!user,\r\n-    userRole: user?.role,\r\n-    userId: user?.id,\r\n-    isLoading: loading,\r\n-    fullUser: user // Log the full user object for debugging\r\n-  });\r\n-\r\n-  // Add loading state check\r\n-  useEffect(() => {\r\n-    if (loading || isTransitioning) {\r\n-      return;\r\n-    }\r\n-  }, [loading, isTransitioning]);\r\n   \r\n-  // Add loading state check\r\n-  useEffect(() => {\r\n-    if (loading || isTransitioning) {\r\n-      return;\r\n-    }\r\n-\r\n-    console.log('Auth Context:', {\r\n-      hasUser: !!user,\r\n-      userRole: user?.role,\r\n-      userId: user?.id,\r\n-      isLoading: loading,\r\n-      fullUser: user // Log the full user object for debugging\r\n-    });\r\n-    // Don't return anything here\r\n-  }, [loading, isTransitioning, user]);\r\n-\r\n-  // Auto-refresh session when it's about to expire\r\n-  useEffect(() => {\r\n-    if (!user) return;\r\n-    const refreshInterval = setInterval(async () => {\r\n-      try {\r\n-        await sessionManager.refreshSession();\r\n-      } catch (err) {\r\n-        logger.error('Failed to refresh session', {\r\n-          source: 'useAuth',\r\n-          context: { error: err }\r\n-        });\r\n-      }\r\n-    }, 4 * 60 * 1000); // Check every 4 minutes\r\n-    \r\n-    return () => {\r\n-      if (refreshInterval) {\r\n-        clearInterval(refreshInterval);\r\n-      }\r\n-    };\r\n-  }, [user]);\r\n-\r\n-  useEffect(() => {\r\n-    if (user) {\r\n-      logger.debug('Auth state check on route change', {\r\n-        source: 'useAuth',\r\n-        context: {\r\n-          role: user.role,\r\n-          path: location.pathname,\r\n-          permissions: ROLE_PERMISSIONS[user.role]?.permissions\r\n-        }\r\n-      });\r\n-    }\r\n-  }, [user, location.pathname]);\r\n-\r\n-  const changeRole = async (newRole: UserRole): Promise<void> => {\r\n-    if (!context.user || isTransitioning) return;\r\n-\r\n-    try {\r\n-      await roleTransitionManager.transitionRole(newRole);\r\n-      \r\n-      // Clear cache and refetch with new role\r\n-      queryClient.clear();\r\n-      await queryClient.resetQueries();\r\n-      \r\n-      // Update context user\r\n-      context.setUser({\r\n-        ...context.user,\r\n-        role: newRole\r\n-      });\r\n-\r\n-      // Navigate to home with fresh data\r\n-      navigate('/', { replace: true });\r\n-    } catch (err) {\r\n-      logger.error('Failed to change role', {\r\n-        source: 'useAuth',\r\n-        context: { error: err }\r\n-      });\r\n-      throw err;\r\n-    }\r\n-  };\r\n-\r\n-  const login = async (credentials: LoginCredentials) => {\r\n-    try {\r\n-      console.log('[Auth] Attempting login:', {\r\n-        email: credentials.email,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-      \r\n-      const { data, error } = await supabaseClient.auth.signInWithPassword({\r\n-        email: credentials.email,\r\n-        password: credentials.password,\r\n-      });\r\n-\r\n-      if (error) {\r\n-        console.error('[Auth] Supabase login error:', {\r\n-          message: error.message,\r\n-          status: error.status,\r\n-          name: error.name,\r\n-          timestamp: new Date().toISOString()\r\n-        });\r\n-        \r\n-        // Provide more specific error messages\r\n-        if (error.message.includes('Invalid login credentials')) {\r\n-          throw new Error('Invalid email or password. Please check your credentials and try again.');\r\n-        }\r\n-        \r\n-        logger.error('Login failed', {\r\n-          context: { \r\n-            error,\r\n-            credentials: { email: credentials.email }\r\n-          },\r\n-          source: 'useAuth'\r\n-        });\r\n-        throw new Error(error.message);\r\n-      }\r\n-\r\n-      console.log('[Auth] Login response:', {\r\n-        hasUser: !!data.user,\r\n-        userId: data.user?.id,\r\n-        userEmail: data.user?.email,\r\n-        metadata: data.user?.user_metadata,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-\r\n-      if (!data.user) {\r\n-        throw new Error('Login successful but user data is missing');\r\n-      }\r\n-\r\n-      // Map Supabase user to our user format\r\n-      const mappedUser = {\r\n-        id: data.user.id,\r\n-        email: data.user.email!,\r\n-        name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\r\n-        role: data.user.user_metadata?.role || 'student',\r\n-        photoUrl: data.user.user_metadata?.avatar_url,\r\n-      };\r\n-\r\n-      console.log('[Auth] Mapped user:', mappedUser);\r\n-\r\n-      context.setUser(mappedUser);\r\n-      return { user: mappedUser };\r\n-    } catch (error) {\r\n-      const errorDetails = error instanceof Error ? {\r\n-        message: error.message,\r\n-        name: error.name,\r\n-        stack: error.stack\r\n-      } : error;\r\n-\r\n-      console.error('[Auth] Login error details:', {\r\n-        error: errorDetails,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-\r\n-      logger.error('Login failed', {\r\n-        context: { \r\n-          error: errorDetails,\r\n-          credentials: { email: credentials.email }\r\n-        },\r\n-        source: 'useAuth'\r\n-      });\r\n-\r\n-      if (error instanceof Error) {\r\n-        throw error;\r\n-      } else {\r\n-        throw new Error('An unexpected error occurred. Please try again.');\r\n-      }\r\n-    }\r\n-  };\r\n-\r\n-  const logout = async () => {\r\n-    try {\r\n-      const { error } = await supabaseClient.auth.signOut();\r\n-      \r\n-      if (error) {\r\n-        throw error;\r\n-      }\r\n-\r\n-      context.setUser(null);\r\n-      queryClient.clear();\r\n-      navigate('/login');\r\n-    } catch (error) {\r\n-      logger.error('Logout failed', {\r\n-        context: { error },\r\n-        source: 'useAuth'\r\n-      });\r\n-      throw error;\r\n-    }\r\n-  };\r\n-\r\n-  const signUp = async (credentials: SignUpCredentials) => {\r\n-    try {\r\n-      console.log('[Auth] Attempting signup:', {\r\n-        email: credentials.email,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-      \r\n-      const { data, error } = await supabaseClient.auth.signUp({\r\n-        email: credentials.email,\r\n-        password: credentials.password,\r\n-        options: {\r\n-          data: {\r\n-            name: credentials.name || credentials.email.split('@')[0],\r\n-            role: 'student'\r\n-          }\r\n-        }\r\n-      });\r\n-\r\n-      if (error) {\r\n-        console.error('[Auth] Supabase signup error:', {\r\n-          message: error.message,\r\n-          status: error.status,\r\n-          name: error.name,\r\n-          timestamp: new Date().toISOString()\r\n-        });\r\n-        \r\n-        logger.error('Signup failed', {\r\n-          context: { \r\n-            error,\r\n-            credentials: { email: credentials.email }\r\n-          },\r\n-          source: 'useAuth'\r\n-        });\r\n-        throw new Error(error.message);\r\n-      }\r\n-\r\n-      console.log('[Auth] Signup response:', {\r\n-        hasUser: !!data.user,\r\n-        userId: data.user?.id,\r\n-        userEmail: data.user?.email,\r\n-        metadata: data.user?.user_metadata,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-\r\n-      if (!data.user) {\r\n-        throw new Error('Signup successful but user data is missing');\r\n-      }\r\n-\r\n-      // Map Supabase user to our user format\r\n-      const mappedUser = {\r\n-        id: data.user.id,\r\n-        email: data.user.email!,\r\n-        name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\r\n-        role: data.user.user_metadata?.role || 'student',\r\n-        photoUrl: data.user.user_metadata?.avatar_url,\r\n-      };\r\n-\r\n-      console.log('[Auth] Mapped user:', mappedUser);\r\n-\r\n-      context.setUser(mappedUser);\r\n-      return { user: mappedUser };\r\n-    } catch (error) {\r\n-      const errorDetails = error instanceof Error ? {\r\n-        message: error.message,\r\n-        name: error.name,\r\n-        stack: error.stack\r\n-      } : error;\r\n-\r\n-      console.error('[Auth] Signup error details:', {\r\n-        error: errorDetails,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-\r\n-      logger.error('Signup failed', {\r\n-        context: { \r\n-          error: errorDetails,\r\n-          credentials: { email: credentials.email }\r\n-        },\r\n-        source: 'useAuth'\r\n-      });\r\n-\r\n-      if (error instanceof Error) {\r\n-        throw error;\r\n-      } else {\r\n-        throw new Error('An unexpected error occurred during signup. Please try again.');\r\n-      }\r\n-    }\r\n-  };\r\n-\r\n-  const resetPassword = async (credentials: ResetPasswordCredentials) => {\r\n-    try {\r\n-      console.log('[Auth] Attempting password reset:', {\r\n-        email: credentials.email,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-      \r\n-      const { data, error } = await supabaseClient.auth.resetPasswordForEmail(\r\n-        credentials.email,\r\n-        { redirectTo: `${window.location.origin}/reset-password` }\r\n-      );\r\n-\r\n-      if (error) {\r\n-        console.error('[Auth] Supabase password reset error:', {\r\n-          message: error.message,\r\n-          status: error.status,\r\n-          name: error.name,\r\n-          timestamp: new Date().toISOString()\r\n-        });\r\n-        \r\n-        logger.error('Password reset failed', {\r\n-          context: { \r\n-            error,\r\n-            credentials: { email: credentials.email }\r\n-          },\r\n-          source: 'useAuth'\r\n-        });\r\n-        throw new Error(error.message);\r\n-      }\r\n-\r\n-      return data;\r\n-    } catch (error) {\r\n-      const errorDetails = error instanceof Error ? {\r\n-        message: error.message,\r\n-        name: error.name,\r\n-        stack: error.stack\r\n-      } : error;\r\n-\r\n-      console.error('[Auth] Password reset error details:', {\r\n-        error: errorDetails,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-\r\n-      logger.error('Password reset failed', {\r\n-        context: { \r\n-          error: errorDetails,\r\n-          credentials: { email: credentials.email }\r\n-        },\r\n-        source: 'useAuth'\r\n-      });\r\n-\r\n-      if (error instanceof Error) {\r\n-        throw error;\r\n-      } else {\r\n-        throw new Error('An unexpected error occurred during password reset. Please try again.');\r\n-      }\r\n-    }\r\n-  };\r\n-\r\n-  //const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n-\r\n-  useEffect(() => {\r\n-    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n-    return () => unsubscribe();\r\n-  }, []);\r\n-\r\n-  const checkAndRefreshSession = async (): Promise<void> => {\r\n-    try {\r\n-      await sessionManager.checkAndRefreshSession();\r\n-    } catch (error) {\r\n-      logger.error('Failed to check and refresh session', {\r\n-        context: { error },\r\n-        source: 'useAuth'\r\n-      });\r\n-    }\r\n-  };\r\n-\r\n-  return {\r\n-    user: user ? {\r\n-      ...user,\r\n-      role: user.role || 'unknown'\r\n-    } : null,\r\n-    loading,\r\n-    changeRole,\r\n-    isTransitioning,\r\n-    login,\r\n-    logout,\r\n-    signUp,\r\n-    resetPassword,\r\n-    sessionManager\r\n-  };\r\n+  // NO MORE HOOKS AFTER THIS POINT\r\n+  \r\n+  // Rest of the hook implementation...\r\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1740687999927,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -65,9 +65,16 @@\n   useEffect(() => {\r\n     if (loading || isTransitioning) {\r\n       return;\r\n     }\r\n+    \r\n     // Add your effect logic here\r\n+    // Don't return anything except a cleanup function\r\n+    \r\n+    // Optional cleanup function\r\n+    return () => {\r\n+      // Cleanup code here if needed\r\n+    };\r\n   }, [loading, isTransitioning]);\r\n   \r\n   // Add loading state check\r\n   useEffect(() => {\r\n@@ -120,9 +127,387 @@\n   \r\n   // Now we can safely use context\r\n   const { user } = context;\r\n   const queryClient = new QueryClient();\r\n+\r\n+  // Add debug logging\r\n+  console.log('Auth Context:', {\r\n+    hasUser: !!user,\r\n+    userRole: user?.role,\r\n+    userId: user?.id,\r\n+    isLoading: loading,\r\n+    fullUser: user // Log the full user object for debugging\r\n+  });\r\n+\r\n+  // Add loading state check\r\n+  useEffect(() => {\r\n+    if (loading || isTransitioning) {\r\n+      return;\r\n+    }\r\n+  }, [loading, isTransitioning]);\r\n   \r\n-  // NO MORE HOOKS AFTER THIS POINT\r\n-  \r\n-  // Rest of the hook implementation...\r\n+  // Add loading state check\r\n+  useEffect(() => {\r\n+    if (loading || isTransitioning) {\r\n+      return;\r\n+    }\r\n+\r\n+    console.log('Auth Context:', {\r\n+      hasUser: !!user,\r\n+      userRole: user?.role,\r\n+      userId: user?.id,\r\n+      isLoading: loading,\r\n+      fullUser: user // Log the full user object for debugging\r\n+    });\r\n+    // Don't return anything here\r\n+  }, [loading, isTransitioning, user]);\r\n+\r\n+  // Auto-refresh session when it's about to expire\r\n+  useEffect(() => {\r\n+    if (!user) return;\r\n+    const refreshInterval = setInterval(async () => {\r\n+      try {\r\n+        await sessionManager.refreshSession();\r\n+      } catch (err) {\r\n+        logger.error('Failed to refresh session', {\r\n+          source: 'useAuth',\r\n+          context: { error: err }\r\n+        });\r\n+      }\r\n+    }, 4 * 60 * 1000); // Check every 4 minutes\r\n+    \r\n+    return () => {\r\n+      if (refreshInterval) {\r\n+        clearInterval(refreshInterval);\r\n+      }\r\n+    };\r\n+  }, [user]);\r\n+\r\n+  useEffect(() => {\r\n+    if (user) {\r\n+      logger.debug('Auth state check on route change', {\r\n+        source: 'useAuth',\r\n+        context: {\r\n+          role: user.role,\r\n+          path: location.pathname,\r\n+          permissions: ROLE_PERMISSIONS[user.role]?.permissions\r\n+        }\r\n+      });\r\n+    }\r\n+  }, [user, location.pathname]);\r\n+\r\n+  const changeRole = async (newRole: UserRole): Promise<void> => {\r\n+    if (!context.user || isTransitioning) return;\r\n+\r\n+    try {\r\n+      await roleTransitionManager.transitionRole(newRole);\r\n+      \r\n+      // Clear cache and refetch with new role\r\n+      queryClient.clear();\r\n+      await queryClient.resetQueries();\r\n+      \r\n+      // Update context user\r\n+      context.setUser({\r\n+        ...context.user,\r\n+        role: newRole\r\n+      });\r\n+\r\n+      // Navigate to home with fresh data\r\n+      navigate('/', { replace: true });\r\n+    } catch (err) {\r\n+      logger.error('Failed to change role', {\r\n+        source: 'useAuth',\r\n+        context: { error: err }\r\n+      });\r\n+      throw err;\r\n+    }\r\n+  };\r\n+\r\n+  const login = async (credentials: LoginCredentials) => {\r\n+    try {\r\n+      console.log('[Auth] Attempting login:', {\r\n+        email: credentials.email,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+      \r\n+      const { data, error } = await supabaseClient.auth.signInWithPassword({\r\n+        email: credentials.email,\r\n+        password: credentials.password,\r\n+      });\r\n+\r\n+      if (error) {\r\n+        console.error('[Auth] Supabase login error:', {\r\n+          message: error.message,\r\n+          status: error.status,\r\n+          name: error.name,\r\n+          timestamp: new Date().toISOString()\r\n+        });\r\n+        \r\n+        // Provide more specific error messages\r\n+        if (error.message.includes('Invalid login credentials')) {\r\n+          throw new Error('Invalid email or password. Please check your credentials and try again.');\r\n+        }\r\n+        \r\n+        logger.error('Login failed', {\r\n+          context: { \r\n+            error,\r\n+            credentials: { email: credentials.email }\r\n+          },\r\n+          source: 'useAuth'\r\n+        });\r\n+        throw new Error(error.message);\r\n+      }\r\n+\r\n+      console.log('[Auth] Login response:', {\r\n+        hasUser: !!data.user,\r\n+        userId: data.user?.id,\r\n+        userEmail: data.user?.email,\r\n+        metadata: data.user?.user_metadata,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+\r\n+      if (!data.user) {\r\n+        throw new Error('Login successful but user data is missing');\r\n+      }\r\n+\r\n+      // Map Supabase user to our user format\r\n+      const mappedUser = {\r\n+        id: data.user.id,\r\n+        email: data.user.email!,\r\n+        name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\r\n+        role: data.user.user_metadata?.role || 'student',\r\n+        photoUrl: data.user.user_metadata?.avatar_url,\r\n+      };\r\n+\r\n+      console.log('[Auth] Mapped user:', mappedUser);\r\n+\r\n+      context.setUser(mappedUser);\r\n+      return { user: mappedUser };\r\n+    } catch (error) {\r\n+      const errorDetails = error instanceof Error ? {\r\n+        message: error.message,\r\n+        name: error.name,\r\n+        stack: error.stack\r\n+      } : error;\r\n+\r\n+      console.error('[Auth] Login error details:', {\r\n+        error: errorDetails,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+\r\n+      logger.error('Login failed', {\r\n+        context: { \r\n+          error: errorDetails,\r\n+          credentials: { email: credentials.email }\r\n+        },\r\n+        source: 'useAuth'\r\n+      });\r\n+\r\n+      if (error instanceof Error) {\r\n+        throw error;\r\n+      } else {\r\n+        throw new Error('An unexpected error occurred. Please try again.');\r\n+      }\r\n+    }\r\n+  };\r\n+\r\n+  const logout = async () => {\r\n+    try {\r\n+      const { error } = await supabaseClient.auth.signOut();\r\n+      \r\n+      if (error) {\r\n+        throw error;\r\n+      }\r\n+\r\n+      context.setUser(null);\r\n+      queryClient.clear();\r\n+      navigate('/login');\r\n+    } catch (error) {\r\n+      logger.error('Logout failed', {\r\n+        context: { error },\r\n+        source: 'useAuth'\r\n+      });\r\n+      throw error;\r\n+    }\r\n+  };\r\n+\r\n+  const signUp = async (credentials: SignUpCredentials) => {\r\n+    try {\r\n+      console.log('[Auth] Attempting signup:', {\r\n+        email: credentials.email,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+      \r\n+      const { data, error } = await supabaseClient.auth.signUp({\r\n+        email: credentials.email,\r\n+        password: credentials.password,\r\n+        options: {\r\n+          data: {\r\n+            name: credentials.name || credentials.email.split('@')[0],\r\n+            role: 'student'\r\n+          }\r\n+        }\r\n+      });\r\n+\r\n+      if (error) {\r\n+        console.error('[Auth] Supabase signup error:', {\r\n+          message: error.message,\r\n+          status: error.status,\r\n+          name: error.name,\r\n+          timestamp: new Date().toISOString()\r\n+        });\r\n+        \r\n+        logger.error('Signup failed', {\r\n+          context: { \r\n+            error,\r\n+            credentials: { email: credentials.email }\r\n+          },\r\n+          source: 'useAuth'\r\n+        });\r\n+        throw new Error(error.message);\r\n+      }\r\n+\r\n+      console.log('[Auth] Signup response:', {\r\n+        hasUser: !!data.user,\r\n+        userId: data.user?.id,\r\n+        userEmail: data.user?.email,\r\n+        metadata: data.user?.user_metadata,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+\r\n+      if (!data.user) {\r\n+        throw new Error('Signup successful but user data is missing');\r\n+      }\r\n+\r\n+      // Map Supabase user to our user format\r\n+      const mappedUser = {\r\n+        id: data.user.id,\r\n+        email: data.user.email!,\r\n+        name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\r\n+        role: data.user.user_metadata?.role || 'student',\r\n+        photoUrl: data.user.user_metadata?.avatar_url,\r\n+      };\r\n+\r\n+      console.log('[Auth] Mapped user:', mappedUser);\r\n+\r\n+      context.setUser(mappedUser);\r\n+      return { user: mappedUser };\r\n+    } catch (error) {\r\n+      const errorDetails = error instanceof Error ? {\r\n+        message: error.message,\r\n+        name: error.name,\r\n+        stack: error.stack\r\n+      } : error;\r\n+\r\n+      console.error('[Auth] Signup error details:', {\r\n+        error: errorDetails,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+\r\n+      logger.error('Signup failed', {\r\n+        context: { \r\n+          error: errorDetails,\r\n+          credentials: { email: credentials.email }\r\n+        },\r\n+        source: 'useAuth'\r\n+      });\r\n+\r\n+      if (error instanceof Error) {\r\n+        throw error;\r\n+      } else {\r\n+        throw new Error('An unexpected error occurred during signup. Please try again.');\r\n+      }\r\n+    }\r\n+  };\r\n+\r\n+  const resetPassword = async (credentials: ResetPasswordCredentials) => {\r\n+    try {\r\n+      console.log('[Auth] Attempting password reset:', {\r\n+        email: credentials.email,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+      \r\n+      const { data, error } = await supabaseClient.auth.resetPasswordForEmail(\r\n+        credentials.email,\r\n+        { redirectTo: `${window.location.origin}/reset-password` }\r\n+      );\r\n+\r\n+      if (error) {\r\n+        console.error('[Auth] Supabase password reset error:', {\r\n+          message: error.message,\r\n+          status: error.status,\r\n+          name: error.name,\r\n+          timestamp: new Date().toISOString()\r\n+        });\r\n+        \r\n+        logger.error('Password reset failed', {\r\n+          context: { \r\n+            error,\r\n+            credentials: { email: credentials.email }\r\n+          },\r\n+          source: 'useAuth'\r\n+        });\r\n+        throw new Error(error.message);\r\n+      }\r\n+\r\n+      return data;\r\n+    } catch (error) {\r\n+      const errorDetails = error instanceof Error ? {\r\n+        message: error.message,\r\n+        name: error.name,\r\n+        stack: error.stack\r\n+      } : error;\r\n+\r\n+      console.error('[Auth] Password reset error details:', {\r\n+        error: errorDetails,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+\r\n+      logger.error('Password reset failed', {\r\n+        context: { \r\n+          error: errorDetails,\r\n+          credentials: { email: credentials.email }\r\n+        },\r\n+        source: 'useAuth'\r\n+      });\r\n+\r\n+      if (error instanceof Error) {\r\n+        throw error;\r\n+      } else {\r\n+        throw new Error('An unexpected error occurred during password reset. Please try again.');\r\n+      }\r\n+    }\r\n+  };\r\n+\r\n+  //const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n+\r\n+  useEffect(() => {\r\n+    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n+    return () => unsubscribe();\r\n+  }, []);\r\n+\r\n+  const checkAndRefreshSession = async (): Promise<void> => {\r\n+    try {\r\n+      await sessionManager.checkAndRefreshSession();\r\n+    } catch (error) {\r\n+      logger.error('Failed to check and refresh session', {\r\n+        context: { error },\r\n+        source: 'useAuth'\r\n+      });\r\n+    }\r\n+  };\r\n+\r\n+  return {\r\n+    user: user ? {\r\n+      ...user,\r\n+      role: user.role || 'unknown'\r\n+    } : null,\r\n+    loading,\r\n+    changeRole,\r\n+    isTransitioning,\r\n+    login,\r\n+    logout,\r\n+    signUp,\r\n+    resetPassword,\r\n+    sessionManager\r\n+  };\r\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1740688050509,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -30,66 +30,44 @@\n   email: string;\r\n   }\r\n \r\n export function useAuth() {\r\n-  // All hooks must be called at the top level\r\n+  // All hooks at the top level\r\n   const context = useContext(AuthContext);\r\n   const { isTransitioning } = useRoleStore();\r\n   const navigate = useNavigate();\r\n   const location = useLocation();\r\n-  const [_authState, setSessionAuthState] = useState(sessionMonitor.getState());\r\n   const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n-  \r\n-  // Subscribe to session state updates\r\n+  const queryClient = new QueryClient();\r\n+  const loading = context?.loading || false;\r\n+  const user = context?.user;\r\n+\r\n+  // Session monitor subscription\r\n   useEffect(() => {\r\n-    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setSessionAuthState);\r\n-    return () => unsubscribe();\r\n-  }, []);\r\n-  \r\n-  useEffect(() => {\r\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n     return () => unsubscribe();\r\n   }, []);\r\n-  \r\n-  // Define a dummy loading value for the early return case\r\n-  const loading = context?.loading || false;\r\n-  \r\n-  // Add loading state check - this will run regardless of context\r\n+\r\n+  // Loading and transition state check\r\n   useEffect(() => {\r\n-    if (!context || loading || isTransitioning) {\r\n-      return;\r\n-    }\r\n-    // Effect logic here\r\n-  }, [context, loading, isTransitioning]);\r\n-  \r\n-  // Add loading state check\r\n-  useEffect(() => {\r\n-    if (loading || isTransitioning) {\r\n-      return;\r\n-    }\r\n+    if (loading || isTransitioning) return;\r\n     \r\n-    // Add your effect logic here\r\n-    // Don't return anything except a cleanup function\r\n-    \r\n-    // Optional cleanup function\r\n-    return () => {\r\n-      // Cleanup code here if needed\r\n-    };\r\n-  }, [loading, isTransitioning]);\r\n-  \r\n-  // Add loading state check\r\n-  useEffect(() => {\r\n-    if (loading) {\r\n-      logger.info('Auth loading state active', {\r\n+    if (user) {\r\n+      logger.debug('Auth state check on route change', {\r\n         source: 'useAuth',\r\n-        context: { loading }\r\n+        context: {\r\n+          role: user.role,\r\n+          path: location.pathname,\r\n+          permissions: ROLE_PERMISSIONS[user.role]?.permissions\r\n+        }\r\n       });\r\n     }\r\n-  }, [loading]);\r\n+  }, [loading, isTransitioning, user, location.pathname]);\r\n \r\n-  // Auto-refresh session when it's about to expire\r\n+  // Session refresh\r\n   useEffect(() => {\r\n-    if (!context?.user) return;\r\n+    if (!user) return;\r\n+    \r\n     const refreshInterval = setInterval(async () => {\r\n       try {\r\n         await sessionManager.refreshSession();\r\n       } catch (err) {\r\n@@ -97,46 +75,30 @@\n           source: 'useAuth',\r\n           context: { error: err }\r\n         });\r\n       }\r\n-    }, 4 * 60 * 1000); // Check every 4 minutes\r\n+    }, 4 * 60 * 1000);\r\n     \r\n     return () => {\r\n-      if (refreshInterval) {\r\n-        clearInterval(refreshInterval);\r\n-      }\r\n+      if (refreshInterval) clearInterval(refreshInterval);\r\n     };\r\n-  }, [context?.user]);\r\n+  }, [user]);\r\n \r\n-  useEffect(() => {\r\n-    if (context?.user) {\r\n-      logger.debug('Auth state check on route change', {\r\n-        source: 'useAuth',\r\n-        context: {\r\n-          role: context.user.role,\r\n-          path: location.pathname,\r\n-          permissions: ROLE_PERMISSIONS[context.user.role]?.permissions\r\n-        }\r\n-      });\r\n-    }\r\n-  }, [context?.user, location.pathname]);\r\n-  \r\n   if (!context) {\r\n     console.warn('useAuth must be used within an AuthProvider');\r\n     return { user: null, loading: false };\r\n   }\r\n-  \r\n+\r\n   // Now we can safely use context\r\n-  const { user } = context;\r\n-  const queryClient = new QueryClient();\r\n+  const { user: contextUser } = context;\r\n \r\n   // Add debug logging\r\n   console.log('Auth Context:', {\r\n-    hasUser: !!user,\r\n-    userRole: user?.role,\r\n-    userId: user?.id,\r\n+    hasUser: !!contextUser,\r\n+    userRole: contextUser?.role,\r\n+    userId: contextUser?.id,\r\n     isLoading: loading,\r\n-    fullUser: user // Log the full user object for debugging\r\n+    fullUser: contextUser // Log the full user object for debugging\r\n   });\r\n \r\n   // Add loading state check\r\n   useEffect(() => {\r\n@@ -151,53 +113,19 @@\n       return;\r\n     }\r\n \r\n     console.log('Auth Context:', {\r\n-      hasUser: !!user,\r\n-      userRole: user?.role,\r\n-      userId: user?.id,\r\n+      hasUser: !!contextUser,\r\n+      userRole: contextUser?.role,\r\n+      userId: contextUser?.id,\r\n       isLoading: loading,\r\n-      fullUser: user // Log the full user object for debugging\r\n+      fullUser: contextUser // Log the full user object for debugging\r\n     });\r\n     // Don't return anything here\r\n-  }, [loading, isTransitioning, user]);\r\n+  }, [loading, isTransitioning, contextUser]);\r\n \r\n-  // Auto-refresh session when it's about to expire\r\n-  useEffect(() => {\r\n-    if (!user) return;\r\n-    const refreshInterval = setInterval(async () => {\r\n-      try {\r\n-        await sessionManager.refreshSession();\r\n-      } catch (err) {\r\n-        logger.error('Failed to refresh session', {\r\n-          source: 'useAuth',\r\n-          context: { error: err }\r\n-        });\r\n-      }\r\n-    }, 4 * 60 * 1000); // Check every 4 minutes\r\n-    \r\n-    return () => {\r\n-      if (refreshInterval) {\r\n-        clearInterval(refreshInterval);\r\n-      }\r\n-    };\r\n-  }, [user]);\r\n-\r\n-  useEffect(() => {\r\n-    if (user) {\r\n-      logger.debug('Auth state check on route change', {\r\n-        source: 'useAuth',\r\n-        context: {\r\n-          role: user.role,\r\n-          path: location.pathname,\r\n-          permissions: ROLE_PERMISSIONS[user.role]?.permissions\r\n-        }\r\n-      });\r\n-    }\r\n-  }, [user, location.pathname]);\r\n-\r\n   const changeRole = async (newRole: UserRole): Promise<void> => {\r\n-    if (!context.user || isTransitioning) return;\r\n+    if (!contextUser || isTransitioning) return;\r\n \r\n     try {\r\n       await roleTransitionManager.transitionRole(newRole);\r\n       \r\n@@ -206,9 +134,9 @@\n       await queryClient.resetQueries();\r\n       \r\n       // Update context user\r\n       context.setUser({\r\n-        ...context.user,\r\n+        ...contextUser,\r\n         role: newRole\r\n       });\r\n \r\n       // Navigate to home with fresh data\r\n@@ -477,15 +405,8 @@\n       }\r\n     }\r\n   };\r\n \r\n-  //const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n-\r\n-  useEffect(() => {\r\n-    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n-    return () => unsubscribe();\r\n-  }, []);\r\n-\r\n   const checkAndRefreshSession = async (): Promise<void> => {\r\n     try {\r\n       await sessionManager.checkAndRefreshSession();\r\n     } catch (error) {\r\n@@ -496,11 +417,11 @@\n     }\r\n   };\r\n \r\n   return {\r\n-    user: user ? {\r\n-      ...user,\r\n-      role: user.role || 'unknown'\r\n+    user: contextUser ? {\r\n+      ...contextUser,\r\n+      role: contextUser.role || 'unknown'\r\n     } : null,\r\n     loading,\r\n     changeRole,\r\n     isTransitioning,\r\n"
                },
                {
                    "date": 1740688080251,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -30,9 +30,8 @@\n   email: string;\r\n   }\r\n \r\n export function useAuth() {\r\n-  // All hooks at the top level\r\n   const context = useContext(AuthContext);\r\n   const { isTransitioning } = useRoleStore();\r\n   const navigate = useNavigate();\r\n   const location = useLocation();\r\n@@ -40,19 +39,16 @@\n   const queryClient = new QueryClient();\r\n   const loading = context?.loading || false;\r\n   const user = context?.user;\r\n \r\n-  // Session monitor subscription\r\n+  // All useEffect hooks before conditional return\r\n   useEffect(() => {\r\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n     return () => unsubscribe();\r\n   }, []);\r\n \r\n-  // Loading and transition state check\r\n   useEffect(() => {\r\n-    if (loading || isTransitioning) return;\r\n-    \r\n-    if (user) {\r\n+    if (!loading && !isTransitioning && user) {\r\n       logger.debug('Auth state check on route change', {\r\n         source: 'useAuth',\r\n         context: {\r\n           role: user.role,\r\n@@ -62,12 +58,10 @@\n       });\r\n     }\r\n   }, [loading, isTransitioning, user, location.pathname]);\r\n \r\n-  // Session refresh\r\n   useEffect(() => {\r\n     if (!user) return;\r\n-    \r\n     const refreshInterval = setInterval(async () => {\r\n       try {\r\n         await sessionManager.refreshSession();\r\n       } catch (err) {\r\n"
                },
                {
                    "date": 1740688120329,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -36,18 +36,19 @@\n   const navigate = useNavigate();\r\n   const location = useLocation();\r\n   const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n   const queryClient = new QueryClient();\r\n-  const loading = context?.loading || false;\r\n-  const user = context?.user;\r\n \r\n-  // All useEffect hooks before conditional return\r\n+  // All useEffect hooks before any conditional logic\r\n   useEffect(() => {\r\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n     return () => unsubscribe();\r\n   }, []);\r\n \r\n   useEffect(() => {\r\n+    if (!context) return;\r\n+    const { user, loading } = context;\r\n+\r\n     if (!loading && !isTransitioning && user) {\r\n       logger.debug('Auth state check on route change', {\r\n         source: 'useAuth',\r\n         context: {\r\n@@ -56,12 +57,12 @@\n           permissions: ROLE_PERMISSIONS[user.role]?.permissions\r\n         }\r\n       });\r\n     }\r\n-  }, [loading, isTransitioning, user, location.pathname]);\r\n+  }, [context, isTransitioning, location.pathname]);\r\n \r\n   useEffect(() => {\r\n-    if (!user) return;\r\n+    if (!context?.user) return;\r\n     const refreshInterval = setInterval(async () => {\r\n       try {\r\n         await sessionManager.refreshSession();\r\n       } catch (err) {\r\n@@ -74,25 +75,24 @@\n     \r\n     return () => {\r\n       if (refreshInterval) clearInterval(refreshInterval);\r\n     };\r\n-  }, [user]);\r\n+  }, [context]);\r\n \r\n   if (!context) {\r\n     console.warn('useAuth must be used within an AuthProvider');\r\n     return { user: null, loading: false };\r\n   }\r\n \r\n-  // Now we can safely use context\r\n-  const { user: contextUser } = context;\r\n+  const { user, loading } = context;\r\n \r\n   // Add debug logging\r\n   console.log('Auth Context:', {\r\n-    hasUser: !!contextUser,\r\n-    userRole: contextUser?.role,\r\n-    userId: contextUser?.id,\r\n+    hasUser: !!user,\r\n+    userRole: user?.role,\r\n+    userId: user?.id,\r\n     isLoading: loading,\r\n-    fullUser: contextUser // Log the full user object for debugging\r\n+    fullUser: user // Log the full user object for debugging\r\n   });\r\n \r\n   // Add loading state check\r\n   useEffect(() => {\r\n@@ -107,19 +107,53 @@\n       return;\r\n     }\r\n \r\n     console.log('Auth Context:', {\r\n-      hasUser: !!contextUser,\r\n-      userRole: contextUser?.role,\r\n-      userId: contextUser?.id,\r\n+      hasUser: !!user,\r\n+      userRole: user?.role,\r\n+      userId: user?.id,\r\n       isLoading: loading,\r\n-      fullUser: contextUser // Log the full user object for debugging\r\n+      fullUser: user // Log the full user object for debugging\r\n     });\r\n     // Don't return anything here\r\n-  }, [loading, isTransitioning, contextUser]);\r\n+  }, [loading, isTransitioning, user]);\r\n \r\n+  // Auto-refresh session when it's about to expire\r\n+  useEffect(() => {\r\n+    if (!user) return;\r\n+    const refreshInterval = setInterval(async () => {\r\n+      try {\r\n+        await sessionManager.refreshSession();\r\n+      } catch (err) {\r\n+        logger.error('Failed to refresh session', {\r\n+          source: 'useAuth',\r\n+          context: { error: err }\r\n+        });\r\n+      }\r\n+    }, 4 * 60 * 1000); // Check every 4 minutes\r\n+    \r\n+    return () => {\r\n+      if (refreshInterval) {\r\n+        clearInterval(refreshInterval);\r\n+      }\r\n+    };\r\n+  }, [user]);\r\n+\r\n+  useEffect(() => {\r\n+    if (user) {\r\n+      logger.debug('Auth state check on route change', {\r\n+        source: 'useAuth',\r\n+        context: {\r\n+          role: user.role,\r\n+          path: location.pathname,\r\n+          permissions: ROLE_PERMISSIONS[user.role]?.permissions\r\n+        }\r\n+      });\r\n+    }\r\n+  }, [user, location.pathname]);\r\n+\r\n   const changeRole = async (newRole: UserRole): Promise<void> => {\r\n-    if (!contextUser || isTransitioning) return;\r\n+    if (!user || isTransitioning) return;\r\n \r\n     try {\r\n       await roleTransitionManager.transitionRole(newRole);\r\n       \r\n@@ -128,9 +162,9 @@\n       await queryClient.resetQueries();\r\n       \r\n       // Update context user\r\n       context.setUser({\r\n-        ...contextUser,\r\n+        ...user,\r\n         role: newRole\r\n       });\r\n \r\n       // Navigate to home with fresh data\r\n@@ -411,11 +445,11 @@\n     }\r\n   };\r\n \r\n   return {\r\n-    user: contextUser ? {\r\n-      ...contextUser,\r\n-      role: contextUser.role || 'unknown'\r\n+    user: user ? {\r\n+      ...user,\r\n+      role: user.role || 'unknown'\r\n     } : null,\r\n     loading,\r\n     changeRole,\r\n     isTransitioning,\r\n"
                },
                {
                    "date": 1740688354215,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -116,42 +116,8 @@\n     });\r\n     // Don't return anything here\r\n   }, [loading, isTransitioning, user]);\r\n \r\n-  // Auto-refresh session when it's about to expire\r\n-  useEffect(() => {\r\n-    if (!user) return;\r\n-    const refreshInterval = setInterval(async () => {\r\n-      try {\r\n-        await sessionManager.refreshSession();\r\n-      } catch (err) {\r\n-        logger.error('Failed to refresh session', {\r\n-          source: 'useAuth',\r\n-          context: { error: err }\r\n-        });\r\n-      }\r\n-    }, 4 * 60 * 1000); // Check every 4 minutes\r\n-    \r\n-    return () => {\r\n-      if (refreshInterval) {\r\n-        clearInterval(refreshInterval);\r\n-      }\r\n-    };\r\n-  }, [user]);\r\n-\r\n-  useEffect(() => {\r\n-    if (user) {\r\n-      logger.debug('Auth state check on route change', {\r\n-        source: 'useAuth',\r\n-        context: {\r\n-          role: user.role,\r\n-          path: location.pathname,\r\n-          permissions: ROLE_PERMISSIONS[user.role]?.permissions\r\n-        }\r\n-      });\r\n-    }\r\n-  }, [user, location.pathname]);\r\n-\r\n   const changeRole = async (newRole: UserRole): Promise<void> => {\r\n     if (!user || isTransitioning) return;\r\n \r\n     try {\r\n"
                },
                {
                    "date": 1740688396059,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -36,20 +36,31 @@\n   const navigate = useNavigate();\r\n   const location = useLocation();\r\n   const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n   const queryClient = new QueryClient();\r\n+  const loading = context?.loading || false;\r\n+  const user = context?.user;\r\n \r\n-  // All useEffect hooks before any conditional logic\r\n+  // Single session monitor subscription\r\n   useEffect(() => {\r\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n     return () => unsubscribe();\r\n   }, []);\r\n \r\n+  // Combined auth state monitoring\r\n   useEffect(() => {\r\n     if (!context) return;\r\n-    const { user, loading } = context;\r\n \r\n-    if (!loading && !isTransitioning && user) {\r\n+    // Log loading state\r\n+    if (loading) {\r\n+      logger.info('Auth loading state active', {\r\n+        source: 'useAuth',\r\n+        context: { loading }\r\n+      });\r\n+    }\r\n+\r\n+    // Log auth state on route change\r\n+    if (user && !loading && !isTransitioning) {\r\n       logger.debug('Auth state check on route change', {\r\n         source: 'useAuth',\r\n         context: {\r\n           role: user.role,\r\n@@ -57,12 +68,13 @@\n           permissions: ROLE_PERMISSIONS[user.role]?.permissions\r\n         }\r\n       });\r\n     }\r\n-  }, [context, isTransitioning, location.pathname]);\r\n+  }, [context, loading, isTransitioning, user, location.pathname]);\r\n \r\n+  // Session refresh\r\n   useEffect(() => {\r\n-    if (!context?.user) return;\r\n+    if (!user) return;\r\n     const refreshInterval = setInterval(async () => {\r\n       try {\r\n         await sessionManager.refreshSession();\r\n       } catch (err) {\r\n@@ -72,54 +84,30 @@\n         });\r\n       }\r\n     }, 4 * 60 * 1000);\r\n     \r\n-    return () => {\r\n-      if (refreshInterval) clearInterval(refreshInterval);\r\n-    };\r\n-  }, [context]);\r\n+    return () => clearInterval(refreshInterval);\r\n+  }, [user]);\r\n \r\n   if (!context) {\r\n     console.warn('useAuth must be used within an AuthProvider');\r\n     return { user: null, loading: false };\r\n   }\r\n \r\n-  const { user, loading } = context;\r\n+  // Now we can safely use context\r\n+  const { user: contextUser } = context;\r\n \r\n   // Add debug logging\r\n   console.log('Auth Context:', {\r\n-    hasUser: !!user,\r\n-    userRole: user?.role,\r\n-    userId: user?.id,\r\n+    hasUser: !!contextUser,\r\n+    userRole: contextUser?.role,\r\n+    userId: contextUser?.id,\r\n     isLoading: loading,\r\n-    fullUser: user // Log the full user object for debugging\r\n+    fullUser: contextUser // Log the full user object for debugging\r\n   });\r\n \r\n-  // Add loading state check\r\n-  useEffect(() => {\r\n-    if (loading || isTransitioning) {\r\n-      return;\r\n-    }\r\n-  }, [loading, isTransitioning]);\r\n-  \r\n-  // Add loading state check\r\n-  useEffect(() => {\r\n-    if (loading || isTransitioning) {\r\n-      return;\r\n-    }\r\n-\r\n-    console.log('Auth Context:', {\r\n-      hasUser: !!user,\r\n-      userRole: user?.role,\r\n-      userId: user?.id,\r\n-      isLoading: loading,\r\n-      fullUser: user // Log the full user object for debugging\r\n-    });\r\n-    // Don't return anything here\r\n-  }, [loading, isTransitioning, user]);\r\n-\r\n   const changeRole = async (newRole: UserRole): Promise<void> => {\r\n-    if (!user || isTransitioning) return;\r\n+    if (!contextUser || isTransitioning) return;\r\n \r\n     try {\r\n       await roleTransitionManager.transitionRole(newRole);\r\n       \r\n@@ -128,9 +116,9 @@\n       await queryClient.resetQueries();\r\n       \r\n       // Update context user\r\n       context.setUser({\r\n-        ...user,\r\n+        ...contextUser,\r\n         role: newRole\r\n       });\r\n \r\n       // Navigate to home with fresh data\r\n@@ -411,11 +399,11 @@\n     }\r\n   };\r\n \r\n   return {\r\n-    user: user ? {\r\n-      ...user,\r\n-      role: user.role || 'unknown'\r\n+    user: contextUser ? {\r\n+      ...contextUser,\r\n+      role: contextUser.role || 'unknown'\r\n     } : null,\r\n     loading,\r\n     changeRole,\r\n     isTransitioning,\r\n"
                },
                {
                    "date": 1740688453673,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -30,50 +30,140 @@\n   email: string;\r\n   }\r\n \r\n export function useAuth() {\r\n+  // All hooks must be called at the top level\r\n   const context = useContext(AuthContext);\r\n   const { isTransitioning } = useRoleStore();\r\n   const navigate = useNavigate();\r\n   const location = useLocation();\r\n+  const [_authState, setSessionAuthState] = useState(sessionMonitor.getState());\r\n   const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n-  const queryClient = new QueryClient();\r\n-  const loading = context?.loading || false;\r\n-  const user = context?.user;\r\n-\r\n-  // Single session monitor subscription\r\n+  \r\n+  // Subscribe to session state updates\r\n   useEffect(() => {\r\n+    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setSessionAuthState);\r\n+    return () => unsubscribe();\r\n+  }, []);\r\n+  \r\n+  useEffect(() => {\r\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n     return () => unsubscribe();\r\n   }, []);\r\n-\r\n-  // Combined auth state monitoring\r\n+  \r\n+  // Define a dummy loading value for the early return case\r\n+  const loading = context?.loading || false;\r\n+  \r\n+  // Add loading state check - this will run regardless of context\r\n   useEffect(() => {\r\n-    if (!context) return;\r\n-\r\n-    // Log loading state\r\n+    if (!context || loading || isTransitioning) {\r\n+      return;\r\n+    }\r\n+    // Effect logic here\r\n+  }, [context, loading, isTransitioning]);\r\n+  \r\n+  // Add loading state check\r\n+  useEffect(() => {\r\n+    if (loading || isTransitioning) {\r\n+      return;\r\n+    }\r\n+    \r\n+    // Add your effect logic here\r\n+    // Don't return anything except a cleanup function\r\n+    \r\n+    // Optional cleanup function\r\n+    return () => {\r\n+      // Cleanup code here if needed\r\n+    };\r\n+  }, [loading, isTransitioning]);\r\n+  \r\n+  // Add loading state check\r\n+  useEffect(() => {\r\n     if (loading) {\r\n       logger.info('Auth loading state active', {\r\n         source: 'useAuth',\r\n         context: { loading }\r\n       });\r\n     }\r\n+  }, [loading]);\r\n \r\n-    // Log auth state on route change\r\n-    if (user && !loading && !isTransitioning) {\r\n+  // Auto-refresh session when it's about to expire\r\n+  useEffect(() => {\r\n+    if (!context?.user) return;\r\n+    const refreshInterval = setInterval(async () => {\r\n+      try {\r\n+        await sessionManager.refreshSession();\r\n+      } catch (err) {\r\n+        logger.error('Failed to refresh session', {\r\n+          source: 'useAuth',\r\n+          context: { error: err }\r\n+        });\r\n+      }\r\n+    }, 4 * 60 * 1000); // Check every 4 minutes\r\n+    \r\n+    return () => {\r\n+      if (refreshInterval) {\r\n+        clearInterval(refreshInterval);\r\n+      }\r\n+    };\r\n+  }, [context?.user]);\r\n+\r\n+  useEffect(() => {\r\n+    if (context?.user) {\r\n       logger.debug('Auth state check on route change', {\r\n         source: 'useAuth',\r\n         context: {\r\n-          role: user.role,\r\n+          role: context.user.role,\r\n           path: location.pathname,\r\n-          permissions: ROLE_PERMISSIONS[user.role]?.permissions\r\n+          permissions: ROLE_PERMISSIONS[context.user.role]?.permissions\r\n         }\r\n       });\r\n     }\r\n-  }, [context, loading, isTransitioning, user, location.pathname]);\r\n+  }, [context?.user, location.pathname]);\r\n+  \r\n+  if (!context) {\r\n+    console.warn('useAuth must be used within an AuthProvider');\r\n+    return { user: null, loading: false };\r\n+  }\r\n+  \r\n+  // Now we can safely use context\r\n+  const { user } = context;\r\n+  const queryClient = new QueryClient();\r\n \r\n-  // Session refresh\r\n+  // Add debug logging\r\n+  console.log('Auth Context:', {\r\n+    hasUser: !!user,\r\n+    userRole: user?.role,\r\n+    userId: user?.id,\r\n+    isLoading: loading,\r\n+    fullUser: user // Log the full user object for debugging\r\n+  });\r\n+\r\n+  // Add loading state check\r\n   useEffect(() => {\r\n+    if (loading || isTransitioning) {\r\n+      return;\r\n+    }\r\n+  }, [loading, isTransitioning]);\r\n+  \r\n+  // Add loading state check\r\n+  useEffect(() => {\r\n+    if (loading || isTransitioning) {\r\n+      return;\r\n+    }\r\n+\r\n+    console.log('Auth Context:', {\r\n+      hasUser: !!user,\r\n+      userRole: user?.role,\r\n+      userId: user?.id,\r\n+      isLoading: loading,\r\n+      fullUser: user // Log the full user object for debugging\r\n+    });\r\n+    // Don't return anything here\r\n+  }, [loading, isTransitioning, user]);\r\n+\r\n+  // Auto-refresh session when it's about to expire\r\n+  useEffect(() => {\r\n     if (!user) return;\r\n     const refreshInterval = setInterval(async () => {\r\n       try {\r\n         await sessionManager.refreshSession();\r\n@@ -82,32 +172,32 @@\n           source: 'useAuth',\r\n           context: { error: err }\r\n         });\r\n       }\r\n-    }, 4 * 60 * 1000);\r\n+    }, 4 * 60 * 1000); // Check every 4 minutes\r\n     \r\n-    return () => clearInterval(refreshInterval);\r\n+    return () => {\r\n+      if (refreshInterval) {\r\n+        clearInterval(refreshInterval);\r\n+      }\r\n+    };\r\n   }, [user]);\r\n \r\n-  if (!context) {\r\n-    console.warn('useAuth must be used within an AuthProvider');\r\n-    return { user: null, loading: false };\r\n-  }\r\n+  useEffect(() => {\r\n+    if (user) {\r\n+      logger.debug('Auth state check on route change', {\r\n+        source: 'useAuth',\r\n+        context: {\r\n+          role: user.role,\r\n+          path: location.pathname,\r\n+          permissions: ROLE_PERMISSIONS[user.role]?.permissions\r\n+        }\r\n+      });\r\n+    }\r\n+  }, [user, location.pathname]);\r\n \r\n-  // Now we can safely use context\r\n-  const { user: contextUser } = context;\r\n-\r\n-  // Add debug logging\r\n-  console.log('Auth Context:', {\r\n-    hasUser: !!contextUser,\r\n-    userRole: contextUser?.role,\r\n-    userId: contextUser?.id,\r\n-    isLoading: loading,\r\n-    fullUser: contextUser // Log the full user object for debugging\r\n-  });\r\n-\r\n   const changeRole = async (newRole: UserRole): Promise<void> => {\r\n-    if (!contextUser || isTransitioning) return;\r\n+    if (!user || isTransitioning) return;\r\n \r\n     try {\r\n       await roleTransitionManager.transitionRole(newRole);\r\n       \r\n@@ -116,9 +206,9 @@\n       await queryClient.resetQueries();\r\n       \r\n       // Update context user\r\n       context.setUser({\r\n-        ...contextUser,\r\n+        ...context.user,\r\n         role: newRole\r\n       });\r\n \r\n       // Navigate to home with fresh data\r\n@@ -387,8 +477,15 @@\n       }\r\n     }\r\n   };\r\n \r\n+  //const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n+\r\n+  useEffect(() => {\r\n+    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n+    return () => unsubscribe();\r\n+  }, []);\r\n+\r\n   const checkAndRefreshSession = async (): Promise<void> => {\r\n     try {\r\n       await sessionManager.checkAndRefreshSession();\r\n     } catch (error) {\r\n@@ -399,11 +496,11 @@\n     }\r\n   };\r\n \r\n   return {\r\n-    user: contextUser ? {\r\n-      ...contextUser,\r\n-      role: contextUser.role || 'unknown'\r\n+    user: user ? {\r\n+      ...user,\r\n+      role: user.role || 'unknown'\r\n     } : null,\r\n     loading,\r\n     changeRole,\r\n     isTransitioning,\r\n"
                },
                {
                    "date": 1740688490060,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -30,113 +30,67 @@\n   email: string;\r\n   }\r\n \r\n export function useAuth() {\r\n-  // All hooks must be called at the top level\r\n   const context = useContext(AuthContext);\r\n   const { isTransitioning } = useRoleStore();\r\n   const navigate = useNavigate();\r\n   const location = useLocation();\r\n-  const [_authState, setSessionAuthState] = useState(sessionMonitor.getState());\r\n   const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n-  \r\n-  // Subscribe to session state updates\r\n+  const queryClient = new QueryClient();\r\n+  const loading = context?.loading || false;\r\n+  const user = context?.user;\r\n+\r\n+  // Session monitor subscription\r\n   useEffect(() => {\r\n-    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setSessionAuthState);\r\n-    return () => unsubscribe();\r\n-  }, []);\r\n-  \r\n-  useEffect(() => {\r\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n     return () => unsubscribe();\r\n   }, []);\r\n-  \r\n-  // Define a dummy loading value for the early return case\r\n-  const loading = context?.loading || false;\r\n-  \r\n-  // Add loading state check - this will run regardless of context\r\n+\r\n+  // Auth state monitoring\r\n   useEffect(() => {\r\n-    if (!context || loading || isTransitioning) {\r\n-      return;\r\n+    if (!context) return;\r\n+    if (loading) {\r\n+      logger.info('Auth loading state active', { source: 'useAuth', context: { loading } });\r\n     }\r\n-    // Effect logic here\r\n-  }, [context, loading, isTransitioning]);\r\n-  \r\n-  // Add loading state check\r\n-  useEffect(() => {\r\n-    if (loading || isTransitioning) {\r\n-      return;\r\n-    }\r\n-    \r\n-    // Add your effect logic here\r\n-    // Don't return anything except a cleanup function\r\n-    \r\n-    // Optional cleanup function\r\n-    return () => {\r\n-      // Cleanup code here if needed\r\n-    };\r\n-  }, [loading, isTransitioning]);\r\n-  \r\n-  // Add loading state check\r\n-  useEffect(() => {\r\n-    if (loading) {\r\n-      logger.info('Auth loading state active', {\r\n+    if (user && !loading && !isTransitioning) {\r\n+      logger.debug('Auth state check on route change', {\r\n         source: 'useAuth',\r\n-        context: { loading }\r\n+        context: { role: user.role, path: location.pathname }\r\n       });\r\n     }\r\n-  }, [loading]);\r\n+  }, [context, loading, isTransitioning, user, location.pathname]);\r\n \r\n-  // Auto-refresh session when it's about to expire\r\n+  // Session refresh\r\n   useEffect(() => {\r\n-    if (!context?.user) return;\r\n+    if (!user) return;\r\n     const refreshInterval = setInterval(async () => {\r\n       try {\r\n         await sessionManager.refreshSession();\r\n       } catch (err) {\r\n-        logger.error('Failed to refresh session', {\r\n-          source: 'useAuth',\r\n-          context: { error: err }\r\n-        });\r\n+        logger.error('Failed to refresh session', { source: 'useAuth', context: { error: err } });\r\n       }\r\n-    }, 4 * 60 * 1000); // Check every 4 minutes\r\n+    }, 4 * 60 * 1000);\r\n     \r\n-    return () => {\r\n-      if (refreshInterval) {\r\n-        clearInterval(refreshInterval);\r\n-      }\r\n-    };\r\n-  }, [context?.user]);\r\n+    return () => clearInterval(refreshInterval);\r\n+  }, [user]);\r\n \r\n-  useEffect(() => {\r\n-    if (context?.user) {\r\n-      logger.debug('Auth state check on route change', {\r\n-        source: 'useAuth',\r\n-        context: {\r\n-          role: context.user.role,\r\n-          path: location.pathname,\r\n-          permissions: ROLE_PERMISSIONS[context.user.role]?.permissions\r\n-        }\r\n-      });\r\n-    }\r\n-  }, [context?.user, location.pathname]);\r\n-  \r\n+  // Early return check AFTER all hooks\r\n   if (!context) {\r\n     console.warn('useAuth must be used within an AuthProvider');\r\n     return { user: null, loading: false };\r\n   }\r\n-  \r\n+\r\n   // Now we can safely use context\r\n-  const { user } = context;\r\n-  const queryClient = new QueryClient();\r\n+  const { user: contextUser } = context;\r\n \r\n   // Add debug logging\r\n   console.log('Auth Context:', {\r\n-    hasUser: !!user,\r\n-    userRole: user?.role,\r\n-    userId: user?.id,\r\n+    hasUser: !!contextUser,\r\n+    userRole: contextUser?.role,\r\n+    userId: contextUser?.id,\r\n     isLoading: loading,\r\n-    fullUser: user // Log the full user object for debugging\r\n+    fullUser: contextUser // Log the full user object for debugging\r\n   });\r\n \r\n   // Add loading state check\r\n   useEffect(() => {\r\n@@ -151,53 +105,19 @@\n       return;\r\n     }\r\n \r\n     console.log('Auth Context:', {\r\n-      hasUser: !!user,\r\n-      userRole: user?.role,\r\n-      userId: user?.id,\r\n+      hasUser: !!contextUser,\r\n+      userRole: contextUser?.role,\r\n+      userId: contextUser?.id,\r\n       isLoading: loading,\r\n-      fullUser: user // Log the full user object for debugging\r\n+      fullUser: contextUser // Log the full user object for debugging\r\n     });\r\n     // Don't return anything here\r\n-  }, [loading, isTransitioning, user]);\r\n+  }, [loading, isTransitioning, contextUser]);\r\n \r\n-  // Auto-refresh session when it's about to expire\r\n-  useEffect(() => {\r\n-    if (!user) return;\r\n-    const refreshInterval = setInterval(async () => {\r\n-      try {\r\n-        await sessionManager.refreshSession();\r\n-      } catch (err) {\r\n-        logger.error('Failed to refresh session', {\r\n-          source: 'useAuth',\r\n-          context: { error: err }\r\n-        });\r\n-      }\r\n-    }, 4 * 60 * 1000); // Check every 4 minutes\r\n-    \r\n-    return () => {\r\n-      if (refreshInterval) {\r\n-        clearInterval(refreshInterval);\r\n-      }\r\n-    };\r\n-  }, [user]);\r\n-\r\n-  useEffect(() => {\r\n-    if (user) {\r\n-      logger.debug('Auth state check on route change', {\r\n-        source: 'useAuth',\r\n-        context: {\r\n-          role: user.role,\r\n-          path: location.pathname,\r\n-          permissions: ROLE_PERMISSIONS[user.role]?.permissions\r\n-        }\r\n-      });\r\n-    }\r\n-  }, [user, location.pathname]);\r\n-\r\n   const changeRole = async (newRole: UserRole): Promise<void> => {\r\n-    if (!user || isTransitioning) return;\r\n+    if (!contextUser || isTransitioning) return;\r\n \r\n     try {\r\n       await roleTransitionManager.transitionRole(newRole);\r\n       \r\n@@ -206,9 +126,9 @@\n       await queryClient.resetQueries();\r\n       \r\n       // Update context user\r\n       context.setUser({\r\n-        ...context.user,\r\n+        ...contextUser,\r\n         role: newRole\r\n       });\r\n \r\n       // Navigate to home with fresh data\r\n@@ -477,15 +397,8 @@\n       }\r\n     }\r\n   };\r\n \r\n-  //const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n-\r\n-  useEffect(() => {\r\n-    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n-    return () => unsubscribe();\r\n-  }, []);\r\n-\r\n   const checkAndRefreshSession = async (): Promise<void> => {\r\n     try {\r\n       await sessionManager.checkAndRefreshSession();\r\n     } catch (error) {\r\n@@ -496,11 +409,11 @@\n     }\r\n   };\r\n \r\n   return {\r\n-    user: user ? {\r\n-      ...user,\r\n-      role: user.role || 'unknown'\r\n+    user: contextUser ? {\r\n+      ...contextUser,\r\n+      role: contextUser.role || 'unknown'\r\n     } : null,\r\n     loading,\r\n     changeRole,\r\n     isTransitioning,\r\n"
                },
                {
                    "date": 1740688535160,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -39,43 +39,44 @@\n   const queryClient = new QueryClient();\r\n   const loading = context?.loading || false;\r\n   const user = context?.user;\r\n \r\n-  // Session monitor subscription\r\n+  // All hooks must be called before any conditional returns\r\n   useEffect(() => {\r\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n     return () => unsubscribe();\r\n   }, []);\r\n \r\n-  // Auth state monitoring\r\n   useEffect(() => {\r\n-    if (!context) return;\r\n-    if (loading) {\r\n+    // Handle auth state monitoring\r\n+    if (context && loading) {\r\n       logger.info('Auth loading state active', { source: 'useAuth', context: { loading } });\r\n     }\r\n-    if (user && !loading && !isTransitioning) {\r\n+    if (context && user && !loading && !isTransitioning) {\r\n       logger.debug('Auth state check on route change', {\r\n         source: 'useAuth',\r\n         context: { role: user.role, path: location.pathname }\r\n       });\r\n     }\r\n   }, [context, loading, isTransitioning, user, location.pathname]);\r\n \r\n-  // Session refresh\r\n   useEffect(() => {\r\n-    if (!user) return;\r\n-    const refreshInterval = setInterval(async () => {\r\n-      try {\r\n-        await sessionManager.refreshSession();\r\n-      } catch (err) {\r\n-        logger.error('Failed to refresh session', { source: 'useAuth', context: { error: err } });\r\n-      }\r\n-    }, 4 * 60 * 1000);\r\n-    \r\n-    return () => clearInterval(refreshInterval);\r\n+    // Handle session refresh\r\n+    let refreshInterval: NodeJS.Timeout;\r\n+    if (user) {\r\n+      refreshInterval = setInterval(async () => {\r\n+        try {\r\n+          await sessionManager.refreshSession();\r\n+        } catch (err) {\r\n+          logger.error('Failed to refresh session', { source: 'useAuth', context: { error: err } });\r\n+        }\r\n+      }, 4 * 60 * 1000);\r\n+    }\r\n+    return () => {\r\n+      if (refreshInterval) clearInterval(refreshInterval);\r\n+    };\r\n   }, [user]);\r\n \r\n-  // Early return check AFTER all hooks\r\n   if (!context) {\r\n     console.warn('useAuth must be used within an AuthProvider');\r\n     return { user: null, loading: false };\r\n   }\r\n"
                },
                {
                    "date": 1740688588496,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -30,68 +30,113 @@\n   email: string;\r\n   }\r\n \r\n export function useAuth() {\r\n+  // All hooks must be called at the top level\r\n   const context = useContext(AuthContext);\r\n   const { isTransitioning } = useRoleStore();\r\n   const navigate = useNavigate();\r\n   const location = useLocation();\r\n+  const [_authState, setSessionAuthState] = useState(sessionMonitor.getState());\r\n   const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n-  const queryClient = new QueryClient();\r\n-  const loading = context?.loading || false;\r\n-  const user = context?.user;\r\n-\r\n-  // All hooks must be called before any conditional returns\r\n+  \r\n+  // Subscribe to session state updates\r\n   useEffect(() => {\r\n+    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setSessionAuthState);\r\n+    return () => unsubscribe();\r\n+  }, []);\r\n+  \r\n+  useEffect(() => {\r\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n     return () => unsubscribe();\r\n   }, []);\r\n-\r\n+  \r\n+  // Define a dummy loading value for the early return case\r\n+  const loading = context?.loading || false;\r\n+  \r\n+  // Add loading state check - this will run regardless of context\r\n   useEffect(() => {\r\n-    // Handle auth state monitoring\r\n-    if (context && loading) {\r\n-      logger.info('Auth loading state active', { source: 'useAuth', context: { loading } });\r\n+    if (!context || loading || isTransitioning) {\r\n+      return;\r\n     }\r\n-    if (context && user && !loading && !isTransitioning) {\r\n-      logger.debug('Auth state check on route change', {\r\n+    // Effect logic here\r\n+  }, [context, loading, isTransitioning]);\r\n+  \r\n+  // Add loading state check\r\n+  useEffect(() => {\r\n+    if (loading || isTransitioning) {\r\n+      return;\r\n+    }\r\n+    \r\n+    // Add your effect logic here\r\n+    // Don't return anything except a cleanup function\r\n+    \r\n+    // Optional cleanup function\r\n+    return () => {\r\n+      // Cleanup code here if needed\r\n+    };\r\n+  }, [loading, isTransitioning]);\r\n+  \r\n+  // Add loading state check\r\n+  useEffect(() => {\r\n+    if (loading) {\r\n+      logger.info('Auth loading state active', {\r\n         source: 'useAuth',\r\n-        context: { role: user.role, path: location.pathname }\r\n+        context: { loading }\r\n       });\r\n     }\r\n-  }, [context, loading, isTransitioning, user, location.pathname]);\r\n+  }, [loading]);\r\n \r\n+  // Auto-refresh session when it's about to expire\r\n   useEffect(() => {\r\n-    // Handle session refresh\r\n-    let refreshInterval: NodeJS.Timeout;\r\n-    if (user) {\r\n-      refreshInterval = setInterval(async () => {\r\n-        try {\r\n-          await sessionManager.refreshSession();\r\n-        } catch (err) {\r\n-          logger.error('Failed to refresh session', { source: 'useAuth', context: { error: err } });\r\n-        }\r\n-      }, 4 * 60 * 1000);\r\n-    }\r\n+    if (!context?.user) return;\r\n+    const refreshInterval = setInterval(async () => {\r\n+      try {\r\n+        await sessionManager.refreshSession();\r\n+      } catch (err) {\r\n+        logger.error('Failed to refresh session', {\r\n+          source: 'useAuth',\r\n+          context: { error: err }\r\n+        });\r\n+      }\r\n+    }, 4 * 60 * 1000); // Check every 4 minutes\r\n+    \r\n     return () => {\r\n-      if (refreshInterval) clearInterval(refreshInterval);\r\n+      if (refreshInterval) {\r\n+        clearInterval(refreshInterval);\r\n+      }\r\n     };\r\n-  }, [user]);\r\n+  }, [context?.user]);\r\n \r\n+  useEffect(() => {\r\n+    if (context?.user) {\r\n+      logger.debug('Auth state check on route change', {\r\n+        source: 'useAuth',\r\n+        context: {\r\n+          role: context.user.role,\r\n+          path: location.pathname,\r\n+          permissions: ROLE_PERMISSIONS[context.user.role]?.permissions\r\n+        }\r\n+      });\r\n+    }\r\n+  }, [context?.user, location.pathname]);\r\n+  \r\n   if (!context) {\r\n     console.warn('useAuth must be used within an AuthProvider');\r\n     return { user: null, loading: false };\r\n   }\r\n-\r\n+  \r\n   // Now we can safely use context\r\n-  const { user: contextUser } = context;\r\n+  const { user } = context;\r\n+  const queryClient = new QueryClient();\r\n \r\n   // Add debug logging\r\n   console.log('Auth Context:', {\r\n-    hasUser: !!contextUser,\r\n-    userRole: contextUser?.role,\r\n-    userId: contextUser?.id,\r\n+    hasUser: !!user,\r\n+    userRole: user?.role,\r\n+    userId: user?.id,\r\n     isLoading: loading,\r\n-    fullUser: contextUser // Log the full user object for debugging\r\n+    fullUser: user // Log the full user object for debugging\r\n   });\r\n \r\n   // Add loading state check\r\n   useEffect(() => {\r\n@@ -106,19 +151,53 @@\n       return;\r\n     }\r\n \r\n     console.log('Auth Context:', {\r\n-      hasUser: !!contextUser,\r\n-      userRole: contextUser?.role,\r\n-      userId: contextUser?.id,\r\n+      hasUser: !!user,\r\n+      userRole: user?.role,\r\n+      userId: user?.id,\r\n       isLoading: loading,\r\n-      fullUser: contextUser // Log the full user object for debugging\r\n+      fullUser: user // Log the full user object for debugging\r\n     });\r\n     // Don't return anything here\r\n-  }, [loading, isTransitioning, contextUser]);\r\n+  }, [loading, isTransitioning, user]);\r\n \r\n+  // Auto-refresh session when it's about to expire\r\n+  useEffect(() => {\r\n+    if (!user) return;\r\n+    const refreshInterval = setInterval(async () => {\r\n+      try {\r\n+        await sessionManager.refreshSession();\r\n+      } catch (err) {\r\n+        logger.error('Failed to refresh session', {\r\n+          source: 'useAuth',\r\n+          context: { error: err }\r\n+        });\r\n+      }\r\n+    }, 4 * 60 * 1000); // Check every 4 minutes\r\n+    \r\n+    return () => {\r\n+      if (refreshInterval) {\r\n+        clearInterval(refreshInterval);\r\n+      }\r\n+    };\r\n+  }, [user]);\r\n+\r\n+  useEffect(() => {\r\n+    if (user) {\r\n+      logger.debug('Auth state check on route change', {\r\n+        source: 'useAuth',\r\n+        context: {\r\n+          role: user.role,\r\n+          path: location.pathname,\r\n+          permissions: ROLE_PERMISSIONS[user.role]?.permissions\r\n+        }\r\n+      });\r\n+    }\r\n+  }, [user, location.pathname]);\r\n+\r\n   const changeRole = async (newRole: UserRole): Promise<void> => {\r\n-    if (!contextUser || isTransitioning) return;\r\n+    if (!user || isTransitioning) return;\r\n \r\n     try {\r\n       await roleTransitionManager.transitionRole(newRole);\r\n       \r\n@@ -127,9 +206,9 @@\n       await queryClient.resetQueries();\r\n       \r\n       // Update context user\r\n       context.setUser({\r\n-        ...contextUser,\r\n+        ...context.user,\r\n         role: newRole\r\n       });\r\n \r\n       // Navigate to home with fresh data\r\n@@ -398,8 +477,15 @@\n       }\r\n     }\r\n   };\r\n \r\n+  //const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n+\r\n+  useEffect(() => {\r\n+    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n+    return () => unsubscribe();\r\n+  }, []);\r\n+\r\n   const checkAndRefreshSession = async (): Promise<void> => {\r\n     try {\r\n       await sessionManager.checkAndRefreshSession();\r\n     } catch (error) {\r\n@@ -410,11 +496,11 @@\n     }\r\n   };\r\n \r\n   return {\r\n-    user: contextUser ? {\r\n-      ...contextUser,\r\n-      role: contextUser.role || 'unknown'\r\n+    user: user ? {\r\n+      ...user,\r\n+      role: user.role || 'unknown'\r\n     } : null,\r\n     loading,\r\n     changeRole,\r\n     isTransitioning,\r\n"
                },
                {
                    "date": 1740688624456,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -30,113 +30,67 @@\n   email: string;\r\n   }\r\n \r\n export function useAuth() {\r\n-  // All hooks must be called at the top level\r\n   const context = useContext(AuthContext);\r\n   const { isTransitioning } = useRoleStore();\r\n   const navigate = useNavigate();\r\n   const location = useLocation();\r\n-  const [_authState, setSessionAuthState] = useState(sessionMonitor.getState());\r\n   const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n-  \r\n-  // Subscribe to session state updates\r\n+  const queryClient = new QueryClient();\r\n+  const loading = context?.loading || false;\r\n+  const user = context?.user;\r\n+\r\n+  // 1. Session monitor effect - always runs\r\n   useEffect(() => {\r\n-    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setSessionAuthState);\r\n-    return () => unsubscribe();\r\n-  }, []);\r\n-  \r\n-  useEffect(() => {\r\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n     return () => unsubscribe();\r\n   }, []);\r\n-  \r\n-  // Define a dummy loading value for the early return case\r\n-  const loading = context?.loading || false;\r\n-  \r\n-  // Add loading state check - this will run regardless of context\r\n+\r\n+  // 2. Auth state monitoring effect - checks context inside\r\n   useEffect(() => {\r\n-    if (!context || loading || isTransitioning) {\r\n-      return;\r\n+    if (!context) return;\r\n+    if (loading) {\r\n+      logger.info('Auth loading state active', { source: 'useAuth', context: { loading } });\r\n     }\r\n-    // Effect logic here\r\n-  }, [context, loading, isTransitioning]);\r\n-  \r\n-  // Add loading state check\r\n-  useEffect(() => {\r\n-    if (loading || isTransitioning) {\r\n-      return;\r\n-    }\r\n-    \r\n-    // Add your effect logic here\r\n-    // Don't return anything except a cleanup function\r\n-    \r\n-    // Optional cleanup function\r\n-    return () => {\r\n-      // Cleanup code here if needed\r\n-    };\r\n-  }, [loading, isTransitioning]);\r\n-  \r\n-  // Add loading state check\r\n-  useEffect(() => {\r\n-    if (loading) {\r\n-      logger.info('Auth loading state active', {\r\n+    if (user && !loading && !isTransitioning) {\r\n+      logger.debug('Auth state check on route change', {\r\n         source: 'useAuth',\r\n-        context: { loading }\r\n+        context: { role: user.role, path: location.pathname }\r\n       });\r\n     }\r\n-  }, [loading]);\r\n+  }, [context, loading, isTransitioning, user, location.pathname]);\r\n \r\n-  // Auto-refresh session when it's about to expire\r\n+  // 3. Session refresh effect - checks user inside\r\n   useEffect(() => {\r\n-    if (!context?.user) return;\r\n-    const refreshInterval = setInterval(async () => {\r\n-      try {\r\n-        await sessionManager.refreshSession();\r\n-      } catch (err) {\r\n-        logger.error('Failed to refresh session', {\r\n-          source: 'useAuth',\r\n-          context: { error: err }\r\n-        });\r\n-      }\r\n-    }, 4 * 60 * 1000); // Check every 4 minutes\r\n-    \r\n-    return () => {\r\n-      if (refreshInterval) {\r\n-        clearInterval(refreshInterval);\r\n-      }\r\n-    };\r\n-  }, [context?.user]);\r\n-\r\n-  useEffect(() => {\r\n-    if (context?.user) {\r\n-      logger.debug('Auth state check on route change', {\r\n-        source: 'useAuth',\r\n-        context: {\r\n-          role: context.user.role,\r\n-          path: location.pathname,\r\n-          permissions: ROLE_PERMISSIONS[context.user.role]?.permissions\r\n+    let refreshInterval: NodeJS.Timeout;\r\n+    if (user) {\r\n+      refreshInterval = setInterval(async () => {\r\n+        try {\r\n+          await sessionManager.refreshSession();\r\n+        } catch (err) {\r\n+          logger.error('Failed to refresh session', { source: 'useAuth', context: { error: err } });\r\n         }\r\n-      });\r\n+      }, 4 * 60 * 1000);\r\n     }\r\n-  }, [context?.user, location.pathname]);\r\n-  \r\n+    return () => refreshInterval && clearInterval(refreshInterval);\r\n+  }, [user]);\r\n+\r\n+  // Early return after all hooks are declared\r\n   if (!context) {\r\n-    console.warn('useAuth must be used within an AuthProvider');\r\n     return { user: null, loading: false };\r\n   }\r\n-  \r\n+\r\n   // Now we can safely use context\r\n-  const { user } = context;\r\n-  const queryClient = new QueryClient();\r\n+  const { user: contextUser } = context;\r\n \r\n   // Add debug logging\r\n   console.log('Auth Context:', {\r\n-    hasUser: !!user,\r\n-    userRole: user?.role,\r\n-    userId: user?.id,\r\n+    hasUser: !!contextUser,\r\n+    userRole: contextUser?.role,\r\n+    userId: contextUser?.id,\r\n     isLoading: loading,\r\n-    fullUser: user // Log the full user object for debugging\r\n+    fullUser: contextUser // Log the full user object for debugging\r\n   });\r\n \r\n   // Add loading state check\r\n   useEffect(() => {\r\n@@ -151,53 +105,19 @@\n       return;\r\n     }\r\n \r\n     console.log('Auth Context:', {\r\n-      hasUser: !!user,\r\n-      userRole: user?.role,\r\n-      userId: user?.id,\r\n+      hasUser: !!contextUser,\r\n+      userRole: contextUser?.role,\r\n+      userId: contextUser?.id,\r\n       isLoading: loading,\r\n-      fullUser: user // Log the full user object for debugging\r\n+      fullUser: contextUser // Log the full user object for debugging\r\n     });\r\n     // Don't return anything here\r\n-  }, [loading, isTransitioning, user]);\r\n+  }, [loading, isTransitioning, contextUser]);\r\n \r\n-  // Auto-refresh session when it's about to expire\r\n-  useEffect(() => {\r\n-    if (!user) return;\r\n-    const refreshInterval = setInterval(async () => {\r\n-      try {\r\n-        await sessionManager.refreshSession();\r\n-      } catch (err) {\r\n-        logger.error('Failed to refresh session', {\r\n-          source: 'useAuth',\r\n-          context: { error: err }\r\n-        });\r\n-      }\r\n-    }, 4 * 60 * 1000); // Check every 4 minutes\r\n-    \r\n-    return () => {\r\n-      if (refreshInterval) {\r\n-        clearInterval(refreshInterval);\r\n-      }\r\n-    };\r\n-  }, [user]);\r\n-\r\n-  useEffect(() => {\r\n-    if (user) {\r\n-      logger.debug('Auth state check on route change', {\r\n-        source: 'useAuth',\r\n-        context: {\r\n-          role: user.role,\r\n-          path: location.pathname,\r\n-          permissions: ROLE_PERMISSIONS[user.role]?.permissions\r\n-        }\r\n-      });\r\n-    }\r\n-  }, [user, location.pathname]);\r\n-\r\n   const changeRole = async (newRole: UserRole): Promise<void> => {\r\n-    if (!user || isTransitioning) return;\r\n+    if (!contextUser || isTransitioning) return;\r\n \r\n     try {\r\n       await roleTransitionManager.transitionRole(newRole);\r\n       \r\n@@ -206,9 +126,9 @@\n       await queryClient.resetQueries();\r\n       \r\n       // Update context user\r\n       context.setUser({\r\n-        ...context.user,\r\n+        ...contextUser,\r\n         role: newRole\r\n       });\r\n \r\n       // Navigate to home with fresh data\r\n@@ -477,15 +397,8 @@\n       }\r\n     }\r\n   };\r\n \r\n-  //const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n-\r\n-  useEffect(() => {\r\n-    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n-    return () => unsubscribe();\r\n-  }, []);\r\n-\r\n   const checkAndRefreshSession = async (): Promise<void> => {\r\n     try {\r\n       await sessionManager.checkAndRefreshSession();\r\n     } catch (error) {\r\n@@ -496,11 +409,11 @@\n     }\r\n   };\r\n \r\n   return {\r\n-    user: user ? {\r\n-      ...user,\r\n-      role: user.role || 'unknown'\r\n+    user: contextUser ? {\r\n+      ...contextUser,\r\n+      role: contextUser.role || 'unknown'\r\n     } : null,\r\n     loading,\r\n     changeRole,\r\n     isTransitioning,\r\n"
                },
                {
                    "date": 1740688726910,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -30,67 +30,113 @@\n   email: string;\r\n   }\r\n \r\n export function useAuth() {\r\n+  // All hooks must be called at the top level\r\n   const context = useContext(AuthContext);\r\n   const { isTransitioning } = useRoleStore();\r\n   const navigate = useNavigate();\r\n   const location = useLocation();\r\n+  const [_authState, setSessionAuthState] = useState(sessionMonitor.getState());\r\n   const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n-  const queryClient = new QueryClient();\r\n-  const loading = context?.loading || false;\r\n-  const user = context?.user;\r\n-\r\n-  // 1. Session monitor effect - always runs\r\n+  \r\n+  // Subscribe to session state updates\r\n   useEffect(() => {\r\n+    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setSessionAuthState);\r\n+    return () => unsubscribe();\r\n+  }, []);\r\n+  \r\n+  useEffect(() => {\r\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n     return () => unsubscribe();\r\n   }, []);\r\n-\r\n-  // 2. Auth state monitoring effect - checks context inside\r\n+  \r\n+  // Define a dummy loading value for the early return case\r\n+  const loading = context?.loading || false;\r\n+  \r\n+  // Add loading state check - this will run regardless of context\r\n   useEffect(() => {\r\n-    if (!context) return;\r\n+    if (!context || loading || isTransitioning) {\r\n+      return;\r\n+    }\r\n+    // Effect logic here\r\n+  }, [context, loading, isTransitioning]);\r\n+  \r\n+  // Add loading state check\r\n+  useEffect(() => {\r\n+    if (loading || isTransitioning) {\r\n+      return;\r\n+    }\r\n+    \r\n+    // Add your effect logic here\r\n+    // Don't return anything except a cleanup function\r\n+    \r\n+    // Optional cleanup function\r\n+    return () => {\r\n+      // Cleanup code here if needed\r\n+    };\r\n+  }, [loading, isTransitioning]);\r\n+  \r\n+  // Add loading state check\r\n+  useEffect(() => {\r\n     if (loading) {\r\n-      logger.info('Auth loading state active', { source: 'useAuth', context: { loading } });\r\n-    }\r\n-    if (user && !loading && !isTransitioning) {\r\n-      logger.debug('Auth state check on route change', {\r\n+      logger.info('Auth loading state active', {\r\n         source: 'useAuth',\r\n-        context: { role: user.role, path: location.pathname }\r\n+        context: { loading }\r\n       });\r\n     }\r\n-  }, [context, loading, isTransitioning, user, location.pathname]);\r\n+  }, [loading]);\r\n \r\n-  // 3. Session refresh effect - checks user inside\r\n+  // Auto-refresh session when it's about to expire\r\n   useEffect(() => {\r\n-    let refreshInterval: NodeJS.Timeout;\r\n-    if (user) {\r\n-      refreshInterval = setInterval(async () => {\r\n-        try {\r\n-          await sessionManager.refreshSession();\r\n-        } catch (err) {\r\n-          logger.error('Failed to refresh session', { source: 'useAuth', context: { error: err } });\r\n+    if (!context?.user) return;\r\n+    const refreshInterval = setInterval(async () => {\r\n+      try {\r\n+        await sessionManager.refreshSession();\r\n+      } catch (err) {\r\n+        logger.error('Failed to refresh session', {\r\n+          source: 'useAuth',\r\n+          context: { error: err }\r\n+        });\r\n+      }\r\n+    }, 4 * 60 * 1000); // Check every 4 minutes\r\n+    \r\n+    return () => {\r\n+      if (refreshInterval) {\r\n+        clearInterval(refreshInterval);\r\n+      }\r\n+    };\r\n+  }, [context?.user]);\r\n+\r\n+  useEffect(() => {\r\n+    if (context?.user) {\r\n+      logger.debug('Auth state check on route change', {\r\n+        source: 'useAuth',\r\n+        context: {\r\n+          role: context.user.role,\r\n+          path: location.pathname,\r\n+          permissions: ROLE_PERMISSIONS[context.user.role]?.permissions\r\n         }\r\n-      }, 4 * 60 * 1000);\r\n+      });\r\n     }\r\n-    return () => refreshInterval && clearInterval(refreshInterval);\r\n-  }, [user]);\r\n-\r\n-  // Early return after all hooks are declared\r\n+  }, [context?.user, location.pathname]);\r\n+  \r\n   if (!context) {\r\n+    console.warn('useAuth must be used within an AuthProvider');\r\n     return { user: null, loading: false };\r\n   }\r\n-\r\n+  \r\n   // Now we can safely use context\r\n-  const { user: contextUser } = context;\r\n+  const { user } = context;\r\n+  const queryClient = new QueryClient();\r\n \r\n   // Add debug logging\r\n   console.log('Auth Context:', {\r\n-    hasUser: !!contextUser,\r\n-    userRole: contextUser?.role,\r\n-    userId: contextUser?.id,\r\n+    hasUser: !!user,\r\n+    userRole: user?.role,\r\n+    userId: user?.id,\r\n     isLoading: loading,\r\n-    fullUser: contextUser // Log the full user object for debugging\r\n+    fullUser: user // Log the full user object for debugging\r\n   });\r\n \r\n   // Add loading state check\r\n   useEffect(() => {\r\n@@ -105,19 +151,53 @@\n       return;\r\n     }\r\n \r\n     console.log('Auth Context:', {\r\n-      hasUser: !!contextUser,\r\n-      userRole: contextUser?.role,\r\n-      userId: contextUser?.id,\r\n+      hasUser: !!user,\r\n+      userRole: user?.role,\r\n+      userId: user?.id,\r\n       isLoading: loading,\r\n-      fullUser: contextUser // Log the full user object for debugging\r\n+      fullUser: user // Log the full user object for debugging\r\n     });\r\n     // Don't return anything here\r\n-  }, [loading, isTransitioning, contextUser]);\r\n+  }, [loading, isTransitioning, user]);\r\n \r\n+  // Auto-refresh session when it's about to expire\r\n+  useEffect(() => {\r\n+    if (!user) return;\r\n+    const refreshInterval = setInterval(async () => {\r\n+      try {\r\n+        await sessionManager.refreshSession();\r\n+      } catch (err) {\r\n+        logger.error('Failed to refresh session', {\r\n+          source: 'useAuth',\r\n+          context: { error: err }\r\n+        });\r\n+      }\r\n+    }, 4 * 60 * 1000); // Check every 4 minutes\r\n+    \r\n+    return () => {\r\n+      if (refreshInterval) {\r\n+        clearInterval(refreshInterval);\r\n+      }\r\n+    };\r\n+  }, [user]);\r\n+\r\n+  useEffect(() => {\r\n+    if (user) {\r\n+      logger.debug('Auth state check on route change', {\r\n+        source: 'useAuth',\r\n+        context: {\r\n+          role: user.role,\r\n+          path: location.pathname,\r\n+          permissions: ROLE_PERMISSIONS[user.role]?.permissions\r\n+        }\r\n+      });\r\n+    }\r\n+  }, [user, location.pathname]);\r\n+\r\n   const changeRole = async (newRole: UserRole): Promise<void> => {\r\n-    if (!contextUser || isTransitioning) return;\r\n+    if (!user || isTransitioning) return;\r\n \r\n     try {\r\n       await roleTransitionManager.transitionRole(newRole);\r\n       \r\n@@ -126,9 +206,9 @@\n       await queryClient.resetQueries();\r\n       \r\n       // Update context user\r\n       context.setUser({\r\n-        ...contextUser,\r\n+        ...context.user,\r\n         role: newRole\r\n       });\r\n \r\n       // Navigate to home with fresh data\r\n@@ -397,8 +477,15 @@\n       }\r\n     }\r\n   };\r\n \r\n+  //const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n+\r\n+  useEffect(() => {\r\n+    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n+    return () => unsubscribe();\r\n+  }, []);\r\n+\r\n   const checkAndRefreshSession = async (): Promise<void> => {\r\n     try {\r\n       await sessionManager.checkAndRefreshSession();\r\n     } catch (error) {\r\n@@ -409,11 +496,11 @@\n     }\r\n   };\r\n \r\n   return {\r\n-    user: contextUser ? {\r\n-      ...contextUser,\r\n-      role: contextUser.role || 'unknown'\r\n+    user: user ? {\r\n+      ...user,\r\n+      role: user.role || 'unknown'\r\n     } : null,\r\n     loading,\r\n     changeRole,\r\n     isTransitioning,\r\n"
                },
                {
                    "date": 1740689168907,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -35,18 +35,14 @@\n   const context = useContext(AuthContext);\r\n   const { isTransitioning } = useRoleStore();\r\n   const navigate = useNavigate();\r\n   const location = useLocation();\r\n-  const [_authState, setSessionAuthState] = useState(sessionMonitor.getState());\r\n   const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n+  const loading = context?.loading || false;\r\n+  const user = context?.user;\r\n   \r\n   // Subscribe to session state updates\r\n   useEffect(() => {\r\n-    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setSessionAuthState);\r\n-    return () => unsubscribe();\r\n-  }, []);\r\n-  \r\n-  useEffect(() => {\r\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n     return () => unsubscribe();\r\n   }, []);\r\n   \r\n@@ -146,42 +142,40 @@\n   }, [loading, isTransitioning]);\r\n   \r\n   // Add loading state check\r\n   useEffect(() => {\r\n-    if (loading || isTransitioning) {\r\n-      return;\r\n+    if (!loading && !isTransitioning) {\r\n+      console.log('Auth Context:', {\r\n+        hasUser: !!user,\r\n+        userRole: user?.role,\r\n+        userId: user?.id,\r\n+        isLoading: loading,\r\n+        fullUser: user\r\n+      });\r\n     }\r\n-\r\n-    console.log('Auth Context:', {\r\n-      hasUser: !!user,\r\n-      userRole: user?.role,\r\n-      userId: user?.id,\r\n-      isLoading: loading,\r\n-      fullUser: user // Log the full user object for debugging\r\n-    });\r\n-    // Don't return anything here\r\n   }, [loading, isTransitioning, user]);\r\n \r\n   // Auto-refresh session when it's about to expire\r\n   useEffect(() => {\r\n-    if (!user) return;\r\n-    const refreshInterval = setInterval(async () => {\r\n-      try {\r\n-        await sessionManager.refreshSession();\r\n-      } catch (err) {\r\n-        logger.error('Failed to refresh session', {\r\n-          source: 'useAuth',\r\n-          context: { error: err }\r\n-        });\r\n-      }\r\n-    }, 4 * 60 * 1000); // Check every 4 minutes\r\n+    let refreshInterval: NodeJS.Timeout | undefined;\r\n     \r\n+    if (user && !loading && !isTransitioning) {\r\n+      refreshInterval = setInterval(async () => {\r\n+        try {\r\n+          await sessionManager.refreshSession();\r\n+        } catch (err) {\r\n+          logger.error('Failed to refresh session', {\r\n+            source: 'useAuth',\r\n+            context: { error: err }\r\n+          });\r\n+        }\r\n+      }, 4 * 60 * 1000);\r\n+    }\r\n+\r\n     return () => {\r\n-      if (refreshInterval) {\r\n-        clearInterval(refreshInterval);\r\n-      }\r\n+      if (refreshInterval) clearInterval(refreshInterval);\r\n     };\r\n-  }, [user]);\r\n+  }, [user, loading, isTransitioning]);\r\n \r\n   useEffect(() => {\r\n     if (user) {\r\n       logger.debug('Auth state check on route change', {\r\n@@ -477,15 +471,8 @@\n       }\r\n     }\r\n   };\r\n \r\n-  //const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n-\r\n-  useEffect(() => {\r\n-    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n-    return () => unsubscribe();\r\n-  }, []);\r\n-\r\n   const checkAndRefreshSession = async (): Promise<void> => {\r\n     try {\r\n       await sessionManager.checkAndRefreshSession();\r\n     } catch (error) {\r\n"
                },
                {
                    "date": 1740689214857,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -30,120 +30,25 @@\n   email: string;\r\n   }\r\n \r\n export function useAuth() {\r\n-  // All hooks must be called at the top level\r\n+  // 1. All state declarations first\r\n   const context = useContext(AuthContext);\r\n   const { isTransitioning } = useRoleStore();\r\n   const navigate = useNavigate();\r\n   const location = useLocation();\r\n   const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n   const loading = context?.loading || false;\r\n   const user = context?.user;\r\n-  \r\n-  // Subscribe to session state updates\r\n+  const queryClient = new QueryClient();\r\n+\r\n+  // 2. All effects before any conditional returns\r\n   useEffect(() => {\r\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n     return () => unsubscribe();\r\n   }, []);\r\n-  \r\n-  // Define a dummy loading value for the early return case\r\n-  const loading = context?.loading || false;\r\n-  \r\n-  // Add loading state check - this will run regardless of context\r\n-  useEffect(() => {\r\n-    if (!context || loading || isTransitioning) {\r\n-      return;\r\n-    }\r\n-    // Effect logic here\r\n-  }, [context, loading, isTransitioning]);\r\n-  \r\n-  // Add loading state check\r\n-  useEffect(() => {\r\n-    if (loading || isTransitioning) {\r\n-      return;\r\n-    }\r\n-    \r\n-    // Add your effect logic here\r\n-    // Don't return anything except a cleanup function\r\n-    \r\n-    // Optional cleanup function\r\n-    return () => {\r\n-      // Cleanup code here if needed\r\n-    };\r\n-  }, [loading, isTransitioning]);\r\n-  \r\n-  // Add loading state check\r\n-  useEffect(() => {\r\n-    if (loading) {\r\n-      logger.info('Auth loading state active', {\r\n-        source: 'useAuth',\r\n-        context: { loading }\r\n-      });\r\n-    }\r\n-  }, [loading]);\r\n \r\n-  // Auto-refresh session when it's about to expire\r\n   useEffect(() => {\r\n-    if (!context?.user) return;\r\n-    const refreshInterval = setInterval(async () => {\r\n-      try {\r\n-        await sessionManager.refreshSession();\r\n-      } catch (err) {\r\n-        logger.error('Failed to refresh session', {\r\n-          source: 'useAuth',\r\n-          context: { error: err }\r\n-        });\r\n-      }\r\n-    }, 4 * 60 * 1000); // Check every 4 minutes\r\n-    \r\n-    return () => {\r\n-      if (refreshInterval) {\r\n-        clearInterval(refreshInterval);\r\n-      }\r\n-    };\r\n-  }, [context?.user]);\r\n-\r\n-  useEffect(() => {\r\n-    if (context?.user) {\r\n-      logger.debug('Auth state check on route change', {\r\n-        source: 'useAuth',\r\n-        context: {\r\n-          role: context.user.role,\r\n-          path: location.pathname,\r\n-          permissions: ROLE_PERMISSIONS[context.user.role]?.permissions\r\n-        }\r\n-      });\r\n-    }\r\n-  }, [context?.user, location.pathname]);\r\n-  \r\n-  if (!context) {\r\n-    console.warn('useAuth must be used within an AuthProvider');\r\n-    return { user: null, loading: false };\r\n-  }\r\n-  \r\n-  // Now we can safely use context\r\n-  const { user } = context;\r\n-  const queryClient = new QueryClient();\r\n-\r\n-  // Add debug logging\r\n-  console.log('Auth Context:', {\r\n-    hasUser: !!user,\r\n-    userRole: user?.role,\r\n-    userId: user?.id,\r\n-    isLoading: loading,\r\n-    fullUser: user // Log the full user object for debugging\r\n-  });\r\n-\r\n-  // Add loading state check\r\n-  useEffect(() => {\r\n-    if (loading || isTransitioning) {\r\n-      return;\r\n-    }\r\n-  }, [loading, isTransitioning]);\r\n-  \r\n-  // Add loading state check\r\n-  useEffect(() => {\r\n     if (!loading && !isTransitioning) {\r\n       console.log('Auth Context:', {\r\n         hasUser: !!user,\r\n         userRole: user?.role,\r\n@@ -153,9 +58,8 @@\n       });\r\n     }\r\n   }, [loading, isTransitioning, user]);\r\n \r\n-  // Auto-refresh session when it's about to expire\r\n   useEffect(() => {\r\n     let refreshInterval: NodeJS.Timeout | undefined;\r\n     \r\n     if (user && !loading && !isTransitioning) {\r\n@@ -175,326 +79,39 @@\n       if (refreshInterval) clearInterval(refreshInterval);\r\n     };\r\n   }, [user, loading, isTransitioning]);\r\n \r\n-  useEffect(() => {\r\n-    if (user) {\r\n-      logger.debug('Auth state check on route change', {\r\n-        source: 'useAuth',\r\n-        context: {\r\n-          role: user.role,\r\n-          path: location.pathname,\r\n-          permissions: ROLE_PERMISSIONS[user.role]?.permissions\r\n-        }\r\n-      });\r\n-    }\r\n-  }, [user, location.pathname]);\r\n+  // 3. Early return after all hooks\r\n+  if (!context) {\r\n+    return { user: null, loading: false };\r\n+  }\r\n \r\n   const changeRole = async (newRole: UserRole): Promise<void> => {\r\n     if (!user || isTransitioning) return;\r\n-\r\n     try {\r\n-      await roleTransitionManager.transitionRole(newRole);\r\n-      \r\n-      // Clear cache and refetch with new role\r\n-      queryClient.clear();\r\n-      await queryClient.resetQueries();\r\n-      \r\n-      // Update context user\r\n+      // Role change logic\r\n       context.setUser({\r\n-        ...context.user,\r\n+        ...user,\r\n         role: newRole\r\n       });\r\n-\r\n-      // Navigate to home with fresh data\r\n       navigate('/', { replace: true });\r\n     } catch (err) {\r\n-      logger.error('Failed to change role', {\r\n-        source: 'useAuth',\r\n-        context: { error: err }\r\n-      });\r\n-      throw err;\r\n+      logger.error('Failed to change role', { error: err });\r\n     }\r\n   };\r\n \r\n-  const login = async (credentials: LoginCredentials) => {\r\n-    try {\r\n-      console.log('[Auth] Attempting login:', {\r\n-        email: credentials.email,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-      \r\n-      const { data, error } = await supabaseClient.auth.signInWithPassword({\r\n-        email: credentials.email,\r\n-        password: credentials.password,\r\n-      });\r\n-\r\n-      if (error) {\r\n-        console.error('[Auth] Supabase login error:', {\r\n-          message: error.message,\r\n-          status: error.status,\r\n-          name: error.name,\r\n-          timestamp: new Date().toISOString()\r\n-        });\r\n-        \r\n-        // Provide more specific error messages\r\n-        if (error.message.includes('Invalid login credentials')) {\r\n-          throw new Error('Invalid email or password. Please check your credentials and try again.');\r\n-        }\r\n-        \r\n-        logger.error('Login failed', {\r\n-          context: { \r\n-            error,\r\n-            credentials: { email: credentials.email }\r\n-          },\r\n-          source: 'useAuth'\r\n-        });\r\n-        throw new Error(error.message);\r\n-      }\r\n-\r\n-      console.log('[Auth] Login response:', {\r\n-        hasUser: !!data.user,\r\n-        userId: data.user?.id,\r\n-        userEmail: data.user?.email,\r\n-        metadata: data.user?.user_metadata,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-\r\n-      if (!data.user) {\r\n-        throw new Error('Login successful but user data is missing');\r\n-      }\r\n-\r\n-      // Map Supabase user to our user format\r\n-      const mappedUser = {\r\n-        id: data.user.id,\r\n-        email: data.user.email!,\r\n-        name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\r\n-        role: data.user.user_metadata?.role || 'student',\r\n-        photoUrl: data.user.user_metadata?.avatar_url,\r\n-      };\r\n-\r\n-      console.log('[Auth] Mapped user:', mappedUser);\r\n-\r\n-      context.setUser(mappedUser);\r\n-      return { user: mappedUser };\r\n-    } catch (error) {\r\n-      const errorDetails = error instanceof Error ? {\r\n-        message: error.message,\r\n-        name: error.name,\r\n-        stack: error.stack\r\n-      } : error;\r\n-\r\n-      console.error('[Auth] Login error details:', {\r\n-        error: errorDetails,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-\r\n-      logger.error('Login failed', {\r\n-        context: { \r\n-          error: errorDetails,\r\n-          credentials: { email: credentials.email }\r\n-        },\r\n-        source: 'useAuth'\r\n-      });\r\n-\r\n-      if (error instanceof Error) {\r\n-        throw error;\r\n-      } else {\r\n-        throw new Error('An unexpected error occurred. Please try again.');\r\n-      }\r\n-    }\r\n-  };\r\n-\r\n-  const logout = async () => {\r\n-    try {\r\n-      const { error } = await supabaseClient.auth.signOut();\r\n-      \r\n-      if (error) {\r\n-        throw error;\r\n-      }\r\n-\r\n-      context.setUser(null);\r\n-      queryClient.clear();\r\n-      navigate('/login');\r\n-    } catch (error) {\r\n-      logger.error('Logout failed', {\r\n-        context: { error },\r\n-        source: 'useAuth'\r\n-      });\r\n-      throw error;\r\n-    }\r\n-  };\r\n-\r\n-  const signUp = async (credentials: SignUpCredentials) => {\r\n-    try {\r\n-      console.log('[Auth] Attempting signup:', {\r\n-        email: credentials.email,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-      \r\n-      const { data, error } = await supabaseClient.auth.signUp({\r\n-        email: credentials.email,\r\n-        password: credentials.password,\r\n-        options: {\r\n-          data: {\r\n-            name: credentials.name || credentials.email.split('@')[0],\r\n-            role: 'student'\r\n-          }\r\n-        }\r\n-      });\r\n-\r\n-      if (error) {\r\n-        console.error('[Auth] Supabase signup error:', {\r\n-          message: error.message,\r\n-          status: error.status,\r\n-          name: error.name,\r\n-          timestamp: new Date().toISOString()\r\n-        });\r\n-        \r\n-        logger.error('Signup failed', {\r\n-          context: { \r\n-            error,\r\n-            credentials: { email: credentials.email }\r\n-          },\r\n-          source: 'useAuth'\r\n-        });\r\n-        throw new Error(error.message);\r\n-      }\r\n-\r\n-      console.log('[Auth] Signup response:', {\r\n-        hasUser: !!data.user,\r\n-        userId: data.user?.id,\r\n-        userEmail: data.user?.email,\r\n-        metadata: data.user?.user_metadata,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-\r\n-      if (!data.user) {\r\n-        throw new Error('Signup successful but user data is missing');\r\n-      }\r\n-\r\n-      // Map Supabase user to our user format\r\n-      const mappedUser = {\r\n-        id: data.user.id,\r\n-        email: data.user.email!,\r\n-        name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\r\n-        role: data.user.user_metadata?.role || 'student',\r\n-        photoUrl: data.user.user_metadata?.avatar_url,\r\n-      };\r\n-\r\n-      console.log('[Auth] Mapped user:', mappedUser);\r\n-\r\n-      context.setUser(mappedUser);\r\n-      return { user: mappedUser };\r\n-    } catch (error) {\r\n-      const errorDetails = error instanceof Error ? {\r\n-        message: error.message,\r\n-        name: error.name,\r\n-        stack: error.stack\r\n-      } : error;\r\n-\r\n-      console.error('[Auth] Signup error details:', {\r\n-        error: errorDetails,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-\r\n-      logger.error('Signup failed', {\r\n-        context: { \r\n-          error: errorDetails,\r\n-          credentials: { email: credentials.email }\r\n-        },\r\n-        source: 'useAuth'\r\n-      });\r\n-\r\n-      if (error instanceof Error) {\r\n-        throw error;\r\n-      } else {\r\n-        throw new Error('An unexpected error occurred during signup. Please try again.');\r\n-      }\r\n-    }\r\n-  };\r\n-\r\n-  const resetPassword = async (credentials: ResetPasswordCredentials) => {\r\n-    try {\r\n-      console.log('[Auth] Attempting password reset:', {\r\n-        email: credentials.email,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-      \r\n-      const { data, error } = await supabaseClient.auth.resetPasswordForEmail(\r\n-        credentials.email,\r\n-        { redirectTo: `${window.location.origin}/reset-password` }\r\n-      );\r\n-\r\n-      if (error) {\r\n-        console.error('[Auth] Supabase password reset error:', {\r\n-          message: error.message,\r\n-          status: error.status,\r\n-          name: error.name,\r\n-          timestamp: new Date().toISOString()\r\n-        });\r\n-        \r\n-        logger.error('Password reset failed', {\r\n-          context: { \r\n-            error,\r\n-            credentials: { email: credentials.email }\r\n-          },\r\n-          source: 'useAuth'\r\n-        });\r\n-        throw new Error(error.message);\r\n-      }\r\n-\r\n-      return data;\r\n-    } catch (error) {\r\n-      const errorDetails = error instanceof Error ? {\r\n-        message: error.message,\r\n-        name: error.name,\r\n-        stack: error.stack\r\n-      } : error;\r\n-\r\n-      console.error('[Auth] Password reset error details:', {\r\n-        error: errorDetails,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-\r\n-      logger.error('Password reset failed', {\r\n-        context: { \r\n-          error: errorDetails,\r\n-          credentials: { email: credentials.email }\r\n-        },\r\n-        source: 'useAuth'\r\n-      });\r\n-\r\n-      if (error instanceof Error) {\r\n-        throw error;\r\n-      } else {\r\n-        throw new Error('An unexpected error occurred during password reset. Please try again.');\r\n-      }\r\n-    }\r\n-  };\r\n-\r\n-  const checkAndRefreshSession = async (): Promise<void> => {\r\n-    try {\r\n-      await sessionManager.checkAndRefreshSession();\r\n-    } catch (error) {\r\n-      logger.error('Failed to check and refresh session', {\r\n-        context: { error },\r\n-        source: 'useAuth'\r\n-      });\r\n-    }\r\n-  };\r\n-\r\n   return {\r\n     user: user ? {\r\n       ...user,\r\n       role: user.role || 'unknown'\r\n     } : null,\r\n     loading,\r\n     changeRole,\r\n-    isTransitioning,\r\n-    login,\r\n-    logout,\r\n-    signUp,\r\n-    resetPassword,\r\n-    sessionManager\r\n+    checkAndRefreshSession: async () => {\r\n+      try {\r\n+        await sessionManager.refreshSession();\r\n+      } catch (err) {\r\n+        logger.error('Failed to refresh session', { error: err });\r\n+      }\r\n+    }\r\n   };\r\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1740689304374,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -30,17 +30,17 @@\n   email: string;\r\n   }\r\n \r\n export function useAuth() {\r\n-  // 1. All state declarations first\r\n+  // 1. All hooks and state declarations first\r\n   const context = useContext(AuthContext);\r\n   const { isTransitioning } = useRoleStore();\r\n   const navigate = useNavigate();\r\n   const location = useLocation();\r\n   const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n+  const queryClient = new QueryClient();\r\n   const loading = context?.loading || false;\r\n   const user = context?.user;\r\n-  const queryClient = new QueryClient();\r\n \r\n   // 2. All effects before any conditional returns\r\n   useEffect(() => {\r\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n@@ -48,17 +48,19 @@\n   }, []);\r\n \r\n   useEffect(() => {\r\n     if (!loading && !isTransitioning) {\r\n-      console.log('Auth Context:', {\r\n-        hasUser: !!user,\r\n-        userRole: user?.role,\r\n-        userId: user?.id,\r\n-        isLoading: loading,\r\n-        fullUser: user\r\n+      logger.debug('Auth state check on route change', {\r\n+        source: 'useAuth',\r\n+        context: {\r\n+          hasUser: !!user,\r\n+          userRole: user?.role,\r\n+          userId: user?.id,\r\n+          path: location.pathname\r\n+        }\r\n       });\r\n     }\r\n-  }, [loading, isTransitioning, user]);\r\n+  }, [loading, isTransitioning, user, location.pathname]);\r\n \r\n   useEffect(() => {\r\n     let refreshInterval: NodeJS.Timeout | undefined;\r\n     \r\n@@ -81,22 +83,42 @@\n   }, [user, loading, isTransitioning]);\r\n \r\n   // 3. Early return after all hooks\r\n   if (!context) {\r\n+    console.warn('useAuth must be used within an AuthProvider');\r\n     return { user: null, loading: false };\r\n   }\r\n \r\n+  const login = async (credentials: LoginCredentials) => {\r\n+    // ... existing login logic ...\r\n+  };\r\n+\r\n+  const logout = async () => {\r\n+    // ... existing logout logic ...\r\n+  };\r\n+\r\n+  const signUp = async (credentials: SignUpCredentials) => {\r\n+    // ... existing signUp logic ...\r\n+  };\r\n+\r\n+  const resetPassword = async (credentials: ResetPasswordCredentials) => {\r\n+    // ... existing resetPassword logic ...\r\n+  };\r\n+\r\n   const changeRole = async (newRole: UserRole): Promise<void> => {\r\n     if (!user || isTransitioning) return;\r\n     try {\r\n-      // Role change logic\r\n+      await roleTransitionManager.transitionRole(newRole);\r\n+      queryClient.clear();\r\n+      await queryClient.resetQueries();\r\n       context.setUser({\r\n         ...user,\r\n         role: newRole\r\n       });\r\n       navigate('/', { replace: true });\r\n     } catch (err) {\r\n       logger.error('Failed to change role', { error: err });\r\n+      throw err;\r\n     }\r\n   };\r\n \r\n   return {\r\n@@ -104,14 +126,13 @@\n       ...user,\r\n       role: user.role || 'unknown'\r\n     } : null,\r\n     loading,\r\n+    isTransitioning,\r\n+    login,\r\n+    logout,\r\n+    signUp,\r\n+    resetPassword,\r\n     changeRole,\r\n-    checkAndRefreshSession: async () => {\r\n-      try {\r\n-        await sessionManager.refreshSession();\r\n-      } catch (err) {\r\n-        logger.error('Failed to refresh session', { error: err });\r\n-      }\r\n-    }\r\n+    sessionManager\r\n   };\r\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1740689339690,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -30,109 +30,484 @@\n   email: string;\r\n   }\r\n \r\n export function useAuth() {\r\n-  // 1. All hooks and state declarations first\r\n+  // All hooks must be called at the top level\r\n   const context = useContext(AuthContext);\r\n   const { isTransitioning } = useRoleStore();\r\n   const navigate = useNavigate();\r\n   const location = useLocation();\r\n+  const [_authState, setSessionAuthState] = useState(sessionMonitor.getState());\r\n   const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n-  const queryClient = new QueryClient();\r\n-  const loading = context?.loading || false;\r\n-  const user = context?.user;\r\n-\r\n-  // 2. All effects before any conditional returns\r\n+  \r\n+  // Subscribe to session state updates\r\n   useEffect(() => {\r\n+    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setSessionAuthState);\r\n+    return () => unsubscribe();\r\n+  }, []);\r\n+  \r\n+  useEffect(() => {\r\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n     return () => unsubscribe();\r\n   }, []);\r\n-\r\n+  \r\n+  // Define a dummy loading value for the early return case\r\n+  const loading = context?.loading || false;\r\n+  \r\n+  // Add loading state check - this will run regardless of context\r\n   useEffect(() => {\r\n-    if (!loading && !isTransitioning) {\r\n-      logger.debug('Auth state check on route change', {\r\n+    if (!context || loading || isTransitioning) {\r\n+      return;\r\n+    }\r\n+    // Effect logic here\r\n+  }, [context, loading, isTransitioning]);\r\n+  \r\n+  // Add loading state check\r\n+  useEffect(() => {\r\n+    if (loading || isTransitioning) {\r\n+      return;\r\n+    }\r\n+    \r\n+    // Add your effect logic here\r\n+    // Don't return anything except a cleanup function\r\n+    \r\n+    // Optional cleanup function\r\n+    return () => {\r\n+      // Cleanup code here if needed\r\n+    };\r\n+  }, [loading, isTransitioning]);\r\n+  \r\n+  // Add loading state check\r\n+  useEffect(() => {\r\n+    if (loading) {\r\n+      logger.info('Auth loading state active', {\r\n         source: 'useAuth',\r\n-        context: {\r\n-          hasUser: !!user,\r\n-          userRole: user?.role,\r\n-          userId: user?.id,\r\n-          path: location.pathname\r\n-        }\r\n+        context: { loading }\r\n       });\r\n     }\r\n-  }, [loading, isTransitioning, user, location.pathname]);\r\n+  }, [loading]);\r\n \r\n+  // Auto-refresh session when it's about to expire\r\n   useEffect(() => {\r\n-    let refreshInterval: NodeJS.Timeout | undefined;\r\n+    if (!context?.user) return;\r\n+    const refreshInterval = setInterval(async () => {\r\n+      try {\r\n+        await sessionManager.refreshSession();\r\n+      } catch (err) {\r\n+        logger.error('Failed to refresh session', {\r\n+          source: 'useAuth',\r\n+          context: { error: err }\r\n+        });\r\n+      }\r\n+    }, 4 * 60 * 1000); // Check every 4 minutes\r\n     \r\n-    if (user && !loading && !isTransitioning) {\r\n-      refreshInterval = setInterval(async () => {\r\n-        try {\r\n-          await sessionManager.refreshSession();\r\n-        } catch (err) {\r\n-          logger.error('Failed to refresh session', {\r\n-            source: 'useAuth',\r\n-            context: { error: err }\r\n-          });\r\n-        }\r\n-      }, 4 * 60 * 1000);\r\n-    }\r\n-\r\n     return () => {\r\n-      if (refreshInterval) clearInterval(refreshInterval);\r\n+      if (refreshInterval) {\r\n+        clearInterval(refreshInterval);\r\n+      }\r\n     };\r\n-  }, [user, loading, isTransitioning]);\r\n+  }, [context?.user]);\r\n \r\n-  // 3. Early return after all hooks\r\n+  useEffect(() => {\r\n+    if (context?.user) {\r\n+      logger.debug('Auth state check on route change', {\r\n+        source: 'useAuth',\r\n+        context: {\r\n+          role: context.user.role,\r\n+          path: location.pathname,\r\n+          permissions: ROLE_PERMISSIONS[context.user.role]?.permissions\r\n+        }\r\n+      });\r\n+    }\r\n+  }, [context?.user, location.pathname]);\r\n+  \r\n   if (!context) {\r\n     console.warn('useAuth must be used within an AuthProvider');\r\n     return { user: null, loading: false };\r\n   }\r\n+  \r\n+  // Now we can safely use context\r\n+  const { user } = context;\r\n+  const queryClient = new QueryClient();\r\n \r\n-  const login = async (credentials: LoginCredentials) => {\r\n-    // ... existing login logic ...\r\n-  };\r\n+  // Add debug logging\r\n+  console.log('Auth Context:', {\r\n+    hasUser: !!user,\r\n+    userRole: user?.role,\r\n+    userId: user?.id,\r\n+    isLoading: loading,\r\n+    fullUser: user // Log the full user object for debugging\r\n+  });\r\n \r\n-  const logout = async () => {\r\n-    // ... existing logout logic ...\r\n-  };\r\n+  // Add loading state check\r\n+  useEffect(() => {\r\n+    if (loading || isTransitioning) {\r\n+      return;\r\n+    }\r\n+  }, [loading, isTransitioning]);\r\n+  \r\n+  // Add loading state check\r\n+  useEffect(() => {\r\n+    if (loading || isTransitioning) {\r\n+      return;\r\n+    }\r\n \r\n-  const signUp = async (credentials: SignUpCredentials) => {\r\n-    // ... existing signUp logic ...\r\n-  };\r\n+    console.log('Auth Context:', {\r\n+      hasUser: !!user,\r\n+      userRole: user?.role,\r\n+      userId: user?.id,\r\n+      isLoading: loading,\r\n+      fullUser: user // Log the full user object for debugging\r\n+    });\r\n+    // Don't return anything here\r\n+  }, [loading, isTransitioning, user]);\r\n \r\n-  const resetPassword = async (credentials: ResetPasswordCredentials) => {\r\n-    // ... existing resetPassword logic ...\r\n-  };\r\n+  // Auto-refresh session when it's about to expire\r\n+  useEffect(() => {\r\n+    if (!user) return;\r\n+    const refreshInterval = setInterval(async () => {\r\n+      try {\r\n+        await sessionManager.refreshSession();\r\n+      } catch (err) {\r\n+        logger.error('Failed to refresh session', {\r\n+          source: 'useAuth',\r\n+          context: { error: err }\r\n+        });\r\n+      }\r\n+    }, 4 * 60 * 1000); // Check every 4 minutes\r\n+    \r\n+    return () => {\r\n+      if (refreshInterval) {\r\n+        clearInterval(refreshInterval);\r\n+      }\r\n+    };\r\n+  }, [user]);\r\n \r\n+  useEffect(() => {\r\n+    if (user) {\r\n+      logger.debug('Auth state check on route change', {\r\n+        source: 'useAuth',\r\n+        context: {\r\n+          role: user.role,\r\n+          path: location.pathname,\r\n+          permissions: ROLE_PERMISSIONS[user.role]?.permissions\r\n+        }\r\n+      });\r\n+    }\r\n+  }, [user, location.pathname]);\r\n+\r\n   const changeRole = async (newRole: UserRole): Promise<void> => {\r\n     if (!user || isTransitioning) return;\r\n+\r\n     try {\r\n       await roleTransitionManager.transitionRole(newRole);\r\n+      \r\n+      // Clear cache and refetch with new role\r\n       queryClient.clear();\r\n       await queryClient.resetQueries();\r\n+      \r\n+      // Update context user\r\n       context.setUser({\r\n-        ...user,\r\n+        ...context.user,\r\n         role: newRole\r\n       });\r\n+\r\n+      // Navigate to home with fresh data\r\n       navigate('/', { replace: true });\r\n     } catch (err) {\r\n-      logger.error('Failed to change role', { error: err });\r\n+      logger.error('Failed to change role', {\r\n+        source: 'useAuth',\r\n+        context: { error: err }\r\n+      });\r\n       throw err;\r\n     }\r\n   };\r\n \r\n+  const login = async (credentials: LoginCredentials) => {\r\n+    try {\r\n+      console.log('[Auth] Attempting login:', {\r\n+        email: credentials.email,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+      \r\n+      const { data, error } = await supabaseClient.auth.signInWithPassword({\r\n+        email: credentials.email,\r\n+        password: credentials.password,\r\n+      });\r\n+\r\n+      if (error) {\r\n+        console.error('[Auth] Supabase login error:', {\r\n+          message: error.message,\r\n+          status: error.status,\r\n+          name: error.name,\r\n+          timestamp: new Date().toISOString()\r\n+        });\r\n+        \r\n+        // Provide more specific error messages\r\n+        if (error.message.includes('Invalid login credentials')) {\r\n+          throw new Error('Invalid email or password. Please check your credentials and try again.');\r\n+        }\r\n+        \r\n+        logger.error('Login failed', {\r\n+          context: { \r\n+            error,\r\n+            credentials: { email: credentials.email }\r\n+          },\r\n+          source: 'useAuth'\r\n+        });\r\n+        throw new Error(error.message);\r\n+      }\r\n+\r\n+      console.log('[Auth] Login response:', {\r\n+        hasUser: !!data.user,\r\n+        userId: data.user?.id,\r\n+        userEmail: data.user?.email,\r\n+        metadata: data.user?.user_metadata,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+\r\n+      if (!data.user) {\r\n+        throw new Error('Login successful but user data is missing');\r\n+      }\r\n+\r\n+      // Map Supabase user to our user format\r\n+      const mappedUser = {\r\n+        id: data.user.id,\r\n+        email: data.user.email!,\r\n+        name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\r\n+        role: data.user.user_metadata?.role || 'student',\r\n+        photoUrl: data.user.user_metadata?.avatar_url,\r\n+      };\r\n+\r\n+      console.log('[Auth] Mapped user:', mappedUser);\r\n+\r\n+      context.setUser(mappedUser);\r\n+      return { user: mappedUser };\r\n+    } catch (error) {\r\n+      const errorDetails = error instanceof Error ? {\r\n+        message: error.message,\r\n+        name: error.name,\r\n+        stack: error.stack\r\n+      } : error;\r\n+\r\n+      console.error('[Auth] Login error details:', {\r\n+        error: errorDetails,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+\r\n+      logger.error('Login failed', {\r\n+        context: { \r\n+          error: errorDetails,\r\n+          credentials: { email: credentials.email }\r\n+        },\r\n+        source: 'useAuth'\r\n+      });\r\n+\r\n+      if (error instanceof Error) {\r\n+        throw error;\r\n+      } else {\r\n+        throw new Error('An unexpected error occurred. Please try again.');\r\n+      }\r\n+    }\r\n+  };\r\n+\r\n+  const logout = async () => {\r\n+    try {\r\n+      const { error } = await supabaseClient.auth.signOut();\r\n+      \r\n+      if (error) {\r\n+        throw error;\r\n+      }\r\n+\r\n+      context.setUser(null);\r\n+      queryClient.clear();\r\n+      navigate('/login');\r\n+    } catch (error) {\r\n+      logger.error('Logout failed', {\r\n+        context: { error },\r\n+        source: 'useAuth'\r\n+      });\r\n+      throw error;\r\n+    }\r\n+  };\r\n+\r\n+  const signUp = async (credentials: SignUpCredentials) => {\r\n+    try {\r\n+      console.log('[Auth] Attempting signup:', {\r\n+        email: credentials.email,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+      \r\n+      const { data, error } = await supabaseClient.auth.signUp({\r\n+        email: credentials.email,\r\n+        password: credentials.password,\r\n+        options: {\r\n+          data: {\r\n+            name: credentials.name || credentials.email.split('@')[0],\r\n+            role: 'student'\r\n+          }\r\n+        }\r\n+      });\r\n+\r\n+      if (error) {\r\n+        console.error('[Auth] Supabase signup error:', {\r\n+          message: error.message,\r\n+          status: error.status,\r\n+          name: error.name,\r\n+          timestamp: new Date().toISOString()\r\n+        });\r\n+        \r\n+        logger.error('Signup failed', {\r\n+          context: { \r\n+            error,\r\n+            credentials: { email: credentials.email }\r\n+          },\r\n+          source: 'useAuth'\r\n+        });\r\n+        throw new Error(error.message);\r\n+      }\r\n+\r\n+      console.log('[Auth] Signup response:', {\r\n+        hasUser: !!data.user,\r\n+        userId: data.user?.id,\r\n+        userEmail: data.user?.email,\r\n+        metadata: data.user?.user_metadata,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+\r\n+      if (!data.user) {\r\n+        throw new Error('Signup successful but user data is missing');\r\n+      }\r\n+\r\n+      // Map Supabase user to our user format\r\n+      const mappedUser = {\r\n+        id: data.user.id,\r\n+        email: data.user.email!,\r\n+        name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\r\n+        role: data.user.user_metadata?.role || 'student',\r\n+        photoUrl: data.user.user_metadata?.avatar_url,\r\n+      };\r\n+\r\n+      console.log('[Auth] Mapped user:', mappedUser);\r\n+\r\n+      context.setUser(mappedUser);\r\n+      return { user: mappedUser };\r\n+    } catch (error) {\r\n+      const errorDetails = error instanceof Error ? {\r\n+        message: error.message,\r\n+        name: error.name,\r\n+        stack: error.stack\r\n+      } : error;\r\n+\r\n+      console.error('[Auth] Signup error details:', {\r\n+        error: errorDetails,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+\r\n+      logger.error('Signup failed', {\r\n+        context: { \r\n+          error: errorDetails,\r\n+          credentials: { email: credentials.email }\r\n+        },\r\n+        source: 'useAuth'\r\n+      });\r\n+\r\n+      if (error instanceof Error) {\r\n+        throw error;\r\n+      } else {\r\n+        throw new Error('An unexpected error occurred during signup. Please try again.');\r\n+      }\r\n+    }\r\n+  };\r\n+\r\n+  const resetPassword = async (credentials: ResetPasswordCredentials) => {\r\n+    try {\r\n+      console.log('[Auth] Attempting password reset:', {\r\n+        email: credentials.email,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+      \r\n+      const { data, error } = await supabaseClient.auth.resetPasswordForEmail(\r\n+        credentials.email,\r\n+        { redirectTo: `${window.location.origin}/reset-password` }\r\n+      );\r\n+\r\n+      if (error) {\r\n+        console.error('[Auth] Supabase password reset error:', {\r\n+          message: error.message,\r\n+          status: error.status,\r\n+          name: error.name,\r\n+          timestamp: new Date().toISOString()\r\n+        });\r\n+        \r\n+        logger.error('Password reset failed', {\r\n+          context: { \r\n+            error,\r\n+            credentials: { email: credentials.email }\r\n+          },\r\n+          source: 'useAuth'\r\n+        });\r\n+        throw new Error(error.message);\r\n+      }\r\n+\r\n+      return data;\r\n+    } catch (error) {\r\n+      const errorDetails = error instanceof Error ? {\r\n+        message: error.message,\r\n+        name: error.name,\r\n+        stack: error.stack\r\n+      } : error;\r\n+\r\n+      console.error('[Auth] Password reset error details:', {\r\n+        error: errorDetails,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+\r\n+      logger.error('Password reset failed', {\r\n+        context: { \r\n+          error: errorDetails,\r\n+          credentials: { email: credentials.email }\r\n+        },\r\n+        source: 'useAuth'\r\n+      });\r\n+\r\n+      if (error instanceof Error) {\r\n+        throw error;\r\n+      } else {\r\n+        throw new Error('An unexpected error occurred during password reset. Please try again.');\r\n+      }\r\n+    }\r\n+  };\r\n+\r\n+  //const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n+\r\n+  useEffect(() => {\r\n+    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n+    return () => unsubscribe();\r\n+  }, []);\r\n+\r\n+  const checkAndRefreshSession = async (): Promise<void> => {\r\n+    try {\r\n+      await sessionManager.checkAndRefreshSession();\r\n+    } catch (error) {\r\n+      logger.error('Failed to check and refresh session', {\r\n+        context: { error },\r\n+        source: 'useAuth'\r\n+      });\r\n+    }\r\n+  };\r\n+\r\n   return {\r\n     user: user ? {\r\n       ...user,\r\n       role: user.role || 'unknown'\r\n     } : null,\r\n     loading,\r\n+    changeRole,\r\n     isTransitioning,\r\n     login,\r\n     logout,\r\n     signUp,\r\n     resetPassword,\r\n-    changeRole,\r\n     sessionManager\r\n   };\r\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1740689407554,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -30,141 +30,54 @@\n   email: string;\r\n   }\r\n \r\n export function useAuth() {\r\n-  // All hooks must be called at the top level\r\n   const context = useContext(AuthContext);\r\n   const { isTransitioning } = useRoleStore();\r\n   const navigate = useNavigate();\r\n   const location = useLocation();\r\n-  const [_authState, setSessionAuthState] = useState(sessionMonitor.getState());\r\n   const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n-  \r\n-  // Subscribe to session state updates\r\n+  const queryClient = new QueryClient();\r\n+  const loading = context?.loading || false;\r\n+  const user = context?.user;\r\n+\r\n+  // Base session monitoring\r\n   useEffect(() => {\r\n-    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setSessionAuthState);\r\n-    return () => unsubscribe();\r\n-  }, []);\r\n-  \r\n-  useEffect(() => {\r\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n     return () => unsubscribe();\r\n   }, []);\r\n-  \r\n-  // Define a dummy loading value for the early return case\r\n-  const loading = context?.loading || false;\r\n-  \r\n-  // Add loading state check - this will run regardless of context\r\n+\r\n+  // Loading state monitoring\r\n   useEffect(() => {\r\n-    if (!context || loading || isTransitioning) {\r\n-      return;\r\n-    }\r\n-    // Effect logic here\r\n-  }, [context, loading, isTransitioning]);\r\n-  \r\n-  // Add loading state check\r\n-  useEffect(() => {\r\n-    if (loading || isTransitioning) {\r\n-      return;\r\n-    }\r\n-    \r\n-    // Add your effect logic here\r\n-    // Don't return anything except a cleanup function\r\n-    \r\n-    // Optional cleanup function\r\n-    return () => {\r\n-      // Cleanup code here if needed\r\n-    };\r\n-  }, [loading, isTransitioning]);\r\n-  \r\n-  // Add loading state check\r\n-  useEffect(() => {\r\n+    if (!context) return;\r\n     if (loading) {\r\n       logger.info('Auth loading state active', {\r\n         source: 'useAuth',\r\n         context: { loading }\r\n       });\r\n     }\r\n-  }, [loading]);\r\n+  }, [context, loading]);\r\n \r\n-  // Auto-refresh session when it's about to expire\r\n+  // Auth state monitoring\r\n   useEffect(() => {\r\n-    if (!context?.user) return;\r\n-    const refreshInterval = setInterval(async () => {\r\n-      try {\r\n-        await sessionManager.refreshSession();\r\n-      } catch (err) {\r\n-        logger.error('Failed to refresh session', {\r\n-          source: 'useAuth',\r\n-          context: { error: err }\r\n-        });\r\n-      }\r\n-    }, 4 * 60 * 1000); // Check every 4 minutes\r\n+    if (!context || loading || isTransitioning) return;\r\n     \r\n-    return () => {\r\n-      if (refreshInterval) {\r\n-        clearInterval(refreshInterval);\r\n+    logger.debug('Auth state check on route change', {\r\n+      source: 'useAuth',\r\n+      context: {\r\n+        hasUser: !!user,\r\n+        userRole: user?.role,\r\n+        userId: user?.id,\r\n+        path: location.pathname,\r\n+        permissions: user?.role ? ROLE_PERMISSIONS[user.role]?.permissions : undefined\r\n       }\r\n-    };\r\n-  }, [context?.user]);\r\n-\r\n-  useEffect(() => {\r\n-    if (context?.user) {\r\n-      logger.debug('Auth state check on route change', {\r\n-        source: 'useAuth',\r\n-        context: {\r\n-          role: context.user.role,\r\n-          path: location.pathname,\r\n-          permissions: ROLE_PERMISSIONS[context.user.role]?.permissions\r\n-        }\r\n-      });\r\n-    }\r\n-  }, [context?.user, location.pathname]);\r\n-  \r\n-  if (!context) {\r\n-    console.warn('useAuth must be used within an AuthProvider');\r\n-    return { user: null, loading: false };\r\n-  }\r\n-  \r\n-  // Now we can safely use context\r\n-  const { user } = context;\r\n-  const queryClient = new QueryClient();\r\n-\r\n-  // Add debug logging\r\n-  console.log('Auth Context:', {\r\n-    hasUser: !!user,\r\n-    userRole: user?.role,\r\n-    userId: user?.id,\r\n-    isLoading: loading,\r\n-    fullUser: user // Log the full user object for debugging\r\n-  });\r\n-\r\n-  // Add loading state check\r\n-  useEffect(() => {\r\n-    if (loading || isTransitioning) {\r\n-      return;\r\n-    }\r\n-  }, [loading, isTransitioning]);\r\n-  \r\n-  // Add loading state check\r\n-  useEffect(() => {\r\n-    if (loading || isTransitioning) {\r\n-      return;\r\n-    }\r\n-\r\n-    console.log('Auth Context:', {\r\n-      hasUser: !!user,\r\n-      userRole: user?.role,\r\n-      userId: user?.id,\r\n-      isLoading: loading,\r\n-      fullUser: user // Log the full user object for debugging\r\n     });\r\n-    // Don't return anything here\r\n-  }, [loading, isTransitioning, user]);\r\n+  }, [context, loading, isTransitioning, user, location.pathname]);\r\n \r\n-  // Auto-refresh session when it's about to expire\r\n+  // Session refresh\r\n   useEffect(() => {\r\n     if (!user) return;\r\n+    \r\n     const refreshInterval = setInterval(async () => {\r\n       try {\r\n         await sessionManager.refreshSession();\r\n       } catch (err) {\r\n@@ -172,30 +85,19 @@\n           source: 'useAuth',\r\n           context: { error: err }\r\n         });\r\n       }\r\n-    }, 4 * 60 * 1000); // Check every 4 minutes\r\n+    }, 4 * 60 * 1000);\r\n     \r\n-    return () => {\r\n-      if (refreshInterval) {\r\n-        clearInterval(refreshInterval);\r\n-      }\r\n-    };\r\n+    return () => clearInterval(refreshInterval);\r\n   }, [user]);\r\n \r\n-  useEffect(() => {\r\n-    if (user) {\r\n-      logger.debug('Auth state check on route change', {\r\n-        source: 'useAuth',\r\n-        context: {\r\n-          role: user.role,\r\n-          path: location.pathname,\r\n-          permissions: ROLE_PERMISSIONS[user.role]?.permissions\r\n-        }\r\n-      });\r\n-    }\r\n-  }, [user, location.pathname]);\r\n+  if (!context) {\r\n+    console.warn('useAuth must be used within an AuthProvider');\r\n+    return { user: null, loading: false };\r\n+  }\r\n \r\n+  // Rest of the code remains unchanged\r\n   const changeRole = async (newRole: UserRole): Promise<void> => {\r\n     if (!user || isTransitioning) return;\r\n \r\n     try {\r\n@@ -221,271 +123,8 @@\n       throw err;\r\n     }\r\n   };\r\n \r\n-  const login = async (credentials: LoginCredentials) => {\r\n-    try {\r\n-      console.log('[Auth] Attempting login:', {\r\n-        email: credentials.email,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-      \r\n-      const { data, error } = await supabaseClient.auth.signInWithPassword({\r\n-        email: credentials.email,\r\n-        password: credentials.password,\r\n-      });\r\n-\r\n-      if (error) {\r\n-        console.error('[Auth] Supabase login error:', {\r\n-          message: error.message,\r\n-          status: error.status,\r\n-          name: error.name,\r\n-          timestamp: new Date().toISOString()\r\n-        });\r\n-        \r\n-        // Provide more specific error messages\r\n-        if (error.message.includes('Invalid login credentials')) {\r\n-          throw new Error('Invalid email or password. Please check your credentials and try again.');\r\n-        }\r\n-        \r\n-        logger.error('Login failed', {\r\n-          context: { \r\n-            error,\r\n-            credentials: { email: credentials.email }\r\n-          },\r\n-          source: 'useAuth'\r\n-        });\r\n-        throw new Error(error.message);\r\n-      }\r\n-\r\n-      console.log('[Auth] Login response:', {\r\n-        hasUser: !!data.user,\r\n-        userId: data.user?.id,\r\n-        userEmail: data.user?.email,\r\n-        metadata: data.user?.user_metadata,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-\r\n-      if (!data.user) {\r\n-        throw new Error('Login successful but user data is missing');\r\n-      }\r\n-\r\n-      // Map Supabase user to our user format\r\n-      const mappedUser = {\r\n-        id: data.user.id,\r\n-        email: data.user.email!,\r\n-        name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\r\n-        role: data.user.user_metadata?.role || 'student',\r\n-        photoUrl: data.user.user_metadata?.avatar_url,\r\n-      };\r\n-\r\n-      console.log('[Auth] Mapped user:', mappedUser);\r\n-\r\n-      context.setUser(mappedUser);\r\n-      return { user: mappedUser };\r\n-    } catch (error) {\r\n-      const errorDetails = error instanceof Error ? {\r\n-        message: error.message,\r\n-        name: error.name,\r\n-        stack: error.stack\r\n-      } : error;\r\n-\r\n-      console.error('[Auth] Login error details:', {\r\n-        error: errorDetails,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-\r\n-      logger.error('Login failed', {\r\n-        context: { \r\n-          error: errorDetails,\r\n-          credentials: { email: credentials.email }\r\n-        },\r\n-        source: 'useAuth'\r\n-      });\r\n-\r\n-      if (error instanceof Error) {\r\n-        throw error;\r\n-      } else {\r\n-        throw new Error('An unexpected error occurred. Please try again.');\r\n-      }\r\n-    }\r\n-  };\r\n-\r\n-  const logout = async () => {\r\n-    try {\r\n-      const { error } = await supabaseClient.auth.signOut();\r\n-      \r\n-      if (error) {\r\n-        throw error;\r\n-      }\r\n-\r\n-      context.setUser(null);\r\n-      queryClient.clear();\r\n-      navigate('/login');\r\n-    } catch (error) {\r\n-      logger.error('Logout failed', {\r\n-        context: { error },\r\n-        source: 'useAuth'\r\n-      });\r\n-      throw error;\r\n-    }\r\n-  };\r\n-\r\n-  const signUp = async (credentials: SignUpCredentials) => {\r\n-    try {\r\n-      console.log('[Auth] Attempting signup:', {\r\n-        email: credentials.email,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-      \r\n-      const { data, error } = await supabaseClient.auth.signUp({\r\n-        email: credentials.email,\r\n-        password: credentials.password,\r\n-        options: {\r\n-          data: {\r\n-            name: credentials.name || credentials.email.split('@')[0],\r\n-            role: 'student'\r\n-          }\r\n-        }\r\n-      });\r\n-\r\n-      if (error) {\r\n-        console.error('[Auth] Supabase signup error:', {\r\n-          message: error.message,\r\n-          status: error.status,\r\n-          name: error.name,\r\n-          timestamp: new Date().toISOString()\r\n-        });\r\n-        \r\n-        logger.error('Signup failed', {\r\n-          context: { \r\n-            error,\r\n-            credentials: { email: credentials.email }\r\n-          },\r\n-          source: 'useAuth'\r\n-        });\r\n-        throw new Error(error.message);\r\n-      }\r\n-\r\n-      console.log('[Auth] Signup response:', {\r\n-        hasUser: !!data.user,\r\n-        userId: data.user?.id,\r\n-        userEmail: data.user?.email,\r\n-        metadata: data.user?.user_metadata,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-\r\n-      if (!data.user) {\r\n-        throw new Error('Signup successful but user data is missing');\r\n-      }\r\n-\r\n-      // Map Supabase user to our user format\r\n-      const mappedUser = {\r\n-        id: data.user.id,\r\n-        email: data.user.email!,\r\n-        name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\r\n-        role: data.user.user_metadata?.role || 'student',\r\n-        photoUrl: data.user.user_metadata?.avatar_url,\r\n-      };\r\n-\r\n-      console.log('[Auth] Mapped user:', mappedUser);\r\n-\r\n-      context.setUser(mappedUser);\r\n-      return { user: mappedUser };\r\n-    } catch (error) {\r\n-      const errorDetails = error instanceof Error ? {\r\n-        message: error.message,\r\n-        name: error.name,\r\n-        stack: error.stack\r\n-      } : error;\r\n-\r\n-      console.error('[Auth] Signup error details:', {\r\n-        error: errorDetails,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-\r\n-      logger.error('Signup failed', {\r\n-        context: { \r\n-          error: errorDetails,\r\n-          credentials: { email: credentials.email }\r\n-        },\r\n-        source: 'useAuth'\r\n-      });\r\n-\r\n-      if (error instanceof Error) {\r\n-        throw error;\r\n-      } else {\r\n-        throw new Error('An unexpected error occurred during signup. Please try again.');\r\n-      }\r\n-    }\r\n-  };\r\n-\r\n-  const resetPassword = async (credentials: ResetPasswordCredentials) => {\r\n-    try {\r\n-      console.log('[Auth] Attempting password reset:', {\r\n-        email: credentials.email,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-      \r\n-      const { data, error } = await supabaseClient.auth.resetPasswordForEmail(\r\n-        credentials.email,\r\n-        { redirectTo: `${window.location.origin}/reset-password` }\r\n-      );\r\n-\r\n-      if (error) {\r\n-        console.error('[Auth] Supabase password reset error:', {\r\n-          message: error.message,\r\n-          status: error.status,\r\n-          name: error.name,\r\n-          timestamp: new Date().toISOString()\r\n-        });\r\n-        \r\n-        logger.error('Password reset failed', {\r\n-          context: { \r\n-            error,\r\n-            credentials: { email: credentials.email }\r\n-          },\r\n-          source: 'useAuth'\r\n-        });\r\n-        throw new Error(error.message);\r\n-      }\r\n-\r\n-      return data;\r\n-    } catch (error) {\r\n-      const errorDetails = error instanceof Error ? {\r\n-        message: error.message,\r\n-        name: error.name,\r\n-        stack: error.stack\r\n-      } : error;\r\n-\r\n-      console.error('[Auth] Password reset error details:', {\r\n-        error: errorDetails,\r\n-        timestamp: new Date().toISOString()\r\n-      });\r\n-\r\n-      logger.error('Password reset failed', {\r\n-        context: { \r\n-          error: errorDetails,\r\n-          credentials: { email: credentials.email }\r\n-        },\r\n-        source: 'useAuth'\r\n-      });\r\n-\r\n-      if (error instanceof Error) {\r\n-        throw error;\r\n-      } else {\r\n-        throw new Error('An unexpected error occurred during password reset. Please try again.');\r\n-      }\r\n-    }\r\n-  };\r\n-\r\n-  //const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n-\r\n-  useEffect(() => {\r\n-    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n-    return () => unsubscribe();\r\n-  }, []);\r\n-\r\n   const checkAndRefreshSession = async (): Promise<void> => {\r\n     try {\r\n       await sessionManager.checkAndRefreshSession();\r\n     } catch (error) {\r\n@@ -502,12 +141,8 @@\n       role: user.role || 'unknown'\r\n     } : null,\r\n     loading,\r\n     changeRole,\r\n-    isTransitioning,\r\n-    login,\r\n-    logout,\r\n-    signUp,\r\n-    resetPassword,\r\n-    sessionManager\r\n+    checkAndRefreshSession,\r\n+    authState\r\n   };\r\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1740689493041,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -30,54 +30,141 @@\n   email: string;\r\n   }\r\n \r\n export function useAuth() {\r\n+  // All hooks must be called at the top level\r\n   const context = useContext(AuthContext);\r\n   const { isTransitioning } = useRoleStore();\r\n   const navigate = useNavigate();\r\n   const location = useLocation();\r\n+  const [_authState, setSessionAuthState] = useState(sessionMonitor.getState());\r\n   const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n-  const queryClient = new QueryClient();\r\n-  const loading = context?.loading || false;\r\n-  const user = context?.user;\r\n-\r\n-  // Base session monitoring\r\n+  \r\n+  // Subscribe to session state updates\r\n   useEffect(() => {\r\n+    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setSessionAuthState);\r\n+    return () => unsubscribe();\r\n+  }, []);\r\n+  \r\n+  useEffect(() => {\r\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n     return () => unsubscribe();\r\n   }, []);\r\n-\r\n-  // Loading state monitoring\r\n+  \r\n+  // Define a dummy loading value for the early return case\r\n+  const loading = context?.loading || false;\r\n+  \r\n+  // Add loading state check - this will run regardless of context\r\n   useEffect(() => {\r\n-    if (!context) return;\r\n+    if (!context || loading || isTransitioning) {\r\n+      return;\r\n+    }\r\n+    // Effect logic here\r\n+  }, [context, loading, isTransitioning]);\r\n+  \r\n+  // Add loading state check\r\n+  useEffect(() => {\r\n+    if (loading || isTransitioning) {\r\n+      return;\r\n+    }\r\n+    \r\n+    // Add your effect logic here\r\n+    // Don't return anything except a cleanup function\r\n+    \r\n+    // Optional cleanup function\r\n+    return () => {\r\n+      // Cleanup code here if needed\r\n+    };\r\n+  }, [loading, isTransitioning]);\r\n+  \r\n+  // Add loading state check\r\n+  useEffect(() => {\r\n     if (loading) {\r\n       logger.info('Auth loading state active', {\r\n         source: 'useAuth',\r\n         context: { loading }\r\n       });\r\n     }\r\n-  }, [context, loading]);\r\n+  }, [loading]);\r\n \r\n-  // Auth state monitoring\r\n+  // Auto-refresh session when it's about to expire\r\n   useEffect(() => {\r\n-    if (!context || loading || isTransitioning) return;\r\n+    if (!context?.user) return;\r\n+    const refreshInterval = setInterval(async () => {\r\n+      try {\r\n+        await sessionManager.refreshSession();\r\n+      } catch (err) {\r\n+        logger.error('Failed to refresh session', {\r\n+          source: 'useAuth',\r\n+          context: { error: err }\r\n+        });\r\n+      }\r\n+    }, 4 * 60 * 1000); // Check every 4 minutes\r\n     \r\n-    logger.debug('Auth state check on route change', {\r\n-      source: 'useAuth',\r\n-      context: {\r\n-        hasUser: !!user,\r\n-        userRole: user?.role,\r\n-        userId: user?.id,\r\n-        path: location.pathname,\r\n-        permissions: user?.role ? ROLE_PERMISSIONS[user.role]?.permissions : undefined\r\n+    return () => {\r\n+      if (refreshInterval) {\r\n+        clearInterval(refreshInterval);\r\n       }\r\n+    };\r\n+  }, [context?.user]);\r\n+\r\n+  useEffect(() => {\r\n+    if (context?.user) {\r\n+      logger.debug('Auth state check on route change', {\r\n+        source: 'useAuth',\r\n+        context: {\r\n+          role: context.user.role,\r\n+          path: location.pathname,\r\n+          permissions: ROLE_PERMISSIONS[context.user.role]?.permissions\r\n+        }\r\n+      });\r\n+    }\r\n+  }, [context?.user, location.pathname]);\r\n+  \r\n+  if (!context) {\r\n+    console.warn('useAuth must be used within an AuthProvider');\r\n+    return { user: null, loading: false };\r\n+  }\r\n+  \r\n+  // Now we can safely use context\r\n+  const { user } = context;\r\n+  const queryClient = new QueryClient();\r\n+\r\n+  // Add debug logging\r\n+  console.log('Auth Context:', {\r\n+    hasUser: !!user,\r\n+    userRole: user?.role,\r\n+    userId: user?.id,\r\n+    isLoading: loading,\r\n+    fullUser: user // Log the full user object for debugging\r\n+  });\r\n+\r\n+  // Add loading state check\r\n+  useEffect(() => {\r\n+    if (loading || isTransitioning) {\r\n+      return;\r\n+    }\r\n+  }, [loading, isTransitioning]);\r\n+  \r\n+  // Add loading state check\r\n+  useEffect(() => {\r\n+    if (loading || isTransitioning) {\r\n+      return;\r\n+    }\r\n+\r\n+    console.log('Auth Context:', {\r\n+      hasUser: !!user,\r\n+      userRole: user?.role,\r\n+      userId: user?.id,\r\n+      isLoading: loading,\r\n+      fullUser: user // Log the full user object for debugging\r\n     });\r\n-  }, [context, loading, isTransitioning, user, location.pathname]);\r\n+    // Don't return anything here\r\n+  }, [loading, isTransitioning, user]);\r\n \r\n-  // Session refresh\r\n+  // Auto-refresh session when it's about to expire\r\n   useEffect(() => {\r\n     if (!user) return;\r\n-    \r\n     const refreshInterval = setInterval(async () => {\r\n       try {\r\n         await sessionManager.refreshSession();\r\n       } catch (err) {\r\n@@ -85,19 +172,30 @@\n           source: 'useAuth',\r\n           context: { error: err }\r\n         });\r\n       }\r\n-    }, 4 * 60 * 1000);\r\n+    }, 4 * 60 * 1000); // Check every 4 minutes\r\n     \r\n-    return () => clearInterval(refreshInterval);\r\n+    return () => {\r\n+      if (refreshInterval) {\r\n+        clearInterval(refreshInterval);\r\n+      }\r\n+    };\r\n   }, [user]);\r\n \r\n-  if (!context) {\r\n-    console.warn('useAuth must be used within an AuthProvider');\r\n-    return { user: null, loading: false };\r\n-  }\r\n+  useEffect(() => {\r\n+    if (user) {\r\n+      logger.debug('Auth state check on route change', {\r\n+        source: 'useAuth',\r\n+        context: {\r\n+          role: user.role,\r\n+          path: location.pathname,\r\n+          permissions: ROLE_PERMISSIONS[user.role]?.permissions\r\n+        }\r\n+      });\r\n+    }\r\n+  }, [user, location.pathname]);\r\n \r\n-  // Rest of the code remains unchanged\r\n   const changeRole = async (newRole: UserRole): Promise<void> => {\r\n     if (!user || isTransitioning) return;\r\n \r\n     try {\r\n@@ -123,8 +221,271 @@\n       throw err;\r\n     }\r\n   };\r\n \r\n+  const login = async (credentials: LoginCredentials) => {\r\n+    try {\r\n+      console.log('[Auth] Attempting login:', {\r\n+        email: credentials.email,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+      \r\n+      const { data, error } = await supabaseClient.auth.signInWithPassword({\r\n+        email: credentials.email,\r\n+        password: credentials.password,\r\n+      });\r\n+\r\n+      if (error) {\r\n+        console.error('[Auth] Supabase login error:', {\r\n+          message: error.message,\r\n+          status: error.status,\r\n+          name: error.name,\r\n+          timestamp: new Date().toISOString()\r\n+        });\r\n+        \r\n+        // Provide more specific error messages\r\n+        if (error.message.includes('Invalid login credentials')) {\r\n+          throw new Error('Invalid email or password. Please check your credentials and try again.');\r\n+        }\r\n+        \r\n+        logger.error('Login failed', {\r\n+          context: { \r\n+            error,\r\n+            credentials: { email: credentials.email }\r\n+          },\r\n+          source: 'useAuth'\r\n+        });\r\n+        throw new Error(error.message);\r\n+      }\r\n+\r\n+      console.log('[Auth] Login response:', {\r\n+        hasUser: !!data.user,\r\n+        userId: data.user?.id,\r\n+        userEmail: data.user?.email,\r\n+        metadata: data.user?.user_metadata,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+\r\n+      if (!data.user) {\r\n+        throw new Error('Login successful but user data is missing');\r\n+      }\r\n+\r\n+      // Map Supabase user to our user format\r\n+      const mappedUser = {\r\n+        id: data.user.id,\r\n+        email: data.user.email!,\r\n+        name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\r\n+        role: data.user.user_metadata?.role || 'student',\r\n+        photoUrl: data.user.user_metadata?.avatar_url,\r\n+      };\r\n+\r\n+      console.log('[Auth] Mapped user:', mappedUser);\r\n+\r\n+      context.setUser(mappedUser);\r\n+      return { user: mappedUser };\r\n+    } catch (error) {\r\n+      const errorDetails = error instanceof Error ? {\r\n+        message: error.message,\r\n+        name: error.name,\r\n+        stack: error.stack\r\n+      } : error;\r\n+\r\n+      console.error('[Auth] Login error details:', {\r\n+        error: errorDetails,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+\r\n+      logger.error('Login failed', {\r\n+        context: { \r\n+          error: errorDetails,\r\n+          credentials: { email: credentials.email }\r\n+        },\r\n+        source: 'useAuth'\r\n+      });\r\n+\r\n+      if (error instanceof Error) {\r\n+        throw error;\r\n+      } else {\r\n+        throw new Error('An unexpected error occurred. Please try again.');\r\n+      }\r\n+    }\r\n+  };\r\n+\r\n+  const logout = async () => {\r\n+    try {\r\n+      const { error } = await supabaseClient.auth.signOut();\r\n+      \r\n+      if (error) {\r\n+        throw error;\r\n+      }\r\n+\r\n+      context.setUser(null);\r\n+      queryClient.clear();\r\n+      navigate('/login');\r\n+    } catch (error) {\r\n+      logger.error('Logout failed', {\r\n+        context: { error },\r\n+        source: 'useAuth'\r\n+      });\r\n+      throw error;\r\n+    }\r\n+  };\r\n+\r\n+  const signUp = async (credentials: SignUpCredentials) => {\r\n+    try {\r\n+      console.log('[Auth] Attempting signup:', {\r\n+        email: credentials.email,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+      \r\n+      const { data, error } = await supabaseClient.auth.signUp({\r\n+        email: credentials.email,\r\n+        password: credentials.password,\r\n+        options: {\r\n+          data: {\r\n+            name: credentials.name || credentials.email.split('@')[0],\r\n+            role: 'student'\r\n+          }\r\n+        }\r\n+      });\r\n+\r\n+      if (error) {\r\n+        console.error('[Auth] Supabase signup error:', {\r\n+          message: error.message,\r\n+          status: error.status,\r\n+          name: error.name,\r\n+          timestamp: new Date().toISOString()\r\n+        });\r\n+        \r\n+        logger.error('Signup failed', {\r\n+          context: { \r\n+            error,\r\n+            credentials: { email: credentials.email }\r\n+          },\r\n+          source: 'useAuth'\r\n+        });\r\n+        throw new Error(error.message);\r\n+      }\r\n+\r\n+      console.log('[Auth] Signup response:', {\r\n+        hasUser: !!data.user,\r\n+        userId: data.user?.id,\r\n+        userEmail: data.user?.email,\r\n+        metadata: data.user?.user_metadata,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+\r\n+      if (!data.user) {\r\n+        throw new Error('Signup successful but user data is missing');\r\n+      }\r\n+\r\n+      // Map Supabase user to our user format\r\n+      const mappedUser = {\r\n+        id: data.user.id,\r\n+        email: data.user.email!,\r\n+        name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\r\n+        role: data.user.user_metadata?.role || 'student',\r\n+        photoUrl: data.user.user_metadata?.avatar_url,\r\n+      };\r\n+\r\n+      console.log('[Auth] Mapped user:', mappedUser);\r\n+\r\n+      context.setUser(mappedUser);\r\n+      return { user: mappedUser };\r\n+    } catch (error) {\r\n+      const errorDetails = error instanceof Error ? {\r\n+        message: error.message,\r\n+        name: error.name,\r\n+        stack: error.stack\r\n+      } : error;\r\n+\r\n+      console.error('[Auth] Signup error details:', {\r\n+        error: errorDetails,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+\r\n+      logger.error('Signup failed', {\r\n+        context: { \r\n+          error: errorDetails,\r\n+          credentials: { email: credentials.email }\r\n+        },\r\n+        source: 'useAuth'\r\n+      });\r\n+\r\n+      if (error instanceof Error) {\r\n+        throw error;\r\n+      } else {\r\n+        throw new Error('An unexpected error occurred during signup. Please try again.');\r\n+      }\r\n+    }\r\n+  };\r\n+\r\n+  const resetPassword = async (credentials: ResetPasswordCredentials) => {\r\n+    try {\r\n+      console.log('[Auth] Attempting password reset:', {\r\n+        email: credentials.email,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+      \r\n+      const { data, error } = await supabaseClient.auth.resetPasswordForEmail(\r\n+        credentials.email,\r\n+        { redirectTo: `${window.location.origin}/reset-password` }\r\n+      );\r\n+\r\n+      if (error) {\r\n+        console.error('[Auth] Supabase password reset error:', {\r\n+          message: error.message,\r\n+          status: error.status,\r\n+          name: error.name,\r\n+          timestamp: new Date().toISOString()\r\n+        });\r\n+        \r\n+        logger.error('Password reset failed', {\r\n+          context: { \r\n+            error,\r\n+            credentials: { email: credentials.email }\r\n+          },\r\n+          source: 'useAuth'\r\n+        });\r\n+        throw new Error(error.message);\r\n+      }\r\n+\r\n+      return data;\r\n+    } catch (error) {\r\n+      const errorDetails = error instanceof Error ? {\r\n+        message: error.message,\r\n+        name: error.name,\r\n+        stack: error.stack\r\n+      } : error;\r\n+\r\n+      console.error('[Auth] Password reset error details:', {\r\n+        error: errorDetails,\r\n+        timestamp: new Date().toISOString()\r\n+      });\r\n+\r\n+      logger.error('Password reset failed', {\r\n+        context: { \r\n+          error: errorDetails,\r\n+          credentials: { email: credentials.email }\r\n+        },\r\n+        source: 'useAuth'\r\n+      });\r\n+\r\n+      if (error instanceof Error) {\r\n+        throw error;\r\n+      } else {\r\n+        throw new Error('An unexpected error occurred during password reset. Please try again.');\r\n+      }\r\n+    }\r\n+  };\r\n+\r\n+  //const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n+\r\n+  useEffect(() => {\r\n+    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n+    return () => unsubscribe();\r\n+  }, []);\r\n+\r\n   const checkAndRefreshSession = async (): Promise<void> => {\r\n     try {\r\n       await sessionManager.checkAndRefreshSession();\r\n     } catch (error) {\r\n@@ -141,8 +502,12 @@\n       role: user.role || 'unknown'\r\n     } : null,\r\n     loading,\r\n     changeRole,\r\n-    checkAndRefreshSession,\r\n-    authState\r\n+    isTransitioning,\r\n+    login,\r\n+    logout,\r\n+    signUp,\r\n+    resetPassword,\r\n+    sessionManager\r\n   };\r\n }\n\\ No newline at end of file\n"
                },
                {
                    "date": 1740689551508,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -30,141 +30,64 @@\n   email: string;\r\n   }\r\n \r\n export function useAuth() {\r\n-  // All hooks must be called at the top level\r\n+  // 1. CONTEXT AND STATE - All state declarations first\r\n   const context = useContext(AuthContext);\r\n   const { isTransitioning } = useRoleStore();\r\n   const navigate = useNavigate();\r\n   const location = useLocation();\r\n-  const [_authState, setSessionAuthState] = useState(sessionMonitor.getState());\r\n   const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n+  const queryClient = new QueryClient();\r\n   \r\n-  // Subscribe to session state updates\r\n+  // 2. Compute derived state - These must come before hooks that depend on them\r\n+  const user = context?.user;\r\n+  const loading = context?.loading || false;\r\n+  const isAuthenticated = !!user;\r\n+\r\n+  // 3. ALL EFFECTS - Always called, regardless of context\r\n+  // Session monitor subscription\r\n   useEffect(() => {\r\n-    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setSessionAuthState);\r\n-    return () => unsubscribe();\r\n-  }, []);\r\n-  \r\n-  useEffect(() => {\r\n     const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n     return () => unsubscribe();\r\n   }, []);\r\n-  \r\n-  // Define a dummy loading value for the early return case\r\n-  const loading = context?.loading || false;\r\n-  \r\n-  // Add loading state check - this will run regardless of context\r\n+\r\n+  // Auth state monitoring\r\n   useEffect(() => {\r\n-    if (!context || loading || isTransitioning) {\r\n-      return;\r\n-    }\r\n-    // Effect logic here\r\n-  }, [context, loading, isTransitioning]);\r\n-  \r\n-  // Add loading state check\r\n-  useEffect(() => {\r\n-    if (loading || isTransitioning) {\r\n-      return;\r\n-    }\r\n+    // Only execute the inner logic if we have context\r\n+    if (!context) return;\r\n     \r\n-    // Add your effect logic here\r\n-    // Don't return anything except a cleanup function\r\n-    \r\n-    // Optional cleanup function\r\n-    return () => {\r\n-      // Cleanup code here if needed\r\n-    };\r\n-  }, [loading, isTransitioning]);\r\n-  \r\n-  // Add loading state check\r\n-  useEffect(() => {\r\n     if (loading) {\r\n-      logger.info('Auth loading state active', {\r\n-        source: 'useAuth',\r\n-        context: { loading }\r\n+      logger.info('Auth loading state active', { \r\n+        source: 'useAuth', \r\n+        context: { loading } \r\n       });\r\n     }\r\n-  }, [loading]);\r\n-\r\n-  // Auto-refresh session when it's about to expire\r\n-  useEffect(() => {\r\n-    if (!context?.user) return;\r\n-    const refreshInterval = setInterval(async () => {\r\n-      try {\r\n-        await sessionManager.refreshSession();\r\n-      } catch (err) {\r\n-        logger.error('Failed to refresh session', {\r\n-          source: 'useAuth',\r\n-          context: { error: err }\r\n-        });\r\n-      }\r\n-    }, 4 * 60 * 1000); // Check every 4 minutes\r\n     \r\n-    return () => {\r\n-      if (refreshInterval) {\r\n-        clearInterval(refreshInterval);\r\n-      }\r\n-    };\r\n-  }, [context?.user]);\r\n-\r\n-  useEffect(() => {\r\n-    if (context?.user) {\r\n+    if (user && !loading && !isTransitioning) {\r\n       logger.debug('Auth state check on route change', {\r\n         source: 'useAuth',\r\n-        context: {\r\n-          role: context.user.role,\r\n+        context: { \r\n+          role: user.role, \r\n           path: location.pathname,\r\n-          permissions: ROLE_PERMISSIONS[context.user.role]?.permissions\r\n+          permissions: ROLE_PERMISSIONS[user.role]?.permissions \r\n         }\r\n       });\r\n+      \r\n+      console.log('Auth Context:', {\r\n+        hasUser: !!user,\r\n+        userRole: user.role,\r\n+        userId: user.id,\r\n+        isLoading: loading,\r\n+        fullUser: user\r\n+      });\r\n     }\r\n-  }, [context?.user, location.pathname]);\r\n-  \r\n-  if (!context) {\r\n-    console.warn('useAuth must be used within an AuthProvider');\r\n-    return { user: null, loading: false };\r\n-  }\r\n-  \r\n-  // Now we can safely use context\r\n-  const { user } = context;\r\n-  const queryClient = new QueryClient();\r\n+  }, [context, user, loading, isTransitioning, location.pathname]);\r\n \r\n-  // Add debug logging\r\n-  console.log('Auth Context:', {\r\n-    hasUser: !!user,\r\n-    userRole: user?.role,\r\n-    userId: user?.id,\r\n-    isLoading: loading,\r\n-    fullUser: user // Log the full user object for debugging\r\n-  });\r\n-\r\n-  // Add loading state check\r\n+  // Session refresh effect\r\n   useEffect(() => {\r\n-    if (loading || isTransitioning) {\r\n-      return;\r\n-    }\r\n-  }, [loading, isTransitioning]);\r\n-  \r\n-  // Add loading state check\r\n-  useEffect(() => {\r\n-    if (loading || isTransitioning) {\r\n-      return;\r\n-    }\r\n-\r\n-    console.log('Auth Context:', {\r\n-      hasUser: !!user,\r\n-      userRole: user?.role,\r\n-      userId: user?.id,\r\n-      isLoading: loading,\r\n-      fullUser: user // Log the full user object for debugging\r\n-    });\r\n-    // Don't return anything here\r\n-  }, [loading, isTransitioning, user]);\r\n-\r\n-  // Auto-refresh session when it's about to expire\r\n-  useEffect(() => {\r\n     if (!user) return;\r\n+    \r\n     const refreshInterval = setInterval(async () => {\r\n       try {\r\n         await sessionManager.refreshSession();\r\n       } catch (err) {\r\n@@ -172,33 +95,23 @@\n           source: 'useAuth',\r\n           context: { error: err }\r\n         });\r\n       }\r\n-    }, 4 * 60 * 1000); // Check every 4 minutes\r\n+    }, 4 * 60 * 1000);\r\n     \r\n-    return () => {\r\n-      if (refreshInterval) {\r\n-        clearInterval(refreshInterval);\r\n-      }\r\n-    };\r\n+    return () => clearInterval(refreshInterval);\r\n   }, [user]);\r\n \r\n-  useEffect(() => {\r\n-    if (user) {\r\n-      logger.debug('Auth state check on route change', {\r\n-        source: 'useAuth',\r\n-        context: {\r\n-          role: user.role,\r\n-          path: location.pathname,\r\n-          permissions: ROLE_PERMISSIONS[user.role]?.permissions\r\n-        }\r\n-      });\r\n-    }\r\n-  }, [user, location.pathname]);\r\n+  // 4. CONDITIONAL RETURN - Only after all hooks are defined\r\n+  if (!context) {\r\n+    console.warn('useAuth must be used within an AuthProvider');\r\n+    return { user: null, loading: false };\r\n+  }\r\n \r\n+  // 5. REGULAR FUNCTIONS - These don't contain hooks\r\n   const changeRole = async (newRole: UserRole): Promise<void> => {\r\n     if (!user || isTransitioning) return;\r\n-\r\n+    \r\n     try {\r\n       await roleTransitionManager.transitionRole(newRole);\r\n       \r\n       // Clear cache and refetch with new role\r\n@@ -477,15 +390,8 @@\n       }\r\n     }\r\n   };\r\n \r\n-  //const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n-\r\n-  useEffect(() => {\r\n-    const unsubscribe = sessionMonitor.subscribeToStateUpdates(setAuthState);\r\n-    return () => unsubscribe();\r\n-  }, []);\r\n-\r\n   const checkAndRefreshSession = async (): Promise<void> => {\r\n     try {\r\n       await sessionManager.checkAndRefreshSession();\r\n     } catch (error) {\r\n"
                },
                {
                    "date": 1740689576953,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -111,28 +111,30 @@\n   const changeRole = async (newRole: UserRole): Promise<void> => {\r\n     if (!user || isTransitioning) return;\r\n     \r\n     try {\r\n-      await roleTransitionManager.transitionRole(newRole);\r\n+      // Validate that we have a complete user object before changing role\r\n+      if (!user.id) {\r\n+        throw new Error('Cannot change role: User ID is missing');\r\n+      }\r\n       \r\n-      // Clear cache and refetch with new role\r\n-      queryClient.clear();\r\n-      await queryClient.resetQueries();\r\n+      // Create a valid User object with required fields\r\n+      const updatedUser: User & { role: UserRole } = {\r\n+        ...user,\r\n+        role: newRole,\r\n+        id: user.id, // Ensure id is present\r\n+      };\r\n       \r\n       // Update context user\r\n-      context.setUser({\r\n-        ...context.user,\r\n-        role: newRole\r\n-      });\r\n+      context.setUser(updatedUser);\r\n \r\n       // Navigate to home with fresh data\r\n       navigate('/', { replace: true });\r\n-    } catch (err) {\r\n+    } catch (error) {\r\n       logger.error('Failed to change role', {\r\n         source: 'useAuth',\r\n-        context: { error: err }\r\n+        context: { error, newRole }\r\n       });\r\n-      throw err;\r\n     }\r\n   };\r\n \r\n   const login = async (credentials: LoginCredentials) => {\r\n"
                },
                {
                    "date": 1740689590845,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -15,8 +15,9 @@\n import { AuthLoader } from '../lib/auth/AuthLoader';\r\n import type { AuthError } from '@supabase/supabase-js';\r\n import { sessionMonitor } from '@/lib/auth/SessionMonitor';\r\n import type { SessionState } from '@/lib/auth/sessionManager';\r\n+import { User } from '../types/auth';\r\n \r\n interface LoginCredentials {\r\n   email: string;\r\n   password: string;\r\n"
                },
                {
                    "date": 1740689601757,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -112,30 +112,29 @@\n   const changeRole = async (newRole: UserRole): Promise<void> => {\r\n     if (!user || isTransitioning) return;\r\n     \r\n     try {\r\n-      // Validate that we have a complete user object before changing role\r\n-      if (!user.id) {\r\n-        throw new Error('Cannot change role: User ID is missing');\r\n-      }\r\n+      await roleTransitionManager.transitionRole(newRole);\r\n       \r\n-      // Create a valid User object with required fields\r\n-      const updatedUser: User & { role: UserRole } = {\r\n+      // Clear cache and refetch with new role\r\n+      queryClient.clear();\r\n+      await queryClient.resetQueries();\r\n+      \r\n+      // Update context user with explicit type assertion to fix the error\r\n+      context.setUser({\r\n         ...user,\r\n         role: newRole,\r\n-        id: user.id, // Ensure id is present\r\n-      };\r\n-      \r\n-      // Update context user\r\n-      context.setUser(updatedUser);\r\n+        id: user.id || '', // Ensure id is not undefined\r\n+      } as any); // Type assertion as a last resort to fix the error\r\n \r\n       // Navigate to home with fresh data\r\n       navigate('/', { replace: true });\r\n-    } catch (error) {\r\n+    } catch (err) {\r\n       logger.error('Failed to change role', {\r\n         source: 'useAuth',\r\n-        context: { error, newRole }\r\n+        context: { error: err }\r\n       });\r\n+      throw err;\r\n     }\r\n   };\r\n \r\n   const login = async (credentials: LoginCredentials) => {\r\n"
                },
                {
                    "date": 1740689786182,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -15,9 +15,8 @@\n import { AuthLoader } from '../lib/auth/AuthLoader';\r\n import type { AuthError } from '@supabase/supabase-js';\r\n import { sessionMonitor } from '@/lib/auth/SessionMonitor';\r\n import type { SessionState } from '@/lib/auth/sessionManager';\r\n-import { User } from '../types/auth';\r\n \r\n interface LoginCredentials {\r\n   email: string;\r\n   password: string;\r\n"
                },
                {
                    "date": 1740690407319,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -72,9 +72,9 @@\n           permissions: ROLE_PERMISSIONS[user.role]?.permissions \r\n         }\r\n       });\r\n       \r\n-      console.log('Auth Context:', {\r\n+      logger.info('Auth Context:', {\r\n         hasUser: !!user,\r\n         userRole: user.role,\r\n         userId: user.id,\r\n         isLoading: loading,\r\n@@ -102,9 +102,9 @@\n   }, [user]);\r\n \r\n   // 4. CONDITIONAL RETURN - Only after all hooks are defined\r\n   if (!context) {\r\n-    console.warn('useAuth must be used within an AuthProvider');\r\n+    logger.warn('useAuth must be used within an AuthProvider');\r\n     return { user: null, loading: false };\r\n   }\r\n \r\n   // 5. REGULAR FUNCTIONS - These don't contain hooks\r\n@@ -137,9 +137,9 @@\n   };\r\n \r\n   const login = async (credentials: LoginCredentials) => {\r\n     try {\r\n-      console.log('[Auth] Attempting login:', {\r\n+      logger.info('[Auth] Attempting login:', {\r\n         email: credentials.email,\r\n         timestamp: new Date().toISOString()\r\n       });\r\n       \r\n@@ -148,9 +148,9 @@\n         password: credentials.password,\r\n       });\r\n \r\n       if (error) {\r\n-        console.error('[Auth] Supabase login error:', {\r\n+        logger.error('[Auth] Supabase login error:', {\r\n           message: error.message,\r\n           status: error.status,\r\n           name: error.name,\r\n           timestamp: new Date().toISOString()\r\n@@ -170,9 +170,9 @@\n         });\r\n         throw new Error(error.message);\r\n       }\r\n \r\n-      console.log('[Auth] Login response:', {\r\n+      logger.info('[Auth] Login response:', {\r\n         hasUser: !!data.user,\r\n         userId: data.user?.id,\r\n         userEmail: data.user?.email,\r\n         metadata: data.user?.user_metadata,\r\n@@ -191,9 +191,9 @@\n         role: data.user.user_metadata?.role || 'student',\r\n         photoUrl: data.user.user_metadata?.avatar_url,\r\n       };\r\n \r\n-      console.log('[Auth] Mapped user:', mappedUser);\r\n+      logger.info('[Auth] Mapped user:', mappedUser);\r\n \r\n       context.setUser(mappedUser);\r\n       return { user: mappedUser };\r\n     } catch (error) {\r\n@@ -202,9 +202,9 @@\n         name: error.name,\r\n         stack: error.stack\r\n       } : error;\r\n \r\n-      console.error('[Auth] Login error details:', {\r\n+      logger.error('[Auth] Login error details:', {\r\n         error: errorDetails,\r\n         timestamp: new Date().toISOString()\r\n       });\r\n \r\n@@ -245,9 +245,9 @@\n   };\r\n \r\n   const signUp = async (credentials: SignUpCredentials) => {\r\n     try {\r\n-      console.log('[Auth] Attempting signup:', {\r\n+      logger.info('[Auth] Attempting signup:', {\r\n         email: credentials.email,\r\n         timestamp: new Date().toISOString()\r\n       });\r\n       \r\n@@ -262,9 +262,9 @@\n         }\r\n       });\r\n \r\n       if (error) {\r\n-        console.error('[Auth] Supabase signup error:', {\r\n+        logger.error('[Auth] Supabase signup error:', {\r\n           message: error.message,\r\n           status: error.status,\r\n           name: error.name,\r\n           timestamp: new Date().toISOString()\r\n@@ -279,9 +279,9 @@\n         });\r\n         throw new Error(error.message);\r\n       }\r\n \r\n-      console.log('[Auth] Signup response:', {\r\n+      logger.info('[Auth] Signup response:', {\r\n         hasUser: !!data.user,\r\n         userId: data.user?.id,\r\n         userEmail: data.user?.email,\r\n         metadata: data.user?.user_metadata,\r\n@@ -300,9 +300,9 @@\n         role: data.user.user_metadata?.role || 'student',\r\n         photoUrl: data.user.user_metadata?.avatar_url,\r\n       };\r\n \r\n-      console.log('[Auth] Mapped user:', mappedUser);\r\n+      logger.info('[Auth] Mapped user:', mappedUser);\r\n \r\n       context.setUser(mappedUser);\r\n       return { user: mappedUser };\r\n     } catch (error) {\r\n@@ -311,9 +311,9 @@\n         name: error.name,\r\n         stack: error.stack\r\n       } : error;\r\n \r\n-      console.error('[Auth] Signup error details:', {\r\n+      logger.error('[Auth] Signup error details:', {\r\n         error: errorDetails,\r\n         timestamp: new Date().toISOString()\r\n       });\r\n \r\n@@ -334,9 +334,9 @@\n   };\r\n \r\n   const resetPassword = async (credentials: ResetPasswordCredentials) => {\r\n     try {\r\n-      console.log('[Auth] Attempting password reset:', {\r\n+      logger.info('[Auth] Attempting password reset:', {\r\n         email: credentials.email,\r\n         timestamp: new Date().toISOString()\r\n       });\r\n       \r\n@@ -345,9 +345,9 @@\n         { redirectTo: `${window.location.origin}/reset-password` }\r\n       );\r\n \r\n       if (error) {\r\n-        console.error('[Auth] Supabase password reset error:', {\r\n+        logger.error('[Auth] Supabase password reset error:', {\r\n           message: error.message,\r\n           status: error.status,\r\n           name: error.name,\r\n           timestamp: new Date().toISOString()\r\n@@ -370,9 +370,9 @@\n         name: error.name,\r\n         stack: error.stack\r\n       } : error;\r\n \r\n-      console.error('[Auth] Password reset error details:', {\r\n+      logger.error('[Auth] Password reset error details:', {\r\n         error: errorDetails,\r\n         timestamp: new Date().toISOString()\r\n       });\r\n \r\n"
                },
                {
                    "date": 1740690435806,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -72,14 +72,13 @@\n           permissions: ROLE_PERMISSIONS[user.role]?.permissions \r\n         }\r\n       });\r\n       \r\n-      logger.info('Auth Context:', {\r\n-        hasUser: !!user,\r\n-        userRole: user.role,\r\n-        userId: user.id,\r\n-        isLoading: loading,\r\n-        fullUser: user\r\n+      logger.info('Auth Context:', { \r\n+        context: {\r\n+          hasUser: !!user,\r\n+          userRole: user.role\r\n+        }\r\n       });\r\n     }\r\n   }, [context, user, loading, isTransitioning, location.pathname]);\r\n \r\n@@ -137,24 +136,27 @@\n   };\r\n \r\n   const login = async (credentials: LoginCredentials) => {\r\n     try {\r\n-      logger.info('[Auth] Attempting login:', {\r\n-        email: credentials.email,\r\n-        timestamp: new Date().toISOString()\r\n+      logger.info('[Auth] Attempting login:', { \r\n+        context: {\r\n+          email: credentials.email,\r\n+          timestamp: new Date().toISOString()\r\n+        }\r\n       });\r\n       \r\n       const { data, error } = await supabaseClient.auth.signInWithPassword({\r\n         email: credentials.email,\r\n         password: credentials.password,\r\n       });\r\n \r\n       if (error) {\r\n-        logger.error('[Auth] Supabase login error:', {\r\n-          message: error.message,\r\n-          status: error.status,\r\n-          name: error.name,\r\n-          timestamp: new Date().toISOString()\r\n+        logger.error('[Auth] Supabase login error:', { \r\n+          context: {\r\n+            message: error.message,\r\n+            status: error.status\r\n+          },\r\n+          error\r\n         });\r\n         \r\n         // Provide more specific error messages\r\n         if (error.message.includes('Invalid login credentials')) {\r\n@@ -170,14 +172,13 @@\n         });\r\n         throw new Error(error.message);\r\n       }\r\n \r\n-      logger.info('[Auth] Login response:', {\r\n-        hasUser: !!data.user,\r\n-        userId: data.user?.id,\r\n-        userEmail: data.user?.email,\r\n-        metadata: data.user?.user_metadata,\r\n-        timestamp: new Date().toISOString()\r\n+      logger.info('[Auth] Login response:', { \r\n+        context: {\r\n+          hasUser: !!data.user,\r\n+          userId: data.user?.id\r\n+        }\r\n       });\r\n \r\n       if (!data.user) {\r\n         throw new Error('Login successful but user data is missing');\r\n@@ -191,9 +192,9 @@\n         role: data.user.user_metadata?.role || 'student',\r\n         photoUrl: data.user.user_metadata?.avatar_url,\r\n       };\r\n \r\n-      logger.info('[Auth] Mapped user:', mappedUser);\r\n+      logger.info('[Auth] Mapped user:', { context: mappedUser });\r\n \r\n       context.setUser(mappedUser);\r\n       return { user: mappedUser };\r\n     } catch (error) {\r\n@@ -202,11 +203,13 @@\n         name: error.name,\r\n         stack: error.stack\r\n       } : error;\r\n \r\n-      logger.error('[Auth] Login error details:', {\r\n-        error: errorDetails,\r\n-        timestamp: new Date().toISOString()\r\n+      logger.error('[Auth] Login error details:', { \r\n+        context: {\r\n+          timestamp: new Date().toISOString()\r\n+        },\r\n+        error: errorDetails\r\n       });\r\n \r\n       logger.error('Login failed', {\r\n         context: { \r\n@@ -245,11 +248,13 @@\n   };\r\n \r\n   const signUp = async (credentials: SignUpCredentials) => {\r\n     try {\r\n-      logger.info('[Auth] Attempting signup:', {\r\n-        email: credentials.email,\r\n-        timestamp: new Date().toISOString()\r\n+      logger.info('[Auth] Attempting signup:', { \r\n+        context: {\r\n+          email: credentials.email,\r\n+          timestamp: new Date().toISOString()\r\n+        }\r\n       });\r\n       \r\n       const { data, error } = await supabaseClient.auth.signUp({\r\n         email: credentials.email,\r\n@@ -262,13 +267,14 @@\n         }\r\n       });\r\n \r\n       if (error) {\r\n-        logger.error('[Auth] Supabase signup error:', {\r\n-          message: error.message,\r\n-          status: error.status,\r\n-          name: error.name,\r\n-          timestamp: new Date().toISOString()\r\n+        logger.error('[Auth] Supabase signup error:', { \r\n+          context: {\r\n+            message: error.message,\r\n+            status: error.status\r\n+          },\r\n+          error\r\n         });\r\n         \r\n         logger.error('Signup failed', {\r\n           context: { \r\n@@ -279,14 +285,13 @@\n         });\r\n         throw new Error(error.message);\r\n       }\r\n \r\n-      logger.info('[Auth] Signup response:', {\r\n-        hasUser: !!data.user,\r\n-        userId: data.user?.id,\r\n-        userEmail: data.user?.email,\r\n-        metadata: data.user?.user_metadata,\r\n-        timestamp: new Date().toISOString()\r\n+      logger.info('[Auth] Signup response:', { \r\n+        context: {\r\n+          hasUser: !!data.user,\r\n+          userId: data.user?.id\r\n+        }\r\n       });\r\n \r\n       if (!data.user) {\r\n         throw new Error('Signup successful but user data is missing');\r\n@@ -300,9 +305,9 @@\n         role: data.user.user_metadata?.role || 'student',\r\n         photoUrl: data.user.user_metadata?.avatar_url,\r\n       };\r\n \r\n-      logger.info('[Auth] Mapped user:', mappedUser);\r\n+      logger.info('[Auth] Mapped user:', { context: mappedUser });\r\n \r\n       context.setUser(mappedUser);\r\n       return { user: mappedUser };\r\n     } catch (error) {\r\n@@ -311,11 +316,13 @@\n         name: error.name,\r\n         stack: error.stack\r\n       } : error;\r\n \r\n-      logger.error('[Auth] Signup error details:', {\r\n-        error: errorDetails,\r\n-        timestamp: new Date().toISOString()\r\n+      logger.error('[Auth] Signup error details:', { \r\n+        context: {\r\n+          timestamp: new Date().toISOString()\r\n+        },\r\n+        error: errorDetails\r\n       });\r\n \r\n       logger.error('Signup failed', {\r\n         context: { \r\n@@ -334,24 +341,27 @@\n   };\r\n \r\n   const resetPassword = async (credentials: ResetPasswordCredentials) => {\r\n     try {\r\n-      logger.info('[Auth] Attempting password reset:', {\r\n-        email: credentials.email,\r\n-        timestamp: new Date().toISOString()\r\n+      logger.info('[Auth] Attempting password reset:', { \r\n+        context: {\r\n+          email: credentials.email,\r\n+          timestamp: new Date().toISOString()\r\n+        }\r\n       });\r\n       \r\n       const { data, error } = await supabaseClient.auth.resetPasswordForEmail(\r\n         credentials.email,\r\n         { redirectTo: `${window.location.origin}/reset-password` }\r\n       );\r\n \r\n       if (error) {\r\n-        logger.error('[Auth] Supabase password reset error:', {\r\n-          message: error.message,\r\n-          status: error.status,\r\n-          name: error.name,\r\n-          timestamp: new Date().toISOString()\r\n+        logger.error('[Auth] Supabase password reset error:', { \r\n+          context: {\r\n+            message: error.message,\r\n+            status: error.status\r\n+          },\r\n+          error\r\n         });\r\n         \r\n         logger.error('Password reset failed', {\r\n           context: { \r\n@@ -370,11 +380,13 @@\n         name: error.name,\r\n         stack: error.stack\r\n       } : error;\r\n \r\n-      logger.error('[Auth] Password reset error details:', {\r\n-        error: errorDetails,\r\n-        timestamp: new Date().toISOString()\r\n+      logger.error('[Auth] Password reset error details:', { \r\n+        context: {\r\n+          timestamp: new Date().toISOString()\r\n+        },\r\n+        error: errorDetails\r\n       });\r\n \r\n       logger.error('Password reset failed', {\r\n         context: { \r\n"
                },
                {
                    "date": 1740690716267,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -121,9 +121,9 @@\n       context.setUser({\r\n         ...user,\r\n         role: newRole,\r\n         id: user.id || '', // Ensure id is not undefined\r\n-      } as any); // Type assertion as a last resort to fix the error\r\n+      } as User & { role: UserRole }); // Using proper type instead of any\r\n \r\n       // Navigate to home with fresh data\r\n       navigate('/', { replace: true });\r\n     } catch (err) {\r\n"
                },
                {
                    "date": 1740690752432,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -15,8 +15,9 @@\n import { AuthLoader } from '../lib/auth/AuthLoader';\r\n import type { AuthError } from '@supabase/supabase-js';\r\n import { sessionMonitor } from '@/lib/auth/SessionMonitor';\r\n import type { SessionState } from '@/lib/auth/sessionManager';\r\n+import type { User } from '../types';\r\n \r\n interface LoginCredentials {\r\n   email: string;\r\n   password: string;\r\n"
                },
                {
                    "date": 1740743236155,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -10,11 +10,11 @@\n import { ROLE_PERMISSIONS } from '../types/roles';\r\n import { sessionManager } from '../lib/auth/sessionManager';\r\n import type { UserRole } from '../types/roles';\r\n import { supabaseClient } from '../lib/supabaseClient';\r\n-import { supabase } from '../lib/supabase';\r\n-import { AuthLoader } from '../lib/auth/AuthLoader';\r\n-import type { AuthError } from '@supabase/supabase-js';\r\n+  import { supabase } from '../lib/supabase';\r\n+  import { AuthLoader } from '../lib/auth/AuthLoader';\r\n+  import type { AuthError } from '@supabase/supabase-js';\r\n import { sessionMonitor } from '@/lib/auth/SessionMonitor';\r\n import type { SessionState } from '@/lib/auth/sessionManager';\r\n import type { User } from '../types';\r\n \r\n"
                },
                {
                    "date": 1740743308202,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -10,11 +10,11 @@\n import { ROLE_PERMISSIONS } from '../types/roles';\r\n import { sessionManager } from '../lib/auth/sessionManager';\r\n import type { UserRole } from '../types/roles';\r\n import { supabaseClient } from '../lib/supabaseClient';\r\n-  import { supabase } from '../lib/supabase';\r\n-  import { AuthLoader } from '../lib/auth/AuthLoader';\r\n-  import type { AuthError } from '@supabase/supabase-js';\r\n+  // import { supabase } from '../lib/supabase';\r\n+  // import { AuthLoader } from '../lib/auth/AuthLoader';\r\n+  // import type { AuthError } from '@supabase/supabase-js';\r\n import { sessionMonitor } from '@/lib/auth/SessionMonitor';\r\n import type { SessionState } from '@/lib/auth/sessionManager';\r\n import type { User } from '../types';\r\n \r\n@@ -88,8 +88,9 @@\n     if (!user) return;\r\n     \r\n     const refreshInterval = setInterval(async () => {\r\n       try {\r\n+        \r\n         await sessionManager.refreshSession();\r\n       } catch (err) {\r\n         logger.error('Failed to refresh session', {\r\n           source: 'useAuth',\r\n"
                },
                {
                    "date": 1740743313982,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -88,9 +88,9 @@\n     if (!user) return;\r\n     \r\n     const refreshInterval = setInterval(async () => {\r\n       try {\r\n-        \r\n+        if ()\r\n         await sessionManager.refreshSession();\r\n       } catch (err) {\r\n         logger.error('Failed to refresh session', {\r\n           source: 'useAuth',\r\n"
                },
                {
                    "date": 1740743326809,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -88,9 +88,9 @@\n     if (!user) return;\r\n     \r\n     const refreshInterval = setInterval(async () => {\r\n       try {\r\n-        if ()\r\n+        if (sessionManager.isSessionValid()) {\r\n         await sessionManager.refreshSession();\r\n       } catch (err) {\r\n         logger.error('Failed to refresh session', {\r\n           source: 'useAuth',\r\n"
                },
                {
                    "date": 1740743342363,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -88,9 +88,9 @@\n     if (!user) return;\r\n     \r\n     const refreshInterval = setInterval(async () => {\r\n       try {\r\n-        if (sessionManager.isSessionValid()) {\r\n+        if (sessionManager.()) {\r\n         await sessionManager.refreshSession();\r\n       } catch (err) {\r\n         logger.error('Failed to refresh session', {\r\n           source: 'useAuth',\r\n"
                },
                {
                    "date": 1740743358850,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -88,9 +88,9 @@\n     if (!user) return;\r\n     \r\n     const refreshInterval = setInterval(async () => {\r\n       try {\r\n-        if (sessionManager.()) {\r\n+        if (sessionManager.getState().session) {\r\n         await sessionManager.refreshSession();\r\n       } catch (err) {\r\n         logger.error('Failed to refresh session', {\r\n           source: 'useAuth',\r\n"
                },
                {
                    "date": 1740743386859,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -88,9 +88,9 @@\n     if (!user) return;\r\n     \r\n     const refreshInterval = setInterval(async () => {\r\n       try {\r\n-        if (sessionManager.getState().session) {\r\n+        if (Sess) {\r\n         await sessionManager.refreshSession();\r\n       } catch (err) {\r\n         logger.error('Failed to refresh session', {\r\n           source: 'useAuth',\r\n"
                },
                {
                    "date": 1740743400208,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -88,9 +88,9 @@\n     if (!user) return;\r\n     \r\n     const refreshInterval = setInterval(async () => {\r\n       try {\r\n-        if (Sess) {\r\n+        if (SessionState) {\r\n         await sessionManager.refreshSession();\r\n       } catch (err) {\r\n         logger.error('Failed to refresh session', {\r\n           source: 'useAuth',\r\n"
                },
                {
                    "date": 1740743416490,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -88,9 +88,9 @@\n     if (!user) return;\r\n     \r\n     const refreshInterval = setInterval(async () => {\r\n       try {\r\n-        if (SessionState) {\r\n+        if (SessionState.isAuthenticated ) {\r\n         await sessionManager.refreshSession();\r\n       } catch (err) {\r\n         logger.error('Failed to refresh session', {\r\n           source: 'useAuth',\r\n"
                },
                {
                    "date": 1740743423295,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -88,9 +88,9 @@\n     if (!user) return;\r\n     \r\n     const refreshInterval = setInterval(async () => {\r\n       try {\r\n-        if (SessionState.isAuthenticated ) {\r\n+        if (SessionState.isAuthenticated == false) {\r\n         await sessionManager.refreshSession();\r\n       } catch (err) {\r\n         logger.error('Failed to refresh session', {\r\n           source: 'useAuth',\r\n"
                },
                {
                    "date": 1740743428923,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -89,9 +89,10 @@\n     \r\n     const refreshInterval = setInterval(async () => {\r\n       try {\r\n         if (SessionState.isAuthenticated == false) {\r\n-        await sessionManager.refreshSession();\r\n+          await sessionManager.refreshSession();\r\n+        }\r\n       } catch (err) {\r\n         logger.error('Failed to refresh session', {\r\n           source: 'useAuth',\r\n           context: { error: err }\r\n"
                },
                {
                    "date": 1740743485326,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -88,9 +88,9 @@\n     if (!user) return;\r\n     \r\n     const refreshInterval = setInterval(async () => {\r\n       try {\r\n-        if (SessionState.isAuthenticated == false) {\r\n+        if (authState.isAuthenticated === false) {\r\n           await sessionManager.refreshSession();\r\n         }\r\n       } catch (err) {\r\n         logger.error('Failed to refresh session', {\r\n@@ -100,9 +100,9 @@\n       }\r\n     }, 4 * 60 * 1000);\r\n     \r\n     return () => clearInterval(refreshInterval);\r\n-  }, [user]);\r\n+  }, [user, authState.isAuthenticated]);\r\n \r\n   // 4. CONDITIONAL RETURN - Only after all hooks are defined\r\n   if (!context) {\r\n     logger.warn('useAuth must be used within an AuthProvider');\r\n"
                },
                {
                    "date": 1740743699326,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -88,11 +88,10 @@\n     if (!user) return;\r\n     \r\n     const refreshInterval = setInterval(async () => {\r\n       try {\r\n-        if (authState.isAuthenticated === false) {\r\n-          await sessionManager.refreshSession();\r\n-        }\r\n+        if (SessionState.isAuthenticated == ) {\r\n+        await sessionManager.refreshSession();\r\n       } catch (err) {\r\n         logger.error('Failed to refresh session', {\r\n           source: 'useAuth',\r\n           context: { error: err }\r\n@@ -100,9 +99,9 @@\n       }\r\n     }, 4 * 60 * 1000);\r\n     \r\n     return () => clearInterval(refreshInterval);\r\n-  }, [user, authState.isAuthenticated]);\r\n+  }, [user]);\r\n \r\n   // 4. CONDITIONAL RETURN - Only after all hooks are defined\r\n   if (!context) {\r\n     logger.warn('useAuth must be used within an AuthProvider');\r\n"
                },
                {
                    "date": 1740743710175,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -88,9 +88,9 @@\n     if (!user) return;\r\n     \r\n     const refreshInterval = setInterval(async () => {\r\n       try {\r\n-        if (SessionState.isAuthenticated == ) {\r\n+        \r\n         await sessionManager.refreshSession();\r\n       } catch (err) {\r\n         logger.error('Failed to refresh session', {\r\n           source: 'useAuth',\r\n"
                },
                {
                    "date": 1740920735299,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -14,9 +14,9 @@\n   // import { supabase } from '../lib/supabase';\r\n   // import { AuthLoader } from '../lib/auth/AuthLoader';\r\n   // import type { AuthError } from '@supabase/supabase-js';\r\n import { sessionMonitor } from '@/lib/auth/SessionMonitor';\r\n-import type { SessionState } from '@/lib/auth/sessionManager';\r\n+//import type { SessionState } from '@/lib/auth/sessionManager';\r\n import type { User } from '../types';\r\n \r\n interface LoginCredentials {\r\n   email: string;\r\n@@ -88,9 +88,8 @@\n     if (!user) return;\r\n     \r\n     const refreshInterval = setInterval(async () => {\r\n       try {\r\n-        \r\n         await sessionManager.refreshSession();\r\n       } catch (err) {\r\n         logger.error('Failed to refresh session', {\r\n           source: 'useAuth',\r\n"
                },
                {
                    "date": 1740920743140,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,7 +1,7 @@\n \"use client\";\r\n \r\n-import { useContext, useEffect, useState, useCallback, useRef } from 'react';\r\n+import { useContext, useEffect, useState } from 'react';\r\n import { AuthContext } from '../contexts/AuthContext';\r\n import { useNavigate, useLocation } from 'react-router-dom';\r\n import { QueryClient } from '@tanstack/query-core';\r\n import { roleTransitionManager } from '../lib/auth/RoleTransitionManager';\r\n"
                },
                {
                    "date": 1740920752140,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -36,9 +36,9 @@\n   const context = useContext(AuthContext);\r\n   const { isTransitioning } = useRoleStore();\r\n   const navigate = useNavigate();\r\n   const location = useLocation();\r\n-  const [authState, setAuthState] = useState(sessionMonitor.getState());\r\n+  const [_authState, setAuthState] = useState(sessionMonitor.getState());\r\n   const queryClient = new QueryClient();\r\n   \r\n   // 2. Compute derived state - These must come before hooks that depend on them\r\n   const user = context?.user;\r\n"
                },
                {
                    "date": 1740920757586,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -42,9 +42,9 @@\n   \r\n   // 2. Compute derived state - These must come before hooks that depend on them\r\n   const user = context?.user;\r\n   const loading = context?.loading || false;\r\n-  const isAuthenticated = !!user;\r\n+  const _isAuthenticated = !!user;\r\n \r\n   // 3. ALL EFFECTS - Always called, regardless of context\r\n   // Session monitor subscription\r\n   useEffect(() => {\r\n"
                },
                {
                    "date": 1740920786713,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -404,9 +404,9 @@\n       }\r\n     }\r\n   };\r\n \r\n-  const checkAndRefreshSession = async (): Promise<void> => {\r\n+  const _checkAndRefreshSession = async (): Promise<void> => {\r\n     try {\r\n       await sessionManager.checkAndRefreshSession();\r\n     } catch (error) {\r\n       logger.error('Failed to check and refresh session', {\r\n"
                },
                {
                    "date": 1740920801189,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -404,9 +404,9 @@\n       }\r\n     }\r\n   };\r\n \r\n-  const _checkAndRefreshSession = async (): Promise<void> => {\r\n+  const checkAndRefreshSession = async (): Promise<void> => {\r\n     try {\r\n       await sessionManager.checkAndRefreshSession();\r\n     } catch (error) {\r\n       logger.error('Failed to check and refresh session', {\r\n"
                },
                {
                    "date": 1740920818160,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -404,9 +404,9 @@\n       }\r\n     }\r\n   };\r\n \r\n-  const checkAndRefreshSession = async (): Promise<void> => {\r\n+  expoort const checkAndRefreshSession = async (): Promise<void> => {\r\n     try {\r\n       await sessionManager.checkAndRefreshSession();\r\n     } catch (error) {\r\n       logger.error('Failed to check and refresh session', {\r\n"
                },
                {
                    "date": 1740920827394,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -404,9 +404,9 @@\n       }\r\n     }\r\n   };\r\n \r\n-  expoort const checkAndRefreshSession = async (): Promise<void> => {\r\n+ const checkAndRefreshSession = async (): Promise<void> => {\r\n     try {\r\n       await sessionManager.checkAndRefreshSession();\r\n     } catch (error) {\r\n       logger.error('Failed to check and refresh session', {\r\n"
                },
                {
                    "date": 1740920839295,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -404,18 +404,18 @@\n       }\r\n     }\r\n   };\r\n \r\n- const checkAndRefreshSession = async (): Promise<void> => {\r\n-    try {\r\n-      await sessionManager.checkAndRefreshSession();\r\n-    } catch (error) {\r\n-      logger.error('Failed to check and refresh session', {\r\n-        context: { error },\r\n-        source: 'useAuth'\r\n-      });\r\n-    }\r\n-  };\r\n+  // const checkAndRefreshSession = async (): Promise<void> => {\r\n+  //   try {\r\n+  //     await sessionManager.checkAndRefreshSession();\r\n+  //   } catch (error) {\r\n+  //     logger.error('Failed to check and refresh session', {\r\n+  //       context: { error },\r\n+  //       source: 'useAuth'\r\n+  //     });\r\n+  //   }\r\n+  // };\r\n \r\n   return {\r\n     user: user ? {\r\n       ...user,\r\n"
                },
                {
                    "date": 1740920847928,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -42,9 +42,9 @@\n   \r\n   // 2. Compute derived state - These must come before hooks that depend on them\r\n   const user = context?.user;\r\n   const loading = context?.loading || false;\r\n-  const _isAuthenticated = !!user;\r\n+  //const _isAuthenticated = !!user;\r\n \r\n   // 3. ALL EFFECTS - Always called, regardless of context\r\n   // Session monitor subscription\r\n   useEffect(() => {\r\n"
                }
            ],
            "date": 1738870357092,
            "name": "Commit-0",
            "content": "\"use client\";\r\n\r\nimport { useContext, useEffect } from 'react';\r\nimport { AuthContext } from '../contexts/AuthContext';\r\nimport { useNavigate, useLocation } from 'react-router-dom';\r\nimport { QueryClient } from '@tanstack/query-core';\r\nimport { roleTransitionManager } from '../lib/auth/RoleTransitionManager';\r\nimport { useRoleStore } from '../lib/auth/store';\r\nimport { logger } from '../lib/logger';\r\nimport { ROLE_PERMISSIONS } from '../types/roles';\r\nimport { sessionManager } from '../lib/auth/sessionManager';\r\nimport type { UserRole } from '../types/roles';\r\nimport { supabaseClient } from '../lib/supabaseClient';\r\n\r\ninterface LoginCredentials {\r\n  email: string;\r\n  password: string;\r\n}\r\n\r\ninterface SignUpCredentials extends LoginCredentials {\r\n  name?: string;\r\n}\r\n\r\ninterface ResetPasswordCredentials {\r\n  email: string;\r\n  newPassword: string;\r\n  accessToken: string;\r\n}\r\n\r\n\r\nexport const useAuth = () => {\r\n  const context = useContext(AuthContext);\r\n  \r\n  if (!context) {\r\n    console.warn('useAuth must be used within an AuthProvider');\r\n    return { user: null, loading: false };\r\n  }\r\n\r\n  const { user, loading } = context;\r\n\r\n  // Add debug logging\r\n  console.log('Auth Context:', {\r\n    hasUser: !!user,\r\n    userRole: user?.role,\r\n    userId: user?.id,\r\n    isLoading: loading,\r\n    fullUser: user // Log the full user object for debugging\r\n  });\r\n\r\n  const { isTransitioning } = useRoleStore();\r\n  const navigate = useNavigate();\r\n  const queryClient = new QueryClient();\r\n  const location = useLocation();\r\n  \r\n  // Add loading state check\r\n  useEffect(() => {\r\n    if (loading) {\r\n      logger.info('Auth loading state active', {\r\n        source: 'useAuth'\r\n      });\r\n    }\r\n  }, [loading]);\r\n\r\n  // Auto-refresh session when it's about to expire\r\n  useEffect(() => {\r\n    if (!user) return;\r\n    const refreshInterval = setInterval(async () => {\r\n      try {\r\n        await sessionManager.refreshSession();\r\n      } catch (err) {\r\n        logger.error('Failed to refresh session', {\r\n          context: { error: err },\r\n          source: 'useAuth'\r\n        });\r\n      }\r\n    }, 4 * 60 * 1000); // Check every 4 minutes\r\n    \r\n    return () => {\r\n      if (refreshInterval) {\r\n        clearInterval(refreshInterval);\r\n      }\r\n    };\r\n  }, [user]);\r\n\r\n  useEffect(() => {\r\n    if (user) {\r\n      logger.debug('Auth state check on route change', {\r\n        context: {\r\n          role: user.role,\r\n          path: location.pathname,\r\n          permissions: ROLE_PERMISSIONS[user.role]?.permissions\r\n        },\r\n        source: 'useAuth'\r\n      });\r\n    }\r\n  }, [user, location.pathname]);\r\n\r\n  const changeRole = async (newRole: UserRole): Promise<void> => {\r\n    if (!context.user || isTransitioning) return;\r\n\r\n    try {\r\n      // First try to get current session\r\n      const { data: { session: currentSession }, error: sessionError } = \r\n        await supabaseClient.auth.getSession();\r\n      \r\n      if (sessionError) {\r\n        logger.error('Failed to get current session', {\r\n          context: { error: sessionError },\r\n          source: 'useAuth'\r\n        });\r\n      }\r\n\r\n      // If no current session or error, try refresh\r\n      if (!currentSession || sessionError) {\r\n        const { data: { session: refreshedSession }, error: refreshError } = \r\n          await supabaseClient.auth.refreshSession();\r\n        \r\n        if (refreshError || !refreshedSession) {\r\n          logger.error('Session refresh failed', {\r\n            context: { error: refreshError },\r\n            source: 'useAuth'\r\n          });\r\n          // Redirect to login if session cannot be refreshed\r\n          await supabaseClient.auth.signOut();\r\n          navigate('/login');\r\n          return;\r\n        }\r\n\r\n        // Use refreshed session\r\n        await roleTransitionManager.transitionRole(newRole, refreshedSession);\r\n      } else {\r\n        // Use current session\r\n        await roleTransitionManager.transitionRole(newRole, currentSession);\r\n      }\r\n      \r\n      // Update context user with new role\r\n      context.setUser({\r\n        ...context.user,\r\n        role: newRole\r\n      });\r\n\r\n      // Clear cache and refetch with new role\r\n      queryClient.clear();\r\n      await queryClient.resetQueries();\r\n      \r\n      navigate('/', { replace: true });\r\n    } catch (err) {\r\n      logger.error('Failed to change role', {\r\n        context: { error: err },\r\n        source: 'useAuth'\r\n      });\r\n      \r\n      // Handle session errors specifically\r\n      if (err instanceof Error && err.message.includes('session')) {\r\n        await supabaseClient.auth.signOut();\r\n        navigate('/login');\r\n      }\r\n      \r\n      throw err;\r\n    }\r\n  };\r\n\r\n  const login = async (credentials: LoginCredentials) => {\r\n    try {\r\n      console.log('[Auth] Attempting login:', {\r\n        email: credentials.email,\r\n        timestamp: new Date().toISOString()\r\n      });\r\n      \r\n      const { data, error } = await supabaseClient.auth.signInWithPassword({\r\n        email: credentials.email,\r\n        password: credentials.password,\r\n      });\r\n\r\n      if (error) {\r\n        console.error('[Auth] Supabase login error:', {\r\n          message: error.message,\r\n          status: error.status,\r\n          name: error.name,\r\n          timestamp: new Date().toISOString()\r\n        });\r\n        \r\n        // Provide more specific error messages\r\n        if (error.message.includes('Invalid login credentials')) {\r\n          throw new Error('Invalid email or password. Please check your credentials and try again.');\r\n        }\r\n        \r\n        logger.error('Login failed', {\r\n          context: { \r\n            error,\r\n            credentials: { email: credentials.email }\r\n          },\r\n          source: 'useAuth'\r\n        });\r\n        throw new Error(error.message);\r\n      }\r\n\r\n      console.log('[Auth] Login response:', {\r\n        hasUser: !!data.user,\r\n        userId: data.user?.id,\r\n        userEmail: data.user?.email,\r\n        metadata: data.user?.user_metadata,\r\n        timestamp: new Date().toISOString()\r\n      });\r\n\r\n      if (!data.user) {\r\n        throw new Error('Login successful but user data is missing');\r\n      }\r\n\r\n      // Map Supabase user to our user format\r\n      const mappedUser = {\r\n        id: data.user.id,\r\n        email: data.user.email!,\r\n        name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\r\n        role: data.user.user_metadata?.role || 'student',\r\n        photoUrl: data.user.user_metadata?.avatar_url,\r\n      };\r\n\r\n      console.log('[Auth] Mapped user:', mappedUser);\r\n\r\n      context.setUser(mappedUser);\r\n      return { user: mappedUser };\r\n    } catch (error) {\r\n      const errorDetails = error instanceof Error ? {\r\n        message: error.message,\r\n        name: error.name,\r\n        stack: error.stack\r\n      } : error;\r\n\r\n      console.error('[Auth] Login error details:', {\r\n        error: errorDetails,\r\n        timestamp: new Date().toISOString()\r\n      });\r\n\r\n      logger.error('Login failed', {\r\n        context: { \r\n          error: errorDetails,\r\n          credentials: { email: credentials.email }\r\n        },\r\n        source: 'useAuth'\r\n      });\r\n\r\n      if (error instanceof Error) {\r\n        throw error;\r\n      } else {\r\n        throw new Error('An unexpected error occurred. Please try again.');\r\n      }\r\n    }\r\n  };\r\n\r\n  const logout = async () => {\r\n    try {\r\n      const { error } = await supabaseClient.auth.signOut();\r\n      \r\n      if (error) {\r\n        throw error;\r\n      }\r\n\r\n      context.setUser(null);\r\n      queryClient.clear();\r\n      navigate('/login');\r\n    } catch (error) {\r\n      logger.error('Logout failed', {\r\n        context: { error },\r\n        source: 'useAuth'\r\n      });\r\n      throw error;\r\n    }\r\n  };\r\n\r\n  const signUp = async (credentials: SignUpCredentials) => {\r\n    try {\r\n      console.log('[Auth] Attempting signup:', {\r\n        email: credentials.email,\r\n        timestamp: new Date().toISOString()\r\n      });\r\n      \r\n      const { data, error } = await supabaseClient.auth.signUp({\r\n        email: credentials.email,\r\n        password: credentials.password,\r\n        options: {\r\n          data: {\r\n            name: credentials.name || credentials.email.split('@')[0],\r\n            role: 'student'\r\n          }\r\n        }\r\n      });\r\n\r\n      if (error) {\r\n        console.error('[Auth] Supabase signup error:', {\r\n          message: error.message,\r\n          status: error.status,\r\n          name: error.name,\r\n          timestamp: new Date().toISOString()\r\n        });\r\n        \r\n        logger.error('Signup failed', {\r\n          context: { \r\n            error,\r\n            credentials: { email: credentials.email }\r\n          },\r\n          source: 'useAuth'\r\n        });\r\n        throw new Error(error.message);\r\n      }\r\n\r\n      console.log('[Auth] Signup response:', {\r\n        hasUser: !!data.user,\r\n        userId: data.user?.id,\r\n        userEmail: data.user?.email,\r\n        metadata: data.user?.user_metadata,\r\n        timestamp: new Date().toISOString()\r\n      });\r\n\r\n      if (!data.user) {\r\n        throw new Error('Signup successful but user data is missing');\r\n      }\r\n\r\n      // Map Supabase user to our user format\r\n      const mappedUser = {\r\n        id: data.user.id,\r\n        email: data.user.email!,\r\n        name: data.user.user_metadata?.name || data.user.email!.split('@')[0],\r\n        role: data.user.user_metadata?.role || 'student',\r\n        photoUrl: data.user.user_metadata?.avatar_url,\r\n      };\r\n\r\n      console.log('[Auth] Mapped user:', mappedUser);\r\n\r\n      context.setUser(mappedUser);\r\n      return { user: mappedUser };\r\n    } catch (error) {\r\n      const errorDetails = error instanceof Error ? {\r\n        message: error.message,\r\n        name: error.name,\r\n        stack: error.stack\r\n      } : error;\r\n\r\n      console.error('[Auth] Signup error details:', {\r\n        error: errorDetails,\r\n        timestamp: new Date().toISOString()\r\n      });\r\n\r\n      logger.error('Signup failed', {\r\n        context: { \r\n          error: errorDetails,\r\n          credentials: { email: credentials.email }\r\n        },\r\n        source: '\r\n      });\r\n\r\n      if (error instanceof Error) {\r\n        throw error;\r\n      } else {\r\n        throw new Error('An unexpected error occurred during signup. Please try again.');\r\n      }\r\n    }\r\n  };\r\n\r\n  const resetPassword = async (credentials: ResetPasswordCredentials) => {\r\n    try {\r\n      console.log('[Auth] Attempting password reset:', {\r\n        email: credentials.email,\r\n        timestamp: new Date().toISOString()\r\n      });\r\n      \r\n      const { data, error } = await supabaseClient.auth.resetPasswordForEmail(\r\n        credentials.email,\r\n        { redirectTo: `${window.location.origin}/reset-password` }\r\n      );\r\n\r\n      if (error) {\r\n        console.error('[Auth] Supabase password reset error:', {\r\n          message: error.message,\r\n          status: error.status,\r\n          name: error.name,\r\n          timestamp: new Date().toISOString()\r\n        });\r\n        \r\n        logger.error('Password reset failed', {\r\n          context: { \r\n            error,\r\n            credentials: { email: credentials.email }\r\n          },\r\n          source: 'useAuth'\r\n        });\r\n        throw new Error(error.message);\r\n      }\r\n\r\n      return data;\r\n    } catch (error) {\r\n      const errorDetails = error instanceof Error ? {\r\n        message: error.message,\r\n        name: error.name,\r\n        stack: error.stack\r\n      } : error;\r\n\r\n      console.error('[Auth] Password reset error details:', {\r\n        error: errorDetails,\r\n        timestamp: new Date().toISOString()\r\n      });\r\n\r\n      logger.error('Password reset failed', {\r\n        context: { \r\n          error: errorDetails,\r\n          credentials: { email: credentials.email }\r\n        },\r\n        source: 'useAuth'\r\n      });\r\n\r\n      if (error instanceof Error) {\r\n        throw error;\r\n      } else {\r\n        throw new Error('An unexpected error occurred during password reset. Please try again.');\r\n      }\r\n    }\r\n  };\r\n\r\n  return {\r\n    user: user ? {\r\n      ...user,\r\n      role: user.role || 'unknown'\r\n    } : null,\r\n    loading,\r\n    changeRole,\r\n    isTransitioning,\r\n    login,\r\n    logout,\r\n    signUp,\r\n    resetPassword\r\n  };\r\n};"
        }
    ]
}