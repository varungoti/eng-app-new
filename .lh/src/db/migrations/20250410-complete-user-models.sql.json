{
    "sourceFile": "src/db/migrations/20250410-complete-user-models.sql",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1746696314911,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1746696314911,
            "name": "Commit-0",
            "content": "-- Migration: Complete User Models\r\n-- Timestamp: 2025-04-10\r\n\r\n-- Up Migration\r\n---------------------------------------------------------------------------\r\n\r\nBEGIN;\r\n\r\n-- Add missing user-related columns and constraints\r\nALTER TABLE user_preferences\r\nADD COLUMN IF NOT EXISTS theme text DEFAULT 'light',\r\nADD COLUMN IF NOT EXISTS language text DEFAULT 'en',\r\nADD COLUMN IF NOT EXISTS timezone text DEFAULT 'UTC',\r\nADD COLUMN IF NOT EXISTS notification_settings jsonb DEFAULT '{\r\n  \"email\": true,\r\n  \"push\": true,\r\n  \"sms\": false,\r\n  \"frequency\": \"daily\"\r\n}'::jsonb;\r\n\r\n-- Create user_activity_logs table for tracking user actions\r\nCREATE TABLE IF NOT EXISTS user_activity_logs (\r\n  id uuid NOT NULL DEFAULT gen_random_uuid(),\r\n  user_id uuid NOT NULL,\r\n  action_type text NOT NULL,\r\n  entity_type text NOT NULL,\r\n  entity_id uuid,\r\n  metadata jsonb DEFAULT '{}',\r\n  created_at timestamp with time zone DEFAULT now(),\r\n  CONSTRAINT user_activity_logs_pkey PRIMARY KEY (id),\r\n  CONSTRAINT user_activity_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE\r\n);\r\n\r\n-- Create indexes for user activity logs\r\nCREATE INDEX IF NOT EXISTS idx_user_activity_logs_user_id ON user_activity_logs(user_id);\r\nCREATE INDEX IF NOT EXISTS idx_user_activity_logs_created_at ON user_activity_logs(created_at);\r\nCREATE INDEX IF NOT EXISTS idx_user_activity_logs_action_type ON user_activity_logs(action_type);\r\n\r\n-- Add user roles table if not exists\r\nCREATE TABLE IF NOT EXISTS user_roles (\r\n  id uuid NOT NULL DEFAULT gen_random_uuid(),\r\n  user_id uuid NOT NULL,\r\n  role text NOT NULL,\r\n  school_id uuid,\r\n  created_at timestamp with time zone DEFAULT now(),\r\n  updated_at timestamp with time zone DEFAULT now(),\r\n  CONSTRAINT user_roles_pkey PRIMARY KEY (id),\r\n  CONSTRAINT user_roles_user_id_fkey FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,\r\n  CONSTRAINT user_roles_school_id_fkey FOREIGN KEY (school_id) REFERENCES schools(id) ON DELETE CASCADE,\r\n  CONSTRAINT user_roles_role_check CHECK (role IN ('admin', 'teacher', 'student', 'parent', 'staff')),\r\n  CONSTRAINT user_roles_user_school_role_key UNIQUE (user_id, school_id, role)\r\n);\r\n\r\n-- Create indexes for user roles\r\nCREATE INDEX IF NOT EXISTS idx_user_roles_user_id ON user_roles(user_id);\r\nCREATE INDEX IF NOT EXISTS idx_user_roles_school_id ON user_roles(school_id);\r\nCREATE INDEX IF NOT EXISTS idx_user_roles_role ON user_roles(role);\r\n\r\n-- Add user sessions table for tracking active sessions\r\nCREATE TABLE IF NOT EXISTS user_sessions (\r\n  id uuid NOT NULL DEFAULT gen_random_uuid(),\r\n  user_id uuid NOT NULL,\r\n  session_token text NOT NULL,\r\n  device_info jsonb DEFAULT '{}',\r\n  last_active_at timestamp with time zone DEFAULT now(),\r\n  expires_at timestamp with time zone NOT NULL,\r\n  created_at timestamp with time zone DEFAULT now(),\r\n  CONSTRAINT user_sessions_pkey PRIMARY KEY (id),\r\n  CONSTRAINT user_sessions_user_id_fkey FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,\r\n  CONSTRAINT user_sessions_session_token_key UNIQUE (session_token)\r\n);\r\n\r\n-- Create indexes for user sessions\r\nCREATE INDEX IF NOT EXISTS idx_user_sessions_user_id ON user_sessions(user_id);\r\nCREATE INDEX IF NOT EXISTS idx_user_sessions_last_active_at ON user_sessions(last_active_at);\r\nCREATE INDEX IF NOT EXISTS idx_user_sessions_expires_at ON user_sessions(expires_at);\r\n\r\n-- Add comments for documentation\r\nCOMMENT ON TABLE user_activity_logs IS 'Tracks user actions and activities for auditing and analytics';\r\nCOMMENT ON TABLE user_roles IS 'Manages user roles and permissions across different schools';\r\nCOMMENT ON TABLE user_sessions IS 'Tracks active user sessions and authentication state';\r\n\r\n-- Create function to clean up expired sessions\r\nCREATE OR REPLACE FUNCTION cleanup_expired_sessions()\r\nRETURNS void AS $$\r\nBEGIN\r\n  DELETE FROM user_sessions\r\n  WHERE expires_at < now();\r\nEND;\r\n$$ LANGUAGE plpgsql;\r\n\r\n-- Create function to log user activity\r\nCREATE OR REPLACE FUNCTION log_user_activity(\r\n  p_user_id uuid,\r\n  p_action_type text,\r\n  p_entity_type text,\r\n  p_entity_id uuid DEFAULT NULL,\r\n  p_metadata jsonb DEFAULT '{}'\r\n)\r\nRETURNS uuid AS $$\r\nDECLARE\r\n  v_log_id uuid;\r\nBEGIN\r\n  INSERT INTO user_activity_logs (\r\n    user_id,\r\n    action_type,\r\n    entity_type,\r\n    entity_id,\r\n    metadata\r\n  ) VALUES (\r\n    p_user_id,\r\n    p_action_type,\r\n    p_entity_type,\r\n    p_entity_id,\r\n    p_metadata\r\n  ) RETURNING id INTO v_log_id;\r\n  \r\n  RETURN v_log_id;\r\nEND;\r\n$$ LANGUAGE plpgsql;\r\n\r\nCOMMIT;\r\n\r\n-- Down Migration\r\n---------------------------------------------------------------------------\r\n\r\nBEGIN;\r\n\r\n-- Drop functions\r\nDROP FUNCTION IF EXISTS cleanup_expired_sessions();\r\nDROP FUNCTION IF EXISTS log_user_activity(uuid, text, text, uuid, jsonb);\r\n\r\n-- Drop comments\r\nCOMMENT ON TABLE user_sessions IS NULL;\r\nCOMMENT ON TABLE user_roles IS NULL;\r\nCOMMENT ON TABLE user_activity_logs IS NULL;\r\n\r\n-- Drop indexes\r\nDROP INDEX IF EXISTS idx_user_sessions_expires_at;\r\nDROP INDEX IF EXISTS idx_user_sessions_last_active_at;\r\nDROP INDEX IF EXISTS idx_user_sessions_user_id;\r\nDROP INDEX IF EXISTS idx_user_roles_role;\r\nDROP INDEX IF EXISTS idx_user_roles_school_id;\r\nDROP INDEX IF EXISTS idx_user_roles_user_id;\r\nDROP INDEX IF EXISTS idx_user_activity_logs_action_type;\r\nDROP INDEX IF EXISTS idx_user_activity_logs_created_at;\r\nDROP INDEX IF EXISTS idx_user_activity_logs_user_id;\r\n\r\n-- Drop tables\r\nDROP TABLE IF EXISTS user_sessions;\r\nDROP TABLE IF EXISTS user_roles;\r\nDROP TABLE IF EXISTS user_activity_logs;\r\n\r\n-- Remove added columns from user_preferences\r\nALTER TABLE user_preferences\r\nDROP COLUMN IF EXISTS theme,\r\nDROP COLUMN IF EXISTS language,\r\nDROP COLUMN IF EXISTS timezone,\r\nDROP COLUMN IF EXISTS notification_settings;\r\n\r\nCOMMIT; "
        }
    ]
}