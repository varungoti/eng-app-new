{
    "sourceFile": "src/db/migrations/20240410-initial-schema.sql",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1746701381282,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1746701381282,
            "name": "Commit-0",
            "content": "-- Enable UUID extension\r\nCREATE EXTENSION IF NOT EXISTS \"uuid-ossp\";\r\n\r\n-- Users\r\nCREATE TABLE IF NOT EXISTS users (\r\n  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\r\n  email TEXT UNIQUE NOT NULL,\r\n  password TEXT NOT NULL,\r\n  full_name TEXT NOT NULL,\r\n  avatar_url TEXT,\r\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,\r\n  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP\r\n);\r\n\r\n-- User Roles\r\nCREATE TABLE IF NOT EXISTS user_roles (\r\n  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\r\n  user_id UUID REFERENCES users(id) ON DELETE CASCADE,\r\n  role TEXT NOT NULL CHECK (role IN ('admin', 'teacher', 'student')),\r\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,\r\n  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP\r\n);\r\n\r\n-- User Preferences\r\nCREATE TABLE IF NOT EXISTS user_preferences (\r\n  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\r\n  user_id UUID REFERENCES users(id) ON DELETE CASCADE,\r\n  theme TEXT NOT NULL CHECK (theme IN ('light', 'dark')),\r\n  language TEXT NOT NULL,\r\n  notifications_enabled BOOLEAN DEFAULT true,\r\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,\r\n  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP\r\n);\r\n\r\n-- Schools\r\nCREATE TABLE IF NOT EXISTS schools (\r\n  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\r\n  name TEXT NOT NULL,\r\n  description TEXT,\r\n  address TEXT,\r\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP\r\n);\r\n\r\n-- School Settings\r\nCREATE TABLE IF NOT EXISTS school_settings (\r\n  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\r\n  school_id UUID REFERENCES schools(id) ON DELETE CASCADE,\r\n  setting_key TEXT NOT NULL,\r\n  setting_value JSONB NOT NULL,\r\n  UNIQUE (school_id, setting_key)\r\n);\r\n\r\n-- School Departments\r\nCREATE TABLE IF NOT EXISTS school_departments (\r\n  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\r\n  school_id UUID REFERENCES schools(id) ON DELETE CASCADE,\r\n  name TEXT NOT NULL,\r\n  description TEXT,\r\n  head_teacher_id UUID REFERENCES users(id) ON DELETE SET NULL\r\n);\r\n\r\n-- School Events\r\nCREATE TABLE IF NOT EXISTS school_events (\r\n  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\r\n  school_id UUID REFERENCES schools(id) ON DELETE CASCADE,\r\n  title TEXT NOT NULL,\r\n  description TEXT,\r\n  event_type TEXT NOT NULL CHECK (event_type IN ('academic', 'cultural', 'sports', 'other')),\r\n  start_date TIMESTAMP WITH TIME ZONE NOT NULL,\r\n  end_date TIMESTAMP WITH TIME ZONE NOT NULL,\r\n  location TEXT,\r\n  organizer_id UUID REFERENCES users(id) ON DELETE SET NULL\r\n);\r\n\r\n-- School Announcements\r\nCREATE TABLE IF NOT EXISTS school_announcements (\r\n  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\r\n  school_id UUID REFERENCES schools(id) ON DELETE CASCADE,\r\n  title TEXT NOT NULL,\r\n  content TEXT NOT NULL,\r\n  priority TEXT NOT NULL CHECK (priority IN ('low', 'normal', 'high', 'urgent')),\r\n  start_date TIMESTAMP WITH TIME ZONE NOT NULL,\r\n  end_date TIMESTAMP WITH TIME ZONE,\r\n  created_by UUID REFERENCES users(id) ON DELETE SET NULL\r\n);\r\n\r\n-- Lessons\r\nCREATE TABLE IF NOT EXISTS lessons (\r\n  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\r\n  title TEXT NOT NULL,\r\n  description TEXT,\r\n  content JSONB NOT NULL,\r\n  created_by UUID REFERENCES users(id) ON DELETE SET NULL,\r\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP\r\n);\r\n\r\n-- Content Versions\r\nCREATE TABLE IF NOT EXISTS content_versions (\r\n  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\r\n  content_id UUID REFERENCES lessons(id) ON DELETE CASCADE,\r\n  version_number INTEGER NOT NULL,\r\n  content_data JSONB NOT NULL,\r\n  created_by UUID REFERENCES users(id) ON DELETE SET NULL,\r\n  UNIQUE (content_id, version_number)\r\n);\r\n\r\n-- Content Metadata\r\nCREATE TABLE IF NOT EXISTS content_metadata (\r\n  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\r\n  content_id UUID REFERENCES lessons(id) ON DELETE CASCADE,\r\n  metadata_type TEXT NOT NULL,\r\n  metadata_value JSONB NOT NULL,\r\n  UNIQUE (content_id, metadata_type)\r\n);\r\n\r\n-- Content Tags\r\nCREATE TABLE IF NOT EXISTS content_tags (\r\n  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\r\n  name TEXT NOT NULL UNIQUE,\r\n  description TEXT\r\n);\r\n\r\n-- Content Tag Relations\r\nCREATE TABLE IF NOT EXISTS content_tag_relations (\r\n  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\r\n  content_id UUID REFERENCES lessons(id) ON DELETE CASCADE,\r\n  tag_id UUID REFERENCES content_tags(id) ON DELETE CASCADE,\r\n  UNIQUE (content_id, tag_id)\r\n);\r\n\r\n-- Content Approvals\r\nCREATE TABLE IF NOT EXISTS content_approvals (\r\n  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\r\n  content_id UUID REFERENCES lessons(id) ON DELETE CASCADE,\r\n  status TEXT NOT NULL CHECK (status IN ('pending', 'approved', 'rejected')),\r\n  requested_by UUID REFERENCES users(id) ON DELETE SET NULL,\r\n  review_notes TEXT\r\n);\r\n\r\n-- Content Analytics\r\nCREATE TABLE IF NOT EXISTS content_analytics (\r\n  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\r\n  content_id UUID REFERENCES lessons(id) ON DELETE CASCADE,\r\n  view_count INTEGER DEFAULT 0,\r\n  completion_count INTEGER DEFAULT 0,\r\n  average_completion_time INTEGER DEFAULT 0,\r\n  difficulty_rating FLOAT DEFAULT 0,\r\n  engagement_score FLOAT DEFAULT 0\r\n);\r\n\r\n-- School Analytics\r\nCREATE TABLE IF NOT EXISTS school_analytics (\r\n  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\r\n  school_id UUID REFERENCES schools(id) ON DELETE CASCADE,\r\n  total_students INTEGER DEFAULT 0,\r\n  active_students INTEGER DEFAULT 0,\r\n  total_teachers INTEGER DEFAULT 0,\r\n  active_teachers INTEGER DEFAULT 0,\r\n  total_lessons INTEGER DEFAULT 0,\r\n  completed_lessons INTEGER DEFAULT 0,\r\n  average_engagement_score FLOAT DEFAULT 0\r\n); "
        }
    ]
}